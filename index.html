<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª v25.1</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ff9800">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<meta name="robots" content="noindex, nofollow">

<style>
  :root{
    --gap:8px;
    /* ãƒ©ã‚¤ãƒˆï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç‰ˆï¼‰ */
    --bg:#fff8e1; --text:#333; --muted:#666;
    --card:#ffffff; --border:#e0e0e0;
    --btn:#ff9800; --btn-hover:#fb8c00;
    --link:#ffc107; --link-hover:#ffb300;
    --ghost-bg:#f5f5f5; --ghost-hover:#e0e0e0; --ghost-text:#333;
    --danger:#e53935; --danger-hover:#c62828;
  }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; margin:10px; padding-bottom:86px; background:var(--bg); color:var(--text); }
  h2{ margin:14px 0; }
  input, select, button{ font-size:16px; padding:8px; width:100%; box-sizing:border-box; }
  label{ display:block; margin:8px 0 4px; }
  .row{ display:flex; gap:var(--gap); flex-wrap:wrap; }
  .row > * { flex:1; min-width:110px; }
  button{ background:var(--btn); color:#fff; border:none; border-radius:10px; cursor:pointer; }
  button:hover{ background:var(--btn-hover); }
  .link{ background:var(--link)!important; }
  .link:hover{ background:var(--link-hover)!important; }
  .ghost{ background:var(--ghost-bg)!important; color:var(--ghost-text)!important; }
  .ghost:hover{ background:var(--ghost-hover)!important; }
  .danger{ background:var(--danger)!important; }
  .danger:hover{ background:var(--danger-hover)!important; }
  .muted{ color:var(--muted); font-size:12px; }
  .nowrap{ white-space:nowrap; }

  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid var(--border); padding:6px; text-align:center; word-break:break-all; }
  th{ position:sticky; top:0; background:var(--card); z-index:1; }

  /* ãƒŠãƒ“ã¯æ¨ªä¸¦ã³ã€ã‚¹ãƒãƒ›å¹…ã§æŠ˜è¿”ã— */
  .nav{ display:grid; grid-auto-flow:column; grid-auto-columns:1fr; gap:8px; overflow-x:clip; margin-bottom:10px; align-items:center; }
  @media (max-width:420px){ .nav{ grid-auto-flow:row; grid-template-columns:repeat(auto-fit, minmax(110px,1fr)); } }
  .view-switch{ display:inline-flex; gap:8px; align-items:center; font-size:12px; color:#555; }

  .table-wrap{ max-height:48vh; overflow:auto; border:1px solid var(--border); border-radius:8px; background:var(--card); position:relative; z-index:1; }
  .cards{ display:flex; flex-direction:column; gap:8px; position:relative; z-index:1; }
  .card{ border:1px solid var(--border); border-radius:12px; padding:8px; background:var(--card); }
  .card-top{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .card-meta{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .meta-left{ display:flex; gap:12px; flex-wrap:wrap; color:#555; font-size:13px; }
  .total{ font-weight:700; font-size:16px; }
  .sum-box{ border:1px solid var(--border); border-radius:8px; padding:8px; margin-top:10px; background:#fff8; }

  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; }
  .modal-content{ background:var(--card); margin:6% auto; padding:12px; width:92%; max-width:560px; border-radius:10px; max-height:90vh; overflow:auto; padding-bottom:96px; }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .checkbox-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; max-height:50vh; overflow:auto; padding-right:4px; }
  .actions{ display:flex; gap:8px; justify-content:center; position:sticky; bottom:0; background:var(--card); padding:8px 0; box-shadow:0 -4px 10px rgba(0,0,0,.04); z-index:60; }

  /* å…¥åŠ›ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆPWAé¢¨ï¼‰ */
  .fab-bar{ position:fixed; left:0; right:0; bottom:0; z-index:10; background:var(--card); border-top:1px solid var(--border); padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left); box-shadow:0 -6px 20px rgba(0,0,0,.06); }
  .fab-inner{ display:flex; gap:8px; max-width:560px; margin:0 auto; }
  .fab-inner > *{ flex:1; min-width:0; }

  /* ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆè¡Œé–“åœ§ç¸®ç”¨ï¼‰ */
  .bulk-area .modal-content{ padding-top:8px; }
  .bulk-row{ display:grid; grid-template-columns: 2fr 1fr 1fr auto auto; gap:8px; align-items:center; }
  .bulk-row .bm-rate{ display:flex; gap:10px; justify-content:center; }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
  body.dark{
    --bg:#0f0f0f; --text:#e7e7e7; --muted:#a3a3a3;
    --card:#151515; --border:#2a2a2a;
    --btn:#f7931a; --btn-hover:#e07f00;
    --link:#ffb300; --link-hover:#ffa000;
    --ghost-bg:#1e1e1e; --ghost-hover:#262626; --ghost-text:#e7e7e7;
    --danger:#cc3b3b; --danger-hover:#a63030;
  }
  body.dark .modal{ background:rgba(0,0,0,.55); }

  html, body { overflow-x:hidden; }
/* === å…¥åŠ›ã®ä¸Šä¸‹é…ç½®ï¼ˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®çœŸä¸‹ã«æ–‡å­—ï¼‰ === */
.choice-vertical { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
.choice-vertical > label { display:flex; flex-direction:column; align-items:center; gap:4px; margin:0; }
.choice-vertical > label > input { width:22px; height:22px; }
.choice-vertical > label > span  { font-size:14px; line-height:1; text-align:center; }

/* è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ®µè½æ‰±ã„ã§æŠ˜ã‚Šè¿”ã— */
.choice-vertical .info-line { flex-basis:100%; color:var(--muted); font-size:13px; line-height:1.3; }

/* è¡¨/ã‚«ãƒ¼ãƒ‰ã®ä¸¦ã³ã‚‚åŒã˜è¦‹ãŸç›®ã« */
.view-switch { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.view-switch .stack { display:flex; flex-direction:column; align-items:center; gap:4px; }
.view-switch .stack input { width:20px; height:20px; }
.view-switch .stack span  { font-size:13px; line-height:1; white-space:nowrap; text-align:center; }
/* å³ç«¯ã®ç‰ˆè¡¨ç¤ºï¼†æ›´æ–°ãƒœã‚¿ãƒ³ã®ç¸¦ã‚¹ã‚¿ãƒƒã‚¯ */
.nav-right{ margin-left:auto; display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
.nav-right .muted{ font-size:12px; line-height:1; opacity:.85; }
/* === ä¸€æ‹¬ãƒã‚¹ã‚¿ ç™»éŒ²è¡Œã®è¦‹ã‚„ã™ã• === */
.bulk-area{ display:flex; flex-direction:column; gap:10px; }
.bulk-row{
  display:grid; gap:8px; align-items:center;
  grid-template-columns: 1.6fr 1.0fr 0.9fr 0.9fr auto; /* åç§°/ä¾¡æ ¼/ç¨/ç¨ç‡/å‰Šé™¤ */
}
@media (max-width:520px){
  .bulk-row{
    grid-template-columns: 1fr 1fr; /* ã‚¹ãƒãƒ›ã¯2åˆ—ã§æŠ˜è¿”ã— */
  }
  .bulk-row .bm-rate{ grid-column:1/2; }
}
.bulk-row .bm-name,
.bulk-row .bm-price,
.bulk-row .bm-tax{
  height:44px; font-size:16px; padding:8px 10px;
}
.bulk-row .bm-name{ min-width:140px; }
.bulk-row .bm-price{ min-width:100px; }
.bulk-row .bm-tax{ min-width:90px; }

/* 8%/10% ã® â€œä¸¸ã®çœŸä¸‹ã«æ–‡å­—â€ ã‚’çµ±ä¸€ï¼ˆå‰å›ã® util ã‚’å†åˆ©ç”¨ï¼‰ */
.choice-vertical{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
.choice-vertical > label{ display:flex; flex-direction:column; align-items:center; gap:4px; margin:0; }
.choice-vertical > label > input{ width:20px; height:20px; }
.choice-vertical > label > span{ font-size:14px; line-height:1; text-align:center; }
/* ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼šå…¥åŠ›è¡Œã®æ•´å½¢ */
.bulk-area .bulk-row{
  display:grid; grid-template-columns: 1.2fr .9fr .8fr auto auto;
  gap:8px; align-items:center;
}
@media (max-width:520px){
  .bulk-area .bulk-row{
    grid-template-columns: 1fr 1fr;
  }
}

/* ãƒ©ã‚¸ã‚ª/ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®â€œå…¥åŠ›ã®çœŸä¸‹ã«æ–‡å­—â€ */
.choice-vertical label{
  display:flex; flex-direction:column; align-items:center; gap:4px;
}
.choice-vertical input{ display:block; }

/* å…¥åŠ›ã®è¦‹ã‚„ã™ã•ï¼ˆä¾¡æ ¼ãƒ»ç¨åŒºåˆ†ï¼‰ */
.bulk-area .bm-price{ min-width: 0; }
.bulk-area .bm-tax{ min-width: 0; }

/* è¡Œé–“åœ§ç¸®ï¼ˆbulk-area å†…ã ã‘å°‘ã—ã‚¿ã‚¤ãƒˆã«ï¼‰ */
.bulk-area input, .bulk-area select{ padding:8px; }
</style>
</head>
<body>

<!-- ãƒŠãƒ“ -->
<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">ä»•å…¥ã‚Œå…¥åŠ›</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">é›»è©±å¸³</button>
  <button type="button" onclick="showPage('masters')" class="ghost">ãƒã‚¹ã‚¿ç®¡ç†</button>
  <button type="button" onclick="openBulkMaster()" class="link">ğŸ§© ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²</button>
  <button type="button" id="btnTheme" class="ghost" onclick="toggleTheme()">ğŸŒ“ ãƒ€ãƒ¼ã‚¯</button>

  <!-- å³ç«¯ï¼šæ›´æ–°ãƒœã‚¿ãƒ³ â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå…¥ã‚Œæ›¿ãˆæ¸ˆã¿ï¼‰ -->
  <div class="nav-right" style="margin-left:auto; display:flex; align-items:center; gap:10px;">
    <button type="button" class="link" onclick="forceUpdateSW()">ğŸ”„ æ›´æ–°</button>
    <span id="appVersion" class="muted">v25</span>
  </div>
</div>


<!-- ä»•å…¥ã‚Œå…¥åŠ› -->
<section id="page-entry">
  <h2>ä»•å…¥ã‚Œå…¥åŠ›</h2>

  <label>æ—¥ä»˜</label>
  <input type="date" id="inDate">

  <label>ä»•å…¥å…ˆ <span class="muted">ï¼ˆé¸æŠã™ã‚‹ã¨ç´ä»˜ãå•†å“ã®ã¿è¡¨ç¤ºï¼‰</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" onclick="openSupplierModal()">ï¼‹ ä»•å…¥å…ˆè¿½åŠ </button>
  </div>
  <div id="supplierQuick" class="row" style="margin:6px 0; display:none; align-items:center;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">ğŸ“ ã“ã®ä»•å…¥å…ˆã«é›»è©±</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">ğŸ“‹ é›»è©±ç•ªå·ã‚³ãƒ”ãƒ¼</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>å•†å“å</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" onclick="openItemModal()">ï¼‹ å•†å“è¿½åŠ </button>
  </div>

  <div class="row">
    <div>
      <label>å˜ä¾¡</label>
      <input type="number" id="inPrice" value="0" step="1" min="0" onfocus="this.select()">
    </div>
    <div>
      <label>æ•°é‡</label>
      <input type="number" id="inQty" value="1" step="0.1" min="0" onfocus="this.select()">
    </div>
  </div>

  <!-- ã‚¯ã‚¤ãƒƒã‚¯æ•°é‡ã‚­ãƒ¼å‰Šé™¤ï¼šä¾¡æ ¼å±¥æ­´ã®ã¿è¡¨ç¤º -->
<div class="row" style="margin-top:0; justify-content:flex-end;">
  <button type="button" id="btnPriceHist" class="link" style="flex:0 0 auto;" onclick="openPriceHistory()">ä¾¡æ ¼å±¥æ­´</button>
</div>


  <label>ç¨åŒºåˆ†</label>
<div class="radio-group choice-vertical">
  <label><input type="radio" name="inTax" value="taxIncluded"><span>ç¨è¾¼</span></label>
  <label><input type="radio" name="inTax" value="taxExcluded" checked><span>ç¨åˆ¥</span></label>
  <span class="info-line">åŸºæœ¬ç¨ç‡ï¼š<b id="lblRate"></b>%ï¼ˆè¨­å®šã§å¤‰æ›´ï¼‰</span>
</div>


 <label style="margin-top:6px;">ç¨ç‡ï¼ˆ8% / 10% ã‚¯ã‚¤ãƒƒã‚¯åˆ‡æ›¿ï¼‰</label>
<div class="radio-group choice-vertical" id="baseRateRadios">
  <label><input type="radio" name="baseRateChoice" value="8" checked><span>8%</span></label>
  <label><input type="radio" name="baseRateChoice" value="10"><span>10%</span></label>
  <span class="info-line">â€» ä»¥å¾Œã®è¨ˆç®—ã«ä½¿ã†ã€ŒåŸºæœ¬ç¨ç‡ã€ã‚’å³æ™‚æ›´æ–°</span>
</div>


  <h3 class="list-head">
  <span>ä»•å…¥ã‚Œä¸€è¦§</span>
  <div class="view-switch">
    <span class="muted" style="align-self:flex-end;">è¡¨ç¤º</span>

    <label class="choice-col">
      <input type="radio" name="viewMode" value="table">
      <span>è¡¨</span>
    </label>

    <label class="choice-col">
      <input type="radio" name="viewMode" value="cards" checked>
      <span>ã‚«ãƒ¼ãƒ‰</span>
    </label>

    <label class="choice-col" style="margin-left:10px;">
      <input type="checkbox" id="toggleAll" onchange="toggleAllRows(this)">
      <span>å…¨ä»¶è¡¨ç¤º<br><small class="muted">ï¼ˆæœ€æ–°50ä»¶ï¼‰</small></span>
    </label>
  </div>
</h3>


  <!-- æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="row" style="margin:6px 0 10px; align-items:center;">
    <label class="muted" style="margin:0;">æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
    <input type="month" id="filterMonth" style="width:auto;">
    <button type="button" class="ghost" onclick="setThisMonth()">ä»Šæœˆ</button>
    <button type="button" class="ghost" onclick="clearMonthFilter()">è§£é™¤</button>
    <button type="button" class="ghost" onclick="toggleMonthlySummary()">ä»•å…¥å…ˆåˆ¥ãƒ»æœˆåˆè¨ˆ</button>
    <span id="activeFilter" class="muted"></span>
  </div>

  <!-- ä»•å…¥å…ˆåˆ¥ãƒ»æœˆåˆè¨ˆ -->
  <div id="monthlyBox" class="sum-box" style="display:none;">
    <div class="row" style="align-items:center;">
      <div class="muted" style="flex:0 0 auto;">é›†è¨ˆæœˆï¼š</div>
      <div id="summaryMonthLabel" style="flex:0 0 auto; font-weight:700;"></div>
      <div style="flex:1;"></div>
      <button type="button" class="ghost" style="flex:0 0 auto;" onclick="downloadSupplierMonthlyCSV()">CSV</button>
      <button type="button" class="ghost" style="flex:0 0 auto;" onclick="downloadDailySupplierCSV()">æ—¥åˆ¥CSV</button>
    </div>
    <div class="table-wrap" style="max-height:30vh; margin-top:8px;">
      <table>
        <thead><tr><th>ä»•å…¥å…ˆ</th><th>åˆè¨ˆï¼ˆå††ï¼‰</th><th>ä»¶æ•°</th></tr></thead>
        <tbody id="monthlyBody"></tbody>
      </table>
    </div>
  </div>

  <!-- è¡¨ -->
  <div class="table-wrap" id="wrap-table" style="display:none;">
    <table id="listTable">
      <thead>
        <tr><th>æ—¥ä»˜</th><th>ä»•å…¥å…ˆ</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ç¨åŒºåˆ†</th><th>åˆè¨ˆ</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
  <div id="wrap-cards" class="cards"></div>

  <div class="row" style="margin-top:10px;">
    <button type="button" class="ghost" onclick="wipeAll()">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    <button type="button" class="link" onclick="downloadCSV()">CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨æœŸé–“ï¼‰</button>
  </div>

  <div class="row" style="margin-top:6px;">
    <button type="button" class="ghost" onclick="openRestoreChooser()">å¾©å…ƒ</button>
    <button type="button" class="link"  onclick="backupJSON()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>

  <!-- å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="restoreChooser" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å¾©å…ƒ</h3>
        <button type="button" class="ghost" onclick="closeModal('restoreChooser')">âœ•</button>
      </div>
      <p class="muted" id="lastBackupHint" style="margin:6px 0;"></p>
      <div class="row" style="margin-top:8px;">
        <button type="button" class="ghost" onclick="restoreFromFile(); closeModal('restoreChooser')">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
        <button type="button" onclick="quickRestore(); closeModal('restoreChooser')">ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
      </div>
      <div class="muted" style="margin-top:6px;">
        ã†ã¾ãé–‹ã‘ãªã„æ™‚ã¯
        <a href="javascript:void(0)" onclick="forceFileRestore(); closeModal('restoreChooser')">ã“ã¡ã‚‰</a>
      </div>
    </div>
  </div>
  <input id="restoreInput" type="file" accept="application/json" style="display:none"
        onchange="if(this.files[0]) restoreJSON(this.files[0])">
</section>

<!-- é›»è©±å¸³ -->
<section id="page-phonebook" style="display:none;">
  <h2>ä»•å…¥å…ˆé›»è©±å¸³</h2>
  <table id="phoneTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ãƒã‚¹ã‚¿ç®¡ç† -->
<section id="page-masters" style="display:none;">
  <div class="row" style="align-items:center; justify-content:space-between;">
    <h2 style="margin:8px 0;">ãƒã‚¹ã‚¿ä¸€è¦§</h2>
    <button type="button" class="link" style="flex:0 0 auto;" onclick="openBulkMaster()">ğŸ§© ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²</button>
  </div>

  <h3>ä»•å…¥å…ˆ</h3>
  <table id="supTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>å•†å“ï¼ˆç´ä»˜ã‘å…ˆï¼‰</h3>
  <table id="itemTable">
    <thead><tr><th>å•†å“å</th><th>åŸºæº–ä¾¡æ ¼</th><th>ç¨åŒºåˆ†</th><th>ç´ä»˜ã‘ä»•å…¥å…ˆ</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ä»•å…¥ã‚Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="purchaseEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥ã‚Œç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('purchaseEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editPurchaseIndex">
    <label>æ—¥ä»˜</label><input type="date" id="editDate">
    <label>ä»•å…¥å…ˆ</label><select id="editSupplier"></select>
    <label>å•†å“</label><select id="editItem"></select>
    <div class="row">
      <div><label>å˜ä¾¡</label><input type="number" id="editPrice" step="1" min="0"></div>
      <div><label>æ•°é‡</label><input type="number" id="editQty" step="0.1" min="0"></div>
    </div>
    <label>ç¨åŒºåˆ†</label>
    <div class="row" style="align-items:center;">
      <label style="flex:0 0 auto;"><input type="radio" name="editTax" value="taxIncluded"> ç¨è¾¼</label>
      <label style="flex:0 0 auto;"><input type="radio" name="editTax" value="taxExcluded"> ç¨åˆ¥</label>
    </div>
    <div class="actions" style="margin-top:8px;">
      <!-- ãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
      <button type="button" class="danger" onclick="deletePurchase()">å‰Šé™¤</button>
      <button type="button" onclick="updatePurchase()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä»•å…¥å…ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆè¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">âœ•</button>
    </div>
    <label>ç¤¾å</label><input id="supName" type="text" placeholder="ä¾‹ï¼‰Aãƒ•ãƒ¼ã‚º">
    <label>æ‹…å½“è€…</label><input id="supContact" type="text" placeholder="ä¾‹ï¼‰å±±ç”°ã•ã‚“">
    <label>é›»è©±ç•ªå·</label><input id="supPhone" type="tel" placeholder="090-1234-5678">
    <div class="actions" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetSupplierForm()">ã‚¯ãƒªã‚¢</button>
      <button type="button" onclick="addSupplier()">ç™»éŒ²</button>
    </div>
  </div>
</div>

<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>ç¤¾å</label><input id="editSupName" type="text">
    <label>æ‹…å½“è€…</label><input id="editSupContact" type="text">
    <label>é›»è©±ç•ªå·</label><input id="editSupPhone" type="tel">
    <div class="actions" style="margin-top:8px;">
      <button type="button" class="danger" onclick="deleteSupplier()">å‰Šé™¤</button>
      <button type="button" onclick="updateSupplier()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å•†å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“è¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">âœ•</button>
    </div>
    <label>å•†å“å</label><input id="itName" type="text" placeholder="ä¾‹ï¼‰å›½ç”£ã‚‚ã‚‚è‚‰ 2kg">
    <div class="row">
      <div><label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label><input id="itPrice" type="number" placeholder="0"></div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="itTax">
          <option value="taxExcluded" selected>ç¨åˆ¥</option>
          <option value="taxIncluded">ç¨è¾¼</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="itSuppliers" class="checkbox-grid"></div>
    <div class="muted">â€» è¤‡æ•°ã®ä»•å…¥å…ˆã‹ã‚‰è³¼å…¥å¯èƒ½ãªå•†å“ã«å¯¾å¿œã—ã¾ã™ã€‚</div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetItemForm()">ã‚¯ãƒªã‚¢</button>
      <button type="button" onclick="addItem()">ç™»éŒ²</button>
    </div>
  </div>
</div>

<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“ç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>å•†å“å</label><input id="editItName" type="text">
    <div class="row">
      <div><label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label><input id="editItPrice" type="number"></div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="editItTax">
          <option value="taxExcluded">ç¨åˆ¥</option>
          <option value="taxIncluded">ç¨è¾¼</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="editItSuppliers" class="checkbox-grid"></div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" class="danger" onclick="deleteItem()">å‰Šé™¤</button>
      <button type="button" onclick="updateItem()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä¾¡æ ¼å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä¾¡æ ¼å±¥æ­´</h3>
      <button type="button" class="ghost" onclick="closeModal('historyModal')">âœ•</button>
    </div>
    <div class="table-wrap" style="max-height:50vh; margin-top:8px;">
      <table>
        <thead><tr><th>æ—¥ä»˜</th><th>ä»•å…¥å…ˆ</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ç¨åŒºåˆ†</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä»•å…¥å…ˆï¼‹è¤‡æ•°å•†å“ï¼‰ -->
<div id="bulkMasterModal" class="modal">
  <div class="modal-content">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h3>ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆä»•å…¥å…ˆï¼‹è¤‡æ•°å•†å“ï¼‰</h3>
      <button type="button" class="ghost" onclick="closeModal('bulkMasterModal')">âœ•</button>
    </div>

    <!-- ä»•å…¥å…ˆ -->
    <h4>ä»•å…¥å…ˆ</h4>
    <label>ç¤¾å</label>
    <input id="bmSupName" type="text" placeholder="ä¾‹ï¼‰Bæ°´ç”£">
    <div class="row">
      <div>
        <label>æ‹…å½“è€…</label>
        <input id="bmSupContact" type="text">
      </div>
      <div>
        <label>é›»è©±ç•ªå·</label>
        <input id="bmSupPhone" type="tel" placeholder="090-1234-5678">
      </div>
    </div>

    <!-- é‡è¤‡è­¦å‘Šè¡¨ç¤ºï¼ˆå¿…è¦æ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
    <div id="bmDupArea" class="muted" style="display:none; margin-top:8px;"></div>

    <!-- å•†å“è¡Œï¼ˆè¤‡æ•°ï¼‰ -->
    <h4 style="margin-top:12px;">å•†å“ï¼ˆè¤‡æ•°è¡Œè¿½åŠ å¯ï¼‰</h4>
    <div id="bmProducts" class="bulk-area" style="display:flex; flex-direction:column; gap:10px;"></div>

    <div class="row" style="margin-top:6px;">
      <button type="button" class="ghost" onclick="bmAddRow()">ï¼‹ å•†å“ã‚’è¿½åŠ </button>
      <button type="button" class="danger" onclick="bmClearRows()">å•†å“ã‚’å…¨ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ï¼ãƒã‚¸ãƒ†ã‚£ãƒ–å³ï¼‰ -->
    <div class="actions" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="closeModal('bulkMasterModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" onclick="bmSubmit()">ã¾ã¨ã‚ã¦ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- å…¥åŠ›ãƒ•ãƒƒã‚¿ãƒ¼ï¼šãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" class="ghost" onclick="clearEntry()">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
    <button type="button" onclick="savePurchase()">ä¿å­˜</button>
  </div>
</div>

<script>
/* ====== ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ====== */
const APP_VERSION = 'v25.1';
document.addEventListener('DOMContentLoaded', ()=>{
  const el = document.getElementById('appVersion');
  if (el) el.textContent = APP_VERSION;
});

/* ====== SWç™»éŒ² ====== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try{
      const reg = await navigator.serviceWorker.register('./sw.js?v=25.1', {updateViaCache:'none'});
      document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') reg.update(); });
    }catch(e){}
  });
}

/* ====== æ°¸ç¶šåŒ–ã‚­ãƒ¼ ====== */
const LS_KEYS = {
  suppliers: 'suppliers_v2',
  items: 'items_v3',
  purchases: 'purchases_v3',
  taxRate: 'base_tax_rate_v1'
};
const LS_LAST_BACKUP = 'last_backup_json_v1';

const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

/* ====== çŠ¶æ…‹ ====== */
let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

let SHOW_ALL = false;
let VIEW_MODE = 'cards';
let FILTER_MONTH = '';

/* ====== ç¨ç‡ ====== */
function getBaseTaxRate(){ const v = localStorage.getItem(LS_KEYS.taxRate); return v==null ? 0.08 : Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate, String(decimal)); updateTaxRateLabel(); renderBaseRateRadios(); }
function updateTaxRateLabel(){ $('lblRate').textContent = Math.round(getBaseTaxRate()*1000)/10; }
function renderBaseRateRadios(){
  const pct = Math.round(getBaseTaxRate()*100);
  const target = pct===10 ? '10' : '8';
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  radios.forEach(r=>{
    r.checked = (r.value === target);
    r.onchange = ()=> setBaseTaxRate(Number(r.value)/100);
  });
}
function ensureBaseRateChecked(){
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  const any = Array.from(radios).some(r => r.checked);
  if(!any){
    const pct = Math.round(getBaseTaxRate()*100);
    const target = pct===10 ? '10' : '8';
    const r = document.querySelector(`input[name="baseRateChoice"][value="${target}"]`);
    if(r) r.checked = true;
  }
}

/* ====== ãƒ†ãƒ¼ãƒ ====== */
const THEME_KEY = 'app_theme_v1_alt';
function applyTheme(mode){
  const isDark = mode === 'dark';
  document.body.classList.toggle('dark', isDark);
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.setAttribute('content', isDark ? '#0f0f0f' : '#ff9800');
  const b = document.getElementById('btnTheme'); if (b) b.textContent = isDark ? 'â˜€ ãƒ©ã‚¤ãƒˆ' : 'ğŸŒ“ ãƒ€ãƒ¼ã‚¯';
  localStorage.setItem(THEME_KEY, mode);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if (saved==='dark' || saved==='light') applyTheme(saved);
  else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener?.('change', (e)=>{ if(!localStorage.getItem(THEME_KEY)) applyTheme(e.matches ? 'dark':'light'); });
}
function toggleTheme(){
  const now = document.body.classList.contains('dark') ? 'dark' : 'light';
  applyTheme(now==='dark' ? 'light' : 'dark');
}

/* ====== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ====== */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block':'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block':'none';
  $('page-masters').style.display = which==='masters' ? 'block':'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters')  { renderSupTable(); renderItemTable(); }
  if(which==='entry')    ensureBaseRateChecked();
}

/* ====== åˆæœŸæç”» ====== */
function init(){
  const d = new Date();
  $('inDate').value = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;

  const defTax = document.querySelector('input[name="inTax"][value="taxExcluded"]');
  if(defTax) defTax.checked = true;

  const fm = $('filterMonth');
  if (fm){
    fm.onchange = ()=>{ FILTER_MONTH = fm.value || ''; renderList(); updateActiveFilterLabel(); renderSupplierMonthly(); };
  }
  updateActiveFilterLabel();

  const vm = document.querySelectorAll('input[name="viewMode"]');
  vm.forEach(r => r.onchange = ()=>{ VIEW_MODE = r.value; renderList(); });

  renderSupplierSelect();
  renderItemSelect();
  renderList();
  updateTaxRateLabel();
  renderBaseRateRadios();
  ensureBaseRateChecked();
  renderSupplierMonthly();

  initTheme();
}
document.addEventListener('DOMContentLoaded', init);

/* ====== ãƒ˜ãƒ«ãƒ‘ãƒ¼æç”» ====== */
function renderSupplierSelect(){
  const sel = $('inSupplier');
  sel.innerHTML = '<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>' + suppliers.map(s=> `<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange = ()=>{ renderItemSelect(sel.value); updateSupplierQuick(sel.value); };
}
function updateSupplierQuick(supplierId){
  const wrap = $('supplierQuick');
  if(!supplierId){ wrap.style.display='none'; return; }
  const s = suppliers.find(x=>x.id===supplierId); if(!s){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  const phone = s.phone || ''; const telHref = phone ? `tel:${phone}` : '';
  $('supplierPhoneView').textContent = phone ? `é›»è©±ç•ªå·ï¼š${phone}` : 'é›»è©±ç•ªå·æœªç™»éŒ²';
  $('btnCallSupplier').onclick = ()=>{ if(!phone){ alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™'); return; } window.location.href = telHref; };
  $('btnCopySupplier').onclick = ()=> copyPhone(phone);
}
function renderItemSelect(supplierId=''){
  const sel = $('inItem');
  let list = items;
  if(supplierId){ list = items.filter(it => (it.suppliers||[]).includes(supplierId)); }
  sel.innerHTML = '<option value="">-- å•†å“ã‚’é¸æŠ --</option>' + list.map(i=> `<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange = ()=>{
    const it = items.find(x=>x.id===sel.value);
    if(it){
      const last = getLastPriceFor($('inSupplier').value, it.id);
      $('inPrice').value = last!=null ? last : (it.price!=null ? it.price : 0);
      const defaultTax = it.taxType || 'taxExcluded';
      const tsel = document.querySelector('input[name="inTax"][value="'+ defaultTax +'"]');
      if (tsel) tsel.checked = true;
    }
  };
}

/* ====== å…¥åŠ›ã‚¨ãƒªã‚¢ ====== */
function clearEntry(){ $('inItem').value = ''; $('inQty').value = 1; $('inPrice').value = 0; document.querySelector('input[name="inTax"][value="taxExcluded"]').checked = true; }


/* ====== ç›´è¿‘ä¾¡æ ¼å–å¾— ====== */
function getLastPriceFor(supplierId, itemId){
  for (let i = purchases.length - 1; i >= 0; i--) { const p = purchases[i]; if (p.supplierId===supplierId && p.itemId===itemId) return p.price; }
  return null;
}

/* ====== é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼šKeyç”Ÿæˆ ====== */
function dupKeyPurchase(d,sup,it){ return `${d}__${sup}__${it}`; }
function normName(name){ return (name||'').trim().replace(/\s+/g,' ').replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); }

/* ====== ä¿å­˜ãƒ»è¨ˆç®—ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè£…ï¼‰ ====== */
function savePurchase(){
  const date = $('inDate').value;
  const supplierId = $('inSupplier').value;
  const itemId = $('inItem').value;
  const qty = Number($('inQty').value || 0);
  const price = Number($('inPrice').value || 0);
  const selTax = document.querySelector('input[name="inTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';

  if(!date) return alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(!supplierId) return alert('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!itemId) return alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');

  const rate = getBaseTaxRate();

  // === é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒæ—¥Ã—åŒä»•å…¥å…ˆÃ—åŒå•†å“ï¼‰ ===
  const key = dupKeyPurchase(date, supplierId, itemId);
  const idx = purchases.findIndex(p => dupKeyPurchase(p.date, p.supplierId, p.itemId) === key);
  if (idx >= 0) {
    // OK â†’ æ•°é‡åŠ ç®— / Cancel â†’ åˆ¥è¡Œã¨ã—ã¦è¿½åŠ 
    const ok = confirm('åŒã˜æ—¥ãƒ»ä»•å…¥å…ˆãƒ»å•†å“ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚\nOK=æ•°é‡ã‚’åŠ ç®— / ã‚­ãƒ£ãƒ³ã‚»ãƒ«=åˆ¥è¡Œã¨ã—ã¦è¿½åŠ ');
    if (ok) {
      const target = purchases[idx];
      target.qty = Math.round((Number(target.qty||0) + qty)*100)/100;
      // æ—¢å­˜è¡Œã®å˜ä¾¡ãƒ»ç¨ã‚’ç¶­æŒã—ã€totalã‚’æ—¢å­˜ãƒ«ãƒ¼ãƒ«ã§å†è¨ˆç®—
      const r = getBaseTaxRate();
      const base = (target.taxType==='taxExcluded') ? target.qty*target.price : target.qty*target.price/(1+r);
      target.total = Math.round( (target.taxType==='taxExcluded') ? base*(1+r) : target.qty*target.price );
      localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
      clearEntry(); renderList(); renderSupplierMonthly();
      return;
    }
  }

  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);
  purchases.push({date, supplierId, itemId, qty, price, taxType, total});
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  clearEntry(); renderList(); renderSupplierMonthly();
}

/* ====== ä¸€è¦§ & é›†è¨ˆ ====== */
function toggleAllRows(chk){ SHOW_ALL = chk.checked; renderList(); }
function getFilteredArray(){
  let arr = purchases.slice().map((p,idx)=>({p, idx})).reverse();
  if (FILTER_MONTH) arr = arr.filter(({p}) => (p.date||'').slice(0,7) === FILTER_MONTH);
  return SHOW_ALL ? arr : arr.slice(0,50);
}
function renderList(){
  const wrapTable = document.getElementById('wrap-table');
  const wrapCards = document.getElementById('wrap-cards');
  if (VIEW_MODE === 'table') {
    wrapTable.style.display = 'block';
    wrapCards.style.display = 'none';
    renderListTable();
  } else {
    wrapTable.style.display = 'none';
    wrapCards.style.display = 'block';
    renderListCards();
  }
}
function renderListTable(){
  const tb = $('listTable').querySelector('tbody'); tb.innerHTML = '';
  const list = getFilteredArray();
  list.forEach(({p, idx:origIndex})=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.date}</td>
      <td>${s ? s.name : ''}</td>
      <td>${i ? i.name : ''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
      <td>${p.total}</td>
      <td class="nowrap">
        <!-- ãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
        <button class="danger" style="padding:6px 8px;" onclick="deletePurchaseAt(${origIndex})">å‰Šé™¤</button>
        <button class="ghost" style="padding:6px 8px;" onclick="openPurchaseEdit(${origIndex})">ç·¨é›†</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderListCards(){
  const box = document.getElementById('wrap-cards'); box.innerHTML = '';
  const list = getFilteredArray();

  // åŒä¸€æ—¥Ã—åŒä¸€ä»•å…¥å…ˆã§ã‚«ãƒ¼ãƒ‰é›†ç´„ï¼ˆç¨åˆ¥å°è¨ˆï¼‹æŒ‡å®šç¨ç‡åˆè¨ˆï¼‰
  const rate = getBaseTaxRate();
  const map = new Map(); // key = date|supplierId
  list.forEach(({p, idx})=>{
    const key = `${p.date}|${p.supplierId}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push({p, idx});
  });

  Array.from(map.values()).forEach(rows=>{
    const {p:first} = rows[0];
    const s = suppliers.find(x=>x.id===first.supplierId);
    const supplierName = s ? s.name : '(ä¸æ˜)';

    // ç¨åˆ¥å°è¨ˆ
    let subTotalEx = 0;
    rows.forEach(({p})=>{
      const base = p.taxType==='taxExcluded' ? (p.qty*p.price) : (p.qty*p.price/(1+rate));
      subTotalEx += base;
    });
    const totalWithRate = Math.round(subTotalEx * (1+rate));

    const detail = rows.map(({p, idx})=>{
      const i = items.find(x=>x.id===p.itemId);
      return `
        <div class="card-meta">
          <div class="meta-left">
            <span>${i? i.name:''}</span>
            <span>${p.qty} Ã— ${p.price}</span>
            <span>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</span>
          </div>
          <div class="meta-right">
            <!-- ãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
            <span class="actions">
              <button class="danger" onclick="deletePurchaseAt(${idx})">å‰Šé™¤</button>
              <button class="ghost" onclick="openPurchaseEdit(${idx})">ç·¨é›†</button>
            </span>
          </div>
        </div>`;
    }).join('');

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-top">
        <div>${first.date}</div>
        <div class="primary" style="font-weight:700;">${supplierName}</div>
        <div style="margin-left:auto;">
          <button class="ghost" onclick="quickAddForSupplier('${first.supplierId}','${first.date}')">ï¼‹è¿½åŠ </button>
        </div>
      </div>
      <div class="meta-left" style="margin:6px 0;">
        <span>ç¨åˆ¥å°è¨ˆï¼š<b>${Math.round(subTotalEx)}</b> å††</span>
        <span>åˆè¨ˆï¼ˆ${Math.round(rate*100)}%ï¼‰ï¼š<b>${totalWithRate}</b> å††</span>
      </div>
      ${detail}
    `;
    box.appendChild(card);
  });

  if (map.size===0){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    box.appendChild(empty);
  }
}
function updateActiveFilterLabel(){
  const el = $('activeFilter'); if(!el) return;
  el.textContent = FILTER_MONTH ? `é©ç”¨ä¸­ï¼š${FILTER_MONTH}` : '';
}

/* ====== CSV ====== */
function downloadCSV(){
  let csv = 'æ—¥ä»˜,ä»•å…¥å…ˆ,å•†å“,æ•°é‡,å˜ä¾¡,ç¨åŒºåˆ†,åˆè¨ˆ\n';
  purchases.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    csv += `${p.date},${s?s.name:''},${i?i.name:''},${p.qty},${p.price},${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'},${p.total}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼å¾©å…ƒ ====== */
async function backupJSON(){
  const fileName = `shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const data = {version: 1, savedAt: new Date().toISOString(), suppliers, items, purchases, taxRate: localStorage.getItem(LS_KEYS.taxRate)};
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const file = new File([blob], fileName, {type:'application/json'});
  try { localStorage.setItem(LS_LAST_BACKUP, json); } catch(_) {}
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try { await navigator.share({ title: 'ä»•å…¥ã‚Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', text: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã§ã™ã€‚', files: [file] }); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return; }
    catch(e){ if (e.name === 'AbortError') return; }
  }
  if ('showSaveFilePicker' in window) {
    try{
      const handle = await window.showSaveFilePicker({ suggestedName: fileName, types: [{ description:'JSON', accept:{ 'application/json': ['.json'] } }] });
      const w = await handle.createWritable(); await w.write(blob); await w.close();
      alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return;
    }catch(e){ if (e.name === 'AbortError') return; }
  }
  try{
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName; a.click(); URL.revokeObjectURL(a.href); alert('JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
  }catch(e){ alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
}
async function restoreFromFile(){
  try{
    if ('showOpenFilePicker' in window) {
      const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', accept: { 'application/json': ['.json'] } }] });
      const f = await handle.getFile(); const text = await f.text(); const data = JSON.parse(text);
      _applyRestore(data); alert('å¾©å…ƒã—ã¾ã—ãŸ'); return;
    }
  }catch(e){ if (e.name !== 'AbortError') alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); return; }
  const input = $('restoreInput'); if (input) input.click();
}
function quickRestore(){
  try{
    const json = localStorage.getItem(LS_LAST_BACKUP);
    if(!json){ alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚'); return; }
    const data = JSON.parse(json); _applyRestore(data); alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ');
  }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
}
function restoreJSON(file){
  const r = new FileReader();
  r.onload = ()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); } catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); } };
  r.readAsText(file);
}
function forceFileRestore(){
  const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json'; input.style.display = 'none';
  input.onchange = ()=>{ if(input.files && input.files[0]){ const r = new FileReader(); r.onload = ()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); } catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); } }; r.readAsText(input.files[0]); } };
  document.body.appendChild(input); input.click(); setTimeout(()=> document.body.removeChild(input), 0);
}
function _applyRestore(data){
  if(!data || !data.suppliers || !data.items || !data.purchases) throw new Error('å½¢å¼ä¸æ­£');
  suppliers = data.suppliers; items = data.items; purchases = data.purchases;
  if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate, String(data.taxRate));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  renderSupplierSelect(); renderItemSelect(); renderList();
  renderPhonebook(); renderSupTable(); renderItemTable();
  updateTaxRateLabel(); renderSupplierMonthly();
}

/* ====== æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ====== */
function setThisMonth(){
  const d = new Date(); const v = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
  if ($('filterMonth')) $('filterMonth').value = v; FILTER_MONTH = v; renderList(); updateActiveFilterLabel(); renderSupplierMonthly();
}
function clearMonthFilter(){ FILTER_MONTH = ''; if ($('filterMonth')) $('filterMonth').value = ''; renderList(); updateActiveFilterLabel(); renderSupplierMonthly(); }

/* ====== ä»•å…¥å…ˆåˆ¥ãƒ»æœˆåˆè¨ˆ ====== */
function toggleMonthlySummary(){ const box = $('monthlyBox'); const willShow = (box.style.display==='none' || !box.style.display); box.style.display = willShow ? 'block':'none'; if (willShow) { renderSupplierMonthly(); setTimeout(()=> box.scrollIntoView({behavior:'smooth', block:'start'}), 0); } }
function renderSupplierMonthly(){
  const month = FILTER_MONTH || (new Date().toISOString().slice(0,7));
  $('summaryMonthLabel').textContent = month;
  const body = $('monthlyBody'); body.innerHTML = '';
  const monthRows = purchases.filter(p => (p.date||'').slice(0,7) === month);
  const map = new Map(); // supId -> {name,total,count}
  monthRows.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const name = s ? s.name : '(ä¸æ˜)';
    const prev = map.get(p.supplierId) || {name, total:0, count:0};
    prev.total += p.total; prev.count += 1;
    map.set(p.supplierId, prev);
  });
  const entries = Array.from(map.values()).sort((a,b)=> b.total - a.total);
  entries.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.name}</td><td>${e.total}</td><td>${e.count}</td>`;
    body.appendChild(tr);
  });
  if(entries.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="3" class="muted">ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>';
    body.appendChild(tr);
  }
}

/* ====== é›»è©±å¸³ ====== */
function renderPhonebook(){
  const tb = $('phoneTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    const telHref = s.phone ? `tel:${s.phone}` : '';
    tr.innerHTML = `
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center; text-decoration:none; padding:8px; border-radius:8px; display:block;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>ğŸ“ é›»è©±</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
async function copyPhone(num){
  if(!num){ alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(num); }
    else{ const ta = document.createElement('textarea'); ta.value = num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    alert('é›»è©±ç•ªå·ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }catch(e){ alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š' + e.message); }
}

/* ====== ãƒã‚¹ã‚¿ä¸€è¦§ ====== */
function renderSupTable(){
  const tb = $('supTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td>
                    <td>
                      <!-- ãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
                      <button class="danger" onclick="deleteSupplierQuick('${s.id}')">å‰Šé™¤</button>
                      <button class="ghost" onclick="openSupplierEdit('${s.id}')">ç·¨é›†</button>
                    </td>`;
    tb.appendChild(tr);
  });
}
function deleteSupplierQuick(id){
  const s = suppliers.find(x=>x.id===id);
  if (!s) return;
  if(!confirm(`ä»•å…¥å…ˆã€Œ${s.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ç´ä»˜ãå•†å“ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  suppliers = suppliers.filter(x=>x.id!==id);
  items = items.map(it=> ({...it, suppliers: (it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

function renderItemTable(){
  const tb = $('itemTable').querySelector('tbody'); tb.innerHTML = '';
  items.forEach(it=>{
    const names = (it.suppliers||[]).map(id=> (suppliers.find(s=>s.id===id)||{}).name ).filter(Boolean);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${it.price!=null ? it.price : ''}</td>
      <td>${it.taxType==='taxExcluded' ? 'ç¨åˆ¥' : 'ç¨è¾¼'}</td>
      <td>${names.join(' / ')}</td>
      <td>
        <!-- ãƒã‚¬ãƒ†ã‚£ãƒ–å·¦ / ãƒã‚¸ãƒ†ã‚£ãƒ–å³ -->
        <button class="danger" onclick="deleteItemDirect('${it.id}')">å‰Šé™¤</button>
        <button class="ghost" onclick="openItemEdit('${it.id}')">ç·¨é›†</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ====== ä»•å…¥ã‚Œç·¨é›†ãƒ»å‰Šé™¤ ====== */
function openPurchaseEdit(index){
  const p = purchases[index]; if(!p) return;
  $('editPurchaseIndex').value = String(index);
  $('editDate').value = p.date;

  const supSel = $('editSupplier'); supSel.innerHTML = suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  supSel.value = p.supplierId;

  const itemSel = $('editItem');
  const list = items.filter(it => (it.suppliers||[]).includes(p.supplierId));
  itemSel.innerHTML = list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  itemSel.value = p.itemId;

  supSel.onchange = ()=>{
    const list2 = items.filter(it => (it.suppliers||[]).includes(supSel.value));
    itemSel.innerHTML = list2.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  };

  $('editQty').value = p.qty;
  $('editPrice').value = p.price;
  const r = document.querySelector(`input[name="editTax"][value="${p.taxType}"]`); if(r) r.checked = true;

  $('purchaseEditModal').style.display = 'block';
}
function updatePurchase(){
  const idx = Number($('editPurchaseIndex').value);
  const date = $('editDate').value;
  const supplierId = $('editSupplier').value;
  const itemId = $('editItem').value;
  const qty = Number($('editQty').value || 0);
  const price = Number($('editPrice').value || 0);
  const selTax = document.querySelector('input[name="editTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';
  if(!date||!supplierId||!itemId) return alert('æ—¥ä»˜ãƒ»ä»•å…¥å…ˆãƒ»å•†å“ã¯å¿…é ˆã§ã™');
  const rate = getBaseTaxRate();
  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);
  purchases[idx] = {date, supplierId, itemId, qty, price, taxType, total};
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  closeModal('purchaseEditModal'); renderList(); renderSupplierMonthly();
}
function deletePurchase(){ const idx = Number($('editPurchaseIndex').value); if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; purchases.splice(idx,1); localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases)); closeModal('purchaseEditModal'); renderList(); renderSupplierMonthly(); }
function deletePurchaseAt(index){ if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; purchases.splice(index,1); localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases)); renderList(); renderSupplierMonthly(); }

/* ====== ä»•å…¥å…ˆï¼šæ–°è¦/ç·¨é›† ====== */
function openSupplierModal(){ resetSupplierForm(); $('supplierModal').style.display = 'block'; }
function resetSupplierForm(){ $('supName').value=''; $('supContact').value=''; $('supPhone').value=''; }
function addSupplier(){
  const name = $('supName').value.trim(); if(!name) return alert('ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const contact = $('supContact').value.trim(); const phone = $('supPhone').value.trim();
  suppliers.push({id: uid(), name, contact, phone});
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  resetSupplierForm(); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemSupplierChecks();
}
function openSupplierEdit(id){
  const s = suppliers.find(x=>x.id===id); if(!s) return;
  $('editSupId').value = s.id; $('editSupName').value = s.name; $('editSupContact').value = s.contact||''; $('editSupPhone').value = s.phone||'';
  $('supplierEditModal').style.display = 'block';
}
function updateSupplier(){
  const id = $('editSupId').value; const s = suppliers.find(x=>x.id===id); if(!s) return;
  const name = $('editSupName').value.trim(); if(!name) return alert('ç¤¾åã¯å¿…é ˆã§ã™');
  s.name = name; s.contact = $('editSupContact').value.trim(); s.phone = $('editSupPhone').value.trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
}
function deleteSupplier(){
  const id = $('editSupId').value;
  if(!confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ç´ä»˜ãå•†å“ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  items = items.map(it=> ({...it, suppliers: (it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

/* ====== å•†å“ï¼šæ–°è¦/ç·¨é›†ï¼ˆé‡è¤‡åãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼‰ ====== */
function openItemModal(){ resetItemForm(); renderItemSupplierChecks(); $('itemModal').style.display = 'block'; }
function resetItemForm(){ $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded'; }
function renderItemSupplierChecks(target='itSuppliers'){
  const box = $(target);
  if(suppliers.length===0){ box.innerHTML = '<div class="muted">ä»•å…¥å…ˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä»•å…¥å…ˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>'; return; }
  box.innerHTML = suppliers.map(s=>`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" value="${s.id}"> ${s.name}</label>`).join('');
}
function addItem(){
  const raw = $('itName').value; const name = normName(raw);
  if(!name) return alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  // åŒåé‡è¤‡ãƒã‚§ãƒƒã‚¯
  const exists = items.some(it => normName(it.name) === name);
  if (exists && !confirm('åŒåã®å•†å“ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

  const priceStr = $('itPrice').value.trim(); const price = priceStr==='' ? null : Number(priceStr);
  const taxType = $('itTax').value;
  const checks = Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ã‚‹ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
  items.push({id: uid(), name, price, taxType, suppliers: supIds});
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  resetItemForm(); renderItemSupplierChecks(); renderItemSelect($('inSupplier').value); renderItemTable();
}
function openItemEdit(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  $('editItemId').value = it.id; $('editItName').value = it.name; $('editItPrice').value = it.price!=null? it.price : ''; $('editItTax').value = it.taxType || 'taxExcluded';
  renderItemSupplierChecks('editItSuppliers');
  const box = $('editItSuppliers'); (it.suppliers||[]).forEach(sid=>{ const chk = box.querySelector(`input[value="${sid}"]`); if(chk) chk.checked = true; });
  $('itemEditModal').style.display = 'block';
}
function updateItem(){
  const id = $('editItemId').value; const it = items.find(x=>x.id===id); if(!it) return;
  const raw = $('editItName').value; const name = normName(raw);
  if(!name) return alert('å•†å“åã¯å¿…é ˆã§ã™');

  // è‡ªåˆ†ä»¥å¤–ã¨åŒåã‹ï¼Ÿ
  const exists = items.some(x=> x.id!==id && normName(x.name)===name);
  if (exists && !confirm('åŒåã®å•†å“ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

  const priceStr = $('editItPrice').value.trim(); it.price = priceStr==='' ? null : Number(priceStr);
  it.name = name; it.taxType = $('editItTax').value;
  const checks = Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); it.suppliers = supIds;
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}
function deleteItem(){
  const id = $('editItemId').value;
  const it = items.find(x=>x.id===id); if(!it) return;
  const used = purchases.some(p => p.itemId === id);
  if(used){ alert('ã“ã®å•†å“ã¯ä»•å…¥ã‚Œå±¥æ­´ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«è©²å½“ã®ä»•å…¥ã‚Œã‚’å‰Šé™¤/ç·¨é›†ã—ã¦ãã ã•ã„ã€‚'); return; }
  if(!confirm(`å•†å“ã€Œ${it.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  items = items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}
function deleteItemDirect(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const used = purchases.some(p => p.itemId === id);
  if(used){ alert('ã“ã®å•†å“ã¯ä»•å…¥ã‚Œå±¥æ­´ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«è©²å½“ã®ä»•å…¥ã‚Œã‚’å‰Šé™¤/ç·¨é›†ã—ã¦ãã ã•ã„ã€‚'); return; }
  if(!confirm(`å•†å“ã€Œ${it.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  items = items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  renderItemSelect($('inSupplier').value); renderItemTable();
}

/* ====== ä¾¡æ ¼å±¥æ­´ ====== */
function openPriceHistory(){
  const supplierId = $('inSupplier').value || '';
  const itemId = $('inItem').value || '';
  if(!supplierId && !itemId){ alert('ä»•å…¥å…ˆã‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const rows = purchases.filter(p => (!supplierId || p.supplierId===supplierId) && (!itemId || p.itemId===itemId)).slice(-200).reverse().slice(0,20);
  const tb = $('historyTbody'); tb.innerHTML = '';
  rows.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.date}</td><td>${s?s.name:''}</td><td>${i?i.name:''}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td>`;
    tb.appendChild(tr);
  });
  if(rows.length===0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" class="muted">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td>`; tb.appendChild(tr); }
  $('historyModal').style.display='block';
}

/* ====== ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆé‡è¤‡ç¢ºèªä¸€è¦§ä»˜ãï¼‰ ====== */
let bmRowCounter = 0;
function bmRowTemplate(idx){
  return `
    <div class="bulk-row">
      <input type="text"  class="bm-name"  placeholder="å•†å“å">
      <input type="number" class="bm-price" placeholder="ä¾¡æ ¼">
      <select class="bm-tax" aria-label="ç¨åŒºåˆ†">
        <option value="taxExcluded" selected>ç¨åˆ¥</option>
        <option value="taxIncluded">ç¨è¾¼</option>
      </select>
      <div class="bm-rate choice-vertical">
        <label><input type="radio" name="bmRate${idx}" value="0.08" checked><span>8%</span></label>
        <label><input type="radio" name="bmRate${idx}" value="0.10"><span>10%</span></label>
      </div>
      <button type="button" class="danger" onclick="this.closest('.bulk-row').remove()">å‰Šé™¤</button>
    </div>
  `;
}
function openBulkMaster(){
  bmClearRows(); bmAddRow();
  $('bmSupName').value=''; $('bmSupContact').value=''; $('bmSupPhone').value='';
  $('bmDupArea').style.display='none'; $('bmDupArea').innerHTML='';
  $('bulkMasterModal').style.display='block';
}
function bmAddRow(){
  const wrap = $('bmProducts');
  const idx = ++bmRowCounter;
  const div = document.createElement('div');
  div.innerHTML = bmRowTemplate(idx);
  wrap.appendChild(div.firstElementChild);
}
function bmClearRows(){ $('bmProducts').innerHTML=''; }
/* æ­£è¦åŒ–ï¼ˆé‡è¤‡åˆ¤å®šç”¨ï¼šç©ºç™½é™¤å»ï¼‹å°æ–‡å­—ï¼‰ */
function normName(s){ return (s || '').replace(/\s+/g, '').toLowerCase(); }

/* ====== ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆé‡è¤‡ç¢ºèªä»˜ããƒ»ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‰ ====== */
const normName = (s)=> (s||'').trim().replace(/\s+/g,' ').toLowerCase();

let bmRowCounter = 0;
function bmRowTemplate(idx){
  return `
    <div class="bulk-row">
      <input type="text"  class="bm-name"  placeholder="å•†å“å">
      <input type="number" class="bm-price" placeholder="ä¾¡æ ¼">
      <select class="bm-tax" aria-label="ç¨åŒºåˆ†">
        <option value="taxExcluded" selected>ç¨åˆ¥</option>
        <option value="taxIncluded">ç¨è¾¼</option>
      </select>
      <div class="bm-rate choice-vertical">
        <label><input type="radio" name="bmRate${idx}" value="0.08" checked><span>8%</span></label>
        <label><input type="radio" name="bmRate${idx}" value="0.10"><span>10%</span></label>
      </div>
      <button type="button" class="danger" onclick="this.closest('.bulk-row').remove()">å‰Šé™¤</button>
    </div>
  `;
}

function openBulkMaster(){
  bmClearRows(); bmAddRow();
  $('bmSupName').value=''; $('bmSupContact').value=''; $('bmSupPhone').value='';
  const area = $('bmDupArea'); if (area){ area.style.display='none'; area.innerHTML=''; }
  $('bulkMasterModal').style.display='block';
}

function bmAddRow(){
  const wrap = $('bmProducts');
  const idx = ++bmRowCounter;
  const div = document.createElement('div');
  div.innerHTML = bmRowTemplate(idx);
  wrap.appendChild(div.firstElementChild);
}

function bmClearRows(){ $('bmProducts').innerHTML=''; }

function bmSubmit(){
  const supName = $('bmSupName').value.trim();
  if(!supName) return alert('ä»•å…¥å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  const rows = Array.from(document.querySelectorAll('#bmProducts .bulk-row'));
  if (rows.length===0) return alert('å•†å“è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„');

  // 1) é‡è¤‡å€™è£œã®æŠ½å‡ºï¼ˆå•†å“åï¼šç©ºè¡Œã¯é™¤å¤–ã€å…¨è§’/åŠè§’ãƒ»å¤§æ–‡å­—å°æ–‡å­—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã®æºã‚Œã‚’æ­£è¦åŒ–ï¼‰
  const entryNames = rows
    .map(r => normName(r.querySelector('.bm-name').value))
    .filter(n => !!n);

  const duplicateList = entryNames.filter(n =>
    items.some(it => normName(it.name) === n)
  );

  // 2) é‡è¤‡å€™è£œã®æç¤ºï¼ˆã¾ã¨ã‚ã¦è¡¨ç¤ºï¼‰
  if (duplicateList.length > 0){
    const unique = Array.from(new Set(duplicateList));
    const area = $('bmDupArea');
    if (area){
      area.style.display = 'block';
      area.innerHTML =
        'æ—¢å­˜ã¨åŒåã®å•†å“ãŒã‚ã‚Šã¾ã™ï¼š<br>ãƒ»' +
        unique.join('<br>ãƒ»') +
        '<br>ç¶šè¡Œã™ã‚‹ã¨æ–°è¦ã¨ã—ã¦è¿½åŠ ã•ã‚Œã¾ã™ã€‚';
    }
    if (!confirm('é‡è¤‡å€™è£œãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  // 3) ä»•å…¥å…ˆã®ä½œæˆãƒ»ä¿å­˜
  const sup = {
    id: uid(),
    name: supName,
    contact: $('bmSupContact').value.trim(),
    phone: $('bmSupPhone').value.trim()
  };
  suppliers.push(sup);

  // 4) å•†å“ã‚’ã“ã®ä»•å…¥å…ˆã«ç´ä»˜ã‘ã¦ä¸€æ‹¬ä½œæˆ
  rows.forEach(row=>{
    const rawName = row.querySelector('.bm-name').value;
    const name = rawName.trim();
    if (!name) return; // ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ—

    const priceStr = (row.querySelector('.bm-price').value || '').trim();
    const price = priceStr==='' ? null : Number(priceStr);

    const taxType = row.querySelector('.bm-tax').value;
    const rateSel = row.querySelector('input[type="radio"]:checked');
    const taxRate = rateSel ? Number(rateSel.value) : 0.08;

    items.push({ id: uid(), name, price, taxType, taxRate, suppliers: [sup.id] });
  });

  // 5) ä¿å­˜ãƒ»UIæ›´æ–°
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  closeModal('bulkMasterModal');
  renderSupplierSelect(); renderItemSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
  alert('ä¸€æ‹¬ç™»éŒ²ã—ã¾ã—ãŸ');
}

/* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ====== */
function closeModal(id){ const m = $(id); if(m) m.style.display='none'; }
window.addEventListener('click', (e)=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('purchaseEditModal')) closeModal('purchaseEditModal');
  if(e.target===$('historyModal')) closeModal('historyModal');
  if(e.target===$('bulkMasterModal')) closeModal('bulkMasterModal');
  if(e.target===$('restoreChooser')) closeModal('restoreChooser');
});

/* ====== åˆæœŸåŒ–ç³» ====== */
function wipeAll(){
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ãƒ»ä»•å…¥å±¥æ­´ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  suppliers=[]; items=[]; purchases=[];
  localStorage.removeItem(LS_KEYS.suppliers); localStorage.removeItem(LS_KEYS.items); localStorage.removeItem(LS_KEYS.purchases);
  renderSupplierSelect(); renderItemSelect(); renderList(); renderPhonebook(); renderSupTable(); renderItemTable();
  renderSupplierMonthly();
}
function openRestoreChooser(){
  const hint = $('lastBackupHint');
  const has = !!localStorage.getItem(LS_LAST_BACKUP);
  hint.textContent = has ? 'ç«¯æœ«å†…ã«ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å¾©å…ƒã§ãã¾ã™ã€‚' : 'ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§å¾©å…ƒã—ã¦ãã ã•ã„ã€‚';
  $('restoreChooser').style.display = 'block';
}

/* ====== PWAæ›´æ–° ====== */
async function forceUpdateSW(){
  if (!('serviceWorker' in navigator)) { alert('ã“ã®ç’°å¢ƒã¯æœªå¯¾å¿œã§ã™'); return; }
  try{
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg) { alert('Service Workeræœªç™»éŒ²ã§ã™'); return; }
    await reg.update();
    if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if (!window.__reloading) { window.__reloading = true; location.reload(); } });
    alert('æ›´æ–°å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚æ•°ç§’ã§ç”»é¢ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚');
  }catch(e){ alert('æ›´æ–°ã«å¤±æ•—: ' + e.message); }
}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function quickAddForSupplier(supplierId, date){
  if (date) $('inDate').value = date;
  $('inSupplier').value = supplierId;
  renderItemSelect(supplierId);
  $('inItem').focus();
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>
