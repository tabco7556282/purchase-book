<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª v21R</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
/* === Mobile-first design tokens === */
:root{
  --h:44px; --radius:12px; --gap:10px; --font:16px;
  --bg:#ffffff; --muted:#6b7280; --line:#e5e7eb;
  --pri:#16a34a; --pri2:#12833c; --link:#2563eb; --link2:#1f4ec0; --danger:#ef4444; --danger2:#dc2626;
}
*{ box-sizing:border-box }
html,body{ -webkit-text-size-adjust:100%; background:#f8fafc; color:#111; margin:8px; padding-bottom:88px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; }
button,input,select{ font-size:var(--font); height:var(--h); line-height:1.2; border-radius:var(--radius) }
input,select{ padding:0 12px; border:1px solid var(--line); background:#fff }
input:focus,select:focus,button:focus{ outline:2px solid #a7f3d0; outline-offset:2px }
button{ background:var(--pri); color:#fff; border:0; padding:0 14px; cursor:pointer }
button:hover{ background:var(--pri2) }
button.ghost{ background:#f3f4f6; color:#111 }
button.ghost:hover{ background:#e5e7eb }
button.link{ background:#2563eb }
button.link:hover{ background:#1f4ec0 }
button.danger{ background:#ef4444 }
button.danger:hover{ background:#dc2626 }
.small{ color:var(--muted); font-size:12px }
.nav{ display:flex; gap:8px; margin-bottom:10px; align-items:center }
.nav .spacer{ flex:1 }
.row{ display:flex; gap:var(--gap); flex-wrap:wrap }
.row > *{ flex:1 1 200px; min-width:160px }
.card{ background:var(--bg); border:1px solid var(--line); border-radius:var(--radius); padding:12px }
th,td{ padding:10px; border:1px solid var(--line) }
.table-wrap{ overflow:auto; border-radius:var(--radius); border:1px solid var(--line); background:#fff }
.fab-bar{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--line); padding:12px env(safe-area-inset-right) calc(12px + env(safe-area-inset-bottom)) env(safe-area-inset-left); box-shadow:0 -6px 20px rgba(0,0,0,.06) }
.fab-inner{ display:flex; gap:8px; max-width:720px; margin:0 auto }
.hidden{ display:none !important }
.nowrap{ white-space:nowrap }
.right{ text-align:right }
.badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#111; background:#eef2ff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px }
.cards{ display:flex; flex-direction:column; gap:10px }
.card-top{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
.card-meta{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap }
</style>
</head>
<body>

<div class="nav">
  <button class="ghost" onclick="showPage('entry')">ä»•å…¥ã‚Œå…¥åŠ›</button>
  <button class="ghost" onclick="showPage('masters')">ãƒã‚¹ã‚¿</button>
  <button class="ghost" onclick="showPage('phonebook')">é›»è©±å¸³</button>
  <span class="spacer"></span>
  <span class="small">ver <b id="appVersion">v21R</b></span>
  <button class="link" onclick="forceUpdateSW()">ğŸ”„ æ›´æ–°</button>
</div>

<!-- ===== ä»•å…¥ã‚Œå…¥åŠ› ===== -->
<section id="page-entry">
  <h2>ä»•å…¥ã‚Œå…¥åŠ›</h2>

  <div class="row">
    <div>
      <label>æ—¥ä»˜</label>
      <input type="date" id="inDate">
    </div>
    <div>
      <label>ä»•å…¥å…ˆ</label>
      <select id="inSupplier"></select>
    </div>
  </div>

  <div class="badge" id="supplierBadge" style="margin:8px 0; display:none"></div>

  <!-- ãƒ©ã‚¤ãƒ³å…¥åŠ›ï¼ˆã‚¹ãƒãƒ›åã¾ã‚Šï¼‰ -->
  <div class="card" style="display:grid; grid-template-columns: 1.2fr 1fr .8fr 1fr auto; gap:10px; align-items:center;">
    <input id="liSearch" placeholder="å•†å“æ¤œç´¢">
    <select id="liItem"></select>
    <input id="liQty" type="number" min="0" step="0.1" placeholder="æ•°é‡">
    <input id="liUnitEx" type="number" min="0" step="1" placeholder="å˜ä¾¡(ç¨åˆ¥)">
    <div class="row" style="gap:6px; flex:0 0 auto; min-width:140px">
      <button type="button" class="ghost" id="rate8">8%</button>
      <button type="button" class="ghost" id="rate10">10%</button>
    </div>
    <label class="small" style="grid-column: 1 / -2; display:flex; align-items:center; gap:8px;">
      <input type="checkbox" id="autoFillPrice" checked style="width:auto;"> å˜ä¾¡ã‚’è‡ªå‹•å…¥åŠ›ï¼ˆåŸºæº–ä¾¡æ ¼ãŒã‚ã‚Œã°ï¼‰
    </label>
    <input type="hidden" id="liRate" value="0.08"><!-- æ—¢å®š8% -->
    <button id="addLineBtn">ï¼‹ è¿½åŠ </button>
  </div>

  <!-- åŒæ—¥ãƒ»åŒä»•å…¥å…ˆã§â€œä¼ç¥¨ã‚«ãƒ¼ãƒ‰â€ã«è‡ªå‹•é›†ç´„ã—ã¦è¡¨ç¤º -->
  <div class="cards" id="invoiceCards" style="margin-top:8px"></div>

  <div class="row" style="margin-top:10px;">
    <button class="link" onclick="backupJSON()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button class="ghost" onclick="openRestoreChooser()">å¾©å…ƒ</button>
    <button class="danger" onclick="wipeAll()">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
  </div>
</section>

<!-- ===== ãƒã‚¹ã‚¿ ===== -->
<section id="page-masters" class="hidden">
  <h2>ãƒã‚¹ã‚¿</h2>

  <div class="card">
    <h3>ä»•å…¥å…ˆ è¿½åŠ </h3>
    <div class="row">
      <input id="supName" placeholder="ç¤¾å">
      <input id="supContact" placeholder="æ‹…å½“è€…(ä»»æ„)">
      <input id="supPhone" placeholder="é›»è©±(ãƒã‚¤ãƒ•ãƒ³å¯)" type="tel">
      <input id="supInv" placeholder="ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå· (ä¾‹ï¼šT1234567890123)">
      <button onclick="addSupplier()">ï¼‹ è¿½åŠ </button>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:10px;">
    <table id="supTable" style="width:100%">
      <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th>ç™»éŒ²ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>å•†å“ è¿½åŠ </h3>
    <div class="row">
      <input id="itName" placeholder="å•†å“å">
      <input id="itPrice" type="number" step="1" min="0" placeholder="åŸºæº–ä¾¡æ ¼(ä»»æ„)">
      <select id="itTax">
        <option value="taxExcluded" selected>ç¨åˆ¥</option>
        <option value="taxIncluded">ç¨è¾¼</option>
      </select>
      <select id="itRate">
        <option value="0.08" selected>ç¨ç‡ 8%</option>
        <option value="0.10">ç¨ç‡ 10%</option>
      </select>
      <select id="itSuppliers" multiple size="4" style="height:auto; min-height:120px"></select>
      <button onclick="addItem()">ï¼‹ è¿½åŠ </button>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:10px;">
    <table id="itemTable" style="width:100%">
      <thead><tr><th>å•†å“å</th><th>åŸºæº–ä¾¡æ ¼</th><th>ç¨ç‡/åŒºåˆ†</th><th>ç´ä»˜ã‘ä»•å…¥å…ˆ</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- ===== é›»è©±å¸³ ===== -->
<section id="page-phonebook" class="hidden">
  <h2>ä»•å…¥å…ˆé›»è©±å¸³</h2>
  <div class="table-wrap" style="max-height:60vh">
    <table id="phoneTable" style="width:100%">
      <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- FAB -->
<div class="fab-bar">
  <div class="fab-inner">
    <button onclick="savePurchase()">ä¿å­˜</button>
    <button class="ghost" onclick="clearEntry()">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<!-- å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç°¡æ˜“ï¼‰ -->
<div id="restoreChooser" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; display:flex; align-items:center; justify-content:center;">
  <div class="card" style="width:min(92%,560px); max-height:90vh; overflow:auto;">
    <h3>å¾©å…ƒ</h3>
    <p class="small" id="lastBackupHint"></p>
    <div class="row" style="margin-top:8px;">
      <button onclick="quickRestore(); closeRestore()">ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
      <button class="ghost" onclick="restoreFromFile(); closeRestore()">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
    </div>
    <div class="small" style="margin-top:6px;">
      ã†ã¾ãé–‹ã‘ãªã„æ™‚ã¯ <a href="javascript:void(0)" onclick="forceFileRestore(); closeRestore()">ã“ã¡ã‚‰</a>
    </div>
  </div>
</div>
<input id="restoreInput" type="file" accept="application/json" class="hidden" onchange="if(this.files[0]) restoreJSON(this.files[0])">

<script>
/* ===== ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º ===== */
const APP_VERSION = 'v21R';
document.addEventListener('DOMContentLoaded', ()=>{ const el=document.getElementById('appVersion'); if(el) el.textContent=APP_VERSION; });

/* ===== æ°¸ç¶šåŒ–ã‚­ãƒ¼ ===== */
const LS_KEYS = { suppliers:'suppliers_v3', items:'items_v3', purchases:'purchases_v3', taxRate:'base_tax_rate_v2' };
const LS_LAST_BACKUP = 'last_backup_json_v2';

/* ===== çŠ¶æ…‹ ===== */
let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

/* ===== ç¨ç‡ï¼ˆæ—¢å®šï¼š8%ï¼‰ ===== */
function getBaseTaxRate(){ const v = localStorage.getItem(LS_KEYS.taxRate); return v==null ? 0.08 : Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate, String(decimal)); updateTaxRateLabel(); }
function updateTaxRateLabel(){ /* ãƒ©ãƒ™ãƒ«ç”¨é€”ãŒã‚ã‚Œã°ä½¿ç”¨ */ }

/* ===== åˆæœŸåŒ– ===== */
const $ = (id)=> document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);
const todayStr = ()=>{ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; };
const yen = (n)=> Number(n||0).toLocaleString('ja-JP');

function init(){
  $('inDate').value = todayStr();
  renderSupplierSelect();
  renderItemSelect();
  bindLineInputs();
  renderInvoiceCards();
  // SWç™»éŒ²ï¼ˆæ–°ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw-v21r.js?v=21R').catch(()=>{});
    });
  }
}
document.addEventListener('DOMContentLoaded', init);

/* ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ===== */
function showPage(which){
  ['entry','masters','phonebook'].forEach(id=>{
    const el = document.getElementById('page-'+id);
    if(el) el.classList.toggle('hidden', id!==which);
  });
  if(which==='masters'){ renderSupTable(); renderItemTable(); renderItemSupplierChecks(); }
  if(which==='phonebook') renderPhonebook();
}

/* ===== ä»•å…¥å…ˆ ===== */
function renderSupplierSelect(){
  const sel=$('inSupplier');
  sel.innerHTML = '<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>' + suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange = ()=>{ updateSupplierBadge(); renderItemSelect(sel.value); };
}
function updateSupplierBadge(){
  const sid=$('inSupplier').value; const s=suppliers.find(x=>x.id===sid); const badge=$('supplierBadge');
  if(s){ badge.style.display='inline-flex'; badge.innerHTML=`ä»•å…¥å…ˆï¼š<b>${s.name}</b> / ç™»éŒ²ç•ªå·ï¼š<b>${s.invoiceRegId||'-'}</b> / TELï¼š<b>${s.phone||'-'}</b>`; }
  else{ badge.style.display='none'; badge.textContent=''; }
}
function addSupplier(){
  const name=$('supName').value.trim(); if(!name) return alert('ç¤¾åã¯å¿…é ˆ');
  suppliers.push({ id:uid(), name, contact:$('supContact').value.trim(), phone:$('supPhone').value.trim(), invoiceRegId:$('supInv').value.trim() });
  $('supName').value=''; $('supContact').value=''; $('supPhone').value=''; $('supInv').value='';
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  renderSupplierSelect(); renderSupTable(); renderPhonebook(); renderItemSupplierChecks();
}
function renderSupTable(){
  const tb=$('supTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td><td class="nowrap">${s.invoiceRegId||''}</td>
      <td>
        <button type="button" class="ghost" data-act="edit-sup" data-id="${s.id}">ç·¨é›†</button>
        <button type="button" class="danger" data-act="del-sup" data-id="${s.id}">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function editSupplier(id){
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  const name=prompt('ç¤¾å', s.name); if(name===null) return;
  const contact=prompt('æ‹…å½“è€…(ç©ºå¯)', s.contact||''); if(contact===null) return;
  const phone=prompt('é›»è©±(ç©ºå¯)', s.phone||''); if(phone===null) return;
  const inv=prompt('ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå·(ç©ºå¯)', s.invoiceRegId||''); if(inv===null) return;
  s.name=name.trim(); s.contact=contact.trim(); s.phone=phone.trim(); s.invoiceRegId=inv.trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  renderSupTable(); renderSupplierSelect(); renderPhonebook(); renderInvoiceCards();
}
function deleteSupplierById(id){
  if(!confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  suppliers = suppliers.filter(x=>x.id!==id);
  items = items.map(it=> ({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  renderSupTable(); renderSupplierSelect(); renderItemSupplierChecks(); renderItemTable(); renderPhonebook(); renderInvoiceCards();
}

/* ===== å•†å“ ===== */
function renderItemSupplierChecks(){
  const box=$('itSuppliers'); if(!box) return;
  box.innerHTML = suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function addItem(){
  const name=$('itName').value.trim(); if(!name) return alert('å•†å“åã¯å¿…é ˆ');
  const priceStr=$('itPrice').value.trim(); const taxType=$('itTax').value; const defRate=Number($('itRate').value||0.08);
  const supIds=Array.from(($('itSuppliers').selectedOptions||[])).map(o=>o.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ã‚‹ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
  items.push({ id:uid(), name, price: priceStr===''? null:Number(priceStr), taxType, defRate, suppliers:supIds });
  $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded'; $('itRate').value='0.08';
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  renderItemTable(); renderItemSelect($('inSupplier').value);
}
function renderItemTable(){
  const tb=$('itemTable').querySelector('tbody'); tb.innerHTML='';
  items.forEach(it=>{
    if(it.defRate==null) it.defRate=0.08; // æ—§ãƒ‡ãƒ¼ã‚¿æ•‘æ¸ˆï¼ˆæ—¢å®š8%ï¼‰
    const names=(it.suppliers||[]).map(id=> suppliers.find(s=>s.id===id)?.name||'').filter(Boolean).join(' / ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.name}</td><td>${it.price!=null? yen(it.price):''}</td><td>${(it.defRate*100).toFixed(0)}% / ${(it.taxType==='taxExcluded')?'ç¨åˆ¥':'ç¨è¾¼'}</td><td>${names}</td>
      <td>
        <button type="button" class="ghost" data-act="edit-item" data-id="${it.id}">ç·¨é›†</button>
        <button type="button" class="danger" data-act="del-item" data-id="${it.id}">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function editItem(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  const name=prompt('å•†å“å', it.name); if(name===null) return;
  const priceStr=prompt('åŸºæº–ä¾¡æ ¼(ç©ºå¯)', it.price!=null? it.price:''); if(priceStr===null) return;
  const rateStr=prompt('ç¨ç‡: 0.08 ã¾ãŸã¯ 0.10', (it.defRate??0.08).toFixed(2)); if(rateStr===null) return;
  const taxType=prompt('ç¨åŒºåˆ†: taxExcluded/taxIncluded', it.taxType||'taxExcluded'); if(taxType===null) return;
  const r=Number(rateStr); if(!(r===0.08 || r===0.10)) return alert('0.08 ã‹ 0.10 ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  it.name=name.trim(); it.price=priceStr===''? null:Number(priceStr); it.defRate=r; it.taxType=(taxType==='taxIncluded')?'taxIncluded':'taxExcluded';
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  renderItemTable(); renderItemSelect($('inSupplier').value);
}
function deleteItemDirect(id){
  const used=purchases.some(p=>p.itemId===id);
  if(used){ alert('ã“ã®å•†å“ã¯ä»•å…¥ã‚Œå±¥æ­´ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«è©²å½“ã®ä»•å…¥ã‚Œã‚’å‰Šé™¤/ç·¨é›†ã—ã¦ãã ã•ã„ã€‚'); return; }
  const it=items.find(x=>x.id===id); if(!it) return; if(!confirm(`å•†å“ã€Œ${it.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  items = items.filter(x=>x.id!==id); localStorage.setItem(LS_KEYS.items, JSON.stringify(items)); renderItemTable(); renderItemSelect($('inSupplier').value);
}

// å§”è­²ï¼ˆãƒã‚¹ã‚¿ã®ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ãŒç¢ºå®Ÿã«åŠ¹ãï¼‰
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-act][data-id]'); if(!btn) return;
  const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
  if(act==='edit-sup') editSupplier(id);
  if(act==='del-sup')  deleteSupplierById(id);
  if(act==='edit-item') editItem(id);
  if(act==='del-item')  deleteItemDirect(id);
});

/* ===== å…¥åŠ›ï¼ˆãƒ©ã‚¤ãƒ³ï¼‰ ===== */
function renderItemSelect(supplierId=''){
  const sel=$('liItem'); let list=items;
  if(supplierId){ list = items.filter(it => (it.suppliers||[]).includes(supplierId)); }
  const q=($('liSearch').value||'').trim().toLowerCase(); if(q) list=list.filter(it=> (it.name||'').toLowerCase().includes(q));
  sel.innerHTML = '<option value="">-- å•†å“ãƒã‚¹ã‚¿ --</option>' + list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange = onItemPicked;
  $('liSearch').oninput = ()=> renderItemSelect($('inSupplier').value);
}
function bindLineInputs(){
  $('rate8').onclick = ()=> $('liRate').value=(0.08).toFixed(2);
  $('rate10').onclick = ()=> $('liRate').value=(0.10).toFixed(2);
  $('addLineBtn').onclick = addLine;
  ['liQty','liUnitEx'].forEach(id=> $(id).addEventListener('keydown', e=>{ if(e.key==='Enter') $('addLineBtn').click(); }));
}
function onItemPicked(){
  const it=items.find(x=>x.id===$('liItem').value); if(!it) return;
  const rate = (it.defRate!=null)? it.defRate : getBaseTaxRate();
  $('liRate').value = rate.toFixed(2);
  if($('autoFillPrice').checked && it.price!=null){
    const unitEx = (it.taxType==='taxExcluded') ? Number(it.price) : Math.floor(Number(it.price)/(1+rate));
    $('liUnitEx').value = unitEx;
  } else { $('liUnitEx').value=''; }
}

function addLine(){
  const date=$('inDate').value; const supplierId=$('inSupplier').value; if(!date) return alert('æ—¥ä»˜ã‚’å…¥åŠ›'); if(!supplierId) return alert('ä»•å…¥å…ˆã‚’é¸æŠ');
  const itemId=$('liItem').value; const it=items.find(x=>x.id===itemId); const name= it? it.name : (($('liSearch').value||'').trim());
  const qty=Number($('liQty').value||0); const unitEx=Number($('liUnitEx').value||0); const rate=Number($('liRate').value||getBaseTaxRate());
  if(!name) return alert('å•†å“ã‚’é¸æŠ/å…¥åŠ›ã—ã¦ãã ã•ã„'); if(!(qty>0)) return alert('æ•°é‡ã‚’å…¥åŠ›'); if(!(unitEx>=0)) return alert('å˜ä¾¡ã‚’å…¥åŠ›');
  const taxType = 'taxExcluded'; // ãƒ©ã‚¤ãƒ³å˜ä¾¡ã¯å¸¸ã«ç¨åˆ¥å…¥åŠ›
  const total = Math.round(qty*unitEx*(1+rate));
  purchases.push({date, supplierId, itemId, name, qty, price:unitEx, taxType, rate, total});
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  $('liQty').value=''; $('liUnitEx').value=''; $('liSearch').value=''; $('liItem').value='';
  renderInvoiceCards();
}

/* ===== è¡¨ç¤ºï¼šåŒæ—¥Ã—åŒä»•å…¥å…ˆã§ä¼ç¥¨ã‚«ãƒ¼ãƒ‰åŒ– ===== */
function renderInvoiceCards(){
  const box=$('invoiceCards'); box.innerHTML=''; if(purchases.length===0){ box.innerHTML='<div class="small">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  // group key = date|supplierId
  const map=new Map();
  purchases.forEach(p=>{
    const key=(p.date||'')+'|'+(p.supplierId||''); const arr=map.get(key)||[]; arr.push(p); map.set(key, arr);
  });
  // æœ€æ–°é †
  const keys=[...map.keys()].sort((a,b)=>{ const [da]=a.split('|'), [db]=b.split('|'); return db.localeCompare(da); });
  keys.forEach(key=>{
    const arr=map.get(key)||[]; const [date, sid]=key.split('|'); const s=suppliers.find(x=>x.id===sid);
    let exByRate=new Map(); let grand=0;
    const body=arr.map(p=>{ const ex=Math.round(p.qty*p.price); exByRate.set(p.rate,(exByRate.get(p.rate)||0)+ex); grand+=Math.round(p.qty*p.price*(1+p.rate));
      return `<tr><td>${p.name}</td><td class=right>${p.qty}</td><td class=right>${yen(p.price)}</td><td class=right>${(p.rate*100).toFixed(0)}%</td><td class=right>${yen(ex)}</td></tr>`; }).join('');
    let exTotal=0, taxTotal=0; let parts=[]; for(const [r, ex] of exByRate){ const t=Math.floor(ex*r); exTotal+=ex; taxTotal+=t; parts.push(`${(r*100).toFixed(0)}%ï¼š${yen(ex)} â†’ ç¨ ${yen(t)}`); }
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-top">
        <div>${date}</div>
        <div class="badge">${s?s.name:'(ä¸æ˜)'} / ç™»éŒ²ç•ªå·: <b>${s?.invoiceRegId||'-'}</b></div>
      </div>
      <div class="table-wrap" style="margin:8px 0; max-height:30vh">
        <table style="width:100%"><thead><tr><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡(ç¨åˆ¥)</th><th>ç¨ç‡</th><th>å°è¨ˆ(ç¨æŠœ)</th></tr></thead><tbody>${body}</tbody></table>
      </div>
      <div class="card-meta">
        <div class="small">ç¨æŠœå°è¨ˆ: <b>${yen(exTotal)}</b> / ç¨é¡: <b>${yen(taxTotal)}</b></div>
        <div style="font-weight:700">åˆè¨ˆ: ${yen(exTotal+taxTotal)} å††</div>
      </div>`;
    box.appendChild(card);
  });
}

/* ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼å¾©å…ƒ ===== */
async function backupJSON(){
  const fileName = `shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const data = { version: 'v21R', savedAt: new Date().toISOString(), suppliers, items, purchases, taxRate: localStorage.getItem(LS_KEYS.taxRate) ?? 0.08 };
  const json = JSON.stringify(data, null, 2); const blob = new Blob([json], {type:'application/json'}); const file = new File([blob], fileName, {type:'application/json'});
  try { localStorage.setItem(LS_LAST_BACKUP, json); } catch(_) {}
  if (navigator.canShare && navigator.canShare({ files: [file] })){
    try{ await navigator.share({ title:'ä»•å…¥ã‚Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', text:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã§ã™ã€‚', files:[file] }); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return; }catch(e){ if(e.name==='AbortError') return; }
  }
  if ('showSaveFilePicker' in window){
    try{ const handle=await window.showSaveFilePicker({ suggestedName:fileName, types:[{ description:'JSON', accept:{ 'application/json':['.json'] } }] }); const w=await handle.createWritable(); await w.write(blob); await w.close(); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return; }catch(e){ if(e.name==='AbortError') return; }
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href); alert('JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
}
function openRestoreChooser(){ const hint=$('lastBackupHint'); const has=!!localStorage.getItem(LS_LAST_BACKUP); hint.textContent = has? 'ç«¯æœ«å†…ã«ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å¾©å…ƒã§ãã¾ã™ã€‚' : 'ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§å¾©å…ƒã—ã¦ãã ã•ã„ã€‚'; document.getElementById('restoreChooser').classList.remove('hidden'); }
function closeRestore(){ document.getElementById('restoreChooser').classList.add('hidden'); }
function quickRestore(){ try{ const json=localStorage.getItem(LS_LAST_BACKUP); if(!json){ alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“'); return; } _applyRestore(JSON.parse(json)); alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ'); }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); } }
function restoreFromFile(){ if('showOpenFilePicker' in window){ (async()=>{ try{ const [h]=await window.showOpenFilePicker({ types:[{ description:'JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', accept:{ 'application/json':['.json'] } }] }); const f=await h.getFile(); const t=await f.text(); _applyRestore(JSON.parse(t)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(e){ if(e.name!=='AbortError') alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); } })(); } else { $('restoreInput').click(); } }
function restoreJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); } }; r.readAsText(file); }
function forceFileRestore(){ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.style.display='none'; input.onchange=()=>{ if(input.files && input.files[0]){ const r=new FileReader(); r.onload=()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); } }; r.readAsText(input.files[0]); } }; document.body.appendChild(input); input.click(); setTimeout(()=>document.body.removeChild(input), 0); }
function _applyRestore(data){ if(!data || !data.suppliers || !data.items || !data.purchases) throw new Error('å½¢å¼ä¸æ­£'); suppliers=data.suppliers; items=data.items; purchases=data.purchases; const tr = (data.taxRate!=null)? Number(data.taxRate): 0.08; localStorage.setItem(LS_KEYS.taxRate, String(tr)); localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers)); localStorage.setItem(LS_KEYS.items, JSON.stringify(items)); localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases)); renderSupplierSelect(); renderItemSelect(); renderSupTable(); renderItemTable(); renderPhonebook(); renderInvoiceCards(); }
function wipeAll(){ if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ãƒ»ä»•å…¥å±¥æ­´ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; suppliers=[]; items=[]; purchases=[]; localStorage.removeItem(LS_KEYS.suppliers); localStorage.removeItem(LS_KEYS.items); localStorage.removeItem(LS_KEYS.purchases); localStorage.removeItem(LS_KEYS.taxRate); renderSupplierSelect(); renderItemSelect(); renderSupTable(); renderItemTable(); renderPhonebook(); renderInvoiceCards(); }

/* ===== é›»è©±å¸³ ===== */
function renderPhonebook(){ const tb=$('phoneTable').querySelector('tbody'); tb.innerHTML=''; suppliers.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.contact||''}</td><td>${s.phone||''}</td><td>${s.invoiceRegId||''}</td><td><a class="link" style="display:inline-block; text-decoration:none; padding:0 12px; height:36px; line-height:36px; border-radius:8px;" href="${s.phone?`tel:${s.phone}`:'#'}" ${s.phone?'':'onclick=\"return false;\"'}>ğŸ“ é›»è©±</a></td>`; tb.appendChild(tr); }); }

/* ===== SW å¼·åˆ¶æ›´æ–° ===== */
async function forceUpdateSW(){ if(!('serviceWorker' in navigator)){ alert('æœªå¯¾å¿œ'); return; } try{ const reg=await navigator.serviceWorker.getRegistration(); if(!reg){ alert('SWæœªç™»éŒ²'); return; } await reg.update(); if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!window.__reloading){ window.__reloading=true; location.reload(); }}); alert('æ›´æ–°å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚æ•°ç§’ã§æœ€æ–°ã«åˆ‡æ›¿ã‚ã‚Šã¾ã™ã€‚'); }catch(e){ alert('æ›´æ–°ã«å¤±æ•—: '+e.message); } }
</script>
</body>
</html>

