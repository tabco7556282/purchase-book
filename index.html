<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª V24.3</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#38bdf8; --danger:#ef4444; --warn:#f59e0b; --ring:#334155;
      --chip:#1f2937; --shadow:0 8px 24px rgba(0,0,0,.35);
      --bg-light:#f9fafb; --card-light:#ffffff; --text-light:#111827;
      --bg-dark:#0f172a;  --card-dark:#0b1220; --text-dark:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,var(--bg),#030712 60%); color:var(--text); overflow-x:hidden;
    }
    body[data-theme="light"]{ background:var(--bg-light); color:var(--text-light) }
    body[data-theme="light"] .card{ background:var(--card-light) }
    body[data-theme="dark"]{ background:var(--bg-dark); color:var(--text-dark) }
    body[data-theme="dark"] .card{ background:var(--card-dark) }

    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(6px);
      background:rgba(2,6,23,.75); border-bottom:1px solid var(--ring)}
    .wrap{max-width:980px; margin:0 auto; padding:12px 16px}
    h1{font-size:20px; margin:0; letter-spacing:.02em}
    .subtitle{color:var(--muted); font-size:12px}

    nav.tabs{display:flex; gap:8px; margin:10px 0 0 0; flex-wrap:wrap}
    .tab-btn{padding:10px 12px; border:1px solid var(--ring); border-radius:12px; background:#0c1b2e;
      color:var(--text); cursor:pointer; font-size:14px; box-shadow:var(--shadow)}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--accent2); background:#0a192f}
    main{padding:16px}
    section.panel{display:none}
    section.panel.active{display:block}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px;
      box-shadow:var(--shadow); margin:12px 0}

    /* ãƒ¢ãƒã‚¤ãƒ«ã¯ç¸¦ä¸€åˆ—ãƒ»è‡ªå‹•æŠ˜è¿”ã— */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width: 820px){ .row,.row-3{grid-template-columns:1fr} }
    .stack-sm{display:flex; flex-wrap:wrap; gap:8px}
    .stack-sm>*{flex:1 1 160px}
    @media (max-width: 480px){ .stack-sm>*{flex-basis:100%} }

    label{font-size:12px; color:var(--muted)}
    input,select,textarea,button{font:inherit}
    input[type="text"],input[type="number"],input[type="date"],input[type="tel"],select,textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--ring);
      background:#0a1426; color:var(--text);
    }
    input[type="number"]{appearance:textfield}

    .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--ring); background:#0c1b2e; color:var(--text); cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); border-color:#0369a1}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#15803d}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border-color:#b45309}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626); border-color:#b91c1c}
    .btn.ghost{background:#0a1426}
    .btn.small{padding:8px 10px; font-size:12px}
    .flex{display:flex; gap:8px; align-items:center}
    .right{margin-left:auto}

    .table{width:100%; border-collapse:collapse; table-layout:fixed}
    .table th,.table td{border-bottom:1px solid var(--ring); padding:8px; text-align:left; vertical-align:middle; word-wrap:break-word}
    .table th{color:var(--muted); font-weight:600; font-size:12px}
    .num{text-align:right}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; background:#0c1b2e; border:1px solid var(--ring); color:var(--text)}
    .hint{font-size:12px; color:var(--muted)}
    .pill{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--ring); background:#0b1730; padding:4px 8px; border-radius:999px}
    .toast{position:fixed; bottom:16px; left:0; right:0; display:flex; justify-content:center; pointer-events:none}
    .toast>div{pointer-events:auto; background:#0b1324; border:1px solid var(--ring); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="align-items:flex-end; gap:12px; flex-wrap:wrap">
        <div>
          <h1>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª <span class="chip">V24.3</span></h1>
          <div class="subtitle">ã‚¹ãƒãƒ›æœ€é©ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼åŒæ—¥Ã—åŒä»•å…¥å…ˆã§ã‚«ãƒ¼ãƒ‰é›†ç´„ï¼æœˆæ¬¡é›†è¨ˆ</div>
        </div>
        <span class="right"></span>
        <button id="btn-refresh" class="btn small">æ›´æ–°</button>
        <button id="theme-toggle" class="btn small">ğŸŒ™</button>
      </div>
      <nav class="tabs" role="tablist">
        <button class="tab-btn" role="tab" data-tab="purchase" aria-selected="true">ğŸ§¾ ä»•å…¥ã‚Œå…¥åŠ›</button>
        <button class="tab-btn" role="tab" data-tab="master">ğŸ—‚ï¸ ãƒã‚¹ã‚¿ï¼ˆä»•å…¥å…ˆï¼‹å•†å“ï¼‰</button>
        <button class="tab-btn" role="tab" data-tab="list">ğŸ“š ä»•å…¥ä¸€è¦§</button>
        <button class="tab-btn" role="tab" data-tab="summary">ğŸ“Š æœˆæ¬¡é›†è¨ˆ</button>
        <button class="tab-btn" role="tab" data-tab="settings">âš™ï¸ è¨­å®š/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- ä»•å…¥ã‚Œå…¥åŠ› -->
    <section class="panel active" id="tab-purchase">
      <div class="card">
        <div class="row row-3">
          <div>
            <label>æ—¥ä»˜</label>
            <div class="stack-sm">
              <input type="date" id="p-date" />
              <button class="btn small" id="p-date-today">ä»Šæ—¥</button>
              <button class="btn small" id="p-date-yesterday">æ˜¨æ—¥</button>
              <button class="btn small" id="p-date-picker">ğŸ“…</button>
            </div>
          </div>
          <div>
            <label>ä»•å…¥å…ˆ</label>
            <select id="p-supplier"></select>
            <div class="hint" id="p-supplier-hint"></div>
          </div>
          <div>
            <label>æŒ‡å®šç¨ç‡ï¼ˆã‚«ãƒ¼ãƒ‰ã®ç¨è¾¼è¨ˆç®—ï¼‰</label>
            <div class="stack-sm">
              <label class="pill"><input type="radio" name="p-card-tax" value="0"> 0%</label>
              <label class="pill"><input type="radio" name="p-card-tax" value="8" checked> 8%</label>
              <label class="pill"><input type="radio" name="p-card-tax" value="10"> 10%</label>
            </div>
          </div>
        </div>

        <div class="stack-sm" style="margin:10px 0">
          <button class="btn primary" id="add-line">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          <button class="btn success" id="save-purchase">ğŸ§¾ ä»•å…¥ã‚Œç™»éŒ²</button>
        </div>

        <table class="table" id="p-lines">
          <thead>
            <tr>
              <th>å•†å“</th>
              <th class="num">æ•°é‡</th>
              <th class="num">å˜ä¾¡</th>
              <th>ä¾¡æ ¼æ–¹å¼</th>
              <th class="num">ç¨ç‡</th>
              <th class="num">ç¨åˆ¥å°è¨ˆ</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ãƒã‚¹ã‚¿ç™»éŒ²ï¼†ç·¨é›† -->
    <section class="panel" id="tab-master">
      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ—‚ï¸ ä»•å…¥å…ˆï¼‹å•†å“ ä¸€æ‹¬ç™»éŒ²</h3>
        <div class="row row-3">
          <div>
            <label>æ—¢å­˜ã®ä»•å…¥å…ˆ</label>
            <select id="m-exist-supplier"></select>
          </div>
          <div>
            <label>æ–°è¦ä»•å…¥å…ˆåï¼ˆæ–°è¦ç™»éŒ²ã™ã‚‹å ´åˆï¼‰</label>
            <input id="m-new-supplier" type="text" placeholder="ä¾‹ï¼‰ç‰å±‹çˆç²" />
          </div>
          <div>
            <label>æ‹…å½“è€…å</label>
            <input id="m-supp-contact" type="text" placeholder="ä¾‹ï¼‰ç”°ä¸­ã•ã‚“" />
          </div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div>
            <label>é›»è©±ç•ªå·ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ç™ºä¿¡ï¼‰</label>
            <input id="m-supp-phone" type="tel" placeholder="090-1234-5678" />
          </div>
          <div>
            <label>ä»•å…¥å…ˆãƒ¡ãƒ¢</label>
            <input id="m-supp-memo" type="text" placeholder="ä»»æ„" />
          </div>
          <div>
            <label>ã“ã®ä»•å…¥å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ï¼ˆä»»æ„ï¼‰</label>
            <select id="m-supp-tax">
              <option value="">æœªè¨­å®š</option>
              <option value="0">0%</option>
              <option value="8" selected>8%</option>
              <option value="10">10%</option>
            </select>
          </div>
        </div>

        <table class="table" id="m-products" style="margin-top:10px">
          <thead>
            <tr>
              <th>å•†å“å</th>
              <th class="num">å˜ä¾¡</th>
              <th>ä¾¡æ ¼æ–¹å¼</th>
              <th class="num">ç¨ç‡</th>
              <th>ãƒ¡ãƒ¢</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="stack-sm" style="margin-top:10px">
          <button class="btn" id="m-add-product">ï¼‹ å•†å“è¡Œè¿½åŠ </button>
          <button class="btn success" id="m-save">ğŸ’¾ ä¿å­˜</button>
        </div>
        <div class="hint" style="margin-top:8px">
          ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå•†å“ã¯ã€Œç¨åˆ¥ãƒ»8%ã€ã€‚ä¿å­˜ã§ä»•å…¥å…ˆã¨è¤‡æ•°å•†å“ã‚’åŒæ™‚ç™»éŒ²ã—ã€å„å•†å“ã‚’ã“ã®ä»•å…¥å…ˆã«ç´ã¥ã‘ã¾ã™ã€‚
        </div>
      </div>

      <div class="card">
        <details open>
          <summary><b>âœï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†</b>ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ï¼‰</summary>
          <h4 style="margin:6px 0">ä»•å…¥å…ˆã®ç·¨é›†</h4>
          <table class="table" id="suppliers-table"></table>
          <h4 style="margin:16px 0 6px">å•†å“ã®ç·¨é›†</h4>
          <div class="row" style="margin-bottom:6px">
            <div>
              <label>ä»•å…¥å…ˆã§çµã‚Šè¾¼ã¿</label>
              <select id="prod-filter-supplier"></select>
            </div>
            <div>
              <label>å•†å“åã§æ¤œç´¢</label>
              <input id="prod-filter-q" type="text" placeholder="ä¾‹ï¼‰ãƒã‚¿ãƒ¼" />
            </div>
          </div>
          <div class="stack-sm" style="margin-bottom:10px">
            <button class="btn" id="prod-refresh">å†è¡¨ç¤º</button>
          </div>
          <table class="table" id="products-table"></table>
        </details>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ”— æ—¢å­˜å•†å“ã®ç´ã¥ã‘</h3>
        <div class="row">
          <div>
            <label>ä»•å…¥å…ˆ</label>
            <select id="link-supplier"></select>
          </div>
          <div>
            <label>å•†å“ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <select id="link-products" multiple size="6" style="min-height:120px"></select>
          </div>
        </div>
        <div class="stack-sm" style="margin-top:10px">
          <button class="btn primary" id="link-do">ç´ã¥ã‘ã™ã‚‹</button>
        </div>
      </div>
    </section>

    <!-- ä»•å…¥ä¸€è¦§ -->
    <section class="panel" id="tab-list">
      <div id="list-container"></div>
    </section>

    <!-- æœˆæ¬¡é›†è¨ˆ -->
    <section class="panel" id="tab-summary">
      <div class="card">
        <div class="row">
          <div>
            <label>å¯¾è±¡æœˆ</label>
            <input type="month" id="sum-month" />
          </div>
          <div>
            <label>æ“ä½œ</label>
            <div class="stack-sm">
              <button class="btn" id="sum-refresh">å†è¨ˆç®—</button>
              <button class="btn" id="sum-export">CSVæ›¸ãå‡ºã—</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h4 style="margin:6px 0">ä»•å…¥å…ˆåˆ¥ é›†è¨ˆ</h4>
        <table class="table" id="sum-by-supplier"></table>
        <div class="stack-sm" style="justify-content:flex-end; margin-top:8px">
          <div class="chip" id="sum-overall"></div>
        </div>
      </div>
    </section>

    <!-- è¨­å®š/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
    <section class="panel" id="tab-settings">
      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ</h3>
        <div class="stack-sm">
          <button class="btn" id="export-json">JSONã‚’æ›¸ãå‡ºã—</button>
          <input type="file" id="import-file" accept="application/json" />
          <button class="btn warn" id="import-json">JSONã‹ã‚‰å¾©å…ƒ</button>
          <button class="btn danger" id="wipe-all">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
        <div class="hint" style="margin-top:8px">
          ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã€‚ã‚¹ã‚­ãƒ¼ãƒ <span class="chip">24.0</span>ã€‚
          V21.1/V22/V23 ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒã«å¯¾å¿œã€‚
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" style="display:none"><div></div></div>

  <!-- Part 2/3 ã¨ Part 3/3 ã‚’ã“ã®ç›´å¾Œã«è²¼ã‚‹ -->
<script>
/* ===== Part 2/3: Core Model & Storage (V24.3) ===== */
(function(){
  const APP_KEY='tabco-purchase-v24';
  const SCHEMA_VERSION='24.0';

  const api = {};
  const uuid=()=>crypto.randomUUID?crypto.randomUUID():
    'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
      const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });

  const today = ()=>new Date().toISOString().slice(0,10);
  const ymNow = ()=>new Date().toISOString().slice(0,7);
  const toNum = v=>Number(String(v??'').replace(/[\s,]/g,''))||0;
  const yen = n=>Math.round(n).toLocaleString('ja-JP');
  const telSanitize = s=>(s||'').replace(/[^0-9+]/g,'');
  const byNameJa = (a,b)=>(a.name||'').localeCompare((b.name||''),'ja');

  // expose utils for Part3
  api.util = { today, ymNow, toNum, yen, telSanitize, byNameJa };

  function save(db){ localStorage.setItem(APP_KEY, JSON.stringify(db)); }
  function seed(){ const d={version:SCHEMA_VERSION,suppliers:[],products:[],purchases:[]}; save(d); return d; }
  function patchSupplier(s){
    s.contact??=''; s.phone??=''; s.memo??=''; if(s.defaultTaxRate===undefined) s.defaultTaxRate=null; return s;
  }
  function patchToV24(db){
    db.version=SCHEMA_VERSION;
    db.suppliers=(db.suppliers||[]).map(patchSupplier);
    db.products||(db.products=[]);
    db.purchases||(db.purchases=[]);
    return db;
  }

  // Migration (v21.1 / v22 / v23 / heuristic)
  const safeArr=x=>Array.isArray(x)?x:[];
  const normalizePriceMode=x=> (x==='incl'||x===true||x==='ç¨è¾¼')?'incl':'excl';

  function heuristicMigrateV211Like(src){
    const now=Date.now();
    const supKey=src.suppliers?'suppliers':(src.vendors?'vendors':null);
    const prodKey=src.products?'products':(src.items?'items':null);
    const purKey=['purchases','cards','purchaseList','entries','lines']
      .find(k=>Array.isArray(src[k]));
    const suppliers=[],products=[],purchases=[];
    const nameToSuppId=new Map();

    for(const s of safeArr(supKey?src[supKey]:[])){
      const name=String(s.name??s.title??'').trim();
      if(!name) continue;
      const obj=patchSupplier({
        id:uuid(),name,contact:s.contact||'',phone:s.phone||'',
        memo:s.memo||'',defaultTaxRate:s.defaultTaxRate??null,createdAt:now
      });
      suppliers.push(obj);
      nameToSuppId.set(name,obj.id);
    }

    for(const p of safeArr(prodKey?src[prodKey]:[])){
      const name=String(p.name??p.productName??p.title??'').trim();
      if(!name) continue;
      const basePrice=toNum(p.basePrice??p.price??p.unitPrice??0);
      const priceMode=normalizePriceMode(p.priceMode??p.taxIncluded??false);
      const taxRate=Number(p.taxRate??p.tax??8);
      let supplierId=null;
      const sname=p.supplierName??p.vendorName??'';
      if(sname&&nameToSuppId.has(sname)) supplierId=nameToSuppId.get(sname);
      const note=p.note||p.memo||'';
      products.push({id:uuid(),name,basePrice,priceMode,taxRate,supplierId,note,createdAt:now});
    }

    const byKey=new Map();
    for(const ent of safeArr(purKey?src[purKey]:[])){
      const d=(ent.date||ent.day||ent.at||today()).slice(0,10);
      const sname=ent.supplierName??ent.vendorName??ent.supplier??'';
      let sid=nameToSuppId.get(sname);
      if(!sid&&sname){
        const s=patchSupplier({id:uuid(),name:sname,contact:'',phone:'',memo:'',defaultTaxRate:null,createdAt:now});
        suppliers.push(s); nameToSuppId.set(sname,s.id); sid=s.id;
      }
      if(!sid) continue;
      const key=`${d}|${sid}`;
      let card=byKey.get(key);
      if(!card){
        card={id:uuid(),date:d,supplierId:sid,cardTaxRate:Number(ent.cardTaxRate??ent.taxRate??8),items:[],createdAt:now};
        byKey.set(key,card);
      }

      const items = ent.items && Array.isArray(ent.items) ? ent.items : [ent];
      for(const it of items){
        const name=String(it.name??it.productName??'').trim()||'æœªç™»éŒ²å•†å“';
        const qty=toNum(it.qty??it.quantity??1);
        const unitPrice=toNum(it.unitPrice??it.price??0);
        const priceMode=normalizePriceMode(it.priceMode??it.taxIncluded??false);
        const taxRate=Number(it.taxRate??ent.taxRate??8);
        const prod=products.find(p=>p.name===name&&(!p.supplierId||p.supplierId===sid));
        const productId=prod?prod.id:null;
        card.items.push({id:uuid(),productId,name,qty,unitPrice,priceMode,taxRate});
      }
    }
    for(const [,card] of byKey) purchases.push(card);

    // de-dup
    const uniqBy=(arr,key)=>{ const m=new Map(); for(const x of arr){ const k=x[key]; if(!m.has(k)) m.set(k,x);} return Array.from(m.values()); };
    const suppliersUniq=uniqBy(suppliers,'name').sort(byNameJa);
    const pMap=new Map();
    for(const p of products){
      const k=[p.name,p.supplierId||'',p.priceMode,p.taxRate,Math.round(p.basePrice)].join('|');
      if(!pMap.has(k)) pMap.set(k,p);
    }
    const productsUniq=Array.from(pMap.values()).sort(byNameJa);
    return {version:SCHEMA_VERSION, suppliers:suppliersUniq, products:productsUniq, purchases};
  }

  function migrateV211(src){ return heuristicMigrateV211Like(src); }

  function migrateFromAny(src){
    try{
      const v=String(src?.version||'');
      if(v.startsWith('24')) return patchToV24(structuredClone(src));
      if(v.startsWith('23')||v.startsWith('22')){
        const d=structuredClone(src);
        d.suppliers=(d.suppliers||[]).map(patchSupplier);
        d.version=SCHEMA_VERSION;
        return d;
      }
      if(v.startsWith('21.1')) return migrateV211(src);
      return heuristicMigrateV211Like(src);
    }catch(_){
      return {version:SCHEMA_VERSION,suppliers:[],products:[],purchases:[]};
    }
  }

  function load(){
    const raw=localStorage.getItem(APP_KEY);
    if(raw){ try{ return patchToV24(JSON.parse(raw)); }catch(_){ /* continue */ } }
    // try older keys
    for(const key of ['tabco-purchase-v23','tabco-purchase-v22','tabco-purchase-v21','tabco-purchase-v21_1']){
      const r=localStorage.getItem(key); if(!r) continue;
      try{ const old=JSON.parse(r); const db=migrateFromAny(old); save(db); return db; }catch(_){}
    }
    return seed();
  }

  let DB = load();

  const dal = {
    suppliers(){ return DB.suppliers },
    products(){ return DB.products },
    purchases(){ return DB.purchases },

    upsertSupplierByName({name,contact,phone,memo,defaultTaxRate}){
      const e=DB.suppliers.find(x=>x.name.trim()===name.trim());
      if(e){
        if(contact!==undefined) e.contact=contact;
        if(phone!==undefined) e.phone=phone;
        if(memo!==undefined) e.memo=memo;
        if(defaultTaxRate!==undefined) e.defaultTaxRate=(defaultTaxRate===''?null:Number(defaultTaxRate));
        save(DB); return e;
      }
      const s={id:uuid(),name:name.trim(),contact:contact||'',phone:phone||'',
               memo:memo||'',defaultTaxRate:defaultTaxRate===''?null:Number(defaultTaxRate),
               createdAt:Date.now()};
      DB.suppliers.push(s); save(DB); return s;
    },
    updateSupplier(id,patch){
      const s=DB.suppliers.find(x=>x.id===id); if(!s) return null;
      Object.assign(s,patch); save(DB); return s;
    },
    addProduct({name,basePrice,priceMode,taxRate,supplierId,note}){
      const p={id:uuid(),name:name.trim(),basePrice:toNum(basePrice),
               priceMode,taxRate:Number(taxRate),supplierId:supplierId||null,
               note:note||'',createdAt:Date.now()};
      DB.products.push(p); save(DB); return p;
    },
    updateProduct(id,patch){
      const p=DB.products.find(x=>x.id===id); if(!p) return null;
      Object.assign(p,patch); save(DB); return p;
    },
    linkProductsToSupplier(prodIds,supplierId){
      DB.products.forEach(p=>{ if(prodIds.includes(p.id)) p.supplierId=supplierId; });
      save(DB);
    },
    addPurchaseLines({date,supplierId,cardTaxRate,lines}){
      let card=DB.purchases.find(x=>x.date===date&&x.supplierId===supplierId);
      if(!card){
        card={id:uuid(),date,supplierId,cardTaxRate:Number(cardTaxRate),items:[],createdAt:Date.now()};
        DB.purchases.push(card);
      }else{
        card.cardTaxRate=Number(cardTaxRate);
      }
      for(const ln of lines){
        card.items.push({id:uuid(),productId:ln.productId||null,name:ln.name,qty:Number(ln.qty||1),
                         unitPrice:toNum(ln.unitPrice||0),priceMode:ln.priceMode,taxRate:Number(ln.taxRate)});
      }
      save(DB); return card;
    },
    deletePurchase(id){ DB.purchases=DB.purchases.filter(x=>x.id!==id); save(DB); },
    deleteLine(cardId,lineId){
      const c=DB.purchases.find(x=>x.id===cardId); if(!c) return;
      c.items=c.items.filter(i=>i.id!==lineId); save(DB);
    },
    _setDB(newDB){ DB=newDB; save(DB); }, // for import
    _getDB(){ return DB; }
  };

  // export to window for Part3
  window.App = { dal, save, load, migrateFromAny, patchToV24, seed, util:{today,ymNow,toNum,yen,telSanitize,byNameJa} };
})();
</script>
<script>
/* ===== Part 3/3: UI & Render (V24.3) ===== */
(function(){
  const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
  const { dal, save, migrateFromAny, util } = window.App;
  const { today, ymNow, toNum, yen, telSanitize, byNameJa } = util;

  function showToast(msg){
    const t=$('#toast'); t.style.display='flex'; t.firstElementChild.textContent=msg;
    setTimeout(()=>t.style.display='none',1500);
  }
  function initTabs(){
    $$('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.tab-btn').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        $$('.panel').forEach(p=>p.classList.remove('active'));
        $('#tab-'+btn.dataset.tab).classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });
  }
  // theme
  (function(){
    const KEY='tabco-theme'; const btn=$('#theme-toggle');
    function init(){ const saved=localStorage.getItem(KEY)||'dark';
      document.body.setAttribute('data-theme',saved);
      if(btn) btn.textContent=saved==='dark'?'â˜€ï¸':'ğŸŒ™';
    }
    function toggle(){
      const cur=document.body.getAttribute('data-theme')||'dark';
      const next=cur==='dark'?'light':'dark';
      document.body.setAttribute('data-theme',next);
      if(btn) btn.textContent=next==='dark'?'â˜€ï¸':'ğŸŒ™';
      localStorage.setItem(KEY,next);
    }
    init(); btn?.addEventListener('click',toggle);
  })();

  // ---------- Purchase UI ----------
  function renderSupplierOptions(){
    ['#p-supplier','#m-exist-supplier','#link-supplier','#prod-filter-supplier'].forEach(sel=>{
      const el=$(sel); if(!el) return; el.innerHTML='';
      const o0=document.createElement('option'); o0.value=''; o0.textContent='â€” é¸æŠ â€”'; el.appendChild(o0);
      dal.suppliers().slice().sort(byNameJa).forEach(s=>{
        const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.appendChild(o);
      });
    });
  }
  function productOptionLabel(p){
    return `${p.name} / ${p.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'} ${yen(p.basePrice)} / ç¨ç‡${p.taxRate}%`;
  }
  function renderPurchaseProductOptions(){
    const sid=$('#p-supplier').value;
    const hint=$('#p-supplier-hint'); const supp=dal.suppliers().find(s=>s.id===sid);
    hint.textContent = supp ? `æ‹…å½“: ${supp.contact||'-'} / TEL: ${supp.phone||'-'}` : '';
    $$('#p-lines select[data-role="product"]').forEach(sel=>{
      const items=dal.products().filter(p=>sid?(p.supplierId===sid):true).sort(byNameJa);
      sel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent='â€” å•†å“ â€”'; sel.appendChild(o0);
      items.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=productOptionLabel(p); sel.appendChild(o); });
    });
  }
  function addPurchaseRow(prefill){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><select data-role="product"></select></td>
      <td class="num"><input type="number" min="0" step="1" value="${prefill?.qty??1}" data-role="qty" /></td>
      <td class="num">
        <div class="stack-sm">
          <input type="number" min="0" step="1" value="${prefill?.unitPrice??''}" data-role="price" />
          <div class="stack-sm" style="gap:6px">
            <button class="btn small ghost" data-bump="-10">-10</button>
            <button class="btn small ghost" data-bump="-1">-1</button>
            <button class="btn small ghost" data-bump="1">+1</button>
            <button class="btn small ghost" data-bump="10">+10</button>
          </div>
        </div>
      </td>
      <td><select data-role="mode"><option value="excl">ç¨åˆ¥</option><option value="incl">ç¨è¾¼</option></select></td>
      <td class="num"><select data-role="rate"><option value="0">0%</option><option value="8" selected>8%</option><option value="10">10%</option></select></td>
      <td class="num" data-role="ex">0</td>
      <td class="num"><button class="btn small danger" data-role="del">å‰Šé™¤</button></td>`;
    $('#p-lines tbody').appendChild(tr);
    renderPurchaseProductOptions();

    const sel=tr.querySelector('select[data-role="product"]');
    sel.addEventListener('change',()=>{
      const id=sel.value; if(!id) return;
      const p=dal.products().find(x=>x.id===id); if(!p) return;
      tr.querySelector('input[data-role="price"]').value=p.basePrice;
      tr.querySelector('select[data-role="mode"]').value=p.priceMode;
      tr.querySelector('select[data-role="rate"]').value=String(p.taxRate);
      updateRowEx(tr);
    });

    tr.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('input',()=>updateRowEx(tr));
      el.addEventListener('change',()=>updateRowEx(tr));
    });
    tr.querySelectorAll('button[data-bump]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const d=Number(btn.dataset.bump);
        const inp=tr.querySelector('input[data-role="price"]');
        inp.value=toNum(inp.value)+d; updateRowEx(tr);
      });
    });
    tr.querySelector('[data-role="del"]').addEventListener('click',()=>tr.remove());

    if(prefill){
      if(prefill.productId){ sel.value=prefill.productId; }
      if(prefill.mode){ tr.querySelector('select[data-role="mode"]').value=prefill.mode; }
      if(prefill.rate!==undefined){ tr.querySelector('select[data-role="rate"]').value=String(prefill.rate);}
      updateRowEx(tr);
    }
  }
  function updateRowEx(tr){
    const qty=toNum(tr.querySelector('input[data-role="qty"]').value||1);
    const price=toNum(tr.querySelector('input[data-role="price"]').value||0);
    const mode=tr.querySelector('select[data-role="mode"]').value;
    const rate=Number(tr.querySelector('select[data-role="rate"]').value||8);
    const unitEx = (mode==='excl') ? price : Math.round(price/(1+rate/100));
    const ex = unitEx*qty;
    tr.querySelector('[data-role="ex"]').textContent = yen(ex);
    return ex;
  }
  function collectLines(){
    const rows=Array.from($('#p-lines tbody').children);
    const lines=[];
    for(const tr of rows){
      const productId=tr.querySelector('select[data-role="product"]').value||null;
      const qty=toNum(tr.querySelector('input[data-role="qty"]').value||1);
      const unitPrice=toNum(tr.querySelector('input[data-role="price"]').value||0);
      const priceMode=tr.querySelector('select[data-role="mode"]').value;
      const taxRate=Number(tr.querySelector('select[data-role="rate"]').value||8);
      let name='æœªç™»éŒ²å•†å“';
      if(productId){ const p=dal.products().find(x=>x.id===productId); if(p) name=p.name; }
      if(qty<=0) continue;
      lines.push({productId,name,qty,unitPrice,priceMode,taxRate});
    }
    return lines;
  }
  function initPurchase(){
    $('#p-date').value=$('#p-date').value||today();
    renderSupplierOptions(); renderPurchaseProductOptions();
    $('#p-supplier').addEventListener('change',renderPurchaseProductOptions);
    if(!$('#p-lines tbody').children.length) addPurchaseRow();
    $('#add-line').addEventListener('click',()=>addPurchaseRow());
    $('#save-purchase').addEventListener('click',()=>{
      const date=$('#p-date').value||today();
      const supplierId=$('#p-supplier').value;
      if(!supplierId){ showToast('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      const cardTaxRate=Number(document.querySelector('input[name="p-card-tax"]:checked')?.value||8);
      const lines=collectLines(); if(!lines.length){ showToast('è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      dal.addPurchaseLines({date,supplierId,cardTaxRate,lines});
      $('#p-lines tbody').innerHTML=''; addPurchaseRow(); showToast('ä»•å…¥ã‚Œã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      renderList(); // åæ˜ 
    });
    // date shortcuts
    $('#p-date-today')?.addEventListener('click',()=>$('#p-date').value=today());
    $('#p-date-yesterday')?.addEventListener('click',()=>{
      const d=new Date(); d.setDate(d.getDate()-1); $('#p-date').value=d.toISOString().slice(0,10);
    });
    $('#p-date-picker')?.addEventListener('click',()=>{
      const inp=$('#p-date'); if(inp && typeof inp.showPicker==='function') inp.showPicker(); else inp?.focus();
    });
  }

  // ---------- Master UI ----------
  function addMasterRow(prefill){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" data-role="name" placeholder="å•†å“å" value="${prefill?.name||''}" /></td>
      <td class="num"><input type="number" min="0" step="1" data-role="price" placeholder="0" value="${prefill?.price||''}" /></td>
      <td><select data-role="mode"><option value="excl" ${!prefill||prefill.mode==='excl'?'selected':''}>ç¨åˆ¥</option><option value="incl" ${prefill?.mode==='incl'?'selected':''}>ç¨è¾¼</option></select></td>
      <td class="num"><select data-role="rate"><option value="0">0%</option><option value="8" selected>8%</option><option value="10">10%</option></select></td>
      <td><input type="text" data-role="note" placeholder="ä»»æ„" value="${prefill?.note||''}" /></td>
      <td class="num"><button class="btn small danger" data-role="del">å‰Šé™¤</button></td>`;
    $('#m-products tbody').appendChild(tr);
    tr.querySelector('[data-role="del"]').addEventListener('click',()=>tr.remove());
  }
  function renderMasterCombos(){ renderSupplierOptions(); renderLinkProductsOptions(); if(!$('#m-products tbody').children.length) addMasterRow(); }
  function initMaster(){
    $('#m-add-product').addEventListener('click',()=>addMasterRow());
    $('#m-save').addEventListener('click',()=>{
      let supplierId=$('#m-exist-supplier').value||null;
      const newName=$('#m-new-supplier').value.trim();
      const contact=$('#m-supp-contact').value.trim();
      const phone=$('#m-supp-phone').value.trim();
      const memo=$('#m-supp-memo').value.trim();
      const defTax=$('#m-supp-tax').value;

      if(!supplierId && !newName){ showToast('æ—¢å­˜ã®ä»•å…¥å…ˆã‚’é¸ã¶ã‹ã€æ–°è¦åã‚’å…¥åŠ›'); return; }
      if(!supplierId && newName){
        const s=dal.upsertSupplierByName({name:newName,contact,phone,memo,defaultTaxRate:defTax});
        supplierId=s.id;
      }
      if(supplierId && (contact||phone||memo||defTax!=='')){
        dal.updateSupplier(supplierId,{contact,phone,memo,defaultTaxRate:defTax===''?null:Number(defTax)});
      }

      const rows=Array.from($('#m-products tbody').children); if(!rows.length){ showToast('å•†å“è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      let count=0;
      for(const tr of rows){
        const name=tr.querySelector('[data-role="name"]').value.trim();
        const price=toNum(tr.querySelector('[data-role="price"]').value);
        const mode=tr.querySelector('[data-role="mode"]').value;
        const rate=Number(tr.querySelector('[data-role="rate"]').value||8);
        const note=tr.querySelector('[data-role="note"]').value.trim();
        if(!name) continue;
        dal.addProduct({name,basePrice:price,priceMode:mode,taxRate:rate,supplierId,note}); count++;
      }
      if(count===0){ showToast('æœ‰åŠ¹ãªå•†å“ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      $('#m-products tbody').innerHTML=''; addMasterRow();
      $('#m-new-supplier').value=''; $('#m-supp-memo').value=''; $('#m-supp-contact').value=''; $('#m-supp-phone').value='';
      renderSupplierOptions(); renderLinkProductsOptions();
      showToast(`${count}ä»¶ã®å•†å“ã‚’ç™»éŒ²ãƒ»ç´ã¥ã‘ã—ã¾ã—ãŸ`);
    });

    $('#link-do').addEventListener('click',()=>{
      const sid=$('#link-supplier').value; if(!sid){ showToast('ä»•å…¥å…ˆã‚’é¸æŠ'); return; }
      const prodIds=Array.from($('#link-products').selectedOptions).map(o=>o.value);
      if(!prodIds.length){ showToast('å•†å“ã‚’é¸æŠ'); return; }
      dal.linkProductsToSupplier(prodIds,sid); showToast(`${prodIds.length}ä»¶ã‚’ç´ã¥ã‘ã¾ã—ãŸ`);
    });

    $('#prod-refresh')?.addEventListener('click', renderProductsTable);
  }
  function renderLinkProductsOptions(){
    const el=$('#link-products'); if(!el) return; el.innerHTML='';
    dal.products().slice().sort(byNameJa).forEach(p=>{
      const o=document.createElement('option'); o.value=p.id; o.textContent=productOptionLabel(p); el.appendChild(o);
    });
  }

  // ---------- Edit tables ----------
  function supplierRowView(s){
    const phoneHref=telSanitize(s.phone);
    return `<tr data-id="${s.id}">
      <td>${s.name}<div class="hint">${s.memo||''}</div></td>
      <td>${s.contact||''}</td>
      <td>${s.phone?`<a class="btn small" href="tel:${phoneHref}">ğŸ“ ç™ºä¿¡</a>`:''}</td>
      <td class="num">${s.defaultTaxRate==null?'-':s.defaultTaxRate+'%'}</td>
      <td class="num"><button class="btn small" data-edit-supp>ç·¨é›†</button></td>`;
  }
  function supplierRowEdit(s){
    return `<tr data-id="${s.id}">
      <td><input type="text" data-role="name" value="${s.name}" />
          <div class="hint">ãƒ¡ãƒ¢:<input type="text" data-role="memo" value="${s.memo||''}"></div></td>
      <td><input type="text" data-role="contact" value="${s.contact||''}" /></td>
      <td><input type="tel" data-role="phone" value="${s.phone||''}" /></td>
      <td><select data-role="tax"><option value="">æœªè¨­å®š</option>
            <option value="0" ${s.defaultTaxRate===0?'selected':''}>0%</option>
            <option value="8" ${s.defaultTaxRate===8?'selected':''}>8%</option>
            <option value="10" ${s.defaultTaxRate===10?'selected':''}>10%</option></select></td>
      <td class="num"><button class="btn small success" data-save-supp>ä¿å­˜</button>
                      <button class="btn small ghost" data-cancel-supp>å–æ¶ˆ</button></td>`;
  }
  function renderSuppliersTable(){
    const el=$('#suppliers-table'); if(!el) return;
    const rows=dal.suppliers().slice().sort(byNameJa).map(s=>supplierRowView(s)).join('');
    el.innerHTML=`<thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th class="num">æ—¢å®šç¨ç‡</th><th></th></tr></thead>
                  <tbody>${rows||'<tr><td colspan="5">æœªç™»éŒ²</td></tr>'}</tbody>`;
    el.querySelectorAll('[data-edit-supp]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tr=btn.closest('tr'); const id=tr.dataset.id;
        const s=dal.suppliers().find(x=>x.id===id);
        tr.outerHTML=supplierRowEdit(s);
        const row=$('#suppliers-table').querySelector(`tr[data-id="${id}"]`);
        row.querySelector('[data-save-supp]').addEventListener('click',()=>{
          const patch={
            name:row.querySelector('[data-role="name"]').value.trim(),
            memo:row.querySelector('[data-role="memo"]').value.trim(),
            contact:row.querySelector('[data-role="contact"]').value.trim(),
            phone:row.querySelector('[data-role="phone"]').value.trim(),
            defaultTaxRate:(row.querySelector('[data-role="tax"]').value==='')?null:Number(row.querySelector('[data-role="tax"]').value)
          };
          dal.updateSupplier(id,patch); renderSuppliersTable(); showToast('ä»•å…¥å…ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        });
        row.querySelector('[data-cancel-supp]').addEventListener('click', renderSuppliersTable);
      });
    });
  }

  function productRowView(p){
    const s=p.supplierId?dal.suppliers().find(x=>x.id===p.supplierId):null;
    const sname=s?s.name:'(æœªç´ã¥ã‘)';
    return `<tr data-id="${p.id}">
      <td>${p.name}<div class="hint">${p.note||''}</div></td>
      <td class="num">Â¥${yen(p.basePrice)}</td>
      <td>${p.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
      <td class="num">${p.taxRate}%</td>
      <td>${sname}</td>
      <td class="num"><button class="btn small" data-edit-prod>ç·¨é›†</button></td>`;
  }
  function productRowEdit(p){
    const supplierOpts=['<option value="">(æœªç´ã¥ã‘)</option>']
      .concat(dal.suppliers().slice().sort(byNameJa).map(s=>`<option value="${s.id}" ${p.supplierId===s.id?'selected':''}>${s.name}</option>`)).join('');
    return `<tr data-id="${p.id}">
      <td><input type="text" data-role="name" value="${p.name}" />
          <div class="hint">ãƒ¡ãƒ¢:<input type="text" data-role="note" value="${p.note||''}"></div></td>
      <td><input type="number" min="0" step="1" data-role="price" value="${p.basePrice}" /></td>
      <td><select data-role="mode"><option value="excl" ${p.priceMode==='excl'?'selected':''}>ç¨åˆ¥</option>
                          <option value="incl" ${p.priceMode==='incl'?'selected':''}>ç¨è¾¼</option></select></td>
      <td><select data-role="rate"><option value="0" ${p.taxRate===0?'selected':''}>0%</option>
                          <option value="8" ${p.taxRate===8?'selected':''}>8%</option>
                          <option value="10" ${p.taxRate===10?'selected':''}>10%</option></select></td>
      <td><select data-role="supplier">${supplierOpts}</select></td>
      <td class="num"><button class="btn small success" data-save-prod>ä¿å­˜</button>
                      <button class="btn small ghost" data-cancel-prod>å–æ¶ˆ</button></td>`;
  }
  function renderProductsTable(){
    const el=$('#products-table'); if(!el) return;
    const sid=$('#prod-filter-supplier').value;
    const q=($('#prod-filter-q').value||'').trim();
    let items=dal.products().slice();
    if(sid) items=items.filter(p=>p.supplierId===sid);
    if(q) items=items.filter(p=>p.name.includes(q)||(p.note||'').includes(q));
    items.sort(byNameJa);
    const rows=items.map(p=>productRowView(p)).join('');
    el.innerHTML=`<thead><tr><th>å•†å“</th><th class="num">å˜ä¾¡</th><th>æ–¹å¼</th><th class="num">ç¨ç‡</th><th>ä»•å…¥å…ˆ</th><th></th></tr></thead>
                  <tbody>${rows||'<tr><td colspan="6">è©²å½“ãªã—</td></tr>'}</tbody>`;
    el.querySelectorAll('[data-edit-prod]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tr=btn.closest('tr'); const id=tr.dataset.id;
        const p=dal.products().find(x=>x.id===id);
        tr.outerHTML=productRowEdit(p);
        const row=$('#products-table').querySelector(`tr[data-id="${id}"]`);
        row.querySelector('[data-save-prod]').addEventListener('click',()=>{
          const patch={
            name:row.querySelector('[data-role="name"]').value.trim(),
            note:row.querySelector('[data-role="note"]').value.trim(),
            basePrice:toNum(row.querySelector('[data-role="price"]').value),
            priceMode:row.querySelector('[data-role="mode"]').value,
            taxRate:Number(row.querySelector('[data-role="rate"]').value||8),
            supplierId:row.querySelector('[data-role="supplier"]').value||null
          };
          dal.updateProduct(id,patch); renderProductsTable(); showToast('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        });
        row.querySelector('[data-cancel-prod]').addEventListener('click', renderProductsTable);
      });
    });
  }

  // ---------- List & Summary ----------
  function computeLineEx(it){
    return (it.priceMode==='excl'? it.unitPrice : Math.round(it.unitPrice/(1+it.taxRate/100)))*it.qty;
  }
  function computeCardTotals(card){
    let exTotal=0; for(const it of card.items) exTotal+=computeLineEx(it);
    const taxRate=Number(card.cardTaxRate||8);
    const incTotal=Math.round(exTotal*(1+taxRate/100));
    return {exTotal,incTotal,taxRate};
  }
  function renderList(){
    const cont=$('#list-container'); cont.innerHTML='';
    const cards=dal.purchases(); if(!cards.length){ cont.innerHTML='<div class="card">ã¾ã ä»•å…¥ã‚ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>'; return; }
    const sorted=cards.slice().sort((a,b)=> b.date.localeCompare(a.date) || b.createdAt - a.createdAt);
    for(const card of sorted){
      const supp=dal.suppliers().find(s=>s.id===card.supplierId);
      const sname=supp? supp.name : 'ä¸æ˜ãªä»•å…¥å…ˆ';
      const {exTotal,incTotal,taxRate}=computeCardTotals(card);
      const ph=supp && supp.phone ? telSanitize(supp.phone):'';
      const div=document.createElement('div'); div.className='card';
      div.innerHTML=`
        <div class="stack-sm" style="align-items:flex-end">
          <div>
            <div class="chip">${card.date}</div>
            <div style="font-size:18px; font-weight:600; margin-top:6px">${sname} ${supp&&supp.contact?`<span class="hint">(${supp.contact})</span>`:''}</div>
            ${supp&&supp.memo?`<div class="hint">${supp.memo}</div>`:''}
          </div>
          ${ph? `<a class="btn small" href="tel:${ph}">ğŸ“ ç™ºä¿¡</a>`:''}
          <button class="btn small danger" data-del-card>ã‚«ãƒ¼ãƒ‰å‰Šé™¤</button>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>æŒ‡å®šç¨ç‡ï¼ˆã‚«ãƒ¼ãƒ‰ç¨è¾¼è¨ˆç®—ï¼‰</label>
            <select data-card-tax>
              <option value="0" ${taxRate===0?'selected':''}>0%</option>
              <option value="8" ${taxRate===8?'selected':''}>8%</option>
              <option value="10" ${taxRate===10?'selected':''}>10%</option>
            </select>
          </div>
          <div class="stack-sm" style="align-items:flex-end">
            <div class="chip">ç¨åˆ¥åˆè¨ˆï¼š<b>Â¥${yen(exTotal)}</b></div>
            <div class="chip">ç¨è¾¼åˆè¨ˆï¼ˆæŒ‡å®šç¨ç‡${taxRate}%ï¼‰ï¼š<b>Â¥${yen(incTotal)}</b></div>
          </div>
        </div>
        <table class="table" style="margin-top:8px">
          <thead><tr><th>å•†å“</th><th class="num">æ•°é‡</th><th class="num">å˜ä¾¡</th><th>æ–¹å¼</th><th class="num">ç¨ç‡</th><th class="num">ç¨åˆ¥å°è¨ˆ</th><th></th></tr></thead>
          <tbody>
            ${card.items.map(it=>{
              const p=it.productId? dal.products().find(x=>x.id===it.productId):null;
              const unitEx=it.priceMode==='excl'? it.unitPrice : Math.round(it.unitPrice/(1+it.taxRate/100));
              const ex=unitEx*it.qty; const name=p? p.name : it.name;
              return `<tr data-line-id="${it.id}"><td>${name}</td><td class="num">${yen(it.qty)}</td>
                      <td class="num">Â¥${yen(it.unitPrice)}</td><td>${it.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
                      <td class="num">${it.taxRate}%</td><td class="num">Â¥${yen(ex)}</td>
                      <td class="num"><button class="btn small danger" data-del-line>å‰Šé™¤</button></td>`;
            }).join('')}
          </tbody>
        </table>`;
      cont.appendChild(div);

      div.querySelector('[data-card-tax]').addEventListener('change',e=>{
        card.cardTaxRate=Number(e.target.value); save(window.App._getDB?.()||{});
        renderList();
      });
      div.querySelector('[data-del-card]').addEventListener('click',()=>{
        if(confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ dal.deletePurchase(card.id); renderList(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ'); }
      });
      div.querySelectorAll('[data-del-line]').forEach(btn=>btn.addEventListener('click',()=>{
        const lineId=btn.closest('tr').dataset.lineId; dal.deleteLine(card.id,lineId); renderList(); showToast('è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }));
    }
  }

  function setupSummaryDefaults(){ const m=$('#sum-month'); if(m && !m.value) m.value=ymNow(); }
  function summaryForMonth(ym){
    const map=new Map(); let overallEx=0, overallInc=0;
    for(const card of dal.purchases()){
      if(!card.date.startsWith(ym)) continue;
      for(const it of card.items){
        const unitEx=it.priceMode==='excl'? it.unitPrice : Math.round(it.unitPrice/(1+it.taxRate/100));
        const ex=unitEx*it.qty; const inc=Math.round(ex*(1+it.taxRate/100));
        overallEx+=ex; overallInc+=inc;
        const key=card.supplierId; const cur=map.get(key)||{ex:0,inc:0};
        cur.ex+=ex; cur.inc+=inc; map.set(key,cur);
      }
    }
    return {map,overallEx,overallInc};
  }
  function renderSummary(){
    const ym=$('#sum-month').value||ymNow(); const el=$('#sum-by-supplier');
    const {map,overallEx,overallInc}=summaryForMonth(ym);
    const rows=Array.from(map.entries())
      .sort((a,b)=>{
        const sa=dal.suppliers().find(s=>s.id===a[0]); const sb=dal.suppliers().find(s=>s.id===b[0]);
        const na=sa?sa.name:'(ä¸æ˜)'; const nb=sb?sb.name:'(ä¸æ˜)'; return na.localeCompare(nb,'ja');
      })
      .map(([sid,tot])=>{
        const s=dal.suppliers().find(x=>x.id===sid); const ph=s&&s.phone?telSanitize(s.phone):'';
        return `<tr><td>${s? s.name:'(ä¸æ˜)'} ${s&&s.contact?`<span class="hint">(${s.contact})</span>`:''}</td>
                <td class="num">Â¥${yen(tot.ex)}</td><td class="num">Â¥${yen(tot.inc)}</td>
                <td>${ph?`<a class="btn small" href="tel:${ph}">ğŸ“</a>`:''}</td></tr>`;
      }).join('');
    el.innerHTML=`<thead><tr><th>ä»•å…¥å…ˆ</th><th class="num">ç¨åˆ¥åˆè¨ˆ</th><th class="num">ç¨è¾¼åˆè¨ˆï¼ˆè¡Œç¨ç‡ï¼‰</th><th></th></tr></thead>
                  <tbody>${rows||'<tr><td colspan="4">ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>'}</tbody>`;
    $('#sum-overall').textContent=`ã™ã¹ã¦ã®åˆè¨ˆï¼š ç¨åˆ¥ Â¥${yen(overallEx)} / ç¨è¾¼ï¼ˆè¡Œç¨ç‡ï¼‰ Â¥${yen(overallInc)}`;
  }

  // ---------- Settings ----------
  function initSettings(){
    $('#export-json').addEventListener('click',()=>{
      const db=window.App._getDB?window.App._getDB():null;
      const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`purchase-backup-v24-${today()}.json`; a.click(); URL.revokeObjectURL(url);
    });
    $('#import-json').addEventListener('click',()=>{
      const f=$('#import-file').files?.[0]; if(!f){ showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ'); return; }
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const raw=JSON.parse(reader.result); const next=migrateFromAny(raw);
          window.App._setDB(next); renderAll(); showToast('å¾©å…ƒã—ã¾ã—ãŸ');
        }catch(e){ console.error(e); showToast('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); }
      };
      reader.readAsText(f);
    });
    $('#wipe-all').addEventListener('click',()=>{
      if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
        window.App._setDB({version:'24.0',suppliers:[],products:[],purchases:[]});
        renderAll(); showToast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
      }
    });
  }

  // ---------- Link options ----------
  function renderLinkProductsOptions(){
    const el=$('#link-products'); if(!el) return; el.innerHTML='';
    dal.products().slice().sort(byNameJa).forEach(p=>{
      const o=document.createElement('option'); o.value=p.id; o.textContent=productOptionLabel(p); el.appendChild(o);
    });
  }
  function productOptionLabel(p){ return `${p.name} / ${p.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'} ${yen(p.basePrice)} / ç¨ç‡${p.taxRate}%`; }

  // ---------- Render All ----------
  function renderAll(){
    renderSupplierOptions(); renderPurchaseProductOptions(); renderList();
    renderMasterCombos(); renderSuppliersTable(); renderProductsTable();
    setupSummaryDefaults(); renderSummary();
  }

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded',()=>{
    // tabs & basic
    (function initTabs2(){ 
      $$('.tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          $$('.tab-btn').forEach(b=>b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          $$('.panel').forEach(p=>p.classList.remove('active'));
          $('#tab-'+btn.dataset.tab).classList.add('active');
          window.scrollTo({top:0,behavior:'smooth'});
        });
      });
    })();

    initPurchase(); initMaster(); initSettings();
    setupSummaryDefaults(); renderAll();

    // Refresh button
    $('#btn-refresh')?.addEventListener('click',()=>{
      renderAll(); showToast('ç”»é¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    });

    // Service Worker
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  });
})();
</script>
</body>
</html>
