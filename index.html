<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>仕入れ管理｜MVP v0.3</title>
<style>
:root{
  --brand:#F5A623;
  --bg:#FFF9F2;
  --text:#111;
  --muted:#777;
  --card:#FFFFFF;
  --divider:#E8E2D9;
  --danger:#D0021B;
}
[data-theme="dark"]{
  --bg:#1C1C1E; --text:#F5F5F5; --muted:#BDBDBD; --card:#242426; --divider:#2C2C2E;
}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:10px 12px;display:flex;align-items:center;gap:8px}
header h1{flex:1;margin:0;text-align:center;font-size:18px;letter-spacing:.04em}
.container{padding:14px;max-width:960px;margin:0 auto}
.nav-vertical{display:flex;flex-direction:column;gap:10px;margin:10px 0}
.btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-weight:700;letter-spacing:.02em;cursor:pointer}
.btn.primary{background:var(--brand);color:#111}
.btn.ghost{background:var(--card);border:1px solid var(--divider);color:var(--text)}
.btn.danger{background:#fff;border:1px solid var(--danger);color:var(--danger)}
.btn.small{padding:8px 10px;font-weight:600}
.label{font-size:13px;color:var(--muted);margin:0 0 6px 2px}
.card{background:var(--card);border:1px solid var(--divider);border-radius:16px;padding:14px}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
input,select,textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--divider);background:var(--card);color:var(--text);padding:12px;font-size:16px}
.row{display:flex;gap:10px;align-items:center}
.row .grow{flex:1}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#EEE;color:#333;font-size:12px}
[data-theme="dark"] .pill{background:#333;color:#F0F0F0}
.section-title{font-weight:800;margin:6px 0 8px}
.fixed-bar{position:sticky;bottom:0;display:flex;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 30%);padding:12px 14px}
.fixed-bar .neg{flex:1}
.fixed-bar .pos{flex:2}
.list{display:flex;flex-direction:column;gap:8px}
.list-item{padding:10px 12px;border:1px solid var(--divider);border-radius:12px;background:var(--card)}
.muted{color:var(--muted)}
hr{border:none;border-top:1px solid var(--divider);margin:12px 0}
.ad{border:1px dashed var(--brand);background:rgba(245,166,35,.08);border-radius:12px;padding:12px}
.hidden{display:none !important}
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:12px}
.kpi .v{font-weight:800;font-size:20px}
.toggle{display:inline-flex;align-items:center;gap:8px}
a.btnlink{color:inherit;text-decoration:none;display:inline-block}
</style>
</head>
<body>
  <header>
    <button id="btnHome" class="btn ghost small hidden" type="button">← ホーム</button>
    <h1>仕入れ管理</h1>
    <span class="toggle"><input type="checkbox" id="themeToggle"><label for="themeToggle">ダーク</label></span>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="page-home">
      <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
        <span class="pill" id="pillBackup">最終バックアップ：未実施</span>
        <span class="pill" id="pillPlan">プラン：無料</span>
      </div>
      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><div class="label">今週の仕入れ合計（税込）</div><div class="v" id="kpiWeek">¥0</div></div>
        <div class="kpi"><div class="label">今月の仕入れ合計（税込）</div><div class="v" id="kpiMonth">¥0</div></div>
      </div>

      <div class="nav-vertical" style="margin-top:12px">
        <button class="btn primary" data-goto="input" type="button">仕入入力</button>
        <button class="btn ghost" data-goto="history" type="button">履歴・集計</button>
        <button class="btn ghost" data-goto="suppliers" type="button">仕入れ先マスタ</button>
        <button class="btn ghost" data-goto="products" type="button">商品マスタ</button>
        <button class="btn ghost" id="btnExport" type="button">データ出力</button>
        <button class="btn ghost" data-goto="backup" type="button">バックアップ設定</button>
        <button class="btn ghost" data-goto="license" type="button">ライセンス</button>
      </div>

      <div class="card" id="quotaCard" style="margin-top:8px">
        <div class="label">上限の目安（無料プラン）</div>
        <div>仕入れ先：<b id="qSup">0</b> / 5　｜　商品：<b id="qProd">0</b> / 50</div>
      </div>

      <div class="ad" style="margin-top:12px">
        <div class="label">【広告】</div>
        季節限定！お得な食材セットはこちら ▶
      </div>
    </section>

    <!-- INPUT -->
    <section id="page-input" class="hidden">
      <div class="card grid">
        <div class="grid cols-2">
          <div>
            <div class="label">日付</div>
            <input type="date" id="inDate">
          </div>
          <div>
            <div class="label">仕入れ先</div>
            <select id="inSupplier"></select>
          </div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="label">商品（仕入れ先で絞込）</div>
            <label class="row" style="gap:6px"><input type="checkbox" id="chkFree"> 未登録で入力</label>
          </div>
          <select id="inProduct"></select>
          <div id="freeFields" class="grid cols-2 hidden" style="margin-top:8px">
            <div>
              <div class="label">仕入れ先名（未登録）</div>
              <input id="freeSupplier" type="text" placeholder="例：臨時の市場">
            </div>
            <div>
              <div class="label">商品名（未登録）</div>
              <input id="freeProduct" type="text" placeholder="例：旬の野菜">
            </div>
          </div>
        </div>

        <div class="grid cols-2">
          <div>
            <div class="label">価格（まず価格）</div>
            <input type="number" id="inPrice" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div>
            <div class="label">数量</div>
            <input type="number" id="inQty" value="1" inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

        <div class="row">
          <div class="row" style="gap:16px">
            <label><input type="radio" name="taxmode" value="incl"> 税込</label>
            <label><input type="radio" name="taxmode" value="excl" checked> 税別</label>
          </div>
          <div class="row" style="gap:10px;margin-left:auto">
            <span class="label">税率</span>
            <label><input type="radio" name="taxrate" value="10">10%</label>
            <label><input type="radio" name="taxrate" value="8" checked>8%</label>
            <label><input type="radio" name="taxrate" value="0">非課税</label>
          </div>
        </div>

        <div>
          <div class="label">価格履歴（直近）</div>
          <div id="priceHistory" class="row" style="flex-wrap:wrap"></div>
        </div>
        <div>
          <div class="label">メモ（任意）</div>
          <input id="inMemo">
        </div>
        <button class="btn ghost" id="btnAddLine" type="button">＋ 明細を追加</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">本日の明細（仕入れ先で自動グループ）</div>
        <div id="todayList" class="list"></div>
      </div>

      <div class="fixed-bar">
        <button class="btn ghost small neg" id="btnClear" type="button">クリア</button>
        <button class="btn primary pos" id="btnSave" type="button">保存</button>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section id="page-suppliers" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="section-title">仕入れ先一覧</div>
        <button class="btn primary small" id="btnAddSupplier" type="button">＋ 追加</button>
      </div>
      <div id="supplierList" class="list"></div>
    </section>

    <!-- PRODUCTS -->
    <section id="page-products" class="hidden">
      <div class="row" style="gap:8px;align-items:center">
        <div class="grow">
          <div class="label">仕入れ先で絞込</div>
          <select id="filterProdSupplier"></select>
        </div>
        <button class="btn primary small" id="btnAddProduct" type="button">＋ 追加</button>
      </div>
      <div id="productList" class="list" style="margin-top:8px"></div>
    </section>

    <!-- HISTORY -->
    <section id="page-history" class="hidden">
      <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div>
          <div class="label">期間</div>
          <select id="hisRange">
            <option value="7">1週間</option>
            <option value="30" selected>1ヶ月</option>
          </select>
        </div>
        <div>
          <div class="label">表示</div>
          <label><input type="checkbox" id="toggleGross" checked> 税別小計+税込表示</label>
        </div>
      </div>
      <div id="historyList" class="list" style="margin-top:10px"></div>
      <div class="ad" style="margin-top:12px">
        <div class="label">【広告】</div>
        まとめ買い割引中！仕入れ先直送サービス ▶
      </div>
      <div class="fixed-bar">
        <button class="btn ghost neg" id="btnExport2" type="button">データ出力</button>
        <button class="btn primary pos" data-goto="home" type="button">ホームへ</button>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="page-backup" class="hidden">
      <div class="card">
        <div class="label">最終バックアップ</div>
        <div id="bkLast">未実施</div>
        <hr>
        <div class="label">自動バックアップ（将来拡張）</div>
        <div class="row" style="gap:16px">
          <label><input type="radio" name="bksched" value="daily" checked> 毎日22:00</label>
          <label><input type="radio" name="bksched" value="weekly"> 毎週 月曜</label>
          <label><input type="radio" name="bksched" value="manual"> 手動のみ</label>
        </div>
        <hr>
        <div class="row" style="gap:10px">
          <button class="btn primary" id="btnBackupNow" type="button">今すぐバックアップ</button>
          <button class="btn ghost" id="btnRestore" type="button">バックアップから復元</button>
          <input type="file" id="fileRestore" accept="application/json" class="hidden">
        </div>
      </div>
    </section>

    <!-- LICENSE -->
    <section id="page-license" class="hidden">
      <div class="grid" style="grid-template-columns:1fr;gap:12px">
        <div class="card">
          <h3>無料版</h3>
          <ul>
            <li>広告あり</li>
            <li>仕入れ先 5社まで／商品 合計50品まで</li>
            <li>出力は直近1か月</li>
          </ul>
          <button class="btn ghost small" type="button" disabled>使用中</button>
        </div>
        <div class="card">
          <h3>ミドル（¥700）</h3>
          <ul>
            <li>広告なし</li>
            <li>仕入れ先 20社まで／1社15品の目安</li>
            <li>出力は過去6か月</li>
          </ul>
          <button class="btn primary small" id="mockBuyMid" type="button">アップグレードする</button>
        </div>
        <div class="card">
          <h3>プロ（¥1,500）</h3>
          <ul>
            <li>広告なし</li>
            <li>上限なし</li>
            <li>出力は無制限</li>
          </ul>
          <button class="btn primary small" id="mockBuyPro" type="button">フル機能で使う</button>
        </div>
      </div>
    </section>
  </main>
<script>
// ------- Storage layer -------
const DB = {
  load: function(){
    const d = JSON.parse(localStorage.getItem("tabco-store") || "{}");
    return Object.assign({
      suppliers: [], products: [], entries: [], priceHistory: {},
      settings: { theme: "light", lastBackupAt: null, plan: "free" }
    }, d);
  },
  save: function(data){ localStorage.setItem("tabco-store", JSON.stringify(data)); }
};
let store = DB.load();

// ------- Utils -------
function fmtYMD(d){ function z(n){ return String(n).padStart(2,"0"); } return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate()); }
function yen(n){ n = Math.round(n)||0; return "¥"+n.toLocaleString(); }
function uid(){ return Math.random().toString(36).slice(2,10); }
function todayStr(){ return fmtYMD(new Date()); }
function qs(s,el){ return (el||document).querySelector(s); }
function qsa(s,el){ return Array.prototype.slice.call((el||document).querySelectorAll(s)); }

function enableSelectOnFocus(){
  qsa('input[type="number"], input[type="text"]').forEach(function(inp){
    function selAll(){ if (inp.select) { inp.select(); } }
    inp.addEventListener("focus", selAll);
    inp.addEventListener("click", selAll);
  });
}

function showPage(id){
  qsa("main section").forEach(function(s){ s.classList.add("hidden"); });
  qs("#page-"+id).classList.remove("hidden");
  if (id==="home") { qs("#btnHome").classList.add("hidden"); } else { qs("#btnHome").classList.remove("hidden"); }
  window.scrollTo(0,0);
}

// ------- Theme -------
function applyTheme(){
  document.documentElement.setAttribute("data-theme", store.settings.theme==="dark" ? "dark" : "light");
  qs("#themeToggle").checked = store.settings.theme==="dark";
}
qs("#themeToggle").addEventListener("change", function(e){
  store.settings.theme = e.target.checked ? "dark" : "light";
  DB.save(store); applyTheme();
});
qs("#btnHome").addEventListener("click", function(){ showPage("home"); });

// ------- Navigation -------
qsa("[data-goto]").forEach(function(b){
  b.addEventListener("click", function(){
    var id = b.getAttribute("data-goto");
    showPage(id);
    if (id==="history") { renderHistory(); }
  });
});

// ------- KPI / Home -------
function calcTotals(days){
  var now = new Date();
  var from = new Date(now.getTime() - (days*24*60*60*1000));
  var sum = 0;
  store.entries.forEach(function(e){
    var t = new Date(e.date+"T00:00:00");
    if (t>=from && t<=now){
      var base = e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100);
      sum += base*e.qty;
    }
  });
  return sum;
}
function refreshHome(){
  qs("#kpiWeek").textContent = yen(calcTotals(7));
  qs("#kpiMonth").textContent = yen(calcTotals(30));
  qs("#qSup").textContent = store.suppliers.filter(function(s){return !s.deleted;}).length;
  qs("#qProd").textContent = store.products.filter(function(p){return !p.deleted;}).length;
  qs("#pillPlan").textContent = "プラン："+(store.settings.plan==="free"?"無料":store.settings.plan);
  var bk = store.settings.lastBackupAt ? new Date(store.settings.lastBackupAt) : null;
  qs("#pillBackup").textContent = bk ? ("最終バックアップ："+bk.toLocaleString("ja-JP")) : "最終バックアップ：未実施";
}

// ------- Input page -------
function ensureSample(){
  if (store.suppliers.length===0){
    store.suppliers.push({id:uid(),name:"玉屋商店",contact:"山田",phone:"075-000-0000",invoice_number:"T1234567890123"});
    store.suppliers.push({id:uid(),name:"佐藤青果",contact:"佐藤",phone:"090-000-0000",invoice_number:"T0000000000000"});
    var s1=store.suppliers[0].id, s2=store.suppliers[1].id;
    store.products.push({id:uid(),supplier_id:s1,name:"牛肩ロース",default_price:2000,tax_rate:10,tax_mode:"incl"});
    store.products.push({id:uid(),supplier_id:s2,name:"トマト",default_price:180,tax_rate:8,tax_mode:"excl"});
    DB.save(store);
  }
}
function fillSupplierSelect(sel){
  sel.innerHTML="";
  store.suppliers.filter(function(s){return !s.deleted;}).forEach(function(s){
    var o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
}
function fillProductSelect(sel, supplierId){
  sel.innerHTML="";
  var list = store.products.filter(function(p){ return !p.deleted && (!supplierId || p.supplier_id===supplierId); });
  list.forEach(function(p){
    var o=document.createElement("option"); o.value=p.id; o.textContent=p.name; sel.appendChild(o);
  });
  if (list.length>0){ renderPriceHistory(list[0].id); } else { qs("#priceHistory").innerHTML=""; }
}
function renderPriceHistory(prodId){
  var wrap = qs("#priceHistory"); wrap.innerHTML="";
  var hist = (store.priceHistory[prodId] || []).slice(-3).reverse();
  hist.forEach(function(v){
    var b=document.createElement("button"); b.className="btn ghost small"; b.type="button"; b.textContent = "¥"+v.price;
    b.onclick=function(){ qs("#inPrice").value = v.price; };
    wrap.appendChild(b);
  });
}
function getSupplierNameById(id){
  var s = store.suppliers.find(function(x){ return x.id===id; });
  return s ? s.name : null;
}
function getProdName(pid, fallback){
  var p = store.products.find(function(x){ return x.id===pid; });
  return p ? p.name : (fallback || "未登録");
}

function renderTodayList(){
  var cont = qs("#todayList"); cont.innerHTML="";
  var d = todayStr();
  var group = {};
  store.entries.filter(function(x){return x.date===d;}).forEach(function(e){
    var key = e.supplier_id || e.supplier_name_fallback || "未指定";
    (group[key]=group[key]||[]).push(e);
  });
  Object.keys(group).forEach(function(k){
    var supName = getSupplierNameById(k) || k;
    var div=document.createElement("div"); div.className="list-item";
    var net=0, gross=0;
    group[k].forEach(function(e){
      var n = e.taxmode==="excl" ? e.price : (e.price/(1+e.taxrate/100));
      var g = e.taxmode==="incl" ? e.price : (e.price*(1+e.taxrate/100));
      net += n*e.qty; gross += g*e.qty;
    });
    var html = "<b>"+supName+"</b><div class=\"muted\">税別 "+yen(net)+"｜税込 "+yen(gross)+"</div>";
    html += group[k].map(function(e){
      return "<div class=\"row\" style=\"justify-content:space-between\"><span>・"+getProdName(e.product_id,e.product_name_fallback)+" ×"+e.qty+"</span><span>"+yen(e.price)+"（"+e.taxrate+"%｜"+(e.taxmode==="incl"?"税込":"税別")+"）</span></div>";
    }).join("");
    div.innerHTML = html;
    cont.appendChild(div);
  });
}

function toggleFreeInput(){
  var on = qs("#chkFree").checked;
  qs("#freeFields").classList.toggle("hidden", !on);
  qs("#inSupplier").disabled = on;
  qs("#inProduct").disabled = on;
}

function initInputPage(){
  qs("#inDate").value = todayStr();
  fillSupplierSelect(qs("#inSupplier"));
  var sid = qs("#inSupplier").value; fillProductSelect(qs("#inProduct"), sid);
  renderPriceHistory(qs("#inProduct").value);
  // default tax: excl 8%
  qsa('input[name="taxmode"]').forEach(function(r){ r.checked = (r.value==="excl"); });
  qsa('input[name="taxrate"]').forEach(function(r){ r.checked = (r.value==="8"); });
  toggleFreeInput();
}
qs("#chkFree").addEventListener("change", toggleFreeInput);

qs("#inSupplier").addEventListener("change", function(e){
  fillProductSelect(qs("#inProduct"), e.target.value); renderPriceHistory(qs("#inProduct").value);
});
qs("#inProduct").addEventListener("change", function(e){
  var p = store.products.find(function(x){ return x.id===e.target.value; });
  if (p){
    qs("#inPrice").value = p.default_price || "";
    qsa("input[name=taxrate]").forEach(function(r){ r.checked = String(p.tax_rate)===r.value; });
    qsa("input[name=taxmode]").forEach(function(r){ r.checked = (p.tax_mode || "excl")===r.value; });
    renderPriceHistory(p.id);
  }
});

qs("#btnAddLine").addEventListener("click", function(){
  var date = qs("#inDate").value || todayStr();
  var free = qs("#chkFree").checked;
  var supplier_id = free ? null : (qs("#inSupplier").value || null);
  var product_id  = free ? null : (qs("#inProduct").value || null);
  var supplier_name_fallback = free ? (qs("#freeSupplier").value || "未登録") : (getSupplierNameById(supplier_id) || "未登録");
  var product_name_fallback  = free ? (qs("#freeProduct").value  || "未登録") : null;
  var qty = Number(qs("#inQty").value || 1);
  var price = Number(qs("#inPrice").value || 0);
  var taxrate = Number(qs('input[name=taxrate]:checked').value);
  var taxmode = qs('input[name=taxmode]:checked').value;
  if (!price || !qty){ alert("価格と数量を入力してください"); return; }

  store.entries.push({id:uid(),date:date,supplier_id:supplier_id,product_id:product_id,
    supplier_name_fallback:supplier_name_fallback, product_name_fallback:product_name_fallback,
    qty:qty, price:price, taxrate:taxrate, taxmode:taxmode, memo:qs("#inMemo").value || ""});

  if (product_id){
    var arr = store.priceHistory[product_id] || [];
    arr.push({price:price, ts:Date.now(), taxrate:taxrate, taxmode:taxmode});
    store.priceHistory[product_id] = arr.slice(-5);
  }
  DB.save(store);
  renderTodayList(); refreshHome();
});

qs("#btnSave").addEventListener("click", function(){
  alert("保存しました");
  showPage("home"); refreshHome();
});
qs("#btnClear").addEventListener("click", function(){
  qs("#inQty").value=1; qs("#inPrice").value=""; qs("#inMemo").value="";
});
// ------- Export (Excel can open) -------
function exportData(){
  var dt=new Date(); var ym = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
  var rows = [["日付","仕入先","商品","数量","単価","税率","区分","税込額","メモ"]];
  store.entries.forEach(function(e){
    if (e.date.slice(0,7)===ym){
      var s = getSupplierNameById(e.supplier_id) || e.supplier_name_fallback || "";
      var p = getProdName(e.product_id, e.product_name_fallback);
      var gross = (e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100))*e.qty;
      rows.push([e.date,s,p,e.qty,e.price,e.taxrate,(e.taxmode==="incl"?"税込":"税別"),Math.round(gross),e.memo||""]);
    }
  });
  var csv = rows.map(function(r){ return r.map(function(x){ return '"' + String(x).replace(/"/g,'""') + '"'; }).join(","); }).join("\n");
  var blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
  var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="仕入れ記録_"+ym+".csv"; a.click(); URL.revokeObjectURL(a.href);
  alert("出力しました（Excelで開けます）");
}
qs("#btnExport").addEventListener("click", exportData);
qs("#btnExport2").addEventListener("click", exportData);

// ------- Backup / Restore -------
function backupNow(){
  var payload = {version:"1.0", exported_at:new Date().toISOString(), tables:{
    suppliers:store.suppliers, products:store.products, entries:store.entries, priceHistory:store.priceHistory, settings:store.settings
  }};
  var blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tabco_backup_"+fmtYMD(new Date())+".json"; a.click(); URL.revokeObjectURL(a.href);
  store.settings.lastBackupAt = Date.now(); DB.save(store); refreshHome(); qs("#bkLast").textContent = new Date(store.settings.lastBackupAt).toLocaleString("ja-JP");
}
qs("#btnBackupNow").addEventListener("click", backupNow);
qs("#btnRestore").addEventListener("click", function(){ qs("#fileRestore").click(); });
qs("#fileRestore").addEventListener("change", function(e){
  var file = e.target.files[0]; if (!file) return;
  if (!confirm("バックアップから復元します。現在のデータは置き換えられます。続行しますか？")) return;
  var reader = new FileReader();
  reader.onload = function(){
    try{
      var data = JSON.parse(reader.result);
      if (!data.tables) throw new Error("invalid");
      store.suppliers=data.tables.suppliers||[];
      store.products=data.tables.products||[];
      store.entries=data.tables.entries||[];
      store.priceHistory=data.tables.priceHistory||{};
      store.settings=data.tables.settings||store.settings;
      DB.save(store);
      alert("復元しました");
      applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); fillFilterSupplier(); renderProducts(); renderHistory(); showPage("home"); enableSelectOnFocus();
    }catch(err){
      alert("復元に失敗しました。ファイルをご確認ください。");
    }
  };
  reader.readAsText(file);
});

// ------- License (mock) -------
function setPlan(p){ store.settings.plan=p; DB.save(store); refreshHome(); alert("プランが更新されました（デモ）"); }
qs("#mockBuyMid").addEventListener("click", function(){ setPlan("middle"); });
qs("#mockBuyPro").addEventListener("click", function(){ setPlan("pro"); });

// ------- Init -------
function init(){
  ensureSample(); applyTheme(); refreshHome();
  initInputPage(); renderTodayList(); enableSelectOnFocus();
  renderSuppliers(); fillFilterSupplier(); renderProducts();
}
init();
showPage("home");

// NOTE: Service Worker はテスト安定化のため登録しません（干渉防止）
</script>
</body>
</html>
