<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>仕入れ管理アプリ v22</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{ --gap:8px; }
  body { font-family: system-ui, sans-serif; margin: 10px; padding-bottom: 86px; }
  h2 { margin: 14px 0; }
  input, select, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
  label { display: block; margin: 8px 0 4px; }
  .row { display: flex; gap: var(--gap); flex-wrap: wrap; }
  .row > * { flex: 1; min-width: 110px; }
  button { background: #16a34a; color: #fff; border: none; border-radius: 8px; cursor:pointer; }
  button:hover { background:#12833c; }
  .link { background:#2563eb; }
  .link:hover { background:#1f4ec0; }
  .ghost { background:#e5e7eb; color:#111; }
  .ghost:hover { background:#d1d5db; }
  .danger { background:#ef4444; }
  .danger:hover { background:#c53737; }

  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; word-break: break-all; }
  th { position: sticky; top: 0; background:#fff; z-index: 1; }
  .nav { display:flex; gap:var(--gap); margin-bottom:10px; align-items:center; }
  .radio-group { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .small { font-size: 12px; color:#666; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .chip { border:1px solid #ccc; padding:6px 10px; border-radius:999px; }
  .muted { color:#666; font-size:12px; }
  .nowrap { white-space:nowrap; }
  #page-entry { position: relative; z-index: 1; }

  .table-wrap {
    max-height: 48vh;
    overflow: auto;
    border:1px solid #e5e7eb;
    border-radius:8px;
    position: relative; z-index: 1;
    background:#fff;
  }

  /* カード表示 */
  .list-head { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
  .view-switch { display:inline-flex; gap:8px; align-items:center; font-size:12px; color:#555; }
  .filter-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .filter-row > * { flex: 0 0 auto; }
  .filter-chip { font-size:12px; color:#555; }

  .cards { display:flex; flex-direction:column; gap:8px; position: relative; z-index: 1; }
  .card {
    border:1px solid #e5e7eb; border-radius:8px; padding:8px;
    background:#fff;
  }
  .card-top { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .card-top .primary { font-weight:700; }
  .card-meta {
    display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:4px; flex-wrap:wrap;
  }
  .meta-left { display:flex; gap:10px; flex-wrap:wrap; color:#555; font-size:13px; }
  .meta-right { display:flex; gap:6px; align-items:center; }
  .total { font-weight:700; }
  .card .actions button { padding:6px 8px; }
  .lines { margin-top:6px; }
  .line { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-top:1px dashed #e5e7eb; font-size:14px; }
  .line:first-child { border-top:none; }

  /* モーダル */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; }
  .modal-content {
    background:#fff; margin:6% auto; padding:12px; width:92%; max-width:640px; border-radius:10px;
    max-height:90vh; overflow:auto; padding-bottom:96px;
  }
  .checkbox-grid {
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;
    max-height:50vh; overflow:auto; padding-right:4px;
  }
  .actions {
    display:flex; gap:8px; justify-content:center;
    position:sticky; bottom:0; background:#fff; padding:8px 0;
    box-shadow: 0 -4px 10px rgba(0,0,0,.04); z-index:60;
  }
  .modal-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }

  /* 画面下固定アクションバー */
  .fab-bar {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 10;
    background: #fff; border-top: 1px solid #e5e7eb;
    padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    box-shadow: 0 -6px 20px rgba(0,0,0,.06);
  }
  .fab-inner { display: flex; gap: 8px; max-width: 560px; margin: 0 auto; }
  .fab-inner > * { flex: 1; }

  /* 合計ボックス */
  .sum-box { border:1px solid #e5e7eb; border-radius:8px; padding:8px; margin-top:10px; background:#fafafa; }

  /* itemTable 操作列 */
  .col-actions { width: 120px; }
  .actions-cell { display:flex; gap:8px; justify-content:center; }
  .btn-edit{ background:#e5e7eb; color:#111; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
  .btn-edit:hover{ background:#d1d5db; }
  .btn-del{ background:#ef4444; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
  .btn-del:hover{ background:#dc2626; }

  /* 一括マスタ：商品行 */
  .product-row { display:grid; grid-template-columns: 1.4fr 0.8fr 0.7fr 0.7fr auto; gap:8px; align-items:center; }
  .product-row small { color:#666; }
  /* ===== v22.1: モバイル最適化・横書き整形パッチ ===== */

/* 1) ボタンは横並びでコンパクトに（共通幅100%を解除） */
button { width: auto !important; }

/* 2) ナビを“横書き×すっきり”に。2段まで自動改行、横スライド不要 */
.nav{
  display: grid !important;
  grid-auto-flow: column;
  grid-auto-columns: 1fr;
  gap: 8px;
  /* 画面幅に収める */
  overflow-x: clip;
}
@media (max-width: 420px){
  .nav{
    /* 1行に収まらない場合は自動で2行に折り返し */
    grid-auto-flow: row;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
  }
}
.nav button{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 600;
  line-height: 1.1;
}

/* 3) 入力フォームの横スクロールを根絶 */
html, body { overflow-x: hidden; }
.row { flex-wrap: wrap; }
.row > * { min-width: 0; } /* セレクトやボタンがはみ出さない */

/* 4) カード内の「編集/削除」を小さなピル型に */
.card .actions button,
.line button{
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 14px;
}
.line .row{ gap: 6px !important; flex-wrap: nowrap; }

/* 5) 一覧カードの見た目をタイトに */
.card{ border-radius: 12px; }
.card-top{ align-items:center; }
.card-meta{ gap: 6px; }
.meta-left{ font-size: 13px; gap: 12px; }
.total{ font-size: 16px; }

/* 6) 下部固定バー：高さを少し絞って親指タップしやすく */
.fab-bar{ padding: 8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left); }
.fab-inner > * { min-width: 0; }
.fab-inner button{ padding: 10px 12px; border-radius: 10px; }

/* 7) テーブル時のはみ出し対策 */
.table-wrap{ max-width: 100vw; }

/* 8) アイコン風の強調（任意） */
.link{ box-shadow: 0 1px 2px rgba(0,0,0,.06); }
.ghost{ box-shadow: inset 0 0 0 1px #d1d5db; }
.danger{ box-shadow: 0 1px 2px rgba(239, 68, 68, .25); }
/* --- ① 数量と単価の並びを逆に（単価→数量） --- */
/* 数量・単価を包む行に .row-qty-price を付ける前提（下のHTML修正参照） */
.row-qty-price > div:nth-child(1){ order:2; } /* もとの1列目=数量を後ろへ */
.row-qty-price > div:nth-child(2){ order:1; } /* もとの2列目=単価を前へ  */

/* --- ② チェックボックス/ラジオの“文字を真下”に揃える ― 共通ユーティリティ --- */
/* ラッパーに .choice-v を付ける前提（下のHTML修正参照） */
.choice-v label{
  display:flex; flex-direction:column; align-items:center;
  gap:4px; line-height:1.1; margin:0 8px;
}
.choice-v input{ margin:0; }  /* ずれ防止 */
.view-switch.choice-v{ justify-content:flex-end; } /* 表/カード切替の右寄せを維持 */

/* --- ③ まとめて登録フォーム（商品行）の行間を圧縮し、税率は横並びに --- */
/* まとめて登録の“1商品ぶんの行”に .bulk-row を付ける前提（付けられない場合は親に .bulk-area） */
.bulk-row{ display:grid; grid-template-columns: 1.3fr 0.9fr 0.9fr auto; gap:8px; align-items:center; }
.bulk-row .tax-radios{ display:flex; gap:14px; align-items:center; }   /* 8% / 10% を横並びに */
.bulk-row label{ margin:0; }

/* 行間を約半分に（既存が大きい端末向け） */
.bulk-area .bulk-row + .bulk-row{ margin-top:8px; }  /* 以前より詰める */

/* --- ④ 基準価格・税のフィールドをわかりやすく --- */
.bulk-row input[type="number"]{ min-width: 110px; }  /* 基準価格を少し広く */
.bulk-row select{ min-width: 92px; }                 /* 税（税別/税込）の選択幅 */

/* エントリー側の“税率 8%/10%”も縦ズレ解消（既存idを流用） */
#baseRateRadios.choice-v label{ margin:0 10px; }
/* ラベルの文字をチェックの真下に */
.choice-v label{
  display:flex; flex-direction:column; align-items:center;
  gap:4px; line-height:1.1; margin:0 8px;
}
.choice-v input{ margin:0; } /* 微妙なズレ防止 */

</style>
</head>
<body>

<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">仕入れ入力</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">電話帳</button>
  <button type="button" onclick="showPage('masters')" class="ghost">マスタ管理</button>
  <button type="button" onclick="openBulkMaster()" class="link">🧩 一括マスタ登録</button>
  <button type="button" onclick="openSettings()" class="ghost">⚙ 設定</button>
  <span id="appVersion" class="muted" style="margin-left:auto;">v22.0</span>
  <button type="button" class="link" onclick="forceUpdateSW()">🔄 更新</button>
</div>

<!-- 仕入れ入力 -->
<section id="page-entry">
  <h2>仕入れ入力</h2>
  <label>日付</label>
  <input type="date" id="inDate">

  <label>仕入先 <span class="muted">（選択すると紐付く商品のみ表示）</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" onclick="openSupplierModal()">＋ 仕入先追加</button>
  </div>
  <div id="supplierQuick" class="row" style="margin:6px 0; display:none; align-items:center;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">📞 この仕入先に電話</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">📋 電話番号コピー</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>商品名</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" onclick="openItemModal()">＋ 商品追加</button>
  </div>

  <div class="row row-qty-price">
    <div>
      <label>数量</label>
      <input type="number" id="inQty" value="1" step="0.1" min="0" onfocus="this.select()">
    </div>
    <div>
      <label>単価</label>
      <input type="number" id="inPrice" value="0" step="1" min="0" onfocus="this.select()">
    </div>
  </div>

  <label>税区分</label>
  <div class="radio-group choice-v">
    <label><input type="radio" name="inTax" value="taxIncluded"> 税込</label>
    <label><input type="radio" name="inTax" value="taxExcluded" checked> 税別</label>
    <span class="muted">基本税率：<b id="lblRate"></b>%（設定で変更）</span>
  </div>

  <label style="margin-top:6px;">税率（8% / 10% クイック切替）</label>
  <div class="radio-group choice-v" id="baseRateRadios">
    <label><input type="radio" name="baseRateChoice" value="8" checked> 8%</label>
    <label><input type="radio" name="baseRateChoice" value="10"> 10%</label>
    <span class="small">※ 以後の計算・カード集計の「合計」に使う税率。</span>
  </div>

  <h3 class="list-head" style="margin-top:16px;">
    <span>仕入れ一覧</span>
    <span class="view-switch choice-v">
      表示：
      <label><input type="radio" name="viewMode" value="table"> 表</label>
      <label><input type="radio" name="viewMode" value="cards" checked> カード</label>
      <label style="margin-left:10px;">
        <input type="checkbox" id="toggleAll" onchange="toggleAllRows(this)"> 全件表示（デフォルト：最新50件）
      </label>
    </span>
  </h3>

  <!-- 月フィルター -->
  <div class="filter-row" style="margin:6px 0 10px;">
    <label class="muted" style="margin:0;">月フィルター</label>
    <input type="month" id="filterMonth" style="width:auto;">
    <button type="button" class="ghost" onclick="setThisMonth()">今月</button>
    <button type="button" class="ghost" onclick="clearMonthFilter()">解除</button>
    <button type="button" class="ghost" onclick="toggleMonthlySummary()">仕入先別・月合計</button>
    <span id="activeFilter" class="filter-chip"></span>
  </div>

  <!-- 仕入先別・月合計 -->
  <div id="monthlyBox" class="sum-box" style="display:none;">
    <div class="row" style="align-items:center;">
      <div class="muted" style="flex:0 0 auto;">集計月：</div>
      <div id="summaryMonthLabel" style="flex:0 0 auto; font-weight:700;"></div>
      <div style="flex:1;"></div>
      <button type="button" class="ghost" style="flex:0 0 auto;" onclick="downloadSupplierMonthlyCSV()">CSV</button>
    </div>
    <div class="table-wrap" style="max-height:30vh; margin-top:8px;">
      <table>
        <thead><tr><th>仕入先</th><th>合計（円）</th><th>件数</th></tr></thead>
        <tbody id="monthlyBody"></tbody>
      </table>
    </div>
  </div> 
 
  <!-- 表 -->
  <div class="table-wrap" id="wrap-table" style="display:none;">
    <table id="listTable">
      <thead>
        <tr><th>日付</th><th>仕入先</th><th>商品</th><th>数量</th><th>単価</th><th>税区分</th><th>計算税率</th><th>合計</th><th>操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- カード表示（同日×同仕入先で集約） -->
  <div id="wrap-cards" class="cards"></div>

  <div class="row" style="margin-top:10px;">
    <button type="button" class="link" onclick="downloadCSV()">CSV ダウンロード（全期間）</button>
    <button type="button" class="ghost" onclick="wipeAll()">全データ初期化</button>
  </div>

  <!-- バックアップ / 復元 -->
  <div class="row" style="margin-top:6px;">
    <button type="button" class="link"  onclick="backupJSON()">バックアップ</button>
    <button type="button" class="ghost" onclick="openRestoreChooser()">復元</button>
  </div>

  <!-- 復元モーダル -->
  <div id="restoreChooser" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>復元</h3>
        <button type="button" class="ghost" onclick="closeModal('restoreChooser')">✕</button>
      </div>
      <p class="small" id="lastBackupHint" style="margin:6px 0;"></p>
      <div class="row" style="margin-top:8px;">
        <button type="button" onclick="quickRestore(); closeModal('restoreChooser')">直近バックアップから復元</button>
        <button type="button" class="ghost" onclick="restoreFromFile(); closeModal('restoreChooser')">ファイルから復元</button>
      </div>
      <div class="small" style="margin-top:6px;">
        うまく開けない時は
        <a href="javascript:void(0)" onclick="forceFileRestore(); closeModal('restoreChooser')">こちら</a>
      </div>
    </div>
  </div>

  <!-- 画面には出さないが、旧環境向けのファイル入力 -->
  <input id="restoreInput" type="file" accept="application/json" style="display:none"
        onchange="if(this.files[0]) restoreJSON(this.files[0])">

</section>

<!-- 電話帳 -->
<section id="page-phonebook" style="display:none;">
  <h2>仕入先電話帳</h2>
  <table id="phoneTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- マスタ管理 -->
<section id="page-masters" style="display:none;">
  <h2>マスタ一覧</h2>

  <h3>仕入先</h3>
  <table id="supTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>商品（紐付け先）</h3>
  <table id="itemTable">
    <thead><tr><th>商品名</th><th>基準価格</th><th>税区分</th><th>税率</th><th>紐付け仕入先</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- 仕入れ編集モーダル -->
<div id="purchaseEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入れ編集</h3>
      <button type="button" class="ghost" onclick="closeModal('purchaseEditModal')">✕</button>
    </div>
    <input type="hidden" id="editPurchaseIndex">
    <label>日付</label>
    <input type="date" id="editDate">
    <label>仕入先</label>
    <select id="editSupplier"></select>
    <label>商品</label>
    <select id="editItem"></select>
    <div class="row">
      <div>
        <label>数量</label>
        <input type="number" id="editQty" step="0.1" min="0">
      </div>
      <div>
        <label>単価</label>
        <input type="number" id="editPrice" step="1" min="0">
      </div>
    </div>
    <label>税区分</label>
    <div class="radio-group">
      <label><input type="radio" name="editTax" value="taxIncluded"> 税込</label>
      <label><input type="radio" name="editTax" value="taxExcluded"> 税別</label>
    </div>
    <label>計算税率（8%/10%）</label>
    <div class="radio-group">
      <label><input type="radio" name="editRate" value="0.08"> 8%</label>
      <label><input type="radio" name="editRate" value="0.10"> 10%</label>
    </div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updatePurchase()">保存</button>
      <button type="button" class="danger" onclick="deletePurchase()">削除</button>
    </div>
  </div>
</div>

<!-- 仕入先/商品モーダル（従来） -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先追加</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">✕</button>
    </div>
    <label>社名</label>
    <input id="supName" type="text" placeholder="例）Aフーズ">
    <label>担当者</label>
    <input id="supContact" type="text" placeholder="例）山田さん">
    <label>電話番号</label>
    <input id="supPhone" type="tel" placeholder="090-1234-5678">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addSupplier()">登録</button>
      <button type="button" class="ghost" onclick="resetSupplierForm()">クリア</button>
    </div>
  </div>
</div>

<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先編集</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">✕</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>社名</label>
    <input id="editSupName" type="text">
    <label>担当者</label>
    <input id="editSupContact" type="text">
    <label>電話番号</label>
    <input id="editSupPhone" type="tel">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateSupplier()">保存</button>
      <button type="button" class="danger" onclick="deleteSupplier()">削除</button>
    </div>
  </div>
</div>

<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品追加</h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">✕</button>
    </div>
    <label>商品名</label>
    <input id="itName" type="text" placeholder="例）国産もも肉 2kg">
    <div class="row">
      <div>
        <label>基準価格（任意）</label>
        <input id="itPrice" type="number" placeholder="0">
      </div>
      <div>
        <label>税区分</label>
        <select id="itTax">
          <option value="taxExcluded" selected>税別</option>
          <option value="taxIncluded">税込</option>
        </select>
      </div>
    </div>
    <label>税率</label>
    <div class="radio-group" id="itRateGroup">
      <label><input type="radio" name="itRate" value="0.08" checked> 8%</label>
      <label><input type="radio" name="itRate" value="0.10"> 10%</label>
    </div>
    <label>紐付け仕入先（複数可）</label>
    <div id="itSuppliers" class="checkbox-grid"></div>
    <div class="small">※ 複数の仕入先から購入可能な商品に対応します。</div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addItem()">登録</button>
      <button type="button" class="ghost" onclick="resetItemForm()">クリア</button>
    </div>
  </div>
</div>

<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品編集</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">✕</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>商品名</label>
    <input id="editItName" type="text">
    <div class="row">
      <div>
        <label>基準価格（任意）</label>
        <input id="editItPrice" type="number">
      </div>
      <div>
        <label>税区分</label>
        <select id="editItTax">
          <option value="taxExcluded">税別</option>
          <option value="taxIncluded">税込</option>
        </select>
      </div>
    </div>
    <label>税率</label>
    <div class="radio-group" id="editItRateGroup">
      <label><input type="radio" name="editItRate" value="0.08"> 8%</label>
      <label><input type="radio" name="editItRate" value="0.10"> 10%</label>
    </div>
    <label>紐付け仕入先（複数可）</label>
    <div id="editItSuppliers" class="checkbox-grid"></div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateItem()">保存</button>
      <button type="button" class="danger" onclick="deleteItem()">削除</button>
    </div>
  </div>
</div>

<!-- 一括マスタ登録モーダル（仕入先＋複数商品） -->
<div id="bulkMasterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>一括マスタ登録（仕入先＋複数商品）</h3>
      <button type="button" class="ghost" onclick="closeModal('bulkMasterModal')">✕</button>
    </div>
    <h4>仕入先</h4>
    <label>社名</label>
    <input id="bmSupName" type="text" placeholder="例）B水産">
    <div class="row">
      <div>
        <label>担当者</label>
        <input id="bmSupContact" type="text">
      </div>
      <div>
        <label>電話番号</label>
        <input id="bmSupPhone" type="tel">
      </div>
    </div>
    <h4 style="margin-top:12px;">商品（複数行追加可）</h4>
    <div id="bmProducts" style="display:flex; flex-direction:column; gap:10px;"></div>
    <div class="row" style="margin-top:6px;">
      <button type="button" class="ghost" onclick="bmAddRow()">＋ 行を追加</button>
      <button type="button" class="ghost" onclick="bmClearRows()">行を全クリア</button>
    </div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="bmSubmit()">まとめて登録</button>
    </div>
    <div class="small" style="margin-top:6px;">※ 登録後、この仕入先に紐付いた商品としてマスタに反映されます。</div>
  </div>
</div>

<!-- 設定モーダル -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>設定</h3>
      <button type="button" class="ghost" onclick="closeModal('settingsModal')">✕</button>
    </div>
    <label>基本税率（8% または 10%）</label>
    <div class="radio-group">
      <label><input type="radio" name="baseRatePreset" value="8"> 8%</label>
      <label><input type="radio" name="baseRatePreset" value="10"> 10%</label>
    </div>
    <div class="row" style="margin-top:8px;">
      <button type="button" onclick="saveBaseTaxRate()">保存</button>
      <button type="button" class="ghost" onclick="resetBaseTaxRate()">8%に戻す</button>
    </div>
    <div class="small" style="margin-top:4px;">※ この設定は税別計算に適用され、税込はそのままの金額になります。</div>
  </div>
</div>

<!-- 画面下固定アクションバー -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" onclick="savePurchase()">保存</button>
    <button type="button" class="ghost" onclick="clearEntry()">入力クリア</button>
  </div>
</div>

<script>
/* ====== バージョン ====== */
const APP_VERSION = 'v22.2';
document.addEventListener('DOMContentLoaded', ()=>{
  const el = document.getElementById('appVersion');
  if (el) el.textContent = APP_VERSION;
});

/* ====== 永続化 ====== */
const LS_KEYS = {
  suppliers: 'suppliers_v2',
  items: 'items_v3',            // v22: 税率フィールド追加
  purchases: 'purchases_v3',    // v22: 行ごとの計算税率を保持
  taxRate: 'base_tax_rate_v1'
};
const LS_LAST_BACKUP = 'last_backup_json_v1';

const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

/* ====== 状態 ====== */
let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = migrateItems(JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]'));
let purchases = migratePurchases(JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]'));

/* ====== 表示制御 ====== */
let SHOW_ALL = false;
let VIEW_MODE = 'cards'; // 'cards' or 'table'
let FILTER_MONTH = '';   // 'YYYY-MM' or ''

/* ====== 税率（基本） ====== */
function getBaseTaxRate(){ const v = localStorage.getItem(LS_KEYS.taxRate); return v==null ? 0.08 : Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate, String(decimal)); updateTaxRateLabel(); renderBaseRateRadios(); }
function updateTaxRateLabel(){ $('lblRate').textContent = Math.round(getBaseTaxRate()*1000)/10; }
function renderBaseRateRadios(){
  const pct = Math.round(getBaseTaxRate()*100);
  const target = pct===10 ? '10' : '8';
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  radios.forEach(r=>{
    r.checked = (r.value === target);
    r.onchange = ()=> setBaseTaxRate(Number(r.value)/100);
  });
}
function ensureBaseRateChecked(){
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  const any = Array.from(radios).some(r => r.checked);
  if(!any){
    const pct = Math.round(getBaseTaxRate()*100);
    const target = pct===10 ? '10' : '8';
    const r = document.querySelector(`input[name="baseRateChoice"][value="${target}"]`);
    if(r) r.checked = true;
  }
}

/* ====== マイグレーション ====== */
function migrateItems(arr){
  // 旧v2→v3: item.taxRate を追加（既定0.08）、taxType既定は保持
  return (arr||[]).map(it => {
    if (it.taxRate==null) it.taxRate = 0.08;
    if (!it.taxType) it.taxType = 'taxExcluded';
    return it;
  });
}
function migratePurchases(arr){
  // 旧v2→v3: purchase.taxRate を追加（保存時の基本税率が分からなければ 0.08 を推定）
  return (arr||[]).map(p => {
    if (p.taxRate==null) p.taxRate = getBaseTaxRate() || 0.08;
    return p;
  });
}

/* ====== ページ切替 ====== */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block':'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block':'none';
  $('page-masters').style.display = which==='masters' ? 'block':'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters')  { renderSupTable(); renderItemTable(); }
  if(which==='entry')    ensureBaseRateChecked();
}

/* ====== 初期描画 ====== */
function init(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = ('0'+(today.getMonth()+1)).slice(-2);
  const dd = ('0'+today.getDate()).slice(-2);
  $('inDate').value = `${yyyy}-${mm}-${dd}`;

  const defTax = document.querySelector('input[name="inTax"][value="taxExcluded"]');
  if(defTax) defTax.checked = true;

  const fm = $('filterMonth');
  if (fm){
    fm.onchange = ()=>{ FILTER_MONTH = fm.value || ''; renderList(); updateActiveFilterLabel(); renderSupplierMonthly(); };
  }
  updateActiveFilterLabel();

  const vm = document.querySelectorAll('input[name="viewMode"]');
  vm.forEach(r => r.onchange = ()=>{ VIEW_MODE = r.value; renderList(); });

  renderSupplierSelect();
  renderItemSelect();
  renderList();
  updateTaxRateLabel();
  renderBaseRateRadios();
  ensureBaseRateChecked();
  renderSupplierMonthly();
}
document.addEventListener('DOMContentLoaded', init);

// PWA: Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try{
      // HTTPキャッシュを使わずに sw.js を取得
      const reg = await navigator.serviceWorker.register('./sw.js?ver=22.2', {
        updateViaCache: 'none'
      });
      // 画面復帰時にも更新確認
      document.addEventListener('visibilitychange', ()=>{
        if (document.visibilityState === 'visible') reg.update();
      });
    }catch(e){}
  });
}
/* ====== セレクタ描画 ====== */
function renderSupplierSelect(){
  const sel = $('inSupplier');
  sel.innerHTML = '<option value="">-- 仕入先を選択 --</option>' + suppliers.map(s=> `<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange = ()=>{ renderItemSelect(sel.value); updateSupplierQuick(sel.value); };
}
function updateSupplierQuick(supplierId){
  const wrap = $('supplierQuick');
  if(!supplierId){ wrap.style.display='none'; return; }
  const s = suppliers.find(x=>x.id===supplierId); if(!s){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  const phone = s.phone || ''; const telHref = phone ? `tel:${phone}` : '';
  $('supplierPhoneView').textContent = phone ? `電話番号：${phone}` : '電話番号未登録';
  $('btnCallSupplier').onclick = ()=>{ if(!phone){ alert('電話番号が未登録です'); return; } window.location.href = telHref; };
  $('btnCopySupplier').onclick = ()=> copyPhone(phone);
}
function renderItemSelect(supplierId=''){
  const sel = $('inItem');
  let list = items;
  if(supplierId){ list = items.filter(it => (it.suppliers||[]).includes(supplierId)); }
  sel.innerHTML = '<option value="">-- 商品を選択 --</option>' + list.map(i=> `<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange = ()=>{
    const it = items.find(x=>x.id===sel.value);
    if(it){
      const last = getLastPriceFor($('inSupplier').value, it.id);
      if (last!=null) $('inPrice').value = last;
      else if (it.price!=null) $('inPrice').value = it.price;

      // 商品の既定税区分・税率を入力UIへ反映
      const defaultTax = it.taxType || 'taxExcluded';
      const tsel = document.querySelector('input[name="inTax"][value="'+ defaultTax +'"]');
      if (tsel) tsel.checked = true;

      // クイック税率を商品側の税率に同期
      setBaseTaxRate(it.taxRate || 0.08);
    }
  };
}

/* ====== 入力エリア ====== */
function clearEntry(){
  $('inItem').value = ''; $('inQty').value = 1; $('inPrice').value = 0;
  const r = document.querySelector('input[name="inTax"][value="taxExcluded"]');
  if (r) r.checked = true;
}

/* ====== 直近価格取得 ====== */
function getLastPriceFor(supplierId, itemId){
  for (let i = purchases.length - 1; i >= 0; i--) {
    const p = purchases[i];
    if (p.supplierId === supplierId && p.itemId === itemId) return p.price;
  }
  return null;
}

/* ====== 保存・計算 ====== */
function currentBaseRate(){ return getBaseTaxRate(); }

function savePurchase(){
  const date = $('inDate').value;
  const supplierId = $('inSupplier').value;
  const itemId = $('inItem').value;
  const qty = Number($('inQty').value || 0);
  const price = Number($('inPrice').value || 0);
  const selTax = document.querySelector('input[name="inTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';
  const rateUsed = currentBaseRate();

  if(!date) return alert('日付を入力してください');
  if(!supplierId) return alert('仕入先を選択してください');
  if(!itemId) return alert('商品を選択してください');

  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rateUsed)) : Math.round(qty*price);

  purchases.push({date, supplierId, itemId, qty, price, taxType, taxRate: rateUsed, total});
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  clearEntry(); renderList(); renderSupplierMonthly();
}

/* ====== 一覧・集計 ====== */
function toggleAllRows(chk){ SHOW_ALL = chk.checked; renderList(); }
function getFilteredArray(){
  let arr = purchases.slice().map((p,idx)=>({p, idx})).reverse();
  if (FILTER_MONTH) arr = arr.filter(({p}) => (p.date||'').slice(0,7) === FILTER_MONTH);
  return SHOW_ALL ? arr : arr.slice(0,50);
}
function renderList(){
  const wrapTable = document.getElementById('wrap-table');
  const wrapCards = document.getElementById('wrap-cards');
  if (VIEW_MODE === 'table') {
    wrapTable.style.display = 'block';
    wrapCards.style.display = 'none';
    renderListTable();
  } else {
    wrapTable.style.display = 'none';
    wrapCards.style.display = 'block';
    renderListCardsGrouped();
  }
}
function renderListTable(){
  const tb = $('listTable').querySelector('tbody'); tb.innerHTML = '';
  const list = getFilteredArray();
  list.forEach(({p, idx:origIndex})=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.date}</td>
      <td>${s ? s.name : ''}</td>
      <td>${i ? i.name : ''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'税別':'税込'}</td>
      <td>${Math.round((p.taxRate||0.08)*100)}%</td>
      <td>${p.total}</td>
      <td class="nowrap">
        <button class="ghost" style="padding:6px 8px;" onclick="openPurchaseEdit(${origIndex})">編集</button>
        <button class="danger" style="padding:6px 8px;" onclick="deletePurchaseAt(${origIndex})">削除</button>
      </td>`;
    tb.appendChild(tr);
  });
}

// === v22: カード表示を「同一日×同一仕入先」で集約し、税別小計＋指定税率合計を表示 ===
function renderListCardsGrouped(){
  const box = document.getElementById('wrap-cards'); box.innerHTML = '';
  const list = getFilteredArray();

  // グループ化キー: date|supplierId
  const map = new Map();
  list.forEach(({p, idx})=>{
    const key = `${p.date}|${p.supplierId}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push({p, idx});
  });

  const baseRate = currentBaseRate();
  const baseRatePct = Math.round(baseRate*100);

  // 新しい順に表示（listは逆順）
  Array.from(map.entries()).forEach(([key, rows])=>{
    const [date, supId] = key.split('|');
    const s = suppliers.find(x=>x.id===supId);
    const supName = s ? s.name : '';

    // 税別小計：各行を税抜に統一（行の保存時税率を使う）
    let exSubtotal = 0;
    rows.forEach(({p})=>{
      if (p.taxType === 'taxExcluded') exSubtotal += p.qty * p.price;
      else {
        const r = p.taxRate || 0.08;
        exSubtotal += (p.qty * p.price) / (1 + r);
      }
    });
    exSubtotal = Math.round(exSubtotal);

    const taxedTotal = Math.round(exSubtotal * (1 + baseRate));

    // カード描画
    const card = document.createElement('div');
    card.className = 'card';

    // 行詳細（中段）
    const linesHTML = rows.map(({p, idx})=>{
      const i = items.find(x=>x.id===p.itemId);
      const itName = i ? i.name : '';
      const lineRight = `
        <span>${p.qty} × ${p.price}</span>
        <span class="muted">${p.taxType==='taxExcluded'?'税別':'税込'}（${Math.round((p.taxRate||0.08)*100)}%）</span>
        <button class="ghost" onclick="openPurchaseEdit(${idx})">編集</button>
        <button class="danger" onclick="deletePurchaseAt(${idx})">削除</button>
      `;
      return `<div class="line"><div>${itName}</div><div class="row" style="gap:8px; justify-content:flex-end; flex-wrap:nowrap;">${lineRight}</div></div>`;
    }).join('');

    card.innerHTML = `
      <div class="card-top">
        <div>${date}</div>
        <div class="primary">${supName}</div>
        <div class="muted">明細 ${rows.length} 件</div>
      </div>
      <div class="card-meta">
        <div class="meta-left">
          <span>税別小計：<b>${exSubtotal.toLocaleString()}</b> 円</span>
          <span>合計（${baseRatePct}%）：<b class="total">${taxedTotal.toLocaleString()}</b> 円</span>
        </div>
        <div class="meta-right small muted">
          ※「合計」の税率は画面の8%/10%切替に連動
        </div>
      </div>
      <div class="lines">
        ${linesHTML}
      </div>
    `;
    box.appendChild(card);
  });

  if (map.size===0){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'データがありません';
    box.appendChild(empty);
  }
}

/* ====== CSV ====== */
function downloadCSV(){
  let csv = '日付,仕入先,商品,数量,単価,税区分,計算税率,合計\n';
  purchases.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    csv += `${p.date},${s?s.name:''},${i?i.name:''},${p.qty},${p.price},${p.taxType==='taxExcluded'?'税別':'税込'},${Math.round((p.taxRate||0.08)*100)}%,${p.total}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = '仕入れデータ.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== バックアップ／復元 ====== */
async function backupJSON(){
  const fileName = `shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const data = {
    version: 2,
    savedAt: new Date().toISOString(),
    suppliers, items, purchases,
    taxRate: localStorage.getItem(LS_KEYS.taxRate)
  };
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const file = new File([blob], fileName, {type:'application/json'});

  try { localStorage.setItem(LS_LAST_BACKUP, json); } catch(_) {}

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ title: '仕入れバックアップ', text: 'バックアップJSONです。', files: [file] });
      alert('バックアップを保存しました'); return;
    } catch(e) { if (e.name === 'AbortError') return; }
  }
  if ('showSaveFilePicker' in window) {
    try{
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description:'JSON', accept:{ 'application/json': ['.json'] } }]
      });
      const w = await handle.createWritable(); await w.write(blob); await w.close();
      alert('バックアップを保存しました'); return;
    }catch(e){ if (e.name === 'AbortError') return; }
  }
  try{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
    URL.revokeObjectURL(a.href);
    alert('JSONをダウンロードしました。');
  }catch(e){
    alert('バックアップに失敗しました: ' + e.message);
  }
}
async function restoreFromFile(){
  try{
    if ('showOpenFilePicker' in window) {
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: 'JSONバックアップ', accept: { 'application/json': ['.json'] } }]
      });
      const f = await handle.getFile(); const text = await f.text();
      const data = JSON.parse(text);
      _applyRestore(data);
      alert('復元しました'); return;
    }
  }catch(e){ if (e.name !== 'AbortError') alert('復元に失敗しました: ' + e.message); return; }
  const input = document.getElementById('restoreInput');
  if (input) input.click();
}
function quickRestore(){
  try{
    const json = localStorage.getItem(LS_LAST_BACKUP);
    if(!json){ alert('直近バックアップがありません。先にバックアップしてください。'); return; }
    const data = JSON.parse(json);
    _applyRestore(data);
    alert('直近バックアップから復元しました');
  }catch(e){ alert('復元に失敗しました: ' + e.message); }
}
function restoreJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{ _applyRestore(JSON.parse(r.result)); alert('復元しました'); }
    catch(e){ alert('復元に失敗しました: ' + e.message); }
  };
  r.readAsText(file);
}
function forceFileRestore(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'application/json'; input.style.display = 'none';
  input.onchange = ()=>{
    if(input.files && input.files[0]){
      const r = new FileReader();
      r.onload = ()=>{
        try{ _applyRestore(JSON.parse(r.result)); alert('復元しました'); }
        catch(e){ alert('復元に失敗しました: ' + e.message); }
      };
      r.readAsText(input.files[0]);
    }
  };
  document.body.appendChild(input);
  input.click();
  setTimeout(()=> document.body.removeChild(input), 0);
}
function _applyRestore(data){
  if(!data || !data.suppliers || !data.items || !data.purchases) throw new Error('形式不正');
  suppliers = data.suppliers;
  items = migrateItems(data.items);
  purchases = migratePurchases(data.purchases);
  if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate, String(data.taxRate));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  renderSupplierSelect(); renderItemSelect(); renderList();
  renderPhonebook(); renderSupTable(); renderItemTable();
  updateTaxRateLabel(); renderSupplierMonthly();
}

/* ====== 月フィルター ====== */
function setThisMonth(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = ('0'+(d.getMonth()+1)).slice(-2);
  const v = `${yyyy}-${mm}`;
  if ($('filterMonth')) $('filterMonth').value = v;
  FILTER_MONTH = v;
  renderList();
  updateActiveFilterLabel();
  renderSupplierMonthly();
}
function clearMonthFilter(){
  FILTER_MONTH = '';
  if ($('filterMonth')) $('filterMonth').value = '';
  renderList();
  updateActiveFilterLabel();
  renderSupplierMonthly();
}
function updateActiveFilterLabel(){
  const el = $('activeFilter');
  if (el) el.textContent = FILTER_MONTH ? `適用中：${FILTER_MONTH}` : '';
}

/* ====== 仕入先別・月合計（既存ロジックのまま） ====== */
function toggleMonthlySummary(){
  const box = $('monthlyBox');
  const willShow = (box.style.display==='none' || !box.style.display);
  box.style.display = willShow ? 'block' : 'none';
  if (willShow) {
    renderSupplierMonthly();
    setTimeout(()=> box.scrollIntoView({behavior:'smooth', block:'start'}), 0);
  }
}
function renderSupplierMonthly(){
  const month = FILTER_MONTH || (new Date().toISOString().slice(0,7));
  $('summaryMonthLabel').textContent = month;
  const body = $('monthlyBody'); body.innerHTML = '';
  const monthRows = purchases.filter(p => (p.date||'').slice(0,7) === month);
  const map = new Map(); // supId -> {name,total,count}
  monthRows.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const name = s ? s.name : '(不明)';
    const prev = map.get(p.supplierId) || {name, total:0, count:0};
    prev.total += p.total; prev.count += 1;
    map.set(p.supplierId, prev);
  });
  const entries = Array.from(map.values()).sort((a,b)=> b.total - a.total);
  entries.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.name}</td><td>${e.total}</td><td>${e.count}</td>`;
    body.appendChild(tr);
  });
  if(entries.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="3" class="muted">この月のデータがありません</td>';
    body.appendChild(tr);
  }
}
function downloadSupplierMonthlyCSV(){
  const month = FILTER_MONTH || (new Date().toISOString().slice(0,7));
  const monthRows = purchases.filter(p => (p.date||'').slice(0,7) === month);
  const map = new Map();
  monthRows.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const name = s ? s.name : '(不明)';
    const prev = map.get(name) || {total:0, count:0};
    prev.total += p.total; prev.count += 1;
    map.set(name, prev);
  });
  let csv = `月,仕入先,合計,件数\n`;
  map.forEach((v, name)=>{ csv += `${month},${name},${v.total},${v.count}\n`; });
  const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = `supplier-monthly_${month}.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ====== 電話帳 ====== */
function renderPhonebook(){
  const tb = $('phoneTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    const telHref = s.phone ? `tel:${s.phone}` : '';
    tr.innerHTML = `
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center; text-decoration:none; padding:8px; border-radius:8px; display:block;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>📞 電話</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">📋 コピー</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
async function copyPhone(num){
  if(!num){ alert('電話番号が未登録です'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(num); }
    else{ const ta = document.createElement('textarea'); ta.value = num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    alert('電話番号をコピーしました');
  }catch(e){ alert('コピーできませんでした：' + e.message); }
}

/* ====== マスタ一覧 ====== */
function renderSupTable(){
  const tb = $('supTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td>
                    <td><button class="ghost" onclick="openSupplierEdit('${s.id}')">編集</button></td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb = $('itemTable').querySelector('tbody');
  tb.innerHTML = '';
  items.forEach(it=>{
    const names = (it.suppliers||[])
      .map(id=> (suppliers.find(s=>s.id===id)||{}).name )
      .filter(Boolean);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${it.price!=null ? it.price : ''}</td>
      <td>${it.taxType==='taxExcluded' ? '税別' : '税込'}</td>
      <td>${Math.round((it.taxRate||0.08)*100)}%</td>
      <td>${names.join(' / ')}</td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn-edit" onclick="openItemEdit('${it.id}')">編集</button>
          <button class="btn-del"  onclick="deleteItemDirect('${it.id}')">削除</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* ====== 仕入れ編集・削除 ====== */
function openPurchaseEdit(index){
  const p = purchases[index]; if(!p) return;
  $('editPurchaseIndex').value = String(index);
  $('editDate').value = p.date;

  const supSel = $('editSupplier'); supSel.innerHTML = suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  supSel.value = p.supplierId;

  const itemSel = $('editItem');
  const list = items.filter(it => (it.suppliers||[]).includes(p.supplierId));
  itemSel.innerHTML = list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  itemSel.value = p.itemId;

  supSel.onchange = ()=>{
    const list2 = items.filter(it => (it.suppliers||[]).includes(supSel.value));
    itemSel.innerHTML = list2.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  };

  $('editQty').value = p.qty;
  $('editPrice').value = p.price;

  const r = document.querySelector(`input[name="editTax"][value="${p.taxType}"]`);
  if(r) r.checked = true;

  // 計算税率
  const rr = document.querySelectorAll('input[name="editRate"]');
  rr.forEach(x=> x.checked = (Number(x.value) === Number(p.taxRate||0.08)));

  $('purchaseEditModal').style.display = 'block';
}
function updatePurchase(){
  const idx = Number($('editPurchaseIndex').value);
  const date = $('editDate').value;
  const supplierId = $('editSupplier').value;
  const itemId = $('editItem').value;
  const qty = Number($('editQty').value || 0);
  const price = Number($('editPrice').value || 0);
  const selTax = document.querySelector('input[name="editTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';
  const selRate = document.querySelector('input[name="editRate"]:checked');
  const rate = selRate ? Number(selRate.value) : 0.08;

  if(!date||!supplierId||!itemId) return alert('日付・仕入先・商品は必須です');

  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);

  purchases[idx] = {date, supplierId, itemId, qty, price, taxType, taxRate: rate, total};
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  closeModal('purchaseEditModal');
  renderList(); renderSupplierMonthly();
}
function deletePurchase(){
  const idx = Number($('editPurchaseIndex').value);
  if(!confirm('この仕入れ記録を削除します。よろしいですか？')) return;
  purchases.splice(idx,1);
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  closeModal('purchaseEditModal');
  renderList(); renderSupplierMonthly();
}
function deletePurchaseAt(index){
  if(!confirm('この仕入れ記録を削除します。よろしいですか？')) return;
  purchases.splice(index,1);
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  renderList(); renderSupplierMonthly();
}

/* ====== 仕入先：新規/編集 ====== */
function openSupplierModal(){ resetSupplierForm(); const m = $('supplierModal'); if(!m){ alert('supplierModal が見つかりません'); return; } m.style.display = 'block'; }
function resetSupplierForm(){ $('supName').value=''; $('supContact').value=''; $('supPhone').value=''; }
function addSupplier(){
  const name = $('supName').value.trim(); if(!name) return alert('社名を入力してください');
  const contact = $('supContact').value.trim(); const phone = $('supPhone').value.trim();
  suppliers.push({id: uid(), name, contact, phone});
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  resetSupplierForm(); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemSupplierChecks();
}
function openSupplierEdit(id){
  const s = suppliers.find(x=>x.id===id); if(!s) return;
  $('editSupId').value = s.id; $('editSupName').value = s.name; $('editSupContact').value = s.contact||''; $('editSupPhone').value = s.phone||'';
  const m = $('supplierEditModal'); if(!m){ alert('supplierEditModal が見つかりません'); return; }
  m.style.display = 'block';
}
function updateSupplier(){
  const id = $('editSupId').value; const s = suppliers.find(x=>x.id===id); if(!s) return;
  const name = $('editSupName').value.trim(); if(!name) return alert('社名は必須です');
  s.name = name; s.contact = $('editSupContact').value.trim(); s.phone = $('editSupPhone').value.trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
}
function deleteSupplier(){
  const id = $('editSupId').value;
  if(!confirm('この仕入先を削除します。紐付く商品からも除外されます。よろしいですか？')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  items = items.map(it=> ({...it, suppliers: (it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

/* ====== 商品：新規/編集 ====== */
function openItemModal(){ resetItemForm(); renderItemSupplierChecks(); const m = $('itemModal'); if(!m){ alert('itemModal が見つかりません'); return; } m.style.display = 'block'; }
function resetItemForm(){
  $('itName').value=''; $('itPrice').value='';
  $('itTax').value='taxExcluded';
  // 税率 8% 既定
  const r8 = document.querySelector('#itRateGroup input[value="0.08"]'); if (r8) r8.checked = true;
}
function renderItemSupplierChecks(target='itSuppliers'){
  const box = $(target);
  if(suppliers.length===0){ box.innerHTML = '<div class="small">仕入先がありません。先に仕入先を登録してください。</div>'; return; }
  box.innerHTML = suppliers.map(s=>`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" value="${s.id}"> ${s.name}</label>`).join('');
}
function addItem(){
  const name = $('itName').value.trim(); if(!name) return alert('商品名を入力してください');
  const priceStr = $('itPrice').value.trim(); const price = priceStr==='' ? null : Number(priceStr);
  const taxType = $('itTax').value;
  const rateSel = document.querySelector('input[name="itRate"]:checked'); const taxRate = rateSel ? Number(rateSel.value) : 0.08;
  const checks = Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('紐付ける仕入先を1つ以上選択してください');
  items.push({id: uid(), name, price, taxType, taxRate, suppliers: supIds});
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  resetItemForm(); renderItemSupplierChecks(); renderItemSelect($('inSupplier').value); renderItemTable();
}
function openItemEdit(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  $('editItemId').value = it.id; $('editItName').value = it.name; $('editItPrice').value = it.price!=null? it.price : ''; $('editItTax').value = it.taxType || 'taxExcluded';

  // 税率
  const r8 = document.querySelector('#editItRateGroup input[value="0.08"]');
  const r10= document.querySelector('#editItRateGroup input[value="0.10"]');
  if (r8 && r10){
    r8.checked = (Number(it.taxRate||0.08)===0.08);
    r10.checked = (Number(it.taxRate||0.08)===0.10);
  }

  renderItemSupplierChecks('editItSuppliers');
  const box = $('editItSuppliers'); (it.suppliers||[]).forEach(sid=>{ const chk = box.querySelector(`input[value="${sid}"]`); if(chk) chk.checked = true; });
  const m = $('itemEditModal'); if(!m){ alert('itemEditModal が見つかりません'); return; }
  m.style.display = 'block';
}
function updateItem(){
  const id = $('editItemId').value; const it = items.find(x=>x.id===id); if(!it) return;
  const name = $('editItName').value.trim(); if(!name) return alert('商品名は必須です');
  const priceStr = $('editItPrice').value.trim(); it.price = priceStr==='' ? null : Number(priceStr);
  it.name = name; it.taxType = $('editItTax').value;
  const rateSel = document.querySelector('input[name="editItRate"]:checked'); it.taxRate = rateSel ? Number(rateSel.value) : 0.08;
  const checks = Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('紐付け仕入先を1つ以上選択してください'); it.suppliers = supIds;
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}

/* ====== 一括マスタ登録 ====== */
function openBulkMaster(){ bmClearRows(); bmAddRow(); $('bmSupName').value=''; $('bmSupContact').value=''; $('bmSupPhone').value=''; $('bulkMasterModal').style.display='block'; }
function bmRowTemplate(idx){
  return `
    <div class="product-row" data-idx="${idx}">
      <input type="text" placeholder="商品名" class="bm-name">
      <input type="number" placeholder="基準価格" class="bm-price">
      <select class="bm-taxType">
        <option value="taxExcluded" selected>税別</option>
        <option value="taxIncluded">税込</option>
      </select>
      <div class="radio-group" style="justify-content:center;">
        <label><input type="radio" name="bm-rate-${idx}" value="0.08" checked> 8%</label>
        <label><input type="radio" name="bm-rate-${idx}" value="0.10"> 10%</label>
      </div>
      <button type="button" class="ghost" onclick="bmRemoveRow(${idx})">削除</button>
    </div>
  `;
}
let bmRowCounter = 0;
function bmAddRow(){
  const wrap = $('bmProducts');
  const idx = ++bmRowCounter;
  const div = document.createElement('div');
  div.innerHTML = bmRowTemplate(idx);
  wrap.appendChild(div.firstElementChild);
}
function bmRemoveRow(idx){
  const wrap = $('bmProducts');
  const target = wrap.querySelector(`.product-row[data-idx="${idx}"]`);
  if(target) wrap.removeChild(target);
}
function bmClearRows(){ $('bmProducts').innerHTML=''; }
function bmSubmit(){
  const supName = $('bmSupName').value.trim(); if(!supName) return alert('仕入先名を入力してください');
  const sup = {
    id: uid(),
    name: supName,
    contact: $('bmSupContact').value.trim(),
    phone: $('bmSupPhone').value.trim()
  };
  const rows = Array.from(document.querySelectorAll('#bmProducts .product-row'));
  if (rows.length===0) return alert('商品行を追加してください');

  // 1) 仕入先登録
  suppliers.push(sup);
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));

  // 2) 商品をこの仕入先に紐付けて登録
  rows.forEach(row=>{
    const name = row.querySelector('.bm-name').value.trim();
    if (!name) return; // 空行はスキップ
    const priceStr = row.querySelector('.bm-price').value.trim();
    const price = priceStr==='' ? null : Number(priceStr);
    const taxType = row.querySelector('.bm-taxType').value;
    const rateSel = row.querySelector('input[type="radio"]:checked');
    const taxRate = rateSel ? Number(rateSel.value) : 0.08;
    items.push({ id: uid(), name, price, taxType, taxRate, suppliers: [sup.id] });
  });
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  closeModal('bulkMasterModal');
  renderSupplierSelect(); renderItemSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
  alert('一括登録しました');
}

/* ====== モーダル共通 ====== */
function closeModal(id){ const m = $(id); if(m) m.style.display='none'; }
window.addEventListener('click', (e)=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('purchaseEditModal')) closeModal('purchaseEditModal');
  if(e.target===$('settingsModal')) closeModal('settingsModal');
  if(e.target===$('bulkMasterModal')) closeModal('bulkMasterModal');
  if(e.target===$('restoreChooser')) closeModal('restoreChooser');
});

/* ====== 初期化系 ====== */
function wipeAll(){
  if(!confirm('全データ（仕入先・商品・仕入履歴）を削除します。よろしいですか？')) return;
  suppliers=[]; items=[]; purchases=[];
  localStorage.removeItem(LS_KEYS.suppliers); localStorage.removeItem(LS_KEYS.items); localStorage.removeItem(LS_KEYS.purchases);
  renderSupplierSelect(); renderItemSelect(); renderList(); renderPhonebook(); renderSupTable(); renderItemTable();
  renderSupplierMonthly();
}
function openRestoreChooser(){
  const hint = document.getElementById('lastBackupHint');
  const has = !!localStorage.getItem('last_backup_json_v1');
  hint.textContent = has
    ? '端末内に直近バックアップが見つかりました。ワンタップで復元できます。'
    : '直近バックアップがありません。ファイルを選んで復元してください。';
  document.getElementById('restoreChooser').style.display = 'block';
}

// --- PWA強制更新 ---
async function forceUpdateSW(){
  if (!('serviceWorker' in navigator)) {
    alert('この環境はService Worker非対応です');
    return;
  }
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg) { alert('Service Workerが登録されていません'); return; }
    await reg.update();
    if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    navigator.serviceWorker.addEventListener('controllerchange', ()=>{
      if (!window.__reloading) { window.__reloading = true; location.reload(); }
    });
    alert('更新処理を実行しました。数秒後に最新バージョンへ切り替わります。');
  } catch(e) {
    alert('更新に失敗しました: ' + e.message);
  }
}

function deleteItemDirect(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;

  const used = purchases.some(p => p.itemId === id);
  if(used){
    alert('この商品は仕入れ履歴で使われています。先に該当の仕入れを削除/編集してください。');
    return;
  }
  if(!confirm(`商品「${it.name}」を削除します。よろしいですか？`)) return;

  items = items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  renderItemSelect($('inSupplier').value);
  renderItemTable();
}
</script>

</body>
</html>
