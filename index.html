<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»•å…¥ãƒ»å•†å“ãƒŸãƒ‹å°å¸³ï¼ˆé›»è©±å¯¾å¿œ / CSVãƒ»ç¨ç‡ãƒ»ãƒªã‚«ãƒãƒªå¯¾å¿œï¼‰</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<script>
<script>
/* --- Service Worker ç™»éŒ²ï¼ˆç¢ºå®Ÿã«æœ€æ–°ã‚’å–ã‚‹ï¼†è‡ªå‹•å†èª­ã¿è¾¼ã¿ï¼‰ --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
      .then(reg => {
        // æ–°ç‰ˆã‚’è¦‹ã¤ã‘ãŸã‚‰è‡ªå‹•æ›´æ–°
        reg.update();
      });
  });

  // SWæ›´æ–°åæ˜ æ™‚ã«è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    location.reload();
  });
}

/* --- å¿œæ€¥: URLã« ?reset=1 ã§ SWè§£é™¤ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ --- */
(async () => {
  if (!location.search.includes('reset=1')) return;
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
    }
    if (window.caches?.keys) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
  } finally {
    const base = location.origin + location.pathname; // ã‚¯ã‚¨ãƒªç„¡ã—ã§å†å…¥
    location.replace(base);
  }
})();
</script>
</script>
<style>
  :root{--bg:#f6f7f9;--card:#fff;--ink:#111;--muted:#555;--line:#e5e7eb;--ok:#16a34a;--accent:#2563eb;--danger:#ef4444;--call:#10b981}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:960px;margin:0 auto;padding:12px}
  h1{font-size:18px;margin:4px 0}
  .tabs{display:flex;gap:12px;padding:6px 0}
  .tab{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;height:56px;border:1px solid var(--line);border-radius:16px;background:#fff;cursor:pointer}
  .tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#0b3ea8}
  main{max-width:960px;margin:14px auto;padding:0 12px 80px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .field{margin:12px 0}
  .label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,button,textarea{font:inherit}
  input[type="text"],input[type="number"],input[type="date"],input[type="tel"],select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;min-height:44px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .actions{display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:12px 16px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer;min-height:44px}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.gray{background:#eef2f7}
  .btn.accent{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.danger{background:#fee2e2;border-color:#fecaca}
  .btn.link{background:transparent;border-color:transparent;color:#0b3ea8;text-decoration:underline}
  .btn.call{background:var(--call);border-color:var(--call);color:#fff}
  .help{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;line-height:1.6}
  th{color:var(--muted);font-weight:600;white-space:nowrap}
  td.right{text-align:right}
  .muted{color:var(--muted)}
  .subtle{font-size:12px;color:var(--muted)}
  table tbody tr:nth-child(odd){background:#fafafa}
  .tel{font-weight:600;text-decoration:none;border-bottom:1px dotted #2563eb}
  .tel:active{opacity:.7}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);padding:16px;z-index:50}
  .modal.show{display:block}
  .panel{max-width:520px;margin:40px auto;background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .panel header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .panel .content{padding:16px}
  .panel .foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line);background:#fafafa}
  /* focus ring */
  input:focus,select:focus,button:focus,a:focus{outline:3px solid rgba(37,99,235,.35);outline-offset:2px}
  /* small screen */
  @media (max-width:420px){ body{font-size:17px} .label{font-size:14px} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ä»•å…¥ãƒ»å•†å“ãƒŸãƒ‹å°å¸³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰</h1>
    <div class="tabs">
      <div id="tab-entry" class="tab active" onclick="showPage('entry')">ğŸ“¦ <b>ä»•å…¥ã‚Œå…¥åŠ›</b></div>
      <div id="tab-phone" class="tab" onclick="showPage('phone')">ğŸ“ <b>é›»è©±å¸³</b></div>
      <div id="tab-masters" class="tab" onclick="showPage('masters')">âš™ï¸ <b>ãƒã‚¹ã‚¿ç®¡ç†</b></div>
    </div>
  </div>
</header>

<main>
  <!-- ä»•å…¥ã‚Œå…¥åŠ› -->
  <section id="page-entry" class="card">
    <h2 style="margin:0 0 6px">ä»•å…¥ã‚Œå…¥åŠ›</h2>

    <div class="field">
      <label class="label" for="entDate">æ—¥ä»˜</label>
      <input id="entDate" type="date">
    </div>

    <div class="row">
      <div class="field">
        <label class="label" for="entSupplier">ä»•å…¥å…ˆ</label>
        <select id="entSupplier" onchange="onEntrySupplierChange()">
          <option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>
        </select>
        <div class="help">ä»•å…¥å…ˆã‚’é¸ã¶ã¨ã€ãã®ä»•å…¥å…ˆã«ç´ã¥ãå•†å“ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </div>
      <div class="field" style="align-self:end">
        <button class="btn ok" onclick="openModal('supplierModal')">ï¼‹ ä»•å…¥å…ˆè¿½åŠ </button>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label class="label" for="entItem">å•†å“å</label>
        <select id="entItem" onchange="onEntryItemChange()">
          <option value="">-- å•†å“ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="field" style="align-self:end">
        <button class="btn ok" onclick="openModal('itemModal')">ï¼‹ å•†å“è¿½åŠ </button>
      </div>
    </div>

    <div class="row3">
      <div class="field">
        <label class="label" for="entQty">æ•°é‡</label>
        <input id="entQty" type="number" inputmode="decimal" value="1" min="0">
      </div>
      <div class="field">
        <label class="label" for="entPrice">å˜ä¾¡</label>
        <input id="entPrice" type="number" inputmode="decimal" value="0" min="0">
      </div>
      <div class="field">
        <span class="label">ç¨åŒºåˆ†</span>
        <div style="display:flex;gap:24px;align-items:center">
          <label><input type="radio" name="taxkind" value="inc" checked> ç¨è¾¼</label>
          <label><input type="radio" name="taxkind" value="ex"> ç¨åˆ¥</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <span class="label">ç¨ç‡</span>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label><input type="radio" name="taxrate" value="0.1" checked> 10%</label>
          <label><input type="radio" name="taxrate" value="0.08"> 8%</label>
          <label><input type="radio" name="taxrate" value="custom"> ä»»æ„</label>
          <input id="entTaxCustom" type="number" inputmode="decimal" min="0" step="0.01" value="10" style="width:120px" oninput="selectCustomRate()"> <span class="subtle">ï¼ˆ%ï¼‰</span>
        </div>
      </div>
      <div class="field" style="align-self:end">
        <div class="actions">
          <button class="btn ok" onclick="saveEntry()">ä¿å­˜</button>
          <button class="btn gray" onclick="clearEntry()">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid var(--line)">
    <div class="actions" style="flex-wrap:wrap">
      <button class="btn accent" onclick="exportCSV('today')">å½“æ—¥CSV</button>
      <button class="btn accent" onclick="exportCSV('all')">å…¨ä»¶CSV</button>
      <button class="btn" onclick="undoLast()">ç›´å‰ã«æˆ»ã™ï¼ˆUndoï¼‰</button>
      <button class="btn" onclick="exportJSON()">JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <label class="btn link" for="jsonFile">JSONã‹ã‚‰å¾©å…ƒ<input id="jsonFile" type="file" accept=".json" style="display:none" onchange="importJSON(this.files[0])"></label>
    </div>

    <h3 style="margin:18px 0 8px">é›†è¨ˆ</h3>
    <div id="sumBox" class="muted">ä¿å­˜ã™ã‚‹ã¨ã€ã“ã®ä¸‹ã«å½“æ—¥ã®æ˜ç´°ã¨åˆè¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </section>

  <!-- é›»è©±å¸³ -->
  <section id="page-phone" class="card" style="display:none">
    <div class="row" style="align-items:end">
      <div class="field">
        <label class="label" for="phoneSearch">æ¤œç´¢</label>
        <input id="phoneSearch" type="text" placeholder="ä»•å…¥å…ˆåãƒ»TELãƒ»ãƒ¡ãƒ¢ã§æ¤œç´¢" oninput="renderPhonebook()">
      </div>
      <div class="field">
        <label class="label" for="phoneSort">ä¸¦ã³æ›¿ãˆ</label>
        <select id="phoneSort" onchange="sortSuppliers(this.value)">
          <option value="name_asc">åå‰æ˜‡é †</option>
          <option value="name_desc">åå‰é™é †</option>
          <option value="recent">æœ€è¿‘è¿½åŠ </option>
        </select>
      </div>
    </div>
    <table>
      <thead><tr><th>ä»•å…¥å…ˆå</th><th>TEL</th><th>ãƒ¡ãƒ¢</th></tr></thead>
      <tbody id="phoneRows"></tbody>
    </table>
  </section>

  <!-- ãƒã‚¹ã‚¿ç®¡ç† -->
  <section id="page-masters" style="display:none">
    <div class="card" style="margin-bottom:16px">
      <div class="actions" style="justify-content:space-between;margin-bottom:8px">
        <strong>ä»•å…¥å…ˆãƒã‚¹ã‚¿</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="supSort" onchange="sortSuppliers(this.value)">
            <option value="name_asc">åå‰æ˜‡é †</option>
            <option value="name_desc">åå‰é™é †</option>
            <option value="recent">æœ€è¿‘è¿½åŠ </option>
          </select>
          <button class="btn accent" onclick="openModal('supplierModal')">æ–°è¦è¿½åŠ </button>
          <button class="btn" onclick="exportMasters('suppliers')">CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>ä»•å…¥å…ˆå</th><th>TEL</th><th>ãƒ¡ãƒ¢</th><th class="right">æ“ä½œ</th></tr></thead>
        <tbody id="supRows"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="actions" style="justify-content:space-between;margin-bottom:8px">
        <strong>å•†å“ãƒã‚¹ã‚¿</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="itemSort" onchange="sortItems(this.value)">
            <option value="name_asc">åå‰æ˜‡é †</option>
            <option value="name_desc">åå‰é™é †</option>
            <option value="recent">æœ€è¿‘è¿½åŠ </option>
            <option value="price_asc">ä¾¡æ ¼å®‰ã„é †</option>
            <option value="price_desc">ä¾¡æ ¼é«˜ã„é †</option>
          </select>
          <button class="btn accent" onclick="openModal('itemModal')">æ–°è¦è¿½åŠ </button>
          <button class="btn" onclick="exportMasters('items')">CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>å•†å“å</th><th>ä»•å…¥å…ˆ</th><th class="right">ä¾¡æ ¼</th><th>ãƒ¡ãƒ¢</th><th class="right">æ“ä½œ</th></tr></thead>
        <tbody id="itemRows"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- ä»•å…¥å…ˆ è¿½åŠ /ç·¨é›† -->
<div id="supplierModal" class="modal" aria-hidden="true">
  <div class="panel">
    <header>ä»•å…¥å…ˆ</header>
    <div class="content">
      <input type="hidden" id="supFormId">
      <div class="field"><span class="label">ä»•å…¥å…ˆå</span><input id="supFormName" type="text"></div>
      <div class="field"><span class="label">TEL</span><input id="supFormTel" type="tel" inputmode="tel" autocomplete="tel"></div>
      <div class="field"><span class="label">ãƒ¡ãƒ¢</span><input id="supFormNote" type="text"></div>
    </div>
    <div class="foot">
      <button class="btn" onclick="closeModal('supplierModal')">é–‰ã˜ã‚‹</button>
      <button class="btn ok" onclick="saveSupplier()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å•†å“ è¿½åŠ /ç·¨é›†ï¼ˆä»•å…¥å…ˆã«ç´ä»˜ã‘ï¼‰ -->
<div id="itemModal" class="modal" aria-hidden="true">
  <div class="panel">
    <header>å•†å“</header>
    <div class="content">
      <input type="hidden" id="itemFormId">
      <div class="field"><span class="label">å•†å“å</span><input id="itemFormName" type="text"></div>
      <div class="field">
        <span class="label">ä»•å…¥å…ˆ</span>
        <select id="itemFormSupplier"></select>
      </div>
      <div class="row">
        <div class="field"><span class="label">ä¾¡æ ¼</span><input id="itemFormPrice" type="number" inputmode="decimal" value="0"></div>
        <div class="field"><span class="label">ãƒ¡ãƒ¢</span><input id="itemFormNote" type="text"></div>
      </div>
    </div>
    <div class="foot">
      <button class="btn" onclick="closeModal('itemModal')">é–‰ã˜ã‚‹</button>
      <button class="btn ok" onclick="saveItem()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* ====== ç°¡æ˜“ãƒ˜ãƒ«ãƒ‘ ====== */
const $ = (id)=>document.getElementById(id);
const uid = ()=>'id_'+Math.random().toString(36).slice(2,10);
const LS = {sup:'suppliers_v3', item:'items_v3', pur:'purchases_v3', undo:'undo_snapshot_v1'};
let suppliers = JSON.parse(localStorage.getItem(LS.sup) || '[]');
let items     = JSON.parse(localStorage.getItem(LS.item) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS.pur) || '[]');

// é›»è©±ç•ªå· â†’ tel:href
function telHref(t){
  const s = String(t||'').replace(/[^\d+]/g,'');
  return s ? `tel:${s}` : '';
}

function persist(withUndo=true){
  if(withUndo) takeUndoSnapshot();
  localStorage.setItem(LS.sup, JSON.stringify(suppliers));
  localStorage.setItem(LS.item, JSON.stringify(items));
  localStorage.setItem(LS.pur, JSON.stringify(purchases));
}
function takeUndoSnapshot(){
  const snap = {ts:Date.now(), suppliers, items, purchases};
  localStorage.setItem(LS.undo, JSON.stringify(snap));
}
function undoLast(){
  const snap = JSON.parse(localStorage.getItem(LS.undo)||'null');
  if(!snap){ alert('ç›´å‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  suppliers = snap.suppliers||[]; items = snap.items||[]; purchases = snap.purchases||[];
  persist(false);
  renderAll();
  alert('ç›´å‰ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ');
}
function todayStr(){
  const d = new Date(); const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function fmtJPY(n){return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(Math.round(+n||0))}
function toRate(){ const r = document.querySelector('input[name="taxrate"]:checked').value; if(r==='custom'){ const p = Number($('entTaxCustom').value||0); return Math.max(0, p/100);} return Number(r); }
function selectCustomRate(){ document.querySelector('input[name="taxrate"][value="custom"]').checked = true; }

/* ====== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ====== */
function showPage(which){
  $('page-entry').style.display   = which==='entry' ? 'block':'none';
  $('page-phone').style.display   = which==='phone' ? 'block':'none';
  $('page-masters').style.display = which==='masters' ? 'block':'none';
  ['tab-entry','tab-phone','tab-masters'].forEach(id=>$ (id).classList.remove('active'));
  if(which==='entry') $('tab-entry').classList.add('active');
  if(which==='phone') $('tab-phone').classList.add('active');
  if(which==='masters') $('tab-masters').classList.add('active');

  if(which==='phone') renderPhonebook();
  if(which==='masters'){ renderSupTable(); renderItemTable(); }
}

/* ====== ã‚ªãƒ—ã‚·ãƒ§ãƒ³æç”» ====== */
function renderSupOptions(selectEl, includeBlank=true){
  const el = (typeof selectEl==='string')? $(selectEl):selectEl;
  el.innerHTML = includeBlank?'<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>':'';
  suppliers.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.appendChild(o); });
}
function renderItemOptionsBySupplier(selectEl, supId, includeBlank=true){
  const el = (typeof selectEl==='string')? $(selectEl):selectEl;
  el.innerHTML = includeBlank?'<option value="">-- å•†å“ã‚’é¸æŠ --</option>':'';
  items.filter(i=>i.supplierId===supId).forEach(it=>{
    const o=document.createElement('option'); o.value=it.id; o.textContent=it.name; el.appendChild(o);
  });
}

/* ====== é›»è©±å¸³ãƒ»ãƒã‚¹ã‚¿æç”» ====== */
function renderPhonebook(){
  const q = ($('phoneSearch').value||'').toLowerCase();
  const rows = $('phoneRows'); rows.innerHTML='';
  suppliers.filter(s=>{
    const hay = (s.name+' '+(s.tel||'')+' '+(s.note||'')).toLowerCase();
    return hay.includes(q);
  }).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(s.name)}</td>
      <td>${ s.tel ? `<a class="tel" href="${telHref(s.tel)}">${esc(s.tel)}</a>` : '<span class="muted">æœªç™»éŒ²</span>' }</td>
      <td class="muted">${esc(s.note||'')}</td>
    `;
    rows.appendChild(tr);
  });
}
function renderSupTable(){
  const tb = $('supRows'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(s.name)}</td>
      <td>${ s.tel ? `<a class="tel" href="${telHref(s.tel)}">${esc(s.tel)}</a>` : '<span class="muted">æœªç™»éŒ²</span>' }</td>
      <td class="muted">${esc(s.note||'')}</td>
      <td class="right">
        ${ s.tel ? `<a class="btn call" href="${telHref(s.tel)}">é›»è©±</a>` : '' }
        <button class="btn" onclick="openSupplierEdit('${s.id}')">ç·¨é›†</button>
        <button class="btn danger" onclick="deleteSupplier('${s.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb = $('itemRows'); tb.innerHTML='';
  items.forEach(it=>{
    const sup = suppliers.find(s=>s.id===it.supplierId);
    const sname = sup ? sup.name : 'ï¼ˆæœªè¨­å®šï¼‰';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(it.name)}</td>
      <td>${esc(sname)}</td>
      <td class="right">${fmtJPY(it.price||0)}</td>
      <td class="muted">${esc(it.note||'')}</td>
      <td class="right">
        <button class="btn" onclick="openItemEdit('${it.id}')">ç·¨é›†</button>
        <button class="btn danger" onclick="deleteItem('${it.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderAll(){
  renderSupOptions('entSupplier'); renderSupOptions('itemFormSupplier', false);
  onEntrySupplierChange();
  renderSummary();
  renderPhonebook(); renderSupTable(); renderItemTable();
}

/* ====== ä»•å…¥å…ˆ CRUD ====== */
function openSupplierEdit(id){
  const s = suppliers.find(x=>x.id===id);
  $('supFormId').value = s? s.id : '';
  $('supFormName').value = s? s.name : '';
  $('supFormTel').value  = s? (s.tel||'') : '';
  $('supFormNote').value = s? (s.note||'') : '';
  openModal('supplierModal');
  setTimeout(()=> $('supFormName').focus(), 50);
}
function saveSupplier(){
  const id = $('supFormId').value.trim();
  const name = $('supFormName').value.trim();
  if(!name){ alert('ä»•å…¥å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(id){
    const s = suppliers.find(x=>x.id===id); if(!s) return;
    s.name = name; s.tel = $('supFormTel').value.trim(); s.note = $('supFormNote').value.trim();
  }else{
    suppliers.push({id:uid(), name, tel:$('supFormTel').value.trim(), note:$('supFormNote').value.trim(), created:Date.now()});
  }
  persist();
  closeModal('supplierModal');
  renderAll();
}
function deleteSupplier(id){
  if(!confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç´ã¥ãå•†å“ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  persist();
  renderAll();
}

/* ====== å•†å“ CRUDï¼ˆä»•å…¥å…ˆã«ç´ä»˜ã‘ï¼‰ ====== */
function openItemEdit(id){
  const it = items.find(x=>x.id===id);
  $('itemFormId').value = it? it.id : '';
  $('itemFormName').value = it? it.name : '';
  renderSupOptions('itemFormSupplier', false);
  $('itemFormSupplier').value = it? (it.supplierId||'') : '';
  $('itemFormPrice').value = it? (it.price||0) : 0;
  $('itemFormNote').value  = it? (it.note||'') : '';
  openModal('itemModal');
  setTimeout(()=> $('itemFormName').focus(), 50);
}
function saveItem(){
  const id = $('itemFormId').value.trim();
  const name = $('itemFormName').value.trim();
  const supplierId = $('itemFormSupplier').value;
  const price = Number($('itemFormPrice').value||0);
  const note  = $('itemFormNote').value.trim();
  if(!name){ alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!supplierId){ alert('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if(id){
    const it = items.find(x=>x.id===id); if(!it) return;
    it.name = name; it.supplierId = supplierId; it.price = isFinite(price)?price:0; it.note = note;
  }else{
    items.push({id:uid(), name, supplierId, price:isFinite(price)?price:0, note, created:Date.now()});
  }
  persist();
  closeModal('itemModal');
  renderAll();
}
function deleteItem(id){
  if(!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  items = items.filter(x=>x.id!==id);
  persist();
  renderAll();
}

/* ====== ã‚¨ãƒ³ãƒˆãƒªï¼ˆä¼ç¥¨è¡Œï¼‰ ====== */
function onEntrySupplierChange(){
  const supId = $('entSupplier').value || '';
  renderItemOptionsBySupplier('entItem', supId);
  $('entItem').value = '';
  $('entPrice').value = 0;
}
function onEntryItemChange(){
  const itemId = $('entItem').value;
  const it = items.find(x=>x.id===itemId);
  $('entPrice').value = it ? (it.price||0) : 0;
}
function
