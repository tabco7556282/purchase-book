<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ä»•å…¥ã‚Œç®¡ç†ï½œMVP v0.7.0</title>
<style>
:root{
  --brand:#FFC107; --brand-ink:#1A1300;
  --bg:#FFFBEA; --card:#FFFDF3;
  --text:#111; --muted:#6B6B6B; --divider:#EEDB9A;
  --danger:#D73C3C; --shadow:0 2px 10px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#18191B; --text:#F5F5F5; --muted:#BABABA; --card:#222325; --divider:#2B2C2F;
  --shadow:0 2px 10px rgba(0,0,0,.5);
}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.app-header{position:sticky;top:0;z-index:10;background:var(--brand);color:var(--brand-ink);
  padding:10px 12px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;box-shadow:var(--shadow)}
.app-header h1{margin:0;text-align:center;font-size:18px;letter-spacing:.04em}
.hdr-left{justify-self:start}.hdr-right{justify-self:end;display:flex;gap:8px;align-items:center}
.ver{background:#ffffff80;border:1px solid #ffffffa6;border-radius:999px;padding:2px 8px}
#btnHome{background:#FFE082;color:#5A3A00;border:1px solid #FFFFFF99;box-shadow:0 1px 0 rgba(0,0,0,.06)}

/* ãƒ™ãƒ¼ã‚¹ */
.container{padding:14px;max-width:960px;margin:0 auto}
.nav-vertical{display:flex;flex-direction:column;gap:10px;margin:10px 0}
.btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-weight:700;letter-spacing:.02em;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.btn.primary{background:var(--brand);color:var(--brand-ink)}
.btn.ghost{background:var(--card);border:1px solid var(--divider);color:var(--text)}
.btn.danger{background:#fff;border:1px solid var(--danger);color:var(--danger)}
.btn.small{padding:8px 12px;font-weight:600}
.btn.square{width:100%;height:56px;padding:8px 10px;line-height:1.1;text-align:center;flex-direction:column}
.btn.square .twoline{display:block;line-height:1.1}

/* æ å¼·èª¿ */
#btnAddLine{background:#FFF7CC;border:2px solid #E0B600}
.btn.op{background:#FFF3B0;border:2px solid #E0B600;color:#5A3A00}
.btn.op:active,#btnHome:active{transform:translateY(1px)}

.label{font-size:13px;color:var(--muted);margin:0 0 6px 2px}
.card{background:var(--card);border:1px solid var(--divider);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
input,select,textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--divider);background:#fff;color:var(--text);padding:12px;font-size:16px}
textarea{min-height:84px;resize:vertical}
.row{display:flex;gap:10px;align-items:center}
.row .grow{flex:1}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#FFECB3;color:#5A3A00;font-size:12px}
.section-title{font-weight:800;margin:6px 0 8px}
.fixed-bar{position:sticky;bottom:0;display:flex;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 30%);padding:12px 14px}
.fixed-bar .neg{flex:1}.fixed-bar .pos{flex:2}
.list{display:flex;flex-direction:column;gap:8px}
.list-item{padding:10px 12px;border:1px solid var(--divider);border-radius:12px;background:var(--card)}
#todayList .list-item{background:#FFFDF8;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.list-item.supplier{display:grid;grid-template-columns:1fr 102px;gap:10px;min-height:120px}
.ops-col{display:flex;flex-direction:column;gap:8px;align-items:stretch}

/* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ« */
.theme-toggle{width:40px;height:28px;border-radius:20px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.9);display:flex;align-items:center;padding:2px;cursor:pointer}
.theme-toggle .knob{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#FFD54F;transition:transform .2s ease}
[data-theme="dark"] .theme-toggle{background:#2C2C2E;border-color:#444}
[data-theme="dark"] .theme-toggle .knob{background:#B0B3FF;transform:translateX(12px)}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:flex-end}
.modal{width:100%;background:var(--card);border-radius:16px 16px 0 0;border:1px solid var(--divider);box-shadow:var(--shadow);padding:14px}
.modal h3{margin:2px 0 8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:12px;flex-wrap:nowrap}
.modal .actions .btn{height:44px}
.modal .actions .btn--save{flex:0 0 45%}
.modal .actions .btn--cancel{flex:0 0 30%}
.modal .actions .btn--delete{flex:0 0 18%}
@media (min-width:560px){
  .modal .actions .btn--save{flex-basis:38%}
  .modal .actions .btn--cancel{flex-basis:24%}
  .modal .actions .btn--delete{flex-basis:16%}
}
.sheet{max-width:560px;margin:0 auto}
.hidden{display:none!important}
.mini-meta{font-size:.85em;opacity:.7}
[data-theme="dark"] select,[data-theme="dark"] input,[data-theme="dark"] textarea{background:var(--card);color:var(--text);border-color:#3a3b3f}
[data-theme="dark"] select option{background:#2a2b2e;color:#f5f5f5}
[data-theme="dark"] input::placeholder,[data-theme="dark"] textarea::placeholder{color:rgba(245,245,245,.6)}
[data-theme="dark"] .label{color:#ddd}
[data-theme="dark"] #hisRange{background:var(--card)!important;color:var(--text)!important;border-color:#3a3b3f!important}
</style>
</head>
<body>
<header class="app-header">
  <div class="hdr-left"><button id="btnHome" class="btn ghost small hidden" type="button">â† ãƒ›ãƒ¼ãƒ </button></div>
  <h1 id="pageTitle">ä»•å…¥ã‚Œç®¡ç†</h1>
  <div class="hdr-right">
    <small class="ver">v0.7.0</small>
    <button id="themeBtn" class="theme-toggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿"><div class="knob"><span id="themeIcon">â˜€</span></div></button>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="page-home">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <span class="pill" id="pillBackup">æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šæœªå®Ÿæ–½</span>
      <span class="pill" id="pillPlan">ãƒ—ãƒ©ãƒ³ï¼šç„¡æ–™</span>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      <div class="card"><div class="label">ä»Šé€±ã®ä»•å…¥ã‚Œåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div><div id="kpiWeek" style="font-weight:800;font-size:20px">Â¥0</div></div>
      <div class="card"><div class="label">ä»Šæœˆã®ä»•å…¥ã‚Œåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div><div id="kpiMonth" style="font-weight:800;font-size:20px">Â¥0</div></div>
    </div>
    <div class="nav-vertical" style="margin-top:12px">
      <button class="btn primary" data-goto="input" type="button">ä»•å…¥å…¥åŠ›</button>
      <button class="btn ghost" data-goto="history" type="button">å±¥æ­´ãƒ»é›†è¨ˆ</button>
      <button class="btn ghost" data-goto="suppliers" type="button">ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿</button>
      <button class="btn ghost" data-goto="products" type="button">å•†å“ãƒã‚¹ã‚¿</button>
      <button class="btn ghost" id="btnExport" type="button">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
      <button class="btn ghost" data-goto="backup" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</button>
      <button class="btn ghost" data-goto="license" type="button">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</button>
      <button class="btn danger" id="btnFactoryReset" type="button">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
      <div class="label">â€»åˆæœŸåŒ–ã®å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚</div>
    </div>
  </section>

  <!-- INPUT -->
  <section id="page-input" class="hidden" data-title="ä»•å…¥å…¥åŠ›">
    <div class="card grid">
      <div class="grid cols-2">
        <div><div class="label">æ—¥ä»˜</div><input type="date" id="inDate"></div>
        <div><div class="label">ä»•å…¥ã‚Œå…ˆ</div><select id="inSupplier"></select></div>
      </div>
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">å•†å“ï¼ˆä»•å…¥ã‚Œå…ˆã§çµè¾¼ï¼‰</div>
          <label class="row" style="gap:6px"><input type="checkbox" id="chkFree"> æœªç™»éŒ²ã§å…¥åŠ›</label>
        </div>
        <!-- ğŸ” å•†å“æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
        <input id="prodSearch" type="text" placeholder="å•†å“åã§æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰" class="grow" />
        <select id="inProduct" style="margin-top:6px"></select>
        <div id="freeFields" class="grid cols-2 hidden" style="margin-top:8px">
          <div><div class="label">ä»•å…¥ã‚Œå…ˆåï¼ˆæœªç™»éŒ²ï¼‰</div><input id="freeSupplier" type="text"></div>
          <div><div class="label">å•†å“åï¼ˆæœªç™»éŒ²ï¼‰</div><input id="freeProduct" type="text"></div>
        </div>
      </div>
      <div class="grid cols-2">
        <div><div class="label">ä¾¡æ ¼</div><input type="number" id="inPrice" inputmode="numeric" pattern="[0-9]*"></div>
        <div><div class="label">æ•°é‡</div><input type="number" id="inQty" value="1" inputmode="numeric" pattern="[0-9]*"></div>
      </div>
      <div class="row">
        <div class="row" style="gap:16px">
          <label><input type="radio" name="taxmode" value="incl"> ç¨è¾¼</label>
          <label><input type="radio" name="taxmode" value="excl" checked> ç¨åˆ¥</label>
        </div>
        <div class="row" style="gap:10px;margin-left:auto">
          <span class="label">ç¨ç‡</span>
          <label><input type="radio" name="taxrate" value="10">10%</label>
          <label><input type="radio" name="taxrate" value="8" checked>8%</label>
          <label><input type="radio" name="taxrate" value="0">éèª²ç¨</label>
        </div>
      </div>
      <div><div class="label">ä¾¡æ ¼å±¥æ­´ï¼ˆç›´è¿‘ï¼‰</div><div id="priceHistory" class="row" style="flex-wrap:wrap"></div></div>
      <div><div class="label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div><input id="inMemo"></div>
      <button class="btn ghost" id="btnAddLine" type="button">ï¼‹ æ˜ç´°ã‚’è¿½åŠ </button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="section-title">æœ¬æ—¥ã®æ˜ç´°ï¼ˆä»•å…¥ã‚Œå…ˆã§è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</div>
      <div id="todayList" class="list"></div>
    </div>
    <div class="fixed-bar"><button class="btn ghost small neg" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button><button class="btn primary pos" id="btnSave" type="button">ä¿å­˜</button></div>
  </section>

  <!-- SUPPLIERS -->
  <section id="page-suppliers" class="hidden" data-title="ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="section-title">ä»•å…¥ã‚Œå…ˆä¸€è¦§</div>
      <button class="btn primary small" id="btnAddSupplier" type="button">ï¼‹ è¿½åŠ </button>
    </div>
    <div id="supplierList" class="list"></div>
  </section>

  <!-- PRODUCTS -->
  <section id="page-products" class="hidden" data-title="å•†å“ãƒã‚¹ã‚¿">
    <div class="row" style="gap:8px;align-items:center">
      <div class="grow"><div class="label">ä»•å…¥ã‚Œå…ˆã§çµè¾¼</div><select id="filterProdSupplier"></select></div>
      <button class="btn primary small" id="btnAddProduct" type="button">ï¼‹ è¿½åŠ </button>
    </div>
    <div id="productList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- HISTORY -->
  <section id="page-history" class="hidden" data-title="å±¥æ­´ãƒ»é›†è¨ˆ">
    <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div><div class="label">æœŸé–“</div><select id="hisRange"><option value="7">1é€±é–“</option><option value="30" selected>1ãƒ¶æœˆ</option></select></div>
      <div class="row" style="gap:16px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleGross" checked> ç¨åˆ¥å°è¨ˆï¼‹ç¨è¾¼è¡¨ç¤º</label>
        <label class="row" style="gap:6px"><input type="checkbox" id="showDetail"> æ˜ç´°ã®è©³ç´°ï¼ˆå˜ä¾¡ãƒ»ç¨æƒ…å ±ï¼‰</label>
      </div>
    </div>
    <div id="historyList" class="list" style="margin-top:10px"></div>
    <div class="fixed-bar"><button class="btn ghost neg" id="btnExport2" type="button">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button><button class="btn primary pos" data-goto="home" type="button">ãƒ›ãƒ¼ãƒ ã¸</button></div>
  </section>

  <!-- BACKUP / ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
  <section id="page-backup" class="hidden" data-title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š">
    <div class="card">
      <div class="label">æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div><div id="bkLast">æœªå®Ÿæ–½</div><hr>
      <div class="label">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå°†æ¥æ‹¡å¼µï¼‰</div>
      <div class="row" style="gap:16px">
        <label><input type="radio" name="bksched" value="daily" checked> æ¯æ—¥22:00</label>
        <label><input type="radio" name="bksched" value="weekly"> æ¯é€± æœˆæ›œ</label>
        <label><input type="radio" name="bksched" value="manual"> æ‰‹å‹•ã®ã¿</label>
      </div><hr>
      <div class="row" style="gap:10px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleAutoClear" checked> ï¼‹æ˜ç´°è¿½åŠ å¾Œã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢</label>
      </div><hr>
      <div class="row" style="gap:10px"><button class="btn primary" id="btnBackupNow" type="button">ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button><button class="btn ghost" id="btnRestore" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button><input type="file" id="fileRestore" accept="application/json" class="hidden"></div>
    </div>

    <!-- ğŸ”¶ å¹´åº¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– -->
    <div class="card" style="margin-top:12px">
      <div class="section-title">å¹´åº¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>
      <div class="row" style="justify-content:space-between;align-items:center;gap:6px">
        <div>
          <div class="label">å¯¾è±¡å¹´åº¦ï¼ˆå€‹äººäº‹æ¥­ä¸»ï¼š1æœˆã€œ12æœˆï¼‰</div>
          <div id="fiscalLabel" style="font-weight:800">-</div>
        </div>
        <button class="btn primary small" id="btnArchiveYear" type="button">ã“ã®å¹´åº¦ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
      </div>
      <div class="label" style="margin-top:8px">â€» ä»•å…¥å…ˆãƒ»å•†å“ãƒã‚¹ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚å¯¾è±¡å¹´åº¦ã®æ˜ç´°ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</div>
    </div>
  </section>

  <!-- LICENSE -->
  <section id="page-license" class="hidden" data-title="ãƒ©ã‚¤ã‚»ãƒ³ã‚¹">
    <div class="grid" style="grid-template-columns:1fr;gap:12px">
      <div class="card"><h3>ç„¡æ–™ç‰ˆ</h3><ul><li>åºƒå‘Šã‚ã‚Š</li><li>ä»•å…¥ã‚Œå…ˆ 5ç¤¾ã¾ã§ï¼å•†å“ åˆè¨ˆ50å“ã¾ã§</li><li>å‡ºåŠ›ã¯ç›´è¿‘1ã‹æœˆ</li></ul><button class="btn ghost small" type="button" disabled>ä½¿ç”¨ä¸­</button></div>
      <div class="card"><h3>ãƒŸãƒ‰ãƒ«ï¼ˆÂ¥700ï¼‰</h3><ul><li>åºƒå‘Šãªã—</li><li>ä»•å…¥ã‚Œå…ˆ 20ç¤¾ã¾ã§ï¼1ç¤¾15å“ã®ç›®å®‰</li><li>å‡ºåŠ›ã¯éå»6ã‹æœˆ</li></ul><button class="btn primary small" id="mockBuyMid" type="button">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹</button></div>
      <div class="card"><h3>ãƒ—ãƒ­ï¼ˆÂ¥1,500ï¼‰</h3><ul><li>åºƒå‘Šãªã—</li><li>ä¸Šé™ãªã—</li><li>å‡ºåŠ›ã¯ç„¡åˆ¶é™</li></ul><button class="btn primary small" id="mockBuyPro" type="button">ãƒ•ãƒ«æ©Ÿèƒ½ã§ä½¿ã†</button></div>
    </div>
  </section>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ -->
<div id="modalHost" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <!-- å·¦ï¼å‰Šé™¤ï¼ˆå°ï¼‰ï¼ä¸­å¤®ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼å³ï¼ä¿å­˜ï¼ˆå¤§ï¼‰ -->
      <button class="btn danger small btn--delete delbtn hidden" id="modalDelete">å‰Šé™¤</button>
      <button class="btn ghost small btn--cancel" id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary btn--save" id="modalOK">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* ===== Storage ===== */
const DB={load(){const d=JSON.parse(localStorage.getItem("tabco-store")||"{}");return Object.assign({suppliers:[],products:[],entries:[],priceHistory:{},settings:{theme:"light",lastBackupAt:null,plan:"free",autoClear:true,historyShowBoth:true,showTaxFlags:false,recentProducts:[]}},d)},save(d){localStorage.setItem("tabco-store",JSON.stringify(d))}};
let store=DB.load();

/* ===== Utils ===== */
const $=(s,el)=>(el||document).querySelector(s); const $$=(s,el)=>Array.from((el||document).querySelectorAll(s));
const yen=n=>"Â¥"+(Math.round(n||0)).toLocaleString(); const uid=()=>Math.random().toString(36).slice(2,10);
const fmtYMD=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; const todayStr=()=>fmtYMD(new Date());
function enableSelectOnFocus(){$$('input[type="number"], input[type="text"]').forEach(inp=>{const sel=()=>inp.select&&inp.select();inp.addEventListener("focus",sel);inp.addEventListener("click",sel)})}

/* ===== Theme & Header ===== */
function applyTheme(){document.documentElement.setAttribute("data-theme",store.settings.theme==="dark"?"dark":"light");$("#themeIcon").textContent=store.settings.theme==="dark"?"â˜¾":"â˜€"}
$("#themeBtn").addEventListener("click",()=>{store.settings.theme=store.settings.theme==="dark"?"light":"dark";DB.save(store);applyTheme()});
function setHeaderTitleByPage(id){$("#pageTitle").textContent=$("#page-"+id)?.getAttribute("data-title")||"ä»•å…¥ã‚Œç®¡ç†"}

/* ===== Router ===== */
let internalNav=false;
function showPage(id){
  $$("main section").forEach(s=>s.classList.add("hidden"));
  $("#page-"+id)?.classList.remove("hidden");

  if(id==="home"){
    $("#btnHome").classList.add("hidden");
    $("#pageTitle").textContent="ä»•å…¥ã‚Œç®¡ç†";
  }else{
    $("#btnHome").classList.remove("hidden");
    setHeaderTitleByPage(id);
  }

  // â† ã“ã‚Œã‚’è¿½åŠ ï¼šå±¥æ­´ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸã‚‰æ¯å›æç”»ã™ã‚‹
  if(id==="history"){ renderHistory(); }

  window.scrollTo(0,0);
}
showPage(location.hash.replace("#","")||"home");
if ((location.hash||"") === "#history") renderHistory();  // ä¿é™º

function navigate(id){internalNav=true;location.hash=id;showPage(id);internalNav=false}
window.addEventListener("hashchange",()=>{if(internalNav)return;showPage(location.hash.replace("#","")||"home")});
$("#btnHome").addEventListener("click",()=>navigate("home"));
$$("[data-goto]").forEach(b=>b.addEventListener("click",()=>{const id=b.getAttribute("data-goto");navigate(id);if(id==="history")renderHistory()}));

/* ===== Home KPIs ===== */
function calcTotals(days){const now=new Date(),from=new Date(now.getTime()-days*86400000);return store.entries.reduce((sum,e)=>{if(e.deleted)return sum;const t=new Date(e.date+"T00:00:00");if(t>=from&&t<=now){const base=e.taxmode==="incl"?e.price:e.price*(1+e.taxrate/100);sum+=base*e.qty}return sum},0)}
function refreshHome(){$("#kpiWeek").textContent=yen(calcTotals(7));$("#kpiMonth").textContent=yen(calcTotals(30));$("#pillPlan").textContent="ãƒ—ãƒ©ãƒ³ï¼š"+(store.settings.plan==="free"?"ç„¡æ–™":store.settings.plan);const bk=store.settings.lastBackupAt?new Date(store.settings.lastBackupAt):null;$("#pillBackup").textContent=bk?("æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š"+bk.toLocaleString("ja-JP")):"æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šæœªå®Ÿæ–½"}

/* ===== Sampleï¼ˆåˆå›ã®ã¿ï¼‰ ===== */
function ensureSample(){if(store.suppliers.length===0 && store.entries.length===0 && store.products.length===0){store.suppliers.push({id:uid(),name:"ç‰å±‹å•†åº—",contact:"å±±ç”°",phone:"075-000-0000",invoice_number:"T1234567890123"});store.suppliers.push({id:uid(),name:"ä½è—¤é’æœ",contact:"ä½è—¤",phone:"090-000-0000",invoice_number:"T0000000000000"});const s1=store.suppliers[0].id,s2=store.suppliers[1].id;store.products.push({id:uid(),supplier_id:s1,name:"ç‰›è‚©ãƒ­ãƒ¼ã‚¹",default_price:2000,tax_rate:10,tax_mode:"incl",note:""});store.products.push({id:uid(),supplier_id:s2,name:"ãƒˆãƒãƒˆ",default_price:180,tax_rate:8,tax_mode:"excl",note:""});DB.save(store)}}

/* ===== Input ===== */
function fillSupplierSelect(sel){sel.innerHTML="";store.suppliers.filter(s=>!s.deleted).forEach(s=>{const o=document.createElement("option");o.value=s.id;o.textContent=s.name;sel.appendChild(o)})}
function buildProductOptionsForSupplier(supplierId, searchText=""){
  const recents = (store.settings.recentProducts||[]).slice(0,20);
  const list = store.products.filter(p=>!p.deleted&&(!supplierId||p.supplier_id===supplierId));
  const mru = list.filter(p=>recents.includes(p.id));
  const others = list.filter(p=>!recents.includes(p.id));
  const needle = (searchText||"").trim().toLowerCase();
  function match(p){return !needle || p.name.toLowerCase().includes(needle)}
  return [...mru.filter(match), ...others.filter(match)];
}
function renderProductSelect(sel,supplierId,searchText=""){
  const items=buildProductOptionsForSupplier(supplierId,searchText);
  const prev=sel.value;
  sel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
  items.forEach(p=>{const o=document.createElement("option");o.value=p.id;o.textContent=p.name;sel.appendChild(o)});
  if(items.some(p=>p.id===prev)) sel.value=prev;
  // æ—¢å®šå€¤ã‚¯ãƒªã‚¢
  $("#inPrice").value=""; $("#inQty").value=1;
  $$('input[name=taxrate]').forEach(r=>r.checked=(r.value==="8")); 
  $$('input[name=taxmode]').forEach(r=>r.checked=(r.value==="excl"));
  $("#priceHistory").innerHTML="";
}
function fillProductSelect(sel,supplierId){ renderProductSelect(sel,supplierId,$("#prodSearch").value||""); }
function renderPriceHistory(pid){const w=$("#priceHistory");w.innerHTML="";(store.priceHistory[pid]||[]).slice(-3).reverse().forEach(v=>{const b=document.createElement("button");b.className="btn ghost small";b.type="button";b.textContent="Â¥"+v.price;b.onclick=()=>$("#inPrice").value=v.price;w.appendChild(b)})}
const supplierName=id=>(store.suppliers.find(x=>x.id===id)||{}).name||null;
const prodName=(id,fb)=>(store.products.find(x=>x.id===id)||{}).name||(fb||"æœªç™»éŒ²");
function toggleFreeInput(){const on=$("#chkFree").checked;$("#freeFields").classList.toggle("hidden",!on);$("#inSupplier").disabled=on;$("#inProduct").disabled=on;$("#prodSearch").disabled=on}
function initInputPage(){$("#inDate").value=todayStr();fillSupplierSelect($("#inSupplier"));const sid=$("#inSupplier").value;renderProductSelect($("#inProduct"),sid,"");$("#prodSearch").value="";$("#inQty").value=1;$("#inPrice").value="";$("#inMemo").value="";toggleFreeInput()}
$("#chkFree").addEventListener("change",toggleFreeInput);
$("#inSupplier").addEventListener("change",e=>{renderProductSelect($("#inProduct"),e.target.value,$("#prodSearch").value||"")});
$("#prodSearch").addEventListener("input",e=>{renderProductSelect($("#inProduct"),$("#inSupplier").value,e.target.value)});
$("#inProduct").addEventListener("change",e=>{const p=store.products.find(x=>x.id===e.target.value);if(p){$("#inPrice").value=p.default_price||"";$$('input[name=taxrate]').forEach(r=>r.checked=String(p.tax_rate)===r.value);$$('input[name=taxmode]').forEach(r=>r.checked=(p.tax_mode||"excl")===r.value);renderPriceHistory(p.id)}else{$("#priceHistory").innerHTML=""}});

/* åˆè¨ˆ */
function calcLineTotal(e){
  const p=Number(e.price)||0, q=Number(e.qty)||0, r=Number(e.taxrate)||0;
  const base = p*q;
  if(e.taxmode==="incl"){ const excl = Math.round(base/(1+r/100)); return {excl, incl: base}; }
  else if(e.taxmode==="excl"){ const incl = Math.round(base*(1+r/100)); return {excl: base, incl}; }
  else { return {excl: base, incl: base}; }
}

/* MRU æ›´æ–° */
function bumpRecentProduct(pid){
  if(!pid) return;
  const arr = store.settings.recentProducts || [];
  const i = arr.indexOf(pid);
  if(i>=0) arr.splice(i,1);
  arr.unshift(pid);
  store.settings.recentProducts = arr.slice(0,20);
}

function addLine(){
  const date=$("#inDate").value||todayStr();
  const free=$("#chkFree").checked;
  const supplier_id=free?null:($("#inSupplier").value||null);
  const product_id=free?null:($("#inProduct").value||null);
  const supplier_name_fallback=free?($("#freeSupplier").value||"æœªç™»éŒ²"):(supplierName(supplier_id)||"æœªç™»éŒ²");
  const product_name_fallback=free?($("#freeProduct").value||"æœªç™»éŒ²"):null;
  const qty=Number($("#inQty").value||1);
  const price=Number($("#inPrice").value||0);
  const taxrate=Number($('input[name=taxrate]:checked').value);
  const taxmode=$('input[name=taxmode]:checked').value;
  if(!price||!qty){alert("ä¾¡æ ¼ã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}
  store.entries.push({id:uid(),date,supplier_id,product_id,supplier_name_fallback,product_name_fallback,qty,price,taxrate,taxmode,memo:$("#inMemo").value||""});
  if(product_id){const arr=store.priceHistory[product_id]||[];arr.push({price,ts:Date.now(),taxrate,taxmode});store.priceHistory[product_id]=arr.slice(-5)}
  bumpRecentProduct(product_id);
  DB.save(store);renderTodayList();refreshHome();
  if(store.settings.autoClear){$("#inProduct").value="";$("#inPrice").value="";$("#inQty").value=1;$("#inMemo").value="";$("#priceHistory").innerHTML="";}
}
$("#btnAddLine").addEventListener("click",addLine);

$("#btnSave").addEventListener("click",()=>{alert("ä¿å­˜ã—ã¾ã—ãŸ");navigate("home");refreshHome()});
$("#btnClear").addEventListener("click",()=>{$("#inQty").value=1;$("#inPrice").value="";$("#inMemo").value="";$("#inProduct").value="";$("#priceHistory").innerHTML=""});

/* æ˜ç´°ï¼ˆæœ¬æ—¥ï¼‰ */
function renderTodayList(){
  const cont=$("#todayList");cont.innerHTML="";const d=todayStr();const group={};
  store.entries.filter(x=>!x.deleted && x.date===d).forEach(e=>{const key=e.supplier_id||e.supplier_name_fallback||"æœªæŒ‡å®š";(group[key]=group[key]||[]).push(e)});
  Object.keys(group).forEach(k=>{
    const sup=supplierName(k)||k;const div=document.createElement("div");div.className="list-item";
    let net=0,gross=0;group[k].forEach(e=>{const t=calcLineTotal(e);net+=t.excl;gross+=t.incl});
    let html=`<b>${sup}</b><div class="muted">ç¨åˆ¥ ${yen(net)}ï½œç¨è¾¼ ${yen(gross)}</div>`;
    html+=group[k].map(e=>{
      const t=calcLineTotal(e); const txLabel=e.taxmode==="incl"?"ç¨è¾¼":(e.taxrate===0?"éèª²ç¨":"ç¨åˆ¥");
      const show=(e.taxmode==="incl")?t.incl:t.excl;
      const meta = store.settings.showTaxFlags ? `<br><span class="mini-meta">å˜ä¾¡ ${yen(e.price)} / ${e.taxrate}% / ${txLabel}</span>` : "";
      return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
        <span>ãƒ»${prodName(e.product_id,e.product_name_fallback)} Ã—${e.qty}${meta}</span>
        <span>${yen(show)}</span>
      </div>`;
    }).join("");
    div.innerHTML=html;cont.appendChild(div);
  });
  cont.querySelectorAll(".entry").forEach(el=>el.addEventListener("click",()=>{const id=el.getAttribute("data-id");const ent=store.entries.find(x=>x.id===id);if(ent)openEntryModal(ent)}));
}

/* ===== Supplier/Product ===== */
function renderSuppliers(){
  const list=$("#supplierList"); list.innerHTML="";
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const prodCount=store.products.filter(p=>!p.deleted&&p.supplier_id===s.id).length;
    const item=document.createElement("div"); item.className="list-item supplier";
    item.innerHTML=`
      <div class="tapzone">
        <b>${s.name}</b>
        <div class="muted">æ‹…å½“:${s.contact||"-"}ã€€TEL:${s.phone||"-"}ã€€INV:${s.invoice_number||"-"}</div>
        <div class="muted">ï½œå•†å“${prodCount}ä»¶</div>
      </div>
      <div class="ops-col">
        <button class="btn op small square addp" type="button"><span class="twoline">ï¼‹<br>å•†å“è¿½åŠ </span></button>
        <button class="btn op small square edit" type="button">ç·¨é›†</button>
      </div>`;
    // æœ¬ä½“ã‚¿ãƒƒãƒ—ã§å•†å“ãƒã‚¹ã‚¿ã¸é·ç§»ï¼†çµè¾¼
    item.querySelector(".tapzone").onclick=()=>{navigate("products");$("#filterProdSupplier").value=s.id;renderProducts()};
    item.querySelector(".addp").onclick=()=>openProductModal(null,s.id);
    item.querySelector(".edit").onclick=()=>openSupplierModal(s);
    list.appendChild(item);
  });
}

function renderProducts(){
  const list=$("#productList"); list.innerHTML="";
  const sid=$("#filterProdSupplier").value;
  const items=store.products.filter(p=>!p.deleted&&(!sid||p.supplier_id===sid));
  items.forEach(p=>{
    const sName=supplierName(p.supplier_id)||"-";
    const item=document.createElement("div"); item.className="list-item";
    item.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${p.name}</b>
          <div class="muted">${sName}ï½œæ—¢å®šä¾¡æ ¼ ${yen(p.default_price||0)}ï½œ${p.tax_rate}%ï½œ${p.tax_mode==="incl"?"ç¨è¾¼":"ç¨åˆ¥"}</div>
          ${p.note?(`<div class="muted">ãƒ¡ãƒ¢ï¼š${p.note}</div>`):""}
        </div>
        <div style="width:102px"><button class="btn op small square edit" type="button">ç·¨é›†</button></div>
      </div>`;
    item.querySelector(".edit").onclick=()=>openProductModal(p,p.supplier_id);
    list.appendChild(item);
  });
}
function fillFilterSupplier(){const sel=$("#filterProdSupplier");sel.innerHTML='<option value="">ã™ã¹ã¦</option>';store.suppliers.filter(s=>!s.deleted).forEach(s=>{const o=document.createElement("option");o.value=s.id;o.textContent=s.name;sel.appendChild(o)})}
$("#filterProdSupplier").addEventListener("change",renderProducts);

/* ===== ModalåŸºç›¤ ===== */
function closeModal(){ $("#modalHost").classList.add("hidden"); $("#modalHost").setAttribute("aria-hidden","true"); }
function openModalBase(title,bodyHTML){
  $("#modalTitle").textContent=title;
  $("#modalBody").innerHTML=bodyHTML;

  const host=$("#modalHost");
  const ok=$("#modalOK"), cancel=$("#modalCancel"), del=$("#modalDelete");
  ok.textContent="ä¿å­˜"; cancel.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; del.textContent="å‰Šé™¤";
  ok.onclick=null; del.onclick=null; cancel.onclick=closeModal;
  del.classList.add("hidden");
  ok.classList.add("btn--save"); cancel.classList.add("btn--cancel"); del.classList.add("btn--delete");
  host.classList.remove("hidden"); host.setAttribute("aria-hidden","false");
}
(function(){const host=$("#modalHost"); if(!host) return; if(host.__bound) return;
  host.addEventListener("click",e=>{if(e.target===host) closeModal()});
  document.addEventListener("keydown",e=>{if(e.key==="Escape" && !host.classList.contains("hidden")) closeModal()});
  host.__bound=true;
})();

/* ===== Supplier modal ===== */
function openSupplierModal(s){
  openModalBase(s?"ä»•å…¥ã‚Œå…ˆã‚’ç·¨é›†":"ä»•å…¥ã‚Œå…ˆã‚’è¿½åŠ ",`
    <div class="grid cols-2">
      <div><div class="label">ç¤¾å</div><input id="mSupName" type="text" value="${s?.name||""}"></div>
      <div><div class="label">æ‹…å½“è€…</div><input id="mSupContact" type="text" value="${s?.contact||""}"></div>
      <div><div class="label">é›»è©±</div><input id="mSupPhone" type="text" value="${s?.phone||""}" inputmode="tel"></div>
      <div><div class="label">ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·</div><input id="mSupInv" type="text" value="${s?.invoice_number||""}"></div>
    </div>`);
  const onOK=()=>{const name=$("#mSupName").value.trim();if(!name){alert("ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}
    const contact=$("#mSupContact").value.trim();const phone=$("#mSupPhone").value.trim();const inv=$("#mSupInv").value.trim();
    if(s){s.name=name;s.contact=contact;s.phone=phone;s.invoice_number=inv}else{store.suppliers.push({id:uid(),name,contact,phone,invoice_number:inv})}
    DB.save(store);renderSuppliers();refreshHome();fillSupplierSelect($("#inSupplier"));closeModal();
  };
  $("#modalOK").onclick=onOK;

  if(s){
    const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
    delBtn.onclick=()=>{ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ s.deleted=true; DB.save(store); renderSuppliers(); refreshHome(); closeModal(); } };
    $(".actions").insertBefore(delBtn, $("#modalCancel"));
  }
}

/* ===== Product modalï¼ˆãƒ¡ãƒ¢ä»˜ãï¼‰ ===== */
function openProductModal(p,defaultSid){
  const supOpts=store.suppliers.filter(s=>!s.deleted).map(s=>`<option value="${s.id}" ${(p?.supplier_id||defaultSid)===s.id?"selected":""}>${s.name}</option>`).join("");
  openModalBase(p?"å•†å“ã‚’ç·¨é›†":"å•†å“ã‚’è¿½åŠ ",`
    <div class="grid cols-2">
      <div><div class="label">ä»•å…¥ã‚Œå…ˆ</div><select id="mProdSup">${supOpts}</select></div>
      <div><div class="label">å•†å“å</div><input id="mProdName" type="text" value="${p?.name||""}"></div>
      <div><div class="label">æ—¢å®šä¾¡æ ¼</div><input id="mProdPrice" type="number" inputmode="numeric" value="${p?.default_price??""}"></div>
      <div><div class="label">ç¨ç‡</div><select id="mProdRate">
        <option value="10" ${p?.tax_rate===10?"selected":""}>10%</option>
        <option value="8" ${p?.tax_rate===8||p==null?"selected":""}>8%</option>
        <option value="0" ${p?.tax_rate===0?"selected":""}>éèª²ç¨</option>
      </select></div>
      <div><div class="label">åŒºåˆ†</div><select id="mProdMode">
        <option value="excl" ${(p?.tax_mode||"excl")==="excl"?"selected":""}>ç¨åˆ¥</option>
        <option value="incl" ${(p?.tax_mode||"excl")==="incl"?"selected":""}>ç¨è¾¼</option>
      </select></div>
      <div style="grid-column:1/-1">
        <div class="label">å•†å“ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="mProdNote" placeholder="ä¾‹ï¼šå…¥æ•°24ãƒ»ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ 2æ—¥ãªã©">${p?.note||""}</textarea>
      </div>
    </div>`);
  const onOK=()=>{const sid=$("#mProdSup").value;const name=$("#mProdName").value.trim();if(!sid||!name){alert("ä»•å…¥ã‚Œå…ˆã¨å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}
    if(!p&&store.products.some(x=>!x.deleted&&x.supplier_id===sid&&x.name===name)){if(!confirm("åŒä¸€ä»•å…¥ã‚Œå…ˆã«åŒåã®å•†å“ãŒã‚ã‚Šã¾ã™ã€‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ"))return}
    const price=Number($("#mProdPrice").value||0);const tax_rate=Number($("#mProdRate").value||8);const tax_mode=$("#mProdMode").value||"excl";const note=$("#mProdNote").value||"";
    if(p){p.supplier_id=sid;p.name=name;p.default_price=price;p.tax_rate=tax_rate;p.tax_mode=tax_mode;p.note=note}
    else{store.products.push({id:uid(),supplier_id:sid,name,default_price:price,tax_rate:tax_rate,tax_mode:tax_mode,note})}
    DB.save(store);renderProducts();renderProductSelect($("#inProduct"),$("#inSupplier").value,$("#prodSearch").value||"");closeModal();
  };
  $("#modalOK").onclick=onOK;

  if(p){
    const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
    delBtn.onclick=()=>{ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ p.deleted=true; DB.save(store); renderProducts(); closeModal(); } };
    $(".actions").insertBefore(delBtn, $("#modalCancel"));
  }
}

/* ===== æ˜ç´°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openEntryModal(e){
  const pname=prodName(e.product_id,e.product_name_fallback);
  openModalBase("æ˜ç´°ã‚’ç·¨é›†",`
    <div class="grid cols-2">
      <div><div class="label">å•†å“</div><input type="text" value="${pname}" disabled></div>
      <div><div class="label">æ•°é‡</div><input id="mQty" type="number" inputmode="numeric" value="${e.qty}"></div>
      <div><div class="label">å˜ä¾¡</div><input id="mPrice" type="number" inputmode="numeric" value="${e.price}"></div>
      <div><div class="label">ç¨ç‡</div><select id="mRate">
        <option value="10" ${e.taxrate===10?"selected":""}>10%</option>
        <option value="8" ${e.taxrate===8?"selected":""}>8%</option>
        <option value="0" ${e.taxrate===0?"selected":""}>éèª²ç¨</option>
      </select></div>
      <div style="grid-column:1/-1">
        <div class="row" style="gap:16px">
          <label><input type="radio" name="mMode" value="incl" ${e.taxmode==="incl"?"checked":""}> ç¨è¾¼</label>
          <label><input type="radio" name="mMode" value="excl" ${e.taxmode==="excl"?"checked":""}> ç¨åˆ¥</label>
        </div>
      </div>
      <div style="grid-column:1/-1"><div class="label">ãƒ¡ãƒ¢</div><textarea id="mMemo">${e.memo||""}</textarea></div>
    </div>`);
  $("#modalOK").onclick=()=>{e.qty=Number($("#mQty").value||1);e.price=Number($("#mPrice").value||0);e.taxrate=Number($("#mRate").value||8);e.taxmode=document.querySelector('input[name="mMode"]:checked').value;e.memo=$("#mMemo").value||"";DB.save(store);
    if(e.product_id){const arr=store.priceHistory[e.product_id]||[];arr.push({price:e.price,ts:Date.now(),taxrate:e.taxrate,taxmode:e.taxmode});store.priceHistory[e.product_id]=arr.slice(-5)}
    bumpRecentProduct(e.product_id); renderTodayList();renderHistory();refreshHome();closeModal();
  };

  const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
  delBtn.onclick=()=>{ if(confirm("ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ store.entries=store.entries.filter(x=>x.id!==e.id); DB.save(store); renderTodayList(); renderHistory(); refreshHome(); closeModal(); } };
  $(".actions").insertBefore(delBtn, $("#modalCancel"));
}

/* ===== History / Export ===== */
function renderHistory(){
  const days=Number($("#hisRange").value);const list=$("#historyList");list.innerHTML="";
  const now=new Date(),from=new Date(now.getTime()-days*86400000);const byDate={};
  store.entries.filter(x=>!x.deleted).forEach(e=>{const d=new Date(e.date+"T00:00:00");if(d>=from&&d<=now){(byDate[e.date]=byDate[e.date]||[]).push(e)}});
  Object.keys(byDate).sort().reverse().forEach(dkey=>{
    const group={};byDate[dkey].forEach(e=>{const key=e.supplier_id||e.supplier_name_fallback||"æœªæŒ‡å®š";(group[key]=group[key]||[]).push(e)});
    const sec=document.createElement("div");sec.className="card";
    let html=`<b>${new Date(dkey+"T00:00:00").toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"short"})}</b>`;
    Object.keys(group).forEach(key=>{
      const name=supplierName(key)||key;let net=0,gross=0;group[key].forEach(e=>{const t=calcLineTotal(e);net+=t.excl;gross+=t.incl});
      const showBoth=!!store.settings.historyShowBoth;
      const headerTotals= showBoth ? `ç¨åˆ¥ ${yen(net)}ï½œç¨è¾¼ ${yen(gross)}` : `ç¨è¾¼ ${yen(gross)}`;
      html+=`<div style="margin-top:6px"><u>${name}</u>ã€€<span class="muted">${headerTotals}</span>`;
      html+=group[key].map(e=>{
        const t=calcLineTotal(e); const txLabel=e.taxmode==="incl"?"ç¨è¾¼":(e.taxrate===0?"éèª²ç¨":"ç¨åˆ¥");
        const show=(e.taxmode==="incl")?t.incl:t.excl;
        const meta = store.settings.showTaxFlags ? `<br><span class="mini-meta">å˜ä¾¡ ${yen(e.price)} / ${e.taxrate}% / ${txLabel}</span>` : "";
        return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
          <span>ãƒ»${prodName(e.product_id,e.product_name_fallback)} Ã—${e.qty}${meta}</span>
          <span>${yen(show)}</span>
        </div>`;
      }).join("");
      html+=`</div>`;
    });
    sec.innerHTML=html; list.appendChild(sec);
  });
  list.querySelectorAll(".entry").forEach(el=>el.addEventListener("click",()=>{const id=el.getAttribute("data-id");const ent=store.entries.find(x=>x.id===id);if(ent)openEntryModal(ent)}));
}
$("#hisRange").addEventListener("change",renderHistory);

/* å‡ºåŠ›ï¼ˆä»Šã¯ã€Œå½“æœˆã€å›ºå®šã®ã¾ã¾ï¼šæ¬¡ç‰ˆã§æœŸé–“é¸æŠã‚’è¿½åŠ äºˆå®šï¼‰ */
const ModalExport=()=>{openModalBase("ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›","<div>Excelã§é–‹ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼ˆå½“æœˆåˆ†ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>");$("#modalOK").textContent="å‡ºåŠ›ã™ã‚‹";$("#modalOK").onclick=()=>{exportData();closeModal()}};
function exportData(){const dt=new Date();const ym=dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");const rows=[["æ—¥ä»˜","ä»•å…¥ã‚Œå…ˆ","å•†å“","æ•°é‡","å˜ä¾¡","ç¨ç‡","åŒºåˆ†","ç¨è¾¼é¡","ãƒ¡ãƒ¢"]];store.entries.filter(e=>!e.deleted).forEach(e=>{if(e.date.slice(0,7)===ym){const s=supplierName(e.supplier_id)||e.supplier_name_fallback||"";const p=prodName(e.product_id,e.product_name_fallback);const g=(e.taxmode==="incl"?e.price:e.price*(1+e.taxrate/100))*e.qty;rows.push([e.date,s,p,e.qty,e.price,e.taxrate,(e.taxmode==="incl"?"ç¨è¾¼":"ç¨åˆ¥"),Math.round(g),e.memo||""])}});const csv=rows.map(r=>r.map(x=>'"'+String(x).replace(/"/g,'""')+'"').join(",")).join("\n");const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="ä»•å…¥ã‚Œè¨˜éŒ²_"+ym+".csv";a.click();URL.revokeObjectURL(a.href);alert("å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆExcelã§é–‹ã‘ã¾ã™ï¼‰")}
document.addEventListener("click",(ev)=>{const t=ev.target.closest("#btnExport, #btnExport2");if(t){ev.preventDefault();ModalExport();}},true);

/* ===== Backup / Restore / Fiscal Archive ===== */
function backupNow(){const payload={version:"1.0",exported_at:new Date().toISOString(),tables:{suppliers:store.suppliers,products:store.products,entries:store.entries,priceHistory:store.priceHistory,settings:store.settings}};const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="tabco_backup_"+fmtYMD(new Date())+".json";a.click();URL.revokeObjectURL(a.href);store.settings.lastBackupAt=Date.now();DB.save(store);refreshHome();$("#bkLast").textContent=new Date(store.settings.lastBackupAt).toLocaleString("ja-JP")}
$("#btnBackupNow").addEventListener("click",backupNow);
$("#btnRestore").addEventListener("click",()=>$("#fileRestore").click());
$("#fileRestore").addEventListener("change",e=>{const f=e.target.files[0];if(!f)return;if(!confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ"))return;const r=new FileReader();r.onload=()=>{try{const data=JSON.parse(r.result);if(!data.tables)throw 0;store.suppliers=data.tables.suppliers||[];store.products=data.tables.products||[];store.entries=data.tables.entries||[];store.priceHistory=data.tables.priceHistory||{};store.settings=Object.assign({theme:store.settings.theme,plan:store.settings.plan,autoClear:true,historyShowBoth:true,showTaxFlags:false,recentProducts:store.settings.recentProducts||[]},data.tables.settings||{});DB.save(store);alert("å¾©å…ƒã—ã¾ã—ãŸ");applyTheme();refreshHome();initInputPage();renderSuppliers();fillFilterSupplier();renderProducts();renderHistory();navigate("home");enableSelectOnFocus()}catch{alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚")}};r.readAsText(f)});

/* å¹´åº¦ãƒ©ãƒ™ãƒ«ï¼ˆå€‹äººäº‹æ¥­ä¸»ï¼š1-12æœˆï¼‰ */
function refreshFiscalLabel(){const y=new Date().getFullYear();$("#fiscalLabel").textContent=`å¯¾è±¡ï¼š${y}å¹´ï¼ˆ1æœˆã€œ12æœˆï¼‰`}
$("#btnArchiveYear").addEventListener("click",()=>{
  const year = new Date().getFullYear();
  if(!confirm(`${year}å¹´ã®ä»•å…¥æ˜ç´°ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\nå…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  // 1) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå…¨ä½“ï¼‰
  backupNow();

  // 2) å¹´åº¦åˆ†ã®ã¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’åˆ¥åã§ä¿å­˜ï¼ˆå¾©å…ƒã—ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
  const target = store.entries.filter(e=>e.date.startsWith(String(year)+"-"));
  const archivePayload={version:"1.0",fiscal_year:year,exported_at:new Date().toISOString(),tables:{entries:target}};
  const blob2=new Blob([JSON.stringify(archivePayload,null,2)],{type:"application/json"});
  const a2=document.createElement("a");a2.href=URL.createObjectURL(blob2);a2.download=`tabco_archive_${year}å¹´åº¦.json`;a2.click();URL.revokeObjectURL(a2.href);

  // 3) å¯¾è±¡å¹´ã® entries ã ã‘å‰Šé™¤ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ã¯æ®‹ã™ï¼‰
  store.entries = store.entries.filter(e=>!e.date.startsWith(String(year)+"-"));
  DB.save(store);
  alert(`${year}å¹´ã®æ˜ç´°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆä»•å…¥å…ˆãƒ»å•†å“ã¯æ®‹ã—ã¦ã„ã¾ã™ï¼‰`);
  renderTodayList(); renderHistory(); refreshHome();
});

/* ===== Factory Reset ===== */
$("#btnFactoryReset").addEventListener("click",()=>{
  if(!confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å–å¾—æ¸ˆã¿ã§ã™ã‹ï¼Ÿ\n\næœªå–å¾—ã®å ´åˆã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã¸ç§»å‹•ã—ã¾ã™ã€‚")){navigate("backup");return;}
  if(!confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
  const keep={theme:store.settings.theme,plan:store.settings.plan,autoClear:store.settings.autoClear,lastBackupAt:store.settings.lastBackupAt,historyShowBoth:store.settings.historyShowBoth,showTaxFlags:store.settings.showTaxFlags,recentProducts:store.settings.recentProducts||[]};
  store={suppliers:[],products:[],entries:[],priceHistory:{},settings:keep};
  DB.save(store);
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚");
  applyTheme();refreshHome();initInputPage();renderSuppliers();fillFilterSupplier();renderProducts();renderHistory();navigate("home");
});

/* ===== License mock ===== */
function setPlan(p){store.settings.plan=p;DB.save(store);refreshHome();alert("ãƒ—ãƒ©ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰")}
$("#mockBuyMid").addEventListener("click",()=>setPlan("middle"));
$("#mockBuyPro").addEventListener("click",()=>setPlan("pro"));

/* è¿½åŠ ãƒœã‚¿ãƒ³ãƒãƒ³ãƒ‰ãƒ© */
$("#btnAddSupplier").addEventListener("click",()=>openSupplierModal(null));
$("#btnAddProduct").addEventListener("click",()=>{const sid=$("#filterProdSupplier").value || (store.suppliers.find(s=>!s.deleted)?.id || "");openProductModal(null,sid)});
$("#toggleAutoClear").checked=!!store.settings.autoClear;
$("#toggleAutoClear").addEventListener("change",e=>{store.settings.autoClear=!!e.target.checked;DB.save(store)});

/* Init */
function init(){ensureSample();applyTheme();refreshHome();initInputPage();renderTodayList();enableSelectOnFocus();renderSuppliers();fillFilterSupplier();renderProducts();showPage(location.hash.replace("#","")||"home");refreshFiscalLabel()}
init();

/* å±¥æ­´ãƒˆã‚°ãƒ«åˆæœŸåæ˜  */
window.addEventListener('load',()=>{ $("#toggleGross").checked = !!store.settings.historyShowBoth; $("#showDetail").checked = !!store.settings.showTaxFlags; });
</script>
</body>
</html>
