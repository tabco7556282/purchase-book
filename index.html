<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>仕入れ管理アプリ v3（電話・編集・税率設定）</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{ --gap:8px; }
  body { font-family: system-ui, sans-serif; margin: 10px; padding-bottom: 86px; }
  h2 { margin: 14px 0; }
  input, select, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
  label { display: block; margin: 8px 0 4px; }
  .row { display: flex; gap: var(--gap); flex-wrap: wrap; }
  .row > * { flex: 1; }
  button { background: #16a34a; color: #fff; border: none; border-radius: 8px; cursor:pointer; }
  button:hover { background:#12833c; }
  .link { background:#2563eb; }
  .link:hover { background:#1f4ec0; }
  .ghost { background:#e5e7eb; color:#111; }
  .ghost:hover { background:#d1d5db; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; word-break: break-all; }
  .nav { display:flex; gap:var(--gap); margin-bottom:10px; }
  .radio-group { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .small { font-size: 12px; color:#666; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .chip { border:1px solid #ccc; padding:6px 10px; border-radius:999px; }
  .muted { color:#666; font-size:12px; }
  .nowrap { white-space:nowrap; }

  /* モーダル土台 */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:80; }
  /* モーダル本体：高さ制限＋スクロール */
  .modal-content {
    background:#fff; margin:6% auto; padding:12px; width:92%; max-width:560px; border-radius:10px;
    max-height:90vh; overflow:auto; padding-bottom:96px; /* 下固定ボタン分の余白 */
  }
  /* 仕入先チェックリスト：独立スクロール */
  .checkbox-grid {
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;
    max-height:50vh; overflow:auto; padding-right:4px;
  }
  /* モーダル内のボタン行を下固定（.actions でも .row 最終でも効く） */
  .actions,
  #supplierModal .modal-content > .row:last-child,
  #itemModal .modal-content > .row:last-child {
    display:flex; gap:8px; justify-content:center;
    position:sticky; bottom:0; background:#fff; padding:8px 0;
    box-shadow: 0 -4px 10px rgba(0,0,0,.04); z-index:60;
  }
  .modal-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .danger { background:#ef4444; }
  .danger:hover { background:#c53737; }

  /* === 画面下固定アクションバー（全画面共通） === */
  .fab-bar {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 20;
    background: #fff; border-top: 1px solid #e5e7eb;
    padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    box-shadow: 0 -6px 20px rgba(0,0,0,.06);
  }
  .fab-inner { display: flex; gap: 8px; max-width: 560px; margin: 0 auto; }
  .fab-inner > * { flex: 1; }
</style>
</head>
<body>

<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">仕入れ入力</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">電話帳</button>
  <button type="button" onclick="showPage('masters')" class="ghost">マスタ管理</button>
  <button type="button" onclick="openSettings()" class="ghost">⚙ 設定</button>
</div>

<!-- 仕入れ入力 -->
<section id="page-entry">
  <h2>仕入れ入力</h2>
  <label>日付</label>
  <input type="date" id="inDate">

  <label>仕入先 <span class="muted">（選択すると紐付く商品のみ表示）</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" onclick="openSupplierModal()">＋ 仕入先追加</button>
  </div>
  <div id="supplierQuick" class="row" style="margin:6px 0; display:none; align-items:center;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">📞 この仕入先に電話</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">📋 電話番号コピー</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>商品名</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" onclick="openItemModal()">＋ 商品追加</button>
  </div>

  <div class="row">
    <div>
      <label>数量</label>
      <input type="number" id="inQty" value="1" step="0.1" min="0">
    </div>
    <div>
      <label>単価</label>
      <input type="number" id="inPrice" value="0" step="1" min="0">
    </div>
  </div>

  <label>税区分</label>
  <div class="radio-group">
    <label><input type="radio" name="inTax" value="taxIncluded" checked> 税込</label>
    <label><input type="radio" name="inTax" value="taxExcluded"> 税別</label>
    <span class="muted">基本税率：<b id="lblRate"></b>%（設定で変更）</span>
  </div>

  <!-- 基本税率のクイック切替 -->
  <label style="margin-top:6px;">税率（8% / 10% クイック切替）</label>
  <div class="radio-group" id="baseRateRadios">
    <label><input type="radio" name="baseRateChoice" value="8"> 8%</label>
    <label><input type="radio" name="baseRateChoice" value="10"> 10%</label>
    <span class="small">※ 以後の計算に使う「基本税率」を即時更新します。</span>
  </div>

  <h3>集計</h3>
  <div class="row">
    <div class="chip">日計：<b><span id="sumDaily">0</span> 円</b></div>
    <div class="chip">月計：<b><span id="sumMonthly">0</span> 円</b></div>
  </div>

  <h3>仕入れ一覧</h3>
  <table id="listTable">
    <thead>
      <tr><th>日付</th><th>仕入先</th><th>商品</th><th>数量</th><th>単価</th><th>税区分</th><th>合計</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="row">
    <div class="row" style="margin-top:6px;">
  <button type="button" class="ghost" onclick="downloadJSON()">JSONバックアップ</button>
  <label class="ghost" style="display:inline-block; text-align:center; border-radius:8px; padding:8px; cursor:pointer;">
    JSON復元
    <input type="file" accept="application/json" style="display:none"
      onchange="if(this.files[0]) restoreJSON(this.files[0])">
  </label>
</div>

    <button type="button" class="link" onclick="downloadCSV()">CSV ダウンロード</button>
    <button type="button" class="ghost" onclick="wipeAll()">全データ初期化</button>
  </div>
</section>

<!-- 電話帳 -->
<section id="page-phonebook" style="display:none;">
  <h2>仕入先電話帳</h2>
  <table id="phoneTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- マスタ管理 -->
<section id="page-masters" style="display:none;">
  <h2>マスタ一覧</h2>

  <h3>仕入先</h3>
  <table id="supTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>商品（紐付け先）</h3>
  <table id="itemTable">
    <thead><tr><th>商品名</th><th>基準価格</th><th>税区分</th><th>紐付け仕入先</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- 仕入先モーダル（新規） -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先追加</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">✕</button>
    </div>
    <label>社名</label>
    <input id="supName" type="text" placeholder="例）Aフーズ">
    <label>担当者</label>
    <input id="supContact" type="text" placeholder="例）山田さん">
    <label>電話番号</label>
    <input id="supPhone" type="tel" placeholder="090-1234-5678">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addSupplier()">登録</button>
      <button type="button" class="ghost" onclick="resetSupplierForm()">クリア</button>
    </div>
  </div>
</div>

<!-- 仕入先モーダル（編集） -->
<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先編集</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">✕</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>社名</label>
    <input id="editSupName" type="text">
    <label>担当者</label>
    <input id="editSupContact" type="text">
    <label>電話番号</label>
    <input id="editSupPhone" type="tel">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateSupplier()">保存</button>
      <button type="button" class="danger" onclick="deleteSupplier()">削除</button>
    </div>
  </div>
</div>

<!-- 商品モーダル（新規） -->
<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品追加</h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">✕</button>
    </div>
    <label>商品名</label>
    <input id="itName" type="text" placeholder="例）国産もも肉 2kg">
    <div class="row">
      <div>
        <label>基準価格（任意）</label>
        <input id="itPrice" type="number" placeholder="0">
      </div>
      <div>
        <label>税区分</label>
        <select id="itTax">
          <option value="taxIncluded">税込</option>
          <option value="taxExcluded">税別</option>
        </select>
      </div>
    </div>

    <label>紐付け仕入先（複数可）</label>
    <div id="itSuppliers" class="checkbox-grid"></div>
    <div class="small">※ 複数の仕入先から購入可能な商品に対応します。</div>

    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addItem()">登録</button>
      <button type="button" class="ghost" onclick="resetItemForm()">クリア</button>
    </div>
  </div>
</div>
<!-- 商品モーダル（編集） -->
<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品編集</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">✕</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>商品名</label>
    <input id="editItName" type="text">
    <div class="row">
      <div>
        <label>基準価格（任意）</label>
        <input id="editItPrice" type="number">
      </div>
      <div>
        <label>税区分</label>
        <select id="editItTax">
          <option value="taxIncluded">税込</option>
          <option value="taxExcluded">税別</option>
        </select>
      </div>
    </div>
    <label>紐付け仕入先（複数可）</label>
    <div id="editItSuppliers" class="checkbox-grid"></div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateItem()">保存</button>
      <button type="button" class="danger" onclick="deleteItem()">削除</button>
    </div>
  </div>
</div>

<!-- 設定モーダル（基本税率） -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>設定</h3>
      <button type="button" class="ghost" onclick="closeModal('settingsModal')">✕</button>
    </div>
    <label>基本税率（8% または 10%）</label>
    <div class="radio-group">
      <label><input type="radio" name="baseRatePreset" value="8"> 8%</label>
      <label><input type="radio" name="baseRatePreset" value="10"> 10%</label>
    </div>
    <div class="row" style="margin-top:8px;">
      <button type="button" onclick="saveBaseTaxRate()">保存</button>
      <button type="button" class="ghost" onclick="resetBaseTaxRate()">8%に戻す</button>
    </div>
    <div class="small" style="margin-top:4px;">※ この設定は税別計算に適用され、税込はそのままの金額になります。</div>
  </div>
</div>

<!-- 画面下固定アクションバー -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" onclick="savePurchase()">保存</button>
    <button type="button" class="ghost" onclick="clearEntry()">入力クリア</button>
  </div>
</div>

<script>
/* ====== 永続化 ====== */
const LS_KEYS = {
  suppliers: 'suppliers_v2',
  items: 'items_v2',
  purchases: 'purchases_v2',
  taxRate: 'base_tax_rate_v1'
};

const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

/* ====== 状態 ====== */
let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

/* ====== 税率 ====== */
function getBaseTaxRate(){
  const v = localStorage.getItem(LS_KEYS.taxRate);
  return v==null ? 0.08 : Number(v); // 既定は8%
}
function setBaseTaxRate(decimal){
  localStorage.setItem(LS_KEYS.taxRate, String(decimal));
  updateTaxRateLabel();
  renderBaseRateRadios();
}
function updateTaxRateLabel(){
  $('lblRate').textContent = Math.round(getBaseTaxRate()*1000)/10;
}
function renderBaseRateRadios(){
  const pct = Math.round(getBaseTaxRate()*100);
  const target = pct===10 ? '10' : '8';
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  radios.forEach(r=>{
    r.checked = (r.value === target);
    r.onchange = ()=> setBaseTaxRate(Number(r.value)/100);
  });
}

/* ====== ページ切替 ====== */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block':'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block':'none';
  $('page-masters').style.display = which==='masters' ? 'block':'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters')  { renderSupTable(); renderItemTable(); }
}

/* ====== 初期描画 ====== */
function init(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = ('0'+(today.getMonth()+1)).slice(-2);
  const dd = ('0'+today.getDate()).slice(-2);
  $('inDate').value = `${yyyy}-${mm}-${dd}`;

  renderSupplierSelect();
  renderItemSelect();
  renderListTable();
  updateSums();
  updateTaxRateLabel();
  renderBaseRateRadios();
}
document.addEventListener('DOMContentLoaded', init);

// PWA Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ====== ヘルパー描画 ====== */
function renderSupplierSelect(){
  const sel = $('inSupplier');
  sel.innerHTML = '<option value="">-- 仕入先を選択 --</option>' +
    suppliers.map(s=> `<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange = ()=>{
    renderItemSelect(sel.value);
    updateSupplierQuick(sel.value);
  };
}

function updateSupplierQuick(supplierId){
  const wrap = $('supplierQuick');
  if(!supplierId){ wrap.style.display='none'; return; }
  const s = suppliers.find(x=>x.id===supplierId);
  if(!s){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  const phone = s.phone || '';
  const telHref = phone ? `tel:${phone}` : '';
  $('supplierPhoneView').textContent = phone ? `電話番号：${phone}` : '電話番号未登録';
  const btnCall = $('btnCallSupplier');
  btnCall.onclick = ()=>{
    if(!phone){ alert('電話番号が未登録です'); return; }
    window.location.href = telHref;
  };
  $('btnCopySupplier').onclick = ()=> copyPhone(phone);
}

function renderItemSelect(supplierId=''){
  const sel = $('inItem');
  let list = items;
  if(supplierId){
    list = items.filter(it => (it.suppliers||[]).includes(supplierId));
  }
  sel.innerHTML = '<option value="">-- 商品を選択 --</option>' +
    list.map(i=> `<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange = ()=>{
  const it = items.find(x=>x.id===sel.value);
  if(it){
    // ① 仕入先×商品の直近価格を最優先で反映
    const last = getLastPriceFor($('inSupplier').value, it.id);
    if (last!=null) {
      $('inPrice').value = last;
    } else if (it.price!=null) {
      // ② なければ商品の基準価格
      $('inPrice').value = it.price;
    }
    // 税区分も商品既定を反映
    const tsel = document.querySelector('input[name="inTax"][value="'+(it.taxType||'taxIncluded')+'"]');
    if(tsel) tsel.checked = true;
  }
};


/* ====== 入力エリア ====== */
function clearEntry(){
  $('inItem').value = '';
  $('inQty').value = 1;
  $('inPrice').value = 0;
  document.querySelector('input[name="inTax"][value="taxIncluded"]').checked = true;
}
// 直近の「仕入先×商品」の単価を後ろから探索して取得
function getLastPriceFor(supplierId, itemId){
  for (let i = purchases.length - 1; i >= 0; i--) {
    const p = purchases[i];
    if (p.supplierId === supplierId && p.itemId === itemId) return p.price;
  }
  return null;
}

/* ====== 保存・計算 ====== */
function savePurchase(){
  const date = $('inDate').value;
  const supplierId = $('inSupplier').value;
  const itemId = $('inItem').value;
  const qty = Number($('inQty').value || 0);
  const price = Number($('inPrice').value || 0);
  const taxType = document.querySelector('input[name="inTax"]:checked').value;

  if(!date) return alert('日付を入力してください');
  if(!supplierId) return alert('仕入先を選択してください');
  if(!itemId) return alert('商品を選択してください');

  const rate = getBaseTaxRate();
  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);

  purchases.push({date, supplierId, itemId, qty, price, taxType, total});
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  clearEntry();
  renderListTable();
  updateSums();
}

/* ====== 一覧 & 集計 ====== */
function renderListTable(){
  const tb = $('listTable').querySelector('tbody');
  tb.innerHTML = '';
  purchases.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.date}</td>
      <td>${s ? s.name : ''}</td>
      <td>${i ? i.name : ''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'税別':'税込'}</td>
      <td>${p.total}</td>
    `;
    tb.appendChild(tr);
  });
}

function updateSums(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = ('0'+(today.getMonth()+1)).slice(-2);
  const dd = ('0'+today.getDate()).slice(-2);
  const todayStr = `${yyyy}-${mm}-${dd}`;
  const monthStr = `${yyyy}-${mm}`;

  let daily = 0, monthly = 0;
  purchases.forEach(p=>{
    if(p.date===todayStr) daily += p.total;
    if((p.date||'').slice(0,7)===monthStr) monthly += p.total;
  });
  $('sumDaily').textContent = daily.toString();
  $('sumMonthly').textContent = monthly.toString();
}

/* ====== CSV ====== */
function downloadCSV(){
  let csv = '日付,仕入先,商品,数量,単価,税区分,合計\n';
  purchases.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    csv += `${p.date},${s?s.name:''},${i?i.name:''},${p.qty},${p.price},${p.taxType==='taxExcluded'?'税別':'税込'},${p.total}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = '仕入れデータ.csv'; a.click();
  URL.revokeObjectURL(url);
}
  function downloadJSON(){
  const data = {
    version: 1,
    savedAt: new Date().toISOString(),
    suppliers, items, purchases,
    taxRate: localStorage.getItem(LS_KEYS.taxRate)
  };
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'shiire-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function restoreJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      if(!data || !data.suppliers || !data.items || !data.purchases) throw new Error('形式不正');
      suppliers = data.suppliers; items = data.items; purchases = data.purchases;
      if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate, String(data.taxRate));
      localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
      localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
      localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
      renderSupplierSelect(); renderItemSelect(); renderListTable();
      renderPhonebook(); renderSupTable(); renderItemTable(); updateSums(); updateTaxRateLabel();
      alert('復元しました');
    }catch(e){ alert('復元に失敗: ' + e.message); }
  };
  r.readAsText(file);
}


/* ====== 電話帳 ====== */
function renderPhonebook(){
  const tb = $('phoneTable').querySelector('tbody');
  tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    const telHref = s.phone ? `tel:${s.phone}` : '';
    tr.innerHTML = `
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center; text-decoration:none; padding:8px; border-radius:8px; display:block;"
             href="${telHref}" ${s.phone?'':'onclick="return false;"'}>📞 電話</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">📋 コピー</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}

async function copyPhone(num){
  if(!num){ alert('電話番号が未登録です'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(num);
    }else{
      const ta = document.createElement('textarea');
      ta.value = num; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    }
    alert('電話番号をコピーしました');
  }catch(e){
    alert('コピーできませんでした：' + e.message);
  }
}

/* ====== マスタ一覧 ====== */
function renderSupTable(){
  const tb = $('supTable').querySelector('tbody');
  tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td>
                    <td><button class="ghost" onclick="openSupplierEdit('${s.id}')">編集</button></td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb = $('itemTable').querySelector('tbody');
  tb.innerHTML = '';
  items.forEach(it=>{
    const names = (it.suppliers||[]).map(id=> (suppliers.find(s=>s.id===id)||{}).name ).filter(Boolean);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${it.price!=null? it.price : ''}</td>
      <td>${it.taxType==='taxExcluded'?'税別':'税込'}</td>
      <td>${names.join(' / ')}</td>
      <td><button class="ghost" onclick="openItemEdit('${it.id}')">編集</button></td>
    `;
    tb.appendChild(tr);
  });
}

/* ====== 仕入先：新規/編集 ====== */
function openSupplierModal(){
  resetSupplierForm();
  $('supplierModal').style.display = 'block';
  setFabVisible(false);
}
function resetSupplierForm(){
  $('supName').value=''; $('supContact').value=''; $('supPhone').value='';
}
function addSupplier(){
  const name = $('supName').value.trim();
  if(!name) return alert('社名を入力してください');
  const contact = $('supContact').value.trim();
  const phone = $('supPhone').value.trim();
  suppliers.push({id: uid(), name, contact, phone});
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));

  resetSupplierForm();
  renderSupplierSelect();
  renderPhonebook();
  renderSupTable();
  renderItemSupplierChecks();
}

function openSupplierEdit(id){
  const s = suppliers.find(x=>x.id===id);
  if(!s) return;
  $('editSupId').value = s.id;
  $('editSupName').value = s.name;
  $('editSupContact').value = s.contact||'';
  $('editSupPhone').value = s.phone||'';
  $('supplierEditModal').style.display = 'block';
  setFabVisible(false);
}
function updateSupplier(){
  const id = $('editSupId').value;
  const s = suppliers.find(x=>x.id===id);
  if(!s) return;
  const name = $('editSupName').value.trim();
  if(!name) return alert('社名は必須です');
  s.name = name;
  s.contact = $('editSupContact').value.trim();
  s.phone = $('editSupPhone').value.trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal');
  renderSupplierSelect();
  renderPhonebook();
  renderSupTable();
  renderItemTable();
  updateSupplierQuick($('inSupplier').value);
}
function deleteSupplier(){
  const id = $('editSupId').value;
  if(!confirm('この仕入先を削除します。紐付く商品からも除外されます。よろしいですか？')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  items = items.map(it=> ({...it, suppliers: (it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal');
  renderSupplierSelect();
  renderPhonebook();
  renderSupTable();
  renderItemTable();
  renderItemSelect($('inSupplier').value);
  updateSupplierQuick($('inSupplier').value);
}

/* ====== 商品：新規/編集 ====== */
function openItemModal(){
  resetItemForm();
  renderItemSupplierChecks();
  $('itemModal').style.display = 'block';
  setFabVisible(false);
}
function resetItemForm(){
  $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxIncluded';
}
function renderItemSupplierChecks(target='itSuppliers'){
  const box = $(target);
  if(suppliers.length===0){
    box.innerHTML = '<div class="small">仕入先がありません。先に仕入先を登録してください。</div>';
    return;
  }
  box.innerHTML = suppliers.map(s=>`
    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" value="${s.id}"> ${s.name}
    </label>
  `).join('');
}
function addItem(){
  const name = $('itName').value.trim();
  if(!name) return alert('商品名を入力してください');
  const priceStr = $('itPrice').value.trim();
  const price = priceStr==='' ? null : Number(priceStr);
  const taxType = $('itTax').value;

  const checks = Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked'));
  const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('紐付ける仕入先を1つ以上選択してください');

  items.push({id: uid(), name, price, taxType, suppliers: supIds});
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  resetItemForm();
  renderItemSupplierChecks();
  renderItemSelect($('inSupplier').value);
  renderItemTable();
}

function openItemEdit(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  $('editItemId').value = it.id;
  $('editItName').value = it.name;
  $('editItPrice').value = it.price!=null? it.price : '';
  $('editItTax').value = it.taxType || 'taxIncluded';
  renderItemSupplierChecks('editItSuppliers');
  const box = $('editItSuppliers');
  (it.suppliers||[]).forEach(sid=>{
    const chk = box.querySelector(`input[value="${sid}"]`);
    if(chk) chk.checked = true;
  });
  $('itemEditModal').style.display = 'block';
  setFabVisible(false);
}
function updateItem(){
  const id = $('editItemId').value;
  const it = items.find(x=>x.id===id);
  if(!it) return;
  const name = $('editItName').value.trim();
  if(!name) return alert('商品名は必須です');
  it.name = name;
  const priceStr = $('editItPrice').value.trim();
  it.price = priceStr==='' ? null : Number(priceStr);
  it.taxType = $('editItTax').value;
  const checks = Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked'));
  const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('紐付け仕入先を1つ以上選択してください');
  it.suppliers = supIds;
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal');
  renderItemSelect($('inSupplier').value);
  renderItemTable();
}
function deleteItem(){
  const id = $('editItemId').value;
  if(!confirm('この商品を削除します。よろしいですか？')) return;
  items = items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal');
  renderItemSelect($('inSupplier').value);
  renderItemTable();
}

/* ====== 設定：基本税率 ====== */
function openSettings(){
  const ratePct = Math.round(getBaseTaxRate()*100);
  const target = ratePct===10 ? '10' : '8';
  const radio = document.querySelector(`input[name="baseRatePreset"][value="${target}"]`);
  if(radio) radio.checked = true;
  $('settingsModal').style.display = 'block';
  setFabVisible(false);
}
function saveBaseTaxRate(){
  const sel = document.querySelector('input[name="baseRatePreset"]:checked');
  if(!sel) { alert('税率を選択してください'); return; }
  const v = Number(sel.value);
  setBaseTaxRate(v/100);
  alert(`基本税率を ${v}% に設定しました`);
  closeModal('settingsModal');
}
function resetBaseTaxRate(){
  setBaseTaxRate(0.08);
  alert('基本税率を 8% に戻しました');
  closeModal('settingsModal');
}

/* ====== 固定バーの表示制御／モーダル ====== */
function setFabVisible(show){
  const bar = document.querySelector('.fab-bar');
  if(!bar) return;
  bar.style.display = show ? 'block' : 'none';
}
function anyModalOpen(){
  return ['supplierModal','supplierEditModal','itemModal','itemEditModal','settingsModal']
    .some(id => document.getElementById(id).style.display === 'block');
}
function closeModal(id){
  $(id).style.display='none';
  if(!anyModalOpen()) setFabVisible(true);
}
window.addEventListener('click', (e)=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('settingsModal')) closeModal('settingsModal');
});

/* ====== 初期化系 ====== */
function wipeAll(){
  if(!confirm('全データ（仕入先・商品・仕入履歴）を削除します。よろしいですか？')) return;
  suppliers=[]; items=[]; purchases=[];
  localStorage.removeItem(LS_KEYS.suppliers);
  localStorage.removeItem(LS_KEYS.items);
  localStorage.removeItem(LS_KEYS.purchases);
  renderSupplierSelect();
  renderItemSelect();
  renderListTable();
  renderPhonebook();
  renderSupTable();
  renderItemTable();
  updateSums();
  updateSupplierQuick('');
}
</script>
</body>
</html>

</body>
</html>
