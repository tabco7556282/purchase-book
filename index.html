<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª v22</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{ --gap:8px; }
  *{ box-sizing: border-box; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin:10px; padding-bottom:92px; }
  h2{ margin:14px 0; }
  input,select,button{ font-size:16px; padding:8px; width:100%; }
  label{ display:block; margin:8px 0 4px; }
  .row{ display:flex; gap:var(--gap); flex-wrap:wrap; }
  .row > *{ flex:1; min-width:120px; }
  button{ background:#16a34a; color:#fff; border:none; border-radius:8px; cursor:pointer; }
  button:hover{ background:#12833c; }
  .ghost{ background:#e5e7eb; color:#111; }
  .ghost:hover{ background:#d1d5db; }
  .link{ background:#2563eb; }
  .link:hover{ background:#1f4ec0; }
  .danger{ background:#ef4444; }
  .danger:hover{ background:#dc2626; }
  .muted{ color:#666; font-size:12px; }
  .small{ color:#555; font-size:12px; }

  .nav{ display:flex; gap:var(--gap); align-items:center; margin-bottom:10px; }
  .nav .spacer{ margin-left:auto; }

  .cards{ display:flex; flex-direction:column; gap:8px; }
  .card{ border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff; }
  .card-header{ display:flex; justify-content:space-between; gap:8px; align-items:center; flex-wrap:wrap; }
  .card-meta{ display:flex; gap:12px; flex-wrap:wrap; color:#555; font-size:13px; margin-top:4px; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid #e5e7eb; padding:6px; text-align:center; word-break:break-all; }
  th{ background:#fafafa; }

  .fab-bar{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e5e7eb; padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left); box-shadow:0 -6px 20px rgba(0,0,0,.06); }
  .fab-inner{ display:flex; gap:8px; max-width:560px; margin:0 auto; }
  .fab-inner > *{ flex:1; }

  .sum{ display:flex; gap:12px; justify-content:flex-end; margin-top:8px; font-weight:700; }
  .filter-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .nowrap{ white-space:nowrap; }

  /* modal */
  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; }
  .modal-content{ background:#fff; margin:6% auto; padding:12px; width:92%; max-width:560px; border-radius:10px; max-height:90vh; overflow:auto; }
  .actions{ display:flex; gap:8px; justify-content:center; position:sticky; bottom:0; background:#fff; padding:8px 0; box-shadow:0 -4px 10px rgba(0,0,0,.04); }
</style>
</head>
<body>
  <div class="nav">
    <button class="ghost" onclick="showPage('entry')">ä¼ç¥¨å…¥åŠ›</button>
    <button class="ghost" onclick="showPage('invoices')">ç´å“æ›¸ä¸€è¦§</button>
    <button class="ghost" onclick="showPage('masters')">ãƒã‚¹ã‚¿</button>
    <button class="ghost" onclick="showPage('phonebook')">é›»è©±å¸³</button>
    <button class="ghost" onclick="openSettings()">âš™ è¨­å®š</button>
    <span class="spacer"></span>
    <span id="appVersion" class="muted">v22.1<\/span>
    <button class="link" onclick="forceUpdateSW()">ğŸ”„ æ›´æ–°</button>
  </div>

  <!-- ä¼ç¥¨å…¥åŠ› -->
  <section id="page-entry">
    <h2>ä¼ç¥¨ï¼ˆç´å“æ›¸ï¼‰å…¥åŠ›</h2>
    <div class="row">
      <div>
        <label>æ—¥ä»˜</label>
        <input type="date" id="invDate">
      </div>
      <div>
        <label>ä»•å…¥å…ˆ</label>
        <select id="invSupplier"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>ä¼ç¥¨ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="invNo" placeholder="ä¾‹ï¼‰IK-2025-00012">
      </div>
      <div>
        <label class="nowrap">ä»•å…¥å…ˆ ç™»éŒ²ç•ªå·</label>
        <input type="text" id="invSupplierRegId" disabled>
      </div>
    </div>

    <h3 style="margin-top:10px;">æ˜ç´°è¿½åŠ </h3>
    <div class="row">
      <div>
        <label style="display:flex; align-items:center; gap:8px;">å•†å“ï¼ˆä»»æ„ãƒ»ãƒã‚¹ã‚¿é€£æºï¼‰
  <span class="small" style="margin-left:auto; display:inline-flex; align-items:center; gap:6px;">
    <input type="checkbox" id="showAllItems" style="width:auto;"> å…¨å•†å“è¡¨ç¤º
  </span>
</label>
<div style="display:flex; gap:8px; align-items:center;">
  <input type="text" id="liSearch" placeholder="å•†å“åã‚’æ¤œç´¢" style="flex:1;" />
  <select id="liItem" style="flex:1;"></select>
</div>
<div class="small" style="margin-top:6px; display:flex; align-items:center; gap:6px;">
  <input type="checkbox" id="autoFillPrice" checked style="width:auto;"> å˜ä¾¡ã‚’è‡ªå‹•å…¥åŠ›ï¼ˆåŸºæº–ä¾¡æ ¼ãŒã‚ã‚Œã°ï¼‰
</div>
      </div>
      <div>
        <label>å•†å“åï¼ˆç›´æ¥å…¥åŠ›å¯ï¼‰</label>
        <input type="text" id="liName" placeholder="ä¾‹ï¼‰å›½ç”£ã‚‚ã‚‚è‚‰ 2kg">
      </div>
    </div>
      <div>
        <label>å•†å“åï¼ˆç›´æ¥å…¥åŠ›å¯ï¼‰</label>
        <input type="text" id="liName" placeholder="ä¾‹ï¼‰å›½ç”£ã‚‚ã‚‚è‚‰ 2kg">
      </div>
    </div>
    <div class="row">
      <div>
        <label>æ•°é‡</label>
        <input type="number" id="liQty" value="1" step="0.1" min="0" onfocus="this.select()">
      </div>
      <div>
        <label>å˜ä¾¡(ç¨åˆ¥)</label>
        <input type="number" id="liUnitEx" value="0" step="1" min="0" onfocus="this.select()">
      </div>
      <div>
        <label>ç¨ç‡</label>
        <select id="liRate">
          <option value="0.08">8%</option>
          <option value="0.10" selected>10%</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button onclick="addLine()">ï¼‹ æ˜ç´°ã‚’è¿½åŠ </button>
      <button class="ghost" onclick="clearLineForm()">ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="card" style="margin-top:10px;">
      <div class="card-header"><b>æ˜ç´°ä¸€è¦§</b></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡(ç¨åˆ¥)</th><th>é‡‘é¡(ç¨åˆ¥)</th><th>ç¨ç‡</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="lineBody"></tbody>
        </table>
      </div>
      <div class="sum">
        <div>å°è¨ˆ(ç¨åˆ¥)ï¼š<span id="sumEx">0</span> å††</div>
        <div>æ¶ˆè²»ç¨é¡ï¼š<span id="sumTax">0</span> å††</div>
        <div>åˆè¨ˆ(ç¨è¾¼)ï¼š<span id="sumIn">0</span> å††</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="link" onclick="saveInvoice()">ä¼ç¥¨ã‚’ä¿å­˜</button>
      <button class="ghost" onclick="newInvoice()">æ–°ã—ã„ä¼ç¥¨</button>
    </div>
  </section>

  <!-- ç´å“æ›¸ä¸€è¦§ -->
  <section id="page-invoices" style="display:none;">
    <h2>ç´å“æ›¸ä¸€è¦§</h2>
    <div class="filter-row" style="margin:6px 0 10px;">
      <label class="muted" style="margin:0;">æœˆ</label>
      <input type="month" id="filterMonth">
      <button class="ghost" onclick="setThisMonth()">ä»Šæœˆ</button>
      <button class="ghost" onclick="clearMonthFilter()">è§£é™¤</button>
      <span id="activeFilter" class="muted"></span>
      <span class="spacer"></span>
      <button class="ghost" onclick="downloadInvoicesCSV()">CSV</button>
      <button class="ghost" onclick="openBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ</button>
    </div>
    <div id="invoiceCards" class="cards"></div>
  </section>

  <!-- ãƒã‚¹ã‚¿ -->
  <section id="page-masters" style="display:none;">
    <h2>ãƒã‚¹ã‚¿</h2>
    <h3>ä»•å…¥å…ˆ</h3>
    <div class="row">
      <input id="supName" placeholder="ç¤¾å"> 
      <input id="supContact" placeholder="æ‹…å½“è€…"> 
      <input id="supPhone" placeholder="é›»è©±ç•ªå·(ãƒã‚¤ãƒ•ãƒ³å¯)"> 
    </div>
    <div class="row">
      <input id="supQID" placeholder="é©æ ¼è«‹æ±‚æ›¸ ç™»éŒ²ç•ªå· (ä¾‹:T1234567890123)"> 
      <button onclick="addSupplier()">ï¼‹ è¿½åŠ </button>
    </div>
    <div class="card" style="margin-top:8px;">
      <table id="supTable">
        <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th>ç™»éŒ²ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:18px;">å•†å“</h3>
    <div class="row">
      <input id="itName" placeholder="å•†å“å"> 
      <input id="itPrice" type="number" step="1" min="0" placeholder="åŸºæº–ä¾¡æ ¼(ä»»æ„)"> 
      <select id="itTax">
        <option value="taxExcluded" selected>ç¨åˆ¥</option>
        <option value="taxIncluded">ç¨è¾¼</option>
      </select>
      <select id="itRate">
        <option value="0.08">ç¨ç‡ 8%</option>
        <option value="0.10" selected>ç¨ç‡ 10%</option>
      </select>
    </div>
    <div class="row">
      <select id="itSupplierMulti" multiple size="4" style="min-height:120px;"></select>
      <button onclick="addItem()">ï¼‹ è¿½åŠ </button>
    </div>
    <div class="card" style="margin-top:8px;">
      <table id="itemTable">
        <thead><tr><th>å•†å“å</th><th>åŸºæº–ä¾¡æ ¼</th><th>ç¨ç‡/åŒºåˆ†</th><th>ä»•å…¥å…ˆ</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- é›»è©±å¸³ -->
  <section id="page-phonebook" style="display:none;">
    <h2>ä»•å…¥å…ˆé›»è©±å¸³</h2>
    <table id="phoneTable">
      <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3>è¨­å®š</h3>
        <button class="ghost" onclick="closeModal('settingsModal')">âœ•</button>
      </div>
      <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡</label>
      <div class="row">
        <button class="ghost" onclick="setBaseTax(0.08)">8%</button>
        <button class="ghost" onclick="setBaseTax(0.10)">10%</button>
        <span class="muted" id="lblBaseTax"></span>
      </div>
      <div class="actions">
        <button onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="backupModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ</h3>
        <button class="ghost" onclick="closeModal('backupModal')">âœ•</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="link" onclick="backupJSON()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <button class="ghost" onclick="restoreFromFile()">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
      </div>
      <p class="small" style="margin-top:6px;">â€» ä»¥å‰ã® v20/v21 ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•ã§ç§»è¡Œã‚’è©¦ã¿ã¾ã™ã€‚</p>
    </div>
  </div>

  <div class="fab-bar">
    <div class="fab-inner">
      <button onclick="openSettings()">âš™ è¨­å®š</button>
      <button class="ghost" onclick="openBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button class="danger" onclick="wipeAll()">å…¨åˆæœŸåŒ–</button>
    </div>
  </div>

<script>
/***** v22 ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ©ã‚¤ãƒˆ *****/
const APP_VERSION = 'v22.1';

/************** LocalStorage Keys **************/
const LS = {
  suppliers: 'v22_suppliers',
  items: 'v22_items',
  invoices: 'v22_invoices',
  baseTax: 'v22_base_tax',
  // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›
  old_suppliers: 'suppliers_v2',
  old_items: 'items_v2',
  old_purchases: 'purchases_v2'
};

/************** State **************/
let suppliers = loadJSON(LS.suppliers, []);
let items     = loadJSON(LS.items, []);
let invoices  = loadJSON(LS.invoices, []);
let BASE_TAX  = Number(localStorage.getItem(LS.baseTax) ?? '0.10');
let FILTER_MONTH = '';

/************** Types (å‚è€ƒ) **************/
// Supplier { id, name, contact, phone, invoiceRegId }
// Item     { id, name, price|null, taxType: 'taxExcluded'|'taxIncluded', defRate?: number, suppliers: [supplierId] }
// Invoice  { id, date:'YYYY-MM-DD', supplierId, supplierName, invoiceNo?, lines:[Line], subtotalEx, taxTotal, grandTotal }
// Line     { id, name, qty, unitEx, rate }

/************** Utils **************/
function $(id){ return document.getElementById(id); }
function uid(){ return 'id_' + Math.random().toString(36).slice(2,10); }
function loadJSON(key, fallback){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; }catch{ return fallback; } }
function save(){ localStorage.setItem(LS.suppliers, JSON.stringify(suppliers)); localStorage.setItem(LS.items, JSON.stringify(items)); localStorage.setItem(LS.invoices, JSON.stringify(invoices)); localStorage.setItem(LS.baseTax, String(BASE_TAX)); }
function yenFloor(n){ return Math.floor(n); }
function formatYen(n){ return (n||0).toLocaleString(); }
function todayStr(){ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; }
function isValidQualifiedId(v){ if(!v) return true; return /^T\d{13}$/.test(v.trim()); }

/************** Navigation **************/
function showPage(p){
  $('page-entry').style.display   = (p==='entry')?'block':'none';
  $('page-invoices').style.display= (p==='invoices')?'block':'none';
  $('page-masters').style.display = (p==='masters')?'block':'none';
  $('page-phonebook').style.display= (p==='phonebook')?'block':'none';
  if(p==='entry') newInvoiceIfEmpty();
  if(p==='invoices') renderInvoiceCards();
  if(p==='masters') { renderSupTable(); renderItemTable(); renderItemSupplierMulti(); }
  if(p==='phonebook') renderPhonebook();
}

/************** Init **************/
document.addEventListener('DOMContentLoaded', init);
function init(){
  $('appVersion').textContent = APP_VERSION;
  migrateFromOldIfNeeded();
  $('invDate').value = todayStr();
  renderSupplierSelect();
  renderItemSelect();
  $('filterMonth').onchange = () => { FILTER_MONTH = $('filterMonth').value || ''; renderInvoiceCards(); updateActiveFilterLabel(); };
  updateActiveFilterLabel();
  $('invSupplier').onchange = onSupplierChange;
  $('liItem').onchange = onItemPicked;
  // æ–°è¦: å•†å“æ¤œç´¢ / å…¨å•†å“è¡¨ç¤ºãƒˆã‚°ãƒ«
  if ($('liSearch')) $('liSearch').addEventListener('input', renderItemSelect);
  if ($('showAllItems')) $('showAllItems').addEventListener('change', renderItemSelect);
  newInvoice();
  updateBaseTaxLabel();
}

/************** Migration (v20/21 -> v22) **************/
function migrateFromOldIfNeeded(){
  if(invoices.length>0 || (localStorage.getItem(LS.old_purchases)===null)) return; // no need or no old
  try{
    const oldSup = loadJSON(LS.old_suppliers, []);
    const oldItems = loadJSON(LS.old_items, []);
    const oldPurch = loadJSON(LS.old_purchases, []);
    if(oldSup.length===0 && oldPurch.length===0) return;

    // shallow copy suppliers/items
    suppliers = oldSup.map(s=> ({ id:s.id||uid(), name:s.name, contact:s.contact||'', phone:s.phone||'', invoiceRegId:s.invoiceRegId||'' }));
    items = oldItems.map(it=> ({ id:it.id||uid(), name:it.name, price: it.price ?? null, taxType: it.taxType||'taxExcluded', suppliers: it.suppliers||[] }));

    // group purchases by supplierId + date (ç´å“æ›¸å˜ä½)
    const buckets = new Map();
    for(const p of oldPurch){
      const key = `${p.supplierId}|${(p.date||'').slice(0,10)}`;
      const arr = buckets.get(key) || []; arr.push(p); buckets.set(key, arr);
    }
    invoices = [];
    for(const [key, arr] of buckets.entries()){
      const [supplierId, date] = key.split('|');
      const s = suppliers.find(x=>x.id===supplierId); const supplierName = s? s.name : '(ä¸æ˜)';
      // convert lines (unit priceåŸºæº–ï¼šç¨åˆ¥æ­£è¦åŒ–)
      const lines = arr.map(p=>{
        const qty = Number(p.qty||0);
        const rate = (p.taxType==='taxExcluded') ? (Number(localStorage.getItem('base_tax_rate_v1')||0.08)) : (Number(localStorage.getItem('base_tax_rate_v1')||0.08));
        const unitEx = (p.taxType==='taxExcluded') ? Number(p.price||0) : Math.floor(Number(p.price||0)/(1+rate));
        const name = (items.find(i=>i.id===p.itemId)||{}).name || '(å•†å“)';
        return { id: uid(), name, qty, unitEx, rate: (rate||0.10) };
      });
      const inv = makeInvoice({ id: uid(), date, supplierId, supplierName, invoiceNo:'', lines });
      invoices.push(inv);
    }
    save();
    alert('æ—§ãƒ‡ãƒ¼ã‚¿ã‚’ v22 å½¢å¼ã¸ç§»è¡Œã—ã¾ã—ãŸ');
  }catch(e){ console.error(e); alert('æ—§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); }
}

/************** Supplier **************/
function renderSupplierSelect(){
  const sel = $('invSupplier');
  sel.innerHTML = '<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>' + suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function onSupplierChange(){
  const s = suppliers.find(x=>x.id===$('invSupplier').value);
  $('invSupplierRegId').value = s?.invoiceRegId || '';
  if ($('showAllItems')) $('showAllItems').checked = false; // ä»•å…¥å…ˆé¸æŠæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§çµã‚Šè¾¼ã¿
  renderItemSelect();
}
function addSupplier(){
  const name = $('supName').value.trim(); if(!name) return alert('ç¤¾åã¯å¿…é ˆã§ã™');
  const contact = $('supContact').value.trim();
  const phone   = $('supPhone').value.trim();
  const qid     = $('supQID').value.trim();
  if(!isValidQualifiedId(qid)) return alert('ç™»éŒ²ç•ªå·ã¯ã€ŒTã€+13æ¡ã®æ•°å­—ï¼ˆä¾‹:T1234567890123ï¼‰');
  suppliers.push({ id:uid(), name, contact, phone, invoiceRegId: qid });
  $('supName').value=''; $('supContact').value=''; $('supPhone').value=''; $('supQID').value='';
  save(); renderSupplierSelect(); renderSupTable(); renderItemSupplierMulti(); renderPhonebook();
}
function renderSupTable(){
  const tb = $('supTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td><td class="nowrap">${s.invoiceRegId||''}</td>
      <td>
        <button class="ghost" onclick="editSupplier('${s.id}')">ç·¨é›†</button>
        <button class="danger" onclick="delSupplier('${s.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function editSupplier(id){
  const s = suppliers.find(x=>x.id===id); if(!s) return;
  const name = prompt('ç¤¾å', s.name); if(name===null) return;
  const contact = prompt('æ‹…å½“è€…', s.contact||''); if(contact===null) return;
  const phone = prompt('é›»è©±', s.phone||''); if(phone===null) return;
  const qid = prompt('ç™»éŒ²ç•ªå·(T+13æ¡ã€ç©ºå¯)', s.invoiceRegId||''); if(qid===null) return; if(!isValidQualifiedId(qid)) return alert('å½¢å¼ã‚¨ãƒ©ãƒ¼');
  s.name=name.trim(); s.contact=contact.trim(); s.phone=phone.trim(); s.invoiceRegId=qid.trim();
  save(); renderSupplierSelect(); renderSupTable(); renderItemSupplierMulti(); renderPhonebook();
}
function delSupplier(id){
  if(!confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚é–¢é€£ã™ã‚‹å•†å“ãƒªãƒ³ã‚¯ã‚‚å¤–ã‚Œã¾ã™ã€‚')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  items = items.map(it=> ({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  invoices = invoices.filter(inv=> inv.supplierId!==id); // ä¼ç¥¨ã‚‚å‰Šé™¤ï¼ˆå®‰å…¨ç¬¬ä¸€ï¼‰
  save(); renderSupplierSelect(); renderSupTable(); renderItemSupplierMulti(); renderInvoiceCards(); renderPhonebook();
}
function renderPhonebook(){
  const tb = $('phoneTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    const telHref = s.phone? `tel:${s.phone}`:'';
    tr.innerHTML = `<td>${s.name}${s.invoiceRegId? `<div class='small'>ç™»éŒ²ç•ªå·: ${s.invoiceRegId}</div>`:''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <a class="link" style="text-decoration:none;display:inline-block;padding:6px 10px;border-radius:8px;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>ğŸ“ é›»è©±</a>
      </td>`;
    tb.appendChild(tr);
  });
}

/************** Items **************/
function renderItemSupplierMulti(){
  const multi = $('itSupplierMulti');
  multi.innerHTML = suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function addItem(){
  const name = $('itName').value.trim(); if(!name) return alert('å•†å“åã¯å¿…é ˆ');
  const price = $('itPrice').value.trim();
  const taxType = $('itTax').value;
  const defRate = Number(($('itRate')?.value)||BASE_TAX);
  const selected = Array.from($('itSupplierMulti').selectedOptions).map(o=>o.value);
  if(selected.length===0) return alert('ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
  items.push({ id:uid(), name, price: price===''? null : Number(price), taxType, defRate, suppliers: selected });
  $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded'; if($('itRate')) $('itRate').value=BASE_TAX.toFixed(2);
  save(); renderItemTable(); renderItemSelect();
});
  $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded';
  save(); renderItemTable(); renderItemSelect();
}
function renderItemTable(){
  const tb = $('itemTable').querySelector('tbody'); tb.innerHTML='';
  items.forEach(it=>{
    if(it.defRate==null) it.defRate = BASE_TAX; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•‘æ¸ˆ
    const names = (it.suppliers||[]).map(id=> suppliers.find(s=>s.id===id)?.name||'').filter(Boolean).join(' / ');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.price!=null? it.price:''}</td><td>${((it.defRate)*100).toFixed(0)}% / ${(it.taxType==='taxExcluded')?'ç¨åˆ¥':'ç¨è¾¼'}</td><td>${names}</td>
      <td>
        <button class="ghost" onclick="editItem('${it.id}')">ç·¨é›†</button>
        <button class="danger" onclick="delItem('${it.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}</td><td>${it.price!=null? it.price:''}</td><td>${it.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td><td>${names}</td>
      <td>
        <button class="ghost" onclick="editItem('${it.id}')">ç·¨é›†</button>
        <button class="danger" onclick="delItem('${it.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function editItem(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const name = prompt('å•†å“å', it.name); if(name===null) return;
  const priceStr = prompt('åŸºæº–ä¾¡æ ¼(ç©ºå¯)', it.price!=null? it.price:''); if(priceStr===null) return;
  const rateStr = prompt('ç¨ç‡: 0.08 ã¾ãŸã¯ 0.10', (it.defRate??BASE_TAX).toFixed(2)); if(rateStr===null) return;
  const taxType = prompt('ç¨åŒºåˆ†: taxExcluded/taxIncluded', it.taxType||'taxExcluded'); if(taxType===null) return;
  const r = Number(rateStr); if(!(r===0.08 || r===0.10)) return alert('0.08 ã‹ 0.10 ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  it.name = name.trim(); it.price = priceStr===''? null : Number(priceStr); it.defRate = r; it.taxType = (taxType==='taxIncluded')?'taxIncluded':'taxExcluded';
  save(); renderItemTable(); renderItemSelect();
}
function delItem(id){
  if(!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã€‚')) return;
  // NOTE: ä¼ç¥¨ã®æ—¢å­˜è¡Œã¯å•†å“åã‚’ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ã—ã¦ã„ã‚‹ã®ã§å½±éŸ¿ãªã—
  items = items.filter(x=>x.id!==id); save(); renderItemTable(); renderItemSelect();
}

/************** Entry (Invoice Editing) **************/
let DRAFT = null; // { id, date, supplierId, supplierName, invoiceNo, lines:[] }
function newInvoice(){
  DRAFT = { id: uid(), date: todayStr(), supplierId:'', supplierName:'', invoiceNo:'', lines:[] };
  $('invDate').value = DRAFT.date; $('invSupplier').value=''; $('invNo').value=''; $('invSupplierRegId').value='';
  renderLineTable();
}
function newInvoiceIfEmpty(){ if(!DRAFT || DRAFT.lines.length===0) newInvoice(); }
function onItemPicked(){
  const it = items.find(x=>x.id===$('liItem').value);
  if(!it) return;
  $('liName').value = it.name;
  const rate = (it.defRate!=null)? it.defRate : BASE_TAX;
  $('liRate').value = rate.toFixed(2);
  if($('autoFillPrice')?.checked && it.price!=null){
    const unitEx = (it.taxType==='taxExcluded') ? Number(it.price) : Math.floor(Number(it.price)/(1+rate));
    $('liUnitEx').value = unitEx;
  }
}
function renderItemSelect(){
  const sid = $('invSupplier').value;
  const showAll = $('showAllItems')?.checked;
  const q = ($('liSearch')?.value || '').trim();
  const sel = $('liItem');
  let list = items.slice();
  if (sid && !showAll) list = list.filter(it => (it.suppliers||[]).includes(sid));
  if (q) list = list.filter(it => (it.name||'').toLowerCase().includes(q.toLowerCase()));
  sel.innerHTML = '<option value="">-- å•†å“ãƒã‚¹ã‚¿ --</option>' +
    list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
}
function addLine(){
  if(!$('invSupplier').value) return alert('å…ˆã«ä»•å…¥å…ˆã‚’é¸æŠ');
  const name = $('liName').value.trim(); if(!name) return alert('å•†å“åã‚’å…¥åŠ›');
  const qty = Number($('liQty').value||0); if(qty<=0) return alert('æ•°é‡ãŒä¸æ­£');
  const unitEx = Number($('liUnitEx').value||0);
  const rate = Number($('liRate').value||BASE_TAX);
  DRAFT.lines.push({ id:uid(), name, qty, unitEx, rate });
  clearLineForm(); renderLineTable();
}
function clearLineForm(){ $('liItem').value=''; $('liName').value=''; $('liQty').value=1; $('liUnitEx').value=0; $('liRate').value=BASE_TAX.toFixed(2); }
function removeLine(id){ DRAFT.lines = DRAFT.lines.filter(l=>l.id!==id); renderLineTable(); }
function editLine(id){
  const l = DRAFT.lines.find(x=>x.id===id); if(!l) return;
  const name = prompt('å•†å“å', l.name); if(name===null) return;
  const qty = prompt('æ•°é‡', l.qty); if(qty===null) return;
  const unit = prompt('å˜ä¾¡(ç¨åˆ¥)', l.unitEx); if(unit===null) return;
  const rate = prompt('ç¨ç‡(ä¾‹:0.10)', l.rate); if(rate===null) return;
  l.name=name.trim(); l.qty=Number(qty); l.unitEx=Number(unit); l.rate=Number(rate);
  renderLineTable();
}
function computeTotals(lines){
  // ç¨ç‡ã”ã¨ã«å°è¨ˆâ†’ç¨é¡(åˆ‡æ¨ã¦)â†’åˆç®—
  const map = new Map();
  let subtotalEx = 0; let taxTotal = 0;
  for(const l of lines){
    const base = l.qty * l.unitEx; subtotalEx += base;
    const prev = map.get(l.rate)||0; map.set(l.rate, prev + base);
  }
  for(const [rate, baseSum] of map.entries()) taxTotal += yenFloor(baseSum * rate);
  return { subtotalEx, taxTotal, grandTotal: subtotalEx + taxTotal };
}
function renderLineTable(){
  const tb = $('lineBody'); tb.innerHTML='';
  DRAFT.date = $('invDate').value;
  DRAFT.supplierId = $('invSupplier').value; DRAFT.supplierName = suppliers.find(s=>s.id===DRAFT.supplierId)?.name || '';
  DRAFT.invoiceNo = $('invNo').value.trim();
  DRAFT.lines.forEach((l,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td style="text-align:left;">${l.name}</td><td>${l.qty}</td><td>${l.unitEx}</td><td>${l.qty*l.unitEx}</td><td>${(l.rate*100).toFixed(0)}%</td>
      <td>
        <button class="ghost" onclick="editLine('${l.id}')">ç·¨é›†</button>
        <button class="danger" onclick="removeLine('${l.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  const t = computeTotals(DRAFT.lines);
  $('sumEx').textContent = formatYen(t.subtotalEx);
  $('sumTax').textContent = formatYen(t.taxTotal);
  $('sumIn').textContent = formatYen(t.grandTotal);
}
function makeInvoice({id, date, supplierId, supplierName, invoiceNo, lines}){
  const t = computeTotals(lines);
  return { id, date, supplierId, supplierName, invoiceNo: invoiceNo||'', lines, subtotalEx: t.subtotalEx, taxTotal: t.taxTotal, grandTotal: t.grandTotal };
}
function saveInvoice(){
  if(!DRAFT) return;
  if(!DRAFT.date) return alert('æ—¥ä»˜ã‚’å…¥åŠ›');
  if(!DRAFT.supplierId) return alert('ä»•å…¥å…ˆã‚’é¸æŠ');
  if(DRAFT.lines.length===0) return alert('æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“');
  const inv = makeInvoice(DRAFT);
  // æ›´æ–° or è¿½åŠ ï¼ˆåŒã˜idãªã‚‰æ›´æ–°ï¼‰
  const i = invoices.findIndex(x=>x.id===inv.id);
  if(i>=0) invoices[i]=inv; else invoices.push(inv);
  save();
  alert('ä¼ç¥¨ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  newInvoice(); renderInvoiceCards();
}

/************** Invoices List **************/
function updateActiveFilterLabel(){ $('activeFilter').textContent = FILTER_MONTH? `é©ç”¨ä¸­ï¼š${FILTER_MONTH}` : ''; }
function setThisMonth(){ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); $('filterMonth').value=`${y}-${m}`; FILTER_MONTH=`${y}-${m}`; updateActiveFilterLabel(); renderInvoiceCards(); }
function clearMonthFilter(){ FILTER_MONTH=''; $('filterMonth').value=''; updateActiveFilterLabel(); renderInvoiceCards(); }
function renderInvoiceCards(){
  const root = $('invoiceCards'); root.innerHTML='';
  let list = invoices.slice().sort((a,b)=> (a.date<b.date?1:-1));
  if(FILTER_MONTH) list = list.filter(inv => (inv.date||'').slice(0,7)===FILTER_MONTH);
  if(list.length===0){ root.innerHTML = '<div class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  list.forEach(inv=>{
    const s = suppliers.find(x=>x.id===inv.supplierId);
    const card = document.createElement('div'); card.className='card';
    const reg = s?.invoiceRegId ? ` / ç™»éŒ²ç•ªå·:${s.invoiceRegId}` : '';
    card.innerHTML = `
      <div class="card-header">
        <div><b>${inv.supplierName}</b> ${reg}</div>
        <div class="small">${inv.date} ${inv.invoiceNo? ' / No.'+inv.invoiceNo : ''}</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th style="text-align:left;">å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡(ç¨åˆ¥)</th><th>é‡‘é¡(ç¨åˆ¥)</th><th>ç¨ç‡</th></tr></thead>
          <tbody>
            ${inv.lines.map((l,i)=>`<tr><td>${i+1}</td><td style="text-align:left;">${l.name}</td><td>${l.qty}</td><td>${l.unitEx}</td><td>${l.qty*l.unitEx}</td><td>${(l.rate*100).toFixed(0)}%</td></tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div class="sum">
        <div>å°è¨ˆ(ç¨åˆ¥)ï¼š${formatYen(inv.subtotalEx)} å††</div>
        <div>æ¶ˆè²»ç¨é¡ï¼š${formatYen(inv.taxTotal)} å††</div>
        <div>åˆè¨ˆ(ç¨è¾¼)ï¼š${formatYen(inv.grandTotal)} å††</div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="ghost" onclick="editInvoice('${inv.id}')">ç·¨é›†</button>
        <button class="danger" onclick="delInvoice('${inv.id}')">å‰Šé™¤</button>
      </div>
    `;
    root.appendChild(card);
  });
}
function editInvoice(id){
  const inv = invoices.find(x=>x.id===id); if(!inv) return;
  DRAFT = JSON.parse(JSON.stringify(inv)); // deep-ish copy
  $('invDate').value = DRAFT.date; $('invSupplier').value = DRAFT.supplierId; $('invNo').value = DRAFT.invoiceNo||''; $('invSupplierRegId').value = suppliers.find(s=>s.id===DRAFT.supplierId)?.invoiceRegId||'';
  renderItemSelect(); renderLineTable(); showPage('entry');
}
function delInvoice(id){ if(!confirm('ã“ã®ä¼ç¥¨ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; invoices = invoices.filter(x=>x.id!==id); save(); renderInvoiceCards(); }

/************** CSV / Backup **************/
function downloadInvoicesCSV(){
  let csv = 'æ—¥ä»˜,ä»•å…¥å…ˆ,ä¼ç¥¨ç•ªå·,å•†å“,æ•°é‡,å˜ä¾¡ç¨åˆ¥,é‡‘é¡ç¨åˆ¥,ç¨ç‡,å°è¨ˆç¨åˆ¥,æ¶ˆè²»ç¨é¡,åˆè¨ˆç¨è¾¼\n';
  invoices.forEach(inv=>{
    inv.lines.forEach(l=>{
      csv += `${inv.date},${inv.supplierName},${inv.invoiceNo||''},${l.name},${l.qty},${l.unitEx},${l.qty*l.unitEx},${(l.rate*100).toFixed(0)}%,${inv.subtotalEx},${inv.taxTotal},${inv.grandTotal}\n`;
    });
  });
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='invoices.csv'; a.click(); URL.revokeObjectURL(url);
}
function openBackup(){ $('backupModal').style.display='block'; }
function backupJSON(){
  const data = { version: APP_VERSION, savedAt: new Date().toISOString(), suppliers, items, invoices, baseTax: BASE_TAX };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `shiire_v22_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
}
async function restoreFromFile(){
  try{
    if('showOpenFilePicker' in window){
      const [handle] = await window.showOpenFilePicker({ types:[{description:'JSON', accept:{'application/json':['.json']}}] });
      const f = await handle.getFile(); const text = await f.text();
      const data = JSON.parse(text);
      if(!data || !data.suppliers || !data.items || !data.invoices) throw new Error('å½¢å¼ä¸æ­£');
      suppliers = data.suppliers; items = data.items; invoices = data.invoices; BASE_TAX = Number(data.baseTax ?? BASE_TAX);
      save();
      alert('å¾©å…ƒã—ã¾ã—ãŸ');
      renderSupplierSelect(); renderItemSelect(); renderSupTable(); renderItemTable(); renderItemSupplierMulti(); renderInvoiceCards(); renderPhonebook(); updateBaseTaxLabel();
    }else{
      const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = ()=>{ const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); suppliers=data.suppliers; items=data.items; invoices=data.invoices; BASE_TAX=Number(data.baseTax ?? BASE_TAX); save(); alert('å¾©å…ƒã—ã¾ã—ãŸ'); renderSupplierSelect(); renderItemSelect(); renderSupTable(); renderItemTable(); renderInvoiceCards(); renderPhonebook(); updateBaseTaxLabel(); }catch(e){ alert('å¾©å…ƒå¤±æ•—: '+e.message);} }; r.readAsText(input.files[0]); }; document.body.appendChild(input); input.click(); setTimeout(()=>document.body.removeChild(input),0);
    }
  }catch(e){ if(e.name!=='AbortError') alert('å¾©å…ƒã«å¤±æ•—: '+e.message); }
}

/************** Settings **************/
function openSettings(){ $('settingsModal').style.display='block'; }
function closeModal(id){ const m=$(id); if(m) m.style.display='none'; }
window.addEventListener('click', (e)=>{ if(e.target===$('settingsModal')) closeModal('settingsModal'); if(e.target===$('backupModal')) closeModal('backupModal'); });
function setBaseTax(v){ BASE_TAX = Number(v); save(); updateBaseTaxLabel(); alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }
function updateBaseTaxLabel(){ $('lblBaseTax').textContent = `ç¾åœ¨: ${(BASE_TAX*100).toFixed(0)}%`; }

/************** SW Update (ä¿æŒ) **************/
async function forceUpdateSW(){ if(!('serviceWorker' in navigator)) { alert('æœªå¯¾å¿œ'); return; } try{ const reg = await navigator.serviceWorker.getRegistration(); if(!reg){ alert('SWæœªç™»éŒ²'); return; } await reg.update(); if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); } navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!window.__reloading){ window.__reloading=true; location.reload(); } }); alert('æ›´æ–°å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ'); }catch(e){ alert('æ›´æ–°å¤±æ•—: '+e.message); } }

/************** Dangerous **************/
function wipeAll(){ if(!confirm('v22ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å®Ÿè¡Œå¾Œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return; suppliers=[]; items=[]; invoices=[]; save(); renderSupplierSelect(); renderItemSelect(); renderSupTable(); renderItemTable(); renderInvoiceCards(); renderPhonebook(); alert('åˆæœŸåŒ–ã—ã¾ã—ãŸ'); }

// --- Service Worker Register ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js?v=22').catch(()=>{});
  });
}

</script>
</body>
</html>
