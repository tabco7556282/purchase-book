<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ä»•å…¥ã‚Œç®¡ç†ï½œMVP v0.7.1</title>
<style>
:root{
  --brand:#FFC107; --brand-ink:#1A1300;
  --bg:#FFFBEA; --card:#FFFDF3;
  --text:#111; --muted:#6B6B6B; --divider:#EEDB9A;
  --danger:#D73C3C; --shadow:0 2px 10px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#18191B; --text:#F5F5F5; --muted:#BABABA; --card:#222325; --divider:#2B2C2F;
  --shadow:0 2px 10px rgba(0,0,0,.5);
}/* === ãƒ€ãƒ¼ã‚¯æ™‚ã®â€œæ·¡è‰²ã‚«ãƒ¼ãƒ‰ä¸Šã®æ–‡å­—ãŒè–„ããªã‚‹â€å¯¾ç­– ================== */
/* 1) ã‚«ãƒ¼ãƒ‰ç”¨ã®é…è‰²å¤‰æ•°ï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯å…±é€šã§èª­ã¿ã‚„ã™ã„ãƒšã‚¢ï¼‰ */
:root{
  --card-bg-soft: #FFF8D6;   /* ãƒ¬ãƒ¢ãƒ³å¯„ã‚Šã®æ·¡ã„èƒŒæ™¯ */
  --card-fg-soft: #2A1A00;   /* ã—ã£ã‹ã‚Šèª­ã‚ã‚‹æ¿ƒã„æ–‡å­—è‰² */
}
[data-theme="dark"]{
  /* ãƒ€ãƒ¼ã‚¯ã§ã‚‚ã‚«ãƒ¼ãƒ‰ã¯æ·¡è‰²ã€ãã®ä¸Šã®æ–‡å­—ã¯æ¿ƒè‰²ã« */
  --card-bg-soft: #FFF2B8;
  --card-fg-soft: #2A1A00;
}

/* 2) ä»•å…¥å…¥åŠ›ãƒšãƒ¼ã‚¸ï¼šæœ¬æ—¥ã®æ˜ç´°ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ã¨â€œï¼‹æ˜ç´°ã‚’è¿½åŠ â€ãƒœã‚¿ãƒ³ã®é…è‰²ã‚’å›ºå®š */
#todayList .list-item{
  background: var(--card-bg-soft) !important;
  color: var(--card-fg-soft) !important;
}
#todayList .list-item b,
#todayList .list-item u,
#todayList .list-item .muted,
#todayList .list-item .entry span{
  color: var(--card-fg-soft) !important;
  opacity: 1;  /* .muted ãŒç™½ã§è–„ããªã‚‹ã®ã‚’æŠ‘æ­¢ */
}

/* æ˜ç´°è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆID: #btnAddLineï¼‰ */
#btnAddLine{
  background: var(--card-bg-soft) !important;
  color: var(--card-fg-soft) !important;
  border: 2px solid rgba(0,0,0,.18);
}
[data-theme="dark"] #btnAddLine{
  border-color: rgba(0,0,0,.26);
}

html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.app-header{position:sticky;top:0;z-index:10;background:var(--brand);color:var(--brand-ink);
  padding:10px 12px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;box-shadow:var(--shadow)}
.app-header h1{margin:0;text-align:center;font-size:18px;letter-spacing:.04em}
.hdr-left{justify-self:start}.hdr-right{justify-self:end;display:flex;gap:8px;align-items:center}
.ver{background:#ffffff80;border:1px solid #ffffffa6;border-radius:999px;padding:2px 8px}
#btnHome{background:#FFE082;color:#5A3A00;border:1px solid #FFFFFF99;box-shadow:0 1px 0 rgba(0,0,0,.06)}

/* ãƒ™ãƒ¼ã‚¹ */
.container{padding:14px;max-width:960px;margin:0 auto}
.nav-vertical{display:flex;flex-direction:column;gap:10px;margin:10px 0}
.btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-weight:700;letter-spacing:.02em;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.btn.primary{background:var(--brand);color:var(--brand-ink)}
.btn.ghost{background:var(--card);border:1px solid var(--divider);color:var(--text)}
.btn.danger{background:#fff;border:1px solid var(--danger);color:var(--danger)}
.btn.small{padding:8px 12px;font-weight:600}
.btn.square{width:100%;height:56px;padding:8px 10px;line-height:1.1;text-align:center;flex-direction:column}
.btn.square .twoline{display:block;line-height:1.1}
#btnAddLine{background:#FFF7CC;border:2px solid #E0B600}
.btn.op{background:#FFF3B0;border:2px solid #E0B600;color:#5A3A00}
.btn.op:active,#btnHome:active{transform:translateY(1px)}

.label{font-size:13px;color:var(--muted);margin:0 0 6px 2px}
.card{background:var(--card);border:1px solid var(--divider);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
input,select,textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--divider);background:#fff;color:var(--text);padding:12px;font-size:16px}
textarea{min-height:84px;resize:vertical}
.row{display:flex;gap:10px;align-items:center}
.row .grow{flex:1}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#FFECB3;color:#5A3A00;font-size:12px}
.section-title{font-weight:800;margin:6px 0 8px}
.fixed-bar{position:sticky;bottom:0;display:flex;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 30%);padding:12px 14px}
.fixed-bar .neg{flex:1}.fixed-bar .pos{flex:2}
.list{display:flex;flex-direction:column;gap:8px}
.list-item{padding:10px 12px;border:1px solid var(--divider);border-radius:12px;background:var(--card)}
#todayList .list-item{background:#FFFDF8;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.list-item.supplier{display:grid;grid-template-columns:1fr 102px;gap:10px;min-height:120px}
.ops-col{display:flex;flex-direction:column;gap:8px;align-items:stretch}

/* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ« */
.theme-toggle{width:40px;height:28px;border-radius:20px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.9);display:flex;align-items:center;padding:2px;cursor:pointer}
.theme-toggle .knob{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#FFD54F;transition:transform .2s ease}
[data-theme="dark"] .theme-toggle{background:#2C2C2E;border-color:#444}
[data-theme="dark"] .theme-toggle .knob{background:#B0B3FF;transform:translateX(12px)}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:flex-end}
.modal{width:100%;background:var(--card);border-radius:16px 16px 0 0;border:1px solid var(--divider);box-shadow:var(--shadow);padding:14px}
.modal h3{margin:2px 0 8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:12px;flex-wrap:nowrap}
.modal .actions .btn{height:44px}
.modal .actions .btn--save{flex:0 0 45%}
.modal .actions .btn--cancel{flex:0 0 30%}
.modal .actions .btn--delete{flex:0 0 18%}
@media (min-width:560px){
  .modal .actions .btn--save{flex-basis:38%}
  .modal .actions .btn--cancel{flex-basis:24%}
  .modal .actions .btn--delete{flex-basis:16%}
}
.sheet{max-width:560px;margin:0 auto}
.hidden{display:none!important}
.mini-meta{font-size:.85em;opacity:.7}
[data-theme="dark"] select,[data-theme="dark"] input,[data-theme="dark"] textarea{background:var(--card);color:var(--text);border-color:#3a3b3f}
[data-theme="dark"] select option{background:#2a2b2e;color:#f5f5f5}
[data-theme="dark"] input::placeholder,[data-theme="dark"] textarea::placeholder{color:rgba(245,245,245,.6)}
[data-theme="dark"] .label{color:#ddd}
[data-theme="dark"] #hisRange{background:var(--card)!important;color:var(--text)!important;border-color:#3a3b3f!important}
</style>
</head>
<body>
<header class="app-header">
  <div class="hdr-left"><button id="btnHome" class="btn ghost small hidden" type="button">â†ğŸ </button></div>
  <h1 id="pageTitle">ä»•å…¥ã‚Œç®¡ç†</h1>
  <div class="hdr-right">
    <small class="ver">v0.7.1</small>
    <button id="themeBtn" class="theme-toggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿"><div class="knob"><span id="themeIcon">â˜€</span></div></button>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="page-home">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <span class="pill" id="pillBackup">æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šæœªå®Ÿæ–½</span>
      <span class="pill" id="pillPlan">ãƒ—ãƒ©ãƒ³ï¼šç„¡æ–™</span>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      <div class="card"><div class="label">ä»Šé€±ã®ä»•å…¥ã‚Œåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div><div id="kpiWeek" style="font-weight:800;font-size:20px">Â¥0</div></div>
      <div class="card"><div class="label">ä»Šæœˆã®ä»•å…¥ã‚Œåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div><div id="kpiMonth" style="font-weight:800;font-size:20px">Â¥0</div></div>
    </div>
    <div class="nav-vertical" style="margin-top:12px">
      <button class="btn primary" data-goto="input" type="button">ä»•å…¥å…¥åŠ›</button>
      <button class="btn ghost" data-goto="history" type="button">å±¥æ­´ãƒ»é›†è¨ˆ</button>
      <button class="btn ghost" data-goto="suppliers" type="button">ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿</button>
      <button class="btn ghost" data-goto="products" type="button">å•†å“ãƒã‚¹ã‚¿</button>
      <button class="btn ghost" id="btnExport" type="button">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
      <button class="btn ghost" data-goto="backup" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</button>
      <button class="btn ghost" data-goto="license" type="button">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</button>
      <button class="btn ghost" data-goto="rights" type="button">æ¨©åˆ©æƒ…å ±</button>
ã€€    <button class="btn danger" id="btnFactoryReset" type="button">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
      <div class="label">â€»åˆæœŸåŒ–ã®å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚</div>
    </div>
  </section>

  <!-- INPUT -->
  <section id="page-input" class="hidden" data-title="ä»•å…¥å…¥åŠ›">
    <div class="card grid">
      <div class="grid cols-2">
        <div><div class="label">æ—¥ä»˜</div><input type="date" id="inDate"></div>
        <div><div class="label">ä»•å…¥ã‚Œå…ˆ</div><select id="inSupplier"></select></div>
      </div>
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">å•†å“ï¼ˆä»•å…¥ã‚Œå…ˆã§çµè¾¼ï¼‰</div>
          <label class="row" style="gap:6px"><input type="checkbox" id="chkFree"> æœªç™»éŒ²ã§å…¥åŠ›</label>
        </div>
        <input id="prodSearch" type="text" placeholder="å•†å“åã§æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰" class="grow" />
        <select id="inProduct" style="margin-top:6px"></select>
        <div id="freeFields" class="grid cols-2 hidden" style="margin-top:8px">
          <div><div class="label">ä»•å…¥ã‚Œå…ˆåï¼ˆæœªç™»éŒ²ï¼‰</div><input id="freeSupplier" type="text"></div>
          <div><div class="label">å•†å“åï¼ˆæœªç™»éŒ²ï¼‰</div><input id="freeProduct" type="text"></div>
        </div>
      </div>
      <div class="grid cols-2">
        <div><div class="label">ä¾¡æ ¼</div><input type="number" id="inPrice" inputmode="numeric" pattern="[0-9]*"></div>
        <div><div class="label">æ•°é‡</div><input type="number" id="inQty" value="1" inputmode="numeric" pattern="[0-9]*"></div>
      </div>
      <div class="row">
        <div class="row" style="gap:16px">
          <label><input type="radio" name="taxmode" value="incl"> ç¨è¾¼</label>
          <label><input type="radio" name="taxmode" value="excl" checked> ç¨åˆ¥</label>
        </div>
        <div class="row" style="gap:10px;margin-left:auto">
          <span class="label">ç¨ç‡</span>
          <label><input type="radio" name="taxrate" value="10">10%</label>
          <label><input type="radio" name="taxrate" value="8" checked>8%</label>
          <label><input type="radio" name="taxrate" value="0">éèª²ç¨</label>
        </div>
      </div>
      <div><div class="label">ä¾¡æ ¼å±¥æ­´ï¼ˆç›´è¿‘ï¼‰</div><div id="priceHistory" class="row" style="flex-wrap:wrap"></div></div>
      <div><div class="label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div><input id="inMemo"></div>
      <button class="btn ghost" id="btnAddLine" type="button">ï¼‹ æ˜ç´°ã‚’è¿½åŠ </button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="section-title">æœ¬æ—¥ã®æ˜ç´°ï¼ˆä»•å…¥ã‚Œå…ˆã§è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</div>
      <div id="todayList" class="list"></div>
    </div>
    <div class="fixed-bar"><button class="btn ghost small neg" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button><button class="btn primary pos" id="btnSave" type="button">ä¿å­˜</button></div>
  </section>

  <!-- SUPPLIERS -->
  <section id="page-suppliers" class="hidden" data-title="ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="section-title">ä»•å…¥ã‚Œå…ˆä¸€è¦§</div>
      <button class="btn primary small" id="btnAddSupplier" type="button">ï¼‹ è¿½åŠ </button>
    </div>
    <div id="supplierList" class="list"></div>
  </section>

  <!-- PRODUCTS -->
  <section id="page-products" class="hidden" data-title="å•†å“ãƒã‚¹ã‚¿">
    <div class="row" style="gap:8px;align-items:center">
      <div class="grow"><div class="label">ä»•å…¥ã‚Œå…ˆã§çµè¾¼</div><select id="filterProdSupplier"></select></div>
      <button class="btn primary small" id="btnAddProduct" type="button">ï¼‹ è¿½åŠ </button>
    </div>
    <div id="productList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- HISTORY -->
  <section id="page-history" class="hidden" data-title="å±¥æ­´ãƒ»é›†è¨ˆ">
    <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div><div class="label">æœŸé–“</div><select id="hisRange"><option value="7">1é€±é–“</option><option value="30" selected>1ãƒ¶æœˆ</option></select></div>
      <div class="row" style="gap:16px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleGross" checked> ç¨åˆ¥å°è¨ˆï¼‹ç¨è¾¼è¡¨ç¤º</label>
        <label class="row" style="gap:6px"><input type="checkbox" id="showDetail"> æ˜ç´°ã®è©³ç´°ï¼ˆå˜ä¾¡ãƒ»ç¨æƒ…å ±ï¼‰</label>
      </div>
    </div>
    <div id="historyList" class="list" style="margin-top:10px"></div>
    <div class="fixed-bar"><button class="btn ghost neg" id="btnExport2" type="button">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button><button class="btn primary pos" data-goto="home" type="button">ãƒ›ãƒ¼ãƒ ã¸</button></div>
  </section>

  <!-- BACKUP / ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
  <section id="page-backup" class="hidden" data-title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š">
    <div class="card">
      <div class="label">æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div><div id="bkLast">æœªå®Ÿæ–½</div><hr>
      <div class="label">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå°†æ¥æ‹¡å¼µï¼‰</div>
      <div class="row" style="gap:16px">
        <label><input type="radio" name="bksched" value="daily" checked> æ¯æ—¥22:00</label>
        <label><input type="radio" name="bksched" value="weekly"> æ¯é€± æœˆæ›œ</label>
        <label><input type="radio" name="bksched" value="manual"> æ‰‹å‹•ã®ã¿</label>
      </div><hr>
      <div class="row" style="gap:10px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleAutoClear" checked> ï¼‹æ˜ç´°è¿½åŠ å¾Œã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢</label>
      </div><hr>
      <div class="row" style="gap:10px"><button class="btn primary" id="btnBackupNow" type="button">ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button><button class="btn ghost" id="btnRestore" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button><input type="file" id="fileRestore" accept="application/json" class="hidden"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="section-title">å¹´åº¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>
      <div class="row" style="justify-content:space-between;align-items:center;gap:6px">
        <div>
          <div class="label">å¯¾è±¡å¹´åº¦ï¼ˆå€‹äººäº‹æ¥­ä¸»ï¼š1æœˆã€œ12æœˆï¼‰</div>
          <div id="fiscalLabel" style="font-weight:800">-</div>
        </div>
        <button class="btn primary small" id="btnArchiveYear" type="button">ã“ã®å¹´åº¦ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
      </div>
      <div class="label" style="margin-top:8px">â€» ä»•å…¥å…ˆãƒ»å•†å“ãƒã‚¹ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚å¯¾è±¡å¹´åº¦ã®æ˜ç´°ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</div>
    </div>
  </section>

  <!-- LICENSE -->
  <section id="page-license" class="hidden" data-title="ãƒ©ã‚¤ã‚»ãƒ³ã‚¹">
    <div class="grid" style="grid-template-columns:1fr;gap:12px">
      <div class="card"><h3>ç„¡æ–™ç‰ˆ</h3><ul><li>åºƒå‘Šã‚ã‚Š</li><li>ä»•å…¥ã‚Œå…ˆ 5ç¤¾ã¾ã§ï¼å•†å“ åˆè¨ˆ50å“ã¾ã§</li><li>å‡ºåŠ›ã¯ç›´è¿‘1ã‹æœˆ</li></ul><button class="btn ghost small" type="button" disabled>ä½¿ç”¨ä¸­</button></div>
      <div class="card"><h3>ãƒŸãƒ‰ãƒ«ï¼ˆÂ¥700ï¼‰</h3><ul><li>åºƒå‘Šãªã—</li><li>ä»•å…¥ã‚Œå…ˆ 20ç¤¾ã¾ã§ï¼1ç¤¾15å“ã®ç›®å®‰</li><li>å‡ºåŠ›ã¯éå»6ã‹æœˆ</li></ul><button class="btn primary small" id="mockBuyMid" type="button">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹</button></div>
      <div class="card"><h3>ãƒ—ãƒ­ï¼ˆÂ¥1,500ï¼‰</h3><ul><li>åºƒå‘Šãªã—</li><li>ä¸Šé™ãªã—</li><li>å‡ºåŠ›ã¯ç„¡åˆ¶é™</li></ul><button class="btn primary small" id="mockBuyPro" type="button">ãƒ•ãƒ«æ©Ÿèƒ½ã§ä½¿ã†</button></div>
    </div>
  </section>
<!-- RIGHTS / æ¨©åˆ©æƒ…å ±ãƒšãƒ¼ã‚¸ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
<section id="page-rights" class="hidden" data-title="Licenses & Notices">
  <div class="card">
    <h3>Licenses & Notices</h3>

    <!-- 1) App & Version (EN) -->
    <section>
      <h4>App & Version</h4>
      <p>Tabco Ledger Plus v0.8.0</p>
    </section>

    <!-- 2) Copyright (EN) -->
    <section>
      <h4>Copyright</h4>
      <p>Â© 2025 Tabco. All rights reserved.</p>
    </section>

    <!-- 3) Trademark Notice (EN) -->
    <section>
      <h4>Trademark Notice</h4>
      <p>â€œTabco Ledger Plusâ€ and related logos are trademarks of Tabco.</p>
    </section>

    <!-- 4) EULAï¼ˆJPï¼‰ -->
    <section>
      <h4>EULAï¼ˆä½¿ç”¨è¨±è«¾ï¼‰</h4>
      <p>æœ¬ã‚¢ãƒ—ãƒªã®ã”åˆ©ç”¨ã«ã‚ˆã‚ŠEULAï¼ˆä½¿ç”¨è¨±è«¾å¥‘ç´„ï¼‰ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
        <a href="#" id="open-eula">EULAã‚’é–‹ã</a></p>
    </section>

    <!-- 5) ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼ˆJPï¼‰ -->
    <section>
      <h4>ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</h4>
      <p>ãƒ‡ãƒ¼ã‚¿ã¯åŸºæœ¬çš„ã«ãŠä½¿ã„ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é¸ã‚“ã å ´åˆã¯ã€ãŠå®¢æ§˜è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    </section>

    <!-- 6) ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJPï¼‰ -->
    <section>
      <h4>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</h4>
      <p>CSVã¯Exceläº’æ›ã®UTF-16LEï¼‹BOMã€CRLFã§å‡ºåŠ›ã—ã¾ã™ã€‚</p>
    </section>

    <!-- 7) ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è¡¨è¨˜ï¼ˆJPï¼‰ -->
    <section>
      <h4>ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è¡¨è¨˜</h4>
      <p>æœ¬ã‚¢ãƒ—ãƒªã«ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã€ãã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚</p>
    </section>

    <!-- 8) ãŠå•ã„åˆã‚ã›ï¼ˆJPï¼‰ -->
    <section>
      <h4>ãŠå•ã„åˆã‚ã›</h4>
      <p>ã”ä¸æ˜ç‚¹ã¯ info@example.com ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</p>
    </section>

    <!-- ãƒãƒƒã‚¸æç”»ãƒ›ã‚¹ãƒˆï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã ã‘ã§ä½¿ã†ï¼‰ -->
    <div id="tlp-rights-badge-host" aria-hidden="true"></div>
  </div>
</section>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ -->
<div id="modalHost" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button class="btn danger small btn--delete delbtn hidden" id="modalDelete">å‰Šé™¤</button>
      <button class="btn ghost small btn--cancel" id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary btn--save" id="modalOK">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* ===== Storage ===== */
const DB = {
  load(){
    const d = JSON.parse(localStorage.getItem("tabco-store")||"{}");
    return Object.assign({
      suppliers:[], products:[], entries:[], priceHistory:{},
      settings:{
        theme:"light", lastBackupAt:null, plan:"free",
        autoClear:true, historyShowBoth:true, showTaxFlags:false,
        recentProducts:[], hisRangeDays:30
      }
    }, d);
  },
  save(d){ localStorage.setItem("tabco-store", JSON.stringify(d)); }
};
let store = DB.load();

/* ===== Utils ===== */
const $  = (s,el)=>(el||document).querySelector(s);
const $$ = (s,el)=>Array.from((el||document).querySelectorAll(s));
const yen=n=>"Â¥"+(Math.round(n||0)).toLocaleString();
const uid=()=>Math.random().toString(36).slice(2,10);
const fmtYMD=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const todayStr=()=>fmtYMD(new Date());
function enableSelectOnFocus(){
  $$('input[type="number"], input[type="text"]').forEach(inp=>{
    const sel=()=>inp.select&&inp.select();
    inp.addEventListener("focus",sel);
    inp.addEventListener("click",sel);
  });
}

/* ===== Theme & Header ===== */
function applyTheme(){
  document.documentElement.setAttribute("data-theme", store.settings.theme==="dark" ? "dark" : "light");
  const ic = $("#themeIcon"); if(ic) ic.textContent = store.settings.theme==="dark" ? "â˜¾" : "â˜€";
}
document.addEventListener("click",(e)=>{
  if(e.target.closest("#themeBtn")){
    store.settings.theme = store.settings.theme==="dark" ? "light" : "dark";
    DB.save(store); applyTheme();
  }
});

// â˜…ãƒšãƒ¼ã‚¸IDâ†’ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡è¨€
function setHeaderTitleByPage(id){
  const map = {
    home:"ä»•å…¥ã‚Œç®¡ç†",
    input:"ä»•å…¥å…¥åŠ›",
    suppliers:"ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿",
    products:"å•†å“ãƒã‚¹ã‚¿",
    history:"å±¥æ­´ãƒ»é›†è¨ˆ",
    backup:"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š",
    export:"ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›",
    license:"ãƒ©ã‚¤ã‚»ãƒ³ã‚¹",
  rights:"Licenses & Notices",
};
  const el=$("#pageTitle"); if(el) el.textContent = map[id] || "";
}

/* ===== History Controlsï¼ˆä¸€æœ¬åŒ–ï¼‰ ===== */
window.HistoryUI = (function(){
  let bound = false;

  function sync(){
    // ç¨åˆ¥å°è¨ˆï¼‹ç¨è¾¼è¡¨ç¤º
    const cbGross = $("#toggleGross");
    if (cbGross) cbGross.checked = !!store.settings.historyShowBoth;

    // â–¼ è¿½åŠ ï¼šæ˜ç´°ã®è©³ç´°
    const cbDet = $("#showDetail");
    if (cbDet) cbDet.checked = !!store.settings.showTaxFlags;

    // æœŸé–“ã‚»ãƒ¬ã‚¯ãƒˆ
    const sel = $("#hisRange");
    if (sel) {
      const v = String(store.settings.hisRangeDays ?? sel.value ?? 30);
      if (sel.value !== v) sel.value = v;
    }
  }

  function bindOnce(){
    if (bound) return;

    document.addEventListener("change", (e) => {
      const t = e.target;
      if (!t) return;

      if (t.id === "toggleGross") {
        store.settings.historyShowBoth = !!t.checked;
        DB.save(store);
        renderHistory();
      }

      // â–¼ è¿½åŠ ï¼šæ˜ç´°ã®è©³ç´°
      if (t.id === "showDetail") {
        store.settings.showTaxFlags = !!t.checked;
        DB.save(store);
        renderHistory(); // ON/OFFå³åæ˜ 
      }

      if (t.id === "hisRange") {
        store.settings.hisRangeDays = Number(t.value || 30);
        DB.save(store);
        renderHistory();
      }
    });

    bound = true;
  }

  return { sync, bindOnce };
})();

/* ===== Routerï¼ˆå§”ä»»ãƒŠãƒ“ã§å®‰å®šåŒ–ï¼‰ ===== */
let internalNav=false;
function showPage(id){
  $$("main section").forEach(s=>s.classList.add("hidden"));
  const page=$("#page-"+id); if(page) page.classList.remove("hidden");

  if(id==="home"){
    $("#btnHome")?.classList.add("hidden");
    $("#pageTitle").textContent="ä»•å…¥ã‚Œç®¡ç†";
  }else{
    $("#btnHome")?.classList.remove("hidden");
    setHeaderTitleByPage(id);
  }

  if(id==="history"){
    HistoryUI.sync();
    HistoryUI.bindOnce();
    try{ renderHistory(); }catch(err){ console.error("renderHistory failed:", err); }
  }

  window.scrollTo(0,0);
}
function navigate(id){ internalNav=true; location.hash=id; showPage(id); internalNav=false; }
window.addEventListener("hashchange",()=>{ if(internalNav) return; showPage(location.hash.replace("#","")||"home"); });
document.addEventListener("click",(e)=>{ const b=e.target.closest("[data-goto]"); if(!b) return; e.preventDefault(); navigate(b.getAttribute("data-goto")); });
document.addEventListener("click",(e)=>{ if(e.target.closest("#btnHome")) navigate("home"); });

/* ===== Home KPIs ===== */
function calcTotals(days){
  const now=new Date(), from=new Date(now.getTime()-days*86400000);
  return store.entries.reduce((sum,e)=>{
    if(e.deleted) return sum;
    const t=new Date(e.date+"T00:00:00");
    if(t>=from&&t<=now){
      const base = e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100);
      sum+=base*e.qty;
    }
    return sum;
  },0);
}
function refreshHome(){
  $("#kpiWeek").textContent = yen(calcTotals(7));
  $("#kpiMonth").textContent = yen(calcTotals(30));
  $("#pillPlan").textContent  = "ãƒ—ãƒ©ãƒ³ï¼š"+(store.settings.plan==="free"?"ç„¡æ–™":store.settings.plan);
  const bk=store.settings.lastBackupAt?new Date(store.settings.lastBackupAt):null;
  $("#pillBackup").textContent = bk?("æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š"+bk.toLocaleString("ja-JP")):"æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šæœªå®Ÿæ–½";
}

/* ===== Sampleï¼ˆåˆå›ã®ã¿ï¼‰ ===== */
function ensureSample(){
  if(store.suppliers.length===0 && store.entries.length===0 && store.products.length===0){
    store.suppliers.push({id:uid(),name:"ç‰å±‹å•†åº—",contact:"å±±ç”°",phone:"075-000-0000",invoice_number:"T1234567890123"});
    store.suppliers.push({id:uid(),name:"ä½è—¤é’æœ",contact:"ä½è—¤",phone:"090-000-0000",invoice_number:"T0000000000000"});
    const s1=store.suppliers[0].id, s2=store.suppliers[1].id;
    store.products.push({id:uid(),supplier_id:s1,name:"ç‰›è‚©ãƒ­ãƒ¼ã‚¹",default_price:2000,tax_rate:10,tax_mode:"incl",note:""});
    store.products.push({id:uid(),supplier_id:s2,name:"ãƒˆãƒãƒˆ",default_price:180,tax_rate:8,tax_mode:"excl",note:""});
    DB.save(store);
  }
}

/* ===== Input ===== */
function fillSupplierSelect(sel){
  sel.innerHTML="";
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
}
function buildProductOptionsForSupplier(supplierId, searchText=""){
  const recents=(store.settings.recentProducts||[]).slice(0,20);
  const list=store.products.filter(p=>!p.deleted&&(!supplierId||p.supplier_id===supplierId));
  const mru=list.filter(p=>recents.includes(p.id));
  const others=list.filter(p=>!recents.includes(p.id));
  const needle=(searchText||"").trim().toLowerCase();
  const match=p=>!needle||p.name.toLowerCase().includes(needle);
  return [...mru.filter(match), ...others.filter(match)];
}
function renderProductSelect(sel,supplierId,searchText=""){
  const items=buildProductOptionsForSupplier(supplierId,searchText);
  const prev=sel.value;
  sel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
  items.forEach(p=>{const o=document.createElement("option");o.value=p.id;o.textContent=p.name;sel.appendChild(o)});
  if(items.some(p=>p.id===prev)) sel.value=prev;
  $("#inPrice").value=""; $("#inQty").value=1;
  $$('input[name=taxrate]').forEach(r=>r.checked=(r.value==="8"));
  $$('input[name=taxmode]').forEach(r=>r.checked=(r.value==="excl"));
  $("#priceHistory").innerHTML="";
}
function fillProductSelect(sel,supplierId){ renderProductSelect(sel,supplierId,$("#prodSearch").value||""); }
function renderPriceHistory(pid){
  const w=$("#priceHistory"); w.innerHTML="";
  (store.priceHistory[pid]||[]).slice(-3).reverse().forEach(v=>{
    const b=document.createElement("button");
    b.className="btn ghost small"; b.type="button"; b.textContent="Â¥"+v.price;
    b.onclick=()=>$("#inPrice").value=v.price; w.appendChild(b);
  });
}
const supplierName=id=>(store.suppliers.find(x=>x.id===id)||{}).name||null;
const prodName=(id,fb)=>(store.products.find(x=>x.id===id)||{}).name||(fb||"æœªç™»éŒ²");
function toggleFreeInput(){
  const on=$("#chkFree").checked;
  $("#freeFields").classList.toggle("hidden",!on);
  $("#inSupplier").disabled=on; $("#inProduct").disabled=on; $("#prodSearch").disabled=on;
}
function initInputPage(){
  $("#inDate").value=todayStr();
  fillSupplierSelect($("#inSupplier"));
  const sid=$("#inSupplier").value;
  renderProductSelect($("#inProduct"),sid,"");
  $("#prodSearch").value=""; $("#inQty").value=1; $("#inPrice").value=""; $("#inMemo").value="";
  toggleFreeInput();
}
document.addEventListener("change",(e)=>{ if(e.target.id==="chkFree") toggleFreeInput(); });
document.addEventListener("change",(e)=>{ if(e.target.id==="inSupplier") renderProductSelect($("#inProduct"),e.target.value,$("#prodSearch").value||""); });
document.addEventListener("input",(e)=>{ if(e.target.id==="prodSearch") renderProductSelect($("#inProduct"),$("#inSupplier").value,e.target.value); });
document.addEventListener("change",(e)=>{
  if(e.target.id==="inProduct"){
    const p=store.products.find(x=>x.id===e.target.value);
    if(p){
      $("#inPrice").value=p.default_price||"";
      $$('input[name=taxrate]').forEach(r=>r.checked=String(p.tax_rate)===r.value);
      $$('input[name=taxmode]').forEach(r=>r.checked=(p.tax_mode||"excl")===r.value);
      renderPriceHistory(p.id);
    }else{
      $("#priceHistory").innerHTML="";
    }
  }
});
// ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿ï¼šï¼‹è¿½åŠ 
document.addEventListener("click",(e)=>{ if(e.target.id==="btnAddSupplier") openSupplierModal(null); });
// å•†å“ãƒã‚¹ã‚¿ï¼šï¼‹è¿½åŠ ï¼ˆçµè¾¼ã®é¸æŠã‚’åˆæœŸå€¤ï¼‰
document.addEventListener("click",(e)=>{
  if(e.target.id==="btnAddProduct"){
    const sid = $("#filterProdSupplier")?.value || (store.suppliers[0]?.id || "");
    openProductModal(null, sid);
  }
});

function calcLineTotal(e){
  const p=Number(e.price)||0, q=Number(e.qty)||0, r=Number(e.taxrate)||0;
  const base = p*q;
  if(e.taxmode==="incl"){ const excl = Math.round(base/(1+r/100)); return {excl, incl: base}; }
  else if(e.taxmode==="excl"){ const incl = Math.round(base*(1+r/100)); return {excl: base, incl}; }
  else { return {excl: base, incl: base}; }
}

/* MRU */
function bumpRecentProduct(pid){
  if(!pid) return;
  const arr = store.settings.recentProducts || [];
  const i = arr.indexOf(pid);
  if(i>=0) arr.splice(i,1);
  arr.unshift(pid);
  store.settings.recentProducts = arr.slice(0,20);
}

document.addEventListener("click",(e)=>{ if(e.target.id==="btnAddLine") addLine(); });
function addLine(){
  const date=$("#inDate").value||todayStr();
  const free=$("#chkFree").checked;
  const supplier_id=free?null:($("#inSupplier").value||null);
  const product_id=free?null:($("#inProduct").value||null);
  const supplier_name_fallback=free?($("#freeSupplier").value||"æœªç™»éŒ²"):(supplierName(supplier_id)||"æœªç™»éŒ²");
  const product_name_fallback=free?($("#freeProduct").value||"æœªç™»éŒ²"):null;
  const qty=Number($("#inQty").value||1);
  const price=Number($("#inPrice").value||0);
  const taxrate=Number(document.querySelector('input[name=taxrate]:checked').value);
  const taxmode=document.querySelector('input[name=taxmode]:checked').value;
  if(!price||!qty){alert("ä¾¡æ ¼ã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}
  store.entries.push({id:uid(),date,supplier_id,product_id,supplier_name_fallback,product_name_fallback,qty,price,taxrate,taxmode,memo:$("#inMemo").value||""});
  if(product_id){
    const arr=store.priceHistory[product_id]||[];
    arr.push({price,ts:Date.now(),taxrate,taxmode});
    store.priceHistory[product_id]=arr.slice(-5);
  }
  bumpRecentProduct(product_id);
  DB.save(store); renderTodayList(); refreshHome();
  if(store.settings.autoClear){
    $("#inProduct").value=""; $("#inPrice").value=""; $("#inQty").value=1; $("#inMemo").value=""; $("#priceHistory").innerHTML="";
  }
}

document.addEventListener("click",(e)=>{ if(e.target.id==="btnSave"){ alert("ä¿å­˜ã—ã¾ã—ãŸ"); navigate("home"); refreshHome(); }});
document.addEventListener("click",(e)=>{ if(e.target.id==="btnClear"){ $("#inQty").value=1;$("#inPrice").value="";$("#inMemo").value="";$("#inProduct").value="";$("#priceHistory").innerHTML=""; }});

// å•†å“ãƒã‚¹ã‚¿ï¼šç·¨é›†ï¼ˆå§”è­²ï¼‰
document.addEventListener("click",(e)=>{
  const btn = e.target.closest("#productList .edit");
  if(!btn) return;
  const pid = btn.getAttribute("data-id");
  if(!pid){ alert("å•†å“IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  const p = store.products.find(x=>!x.deleted && x.id===pid);
  if(!p){ alert("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  openProductModal(p);
});

/* Today list */
function renderTodayList(){
  const cont=$("#todayList"); if(!cont) return;
  cont.innerHTML="";
  const d=todayStr(); const group={};
  store.entries.filter(x=>!x.deleted && x.date===d).forEach(e=>{
    const key=e.supplier_id||e.supplier_name_fallback||"æœªæŒ‡å®š";
    (group[key]=group[key]||[]).push(e);
  });
  Object.keys(group).forEach(k=>{
    const sup=supplierName(k)||k;
    const div=document.createElement("div"); div.className="list-item";
    let net=0,gross=0; group[k].forEach(e=>{const t=calcLineTotal(e); net+=t.excl; gross+=t.incl;});
    let html=`<b>${sup}</b><div class="muted">ç¨åˆ¥ ${yen(net)}ï½œç¨è¾¼ ${yen(gross)}</div>`;
    html+=group[k].map(e=>{
      const t=calcLineTotal(e);
      const txLabel=e.taxmode==="incl"?"ç¨è¾¼":(e.taxrate===0?"éèª²ç¨":"ç¨åˆ¥");
      const show=(e.taxmode==="incl")?t.incl:t.excl;
      const meta = store.settings.showTaxFlags ? `<br><span class="mini-meta">å˜ä¾¡ ${yen(e.price)} / ${e.taxrate}% / ${txLabel}</span>` : "";
      return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
        <span>ãƒ»${prodName(e.product_id,e.product_name_fallback)} Ã—${e.qty}${meta}</span>
        <span>${yen(show)}</span>
      </div>`;
    }).join("");
    div.innerHTML=html; cont.appendChild(div);
  });
}

/* ===== Supplier/Product ===== */
function renderSuppliers(){
  const list=$("#supplierList"); if(!list) return;
  list.innerHTML="";
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const prodCount=store.products.filter(p=>!p.deleted&&p.supplier_id===s.id).length;
    const item=document.createElement("div"); item.className="list-item supplier";
    item.innerHTML=`
      <div class="tapzone">
        <b>${s.name}</b>
        <div class="muted">æ‹…å½“:${s.contact||"-"}ã€€TEL:${s.phone||"-"}ã€€INV:${s.invoice_number||"-"}</div>
        <div class="muted">ï½œå•†å“${prodCount}ä»¶</div>
      </div>
      <div class="ops-col">
        <button class="btn op small square addp" type="button"><span class="twoline">ï¼‹<br>å•†å“è¿½åŠ </span></button>
        <button class="btn op small square edit" type="button">ç·¨é›†</button>
      </div>`;
    list.appendChild(item);
  });
}
function fillFilterSupplier(){
  const sel=$("#filterProdSupplier"); if(!sel) return;
  const cur=sel.value;
  sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

// ä»•å…¥å…ˆã‚«ãƒ¼ãƒ‰ã®å§”ä»»ã‚¯ãƒªãƒƒã‚¯
document.addEventListener("click",(e)=>{
  const addp=e.target.closest("#supplierList .addp");
  const edit=e.target.closest("#supplierList .edit");
  const tap =e.target.closest("#supplierList .tapzone");
  if(addp){
    const item=addp.closest(".list-item");
    const name=item.querySelector("b").textContent;
    const sup=store.suppliers.find(s=>s.name===name);
    if(sup){ openProductModal(null,sup.id); }
  }else if(edit){
    const item=edit.closest(".list-item");
    const name=item.querySelector("b").textContent;
    const sup=store.suppliers.find(s=>s.name===name);
    if(sup){ openSupplierModal(sup); }
  }else if(tap){
    const item=tap.closest(".list-item");
    const name=item.querySelector("b").textContent;
    const sup=store.suppliers.find(s=>s.name===name);
    if(sup){ navigate("products"); $("#filterProdSupplier").value=sup.id; renderProducts(); }
  }
});

function renderProducts(){
  const list=$("#productList"); if(!list) return;
  const sid=$("#filterProdSupplier").value;
  const items=store.products.filter(p=>!p.deleted&&(!sid||p.supplier_id===sid));
  list.innerHTML="";
  items.forEach(p=>{
    const sName=supplierName(p.supplier_id)||"-";
    const item=document.createElement("div"); item.className="list-item";
    item.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${p.name}</b>
          <div class="muted">${sName}ï½œæ—¢å®šä¾¡æ ¼ ${yen(p.default_price||0)}ï½œ${p.tax_rate}%ï½œ${p.tax_mode==="incl"?"ç¨è¾¼":"ç¨åˆ¥"}</div>
          ${p.note?(`<div class="muted">ãƒ¡ãƒ¢ï¼š${p.note}</div>`):""}
        </div>
        <div style="width:102px">
          <button class="btn op small square edit" type="button" data-id="${p.id}">ç·¨é›†</button>
        </div>
      </div>`;
    list.appendChild(item);
  });
}
document.addEventListener("change",(e)=>{ if(e.target.id==="filterProdSupplier") renderProducts(); });

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«åŸºç›¤ ===== */
function closeModal(){ $("#modalHost").classList.add("hidden"); $("#modalHost").setAttribute("aria-hidden","true"); }
function openModalBase(title,bodyHTML){
  $("#modalTitle").textContent=title;
  $("#modalBody").innerHTML=bodyHTML;
  const host=$("#modalHost");
  const ok=$("#modalOK"), cancel=$("#modalCancel"), del=$("#modalDelete");
  ok.textContent="ä¿å­˜"; cancel.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; del.textContent="å‰Šé™¤";
  ok.onclick=null; del.onclick=null; cancel.onclick=closeModal;
  del.classList.add("hidden");
  ok.classList.add("btn--save"); cancel.classList.add("btn--cancel"); del.classList.add("btn--delete");
  host.classList.remove("hidden"); host.setAttribute("aria-hidden","false");
}
(function(){
  const host=$("#modalHost"); if(!host||host.__bound) return;
  host.addEventListener("click",e=>{ if(e.target===host) closeModal(); });
  document.addEventListener("keydown",e=>{ if(e.key==="Escape" && !host.classList.contains("hidden")) closeModal(); });
  host.__bound=true;
})();

/* ===== Supplier / Product Modals ===== */
function openSupplierModal(s){
  openModalBase(s?"ä»•å…¥ã‚Œå…ˆã‚’ç·¨é›†":"ä»•å…¥ã‚Œå…ˆã‚’è¿½åŠ ",`
    <div class="grid cols-2">
      <div><div class="label">ç¤¾å</div><input id="mSupName" type="text" value="${s?.name||""}"></div>
      <div><div class="label">æ‹…å½“è€…</div><input id="mSupContact" type="text" value="${s?.contact||""}"></div>
      <div><div class="label">é›»è©±</div><input id="mSupPhone" type="text" value="${s?.phone||""}" inputmode="tel"></div>
      <div><div class="label">ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·</div><input id="mSupInv" type="text" value="${s?.invoice_number||""}"></div>
    </div>`);
  const onOK=()=>{
    const name=$("#mSupName").value.trim(); if(!name){ alert("ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const contact=$("#mSupContact").value.trim();
    const phone  =$("#mSupPhone").value.trim();
    const inv    =$("#mSupInv").value.trim();
    if(s){ s.name=name; s.contact=contact; s.phone=phone; s.invoice_number=inv; }
    else { store.suppliers.push({id:uid(),name,contact,phone,invoice_number:inv}); }
    DB.save(store); renderSuppliers(); refreshHome(); fillSupplierSelect($("#inSupplier")); closeModal();
  };
  $("#modalOK").onclick=onOK;

  if(s){
    const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
    delBtn.onclick=()=>{ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ s.deleted=true; DB.save(store); renderSuppliers(); refreshHome(); closeModal(); } };
    $(".actions").insertBefore(delBtn, $("#modalCancel"));
  }
}

function openProductModal(p,defaultSid){
  const supOpts=store.suppliers.filter(s=>!s.deleted).map(s=>`<option value="${s.id}" ${(p?.supplier_id||defaultSid)===s.id?"selected":""}>${s.name}</option>`).join("");
  openModalBase(p?"å•†å“ã‚’ç·¨é›†":"å•†å“ã‚’è¿½åŠ ",`
    <div class="grid cols-2">
      <div><div class="label">ä»•å…¥ã‚Œå…ˆ</div><select id="mProdSup">${supOpts}</select></div>
      <div><div class="label">å•†å“å</div><input id="mProdName" type="text" value="${p?.name||""}"></div>
      <div><div class="label">æ—¢å®šä¾¡æ ¼</div><input id="mProdPrice" type="number" inputmode="numeric" value="${p?.default_price??""}"></div>
      <div><div class="label">ç¨ç‡</div><select id="mProdRate">
        <option value="10" ${p?.tax_rate===10?"selected":""}>10%</option>
        <option value="8" ${p?.tax_rate===8||p==null?"selected":""}>8%</option>
        <option value="0" ${p?.tax_rate===0?"selected":""}>éèª²ç¨</option>
      </select></div>
      <div><div class="label">åŒºåˆ†</div><select id="mProdMode">
        <option value="excl" ${(p?.tax_mode||"excl")==="excl"?"selected":""}>ç¨åˆ¥</option>
        <option value="incl" ${(p?.tax_mode||"excl")==="incl"?"selected":""}>ç¨è¾¼</option>
      </select></div>
      <div style="grid-column:1/-1">
        <div class="label">å•†å“ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="mProdNote" placeholder="ä¾‹ï¼šå…¥æ•°24ãƒ»ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ 2æ—¥ãªã©">${p?.note||""}</textarea>
      </div>
    </div>`);
  const onOK=()=>{
    const sid=$("#mProdSup").value;
    const name=$("#mProdName").value.trim();
    if(!sid||!name){ alert("ä»•å…¥ã‚Œå…ˆã¨å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(!p && store.products.some(x=>!x.deleted&&x.supplier_id===sid&&x.name===name)){
      if(!confirm("åŒä¸€ä»•å…¥ã‚Œå…ˆã«åŒåã®å•†å“ãŒã‚ã‚Šã¾ã™ã€‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
    }
    const price=Number($("#mProdPrice").value||0);
    const tax_rate=Number($("#mProdRate").value||8);
    const tax_mode=$("#mProdMode").value||"excl";
    const note=$("#mProdNote").value||"";
    if(p){ p.supplier_id=sid; p.name=name; p.default_price=price; p.tax_rate=tax_rate; p.tax_mode=tax_mode; p.note=note; }
    else { store.products.push({id:uid(),supplier_id:sid,name,default_price:price,tax_rate:tax_rate,tax_mode:tax_mode,note}); }
    DB.save(store); renderProducts(); renderProductSelect($("#inProduct"),$("#inSupplier").value,$("#prodSearch").value||""); closeModal();
  };
  $("#modalOK").onclick=onOK;

  if(p){
    const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
    delBtn.onclick=()=>{ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ p.deleted=true; DB.save(store); renderProducts(); closeModal(); } };
    $(".actions").insertBefore(delBtn, $("#modalCancel"));
  }
}

/* ===== æ˜ç´°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openEntryModal(e){
  const pname=prodName(e.product_id,e.product_name_fallback);
  openModalBase("æ˜ç´°ã‚’ç·¨é›†",`
    <div class="grid cols-2">
      <div><div class="label">å•†å“</div><input type="text" value="${pname}" disabled></div>
      <div><div class="label">æ•°é‡</div><input id="mQty" type="number" inputmode="numeric" value="${e.qty}"></div>
      <div><div class="label">å˜ä¾¡</div><input id="mPrice" type="number" inputmode="numeric" value="${e.price}"></div>
      <div><div class="label">ç¨ç‡</div><select id="mRate">
        <option value="10" ${e.taxrate===10?"selected":""}>10%</option>
        <option value="8" ${e.taxrate===8?"selected":""}>8%</option>
        <option value="0" ${e.taxrate===0?"selected":""}>éèª²ç¨</option>
      </select></div>
      <div style="grid-column:1/-1">
        <div class="row" style="gap:16px">
          <label><input type="radio" name="mMode" value="incl" ${e.taxmode==="incl"?"checked":""}> ç¨è¾¼</label>
          <label><input type="radio" name="mMode" value="excl" ${e.taxmode==="excl"?"checked":""}> ç¨åˆ¥</label>
        </div>
      </div>
      <div style="grid-column:1/-1"><div class="label">ãƒ¡ãƒ¢</div><textarea id="mMemo">${e.memo||""}</textarea></div>
    </div>`);
  $("#modalOK").onclick=()=>{
    e.qty=Number($("#mQty").value||1);
    e.price=Number($("#mPrice").value||0);
    e.taxrate=Number($("#mRate").value||8);
    e.taxmode=document.querySelector('input[name="mMode"]:checked').value;
    e.memo=$("#mMemo").value||"";
    DB.save(store);
    if(e.product_id){
      const arr=store.priceHistory[e.product_id]||[];
      arr.push({price:e.price,ts:Date.now(),taxrate:e.taxrate,taxmode:e.taxmode});
      store.priceHistory[e.product_id]=arr.slice(-5);
    }
    bumpRecentProduct(e.product_id);
    renderTodayList(); renderHistory(); refreshHome(); closeModal();
  };
  const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
  delBtn.onclick=()=>{ if(confirm("ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ store.entries=store.entries.filter(x=>x.id!==e.id); DB.save(store); renderTodayList(); renderHistory(); refreshHome(); closeModal(); } };
  $(".actions").insertBefore(delBtn, $("#modalCancel"));
}

/* ===== HISTORYï¼ˆæç”»ï¼‰ ===== */
function renderHistory(){
  const list = $("#historyList"); if(!list) return;

  let days = Number(store.settings.hisRangeDays ?? ($("#hisRange")?.value || 30));
  if(!Number.isFinite(days) || days<=0) days=30;

  const showBoth = !!store.settings.historyShowBoth;

  const now = new Date(); now.setHours(23,59,59,999);
  const from = new Date(now.getTime() - (days-1)*86400000); from.setHours(0,0,0,0);

  list.innerHTML = "";

  const entries = (store.entries||[]).filter(e=>!e?.deleted);
  if(!entries.length){ list.innerHTML = `<div class="muted">å¯¾è±¡æœŸé–“ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; return; }

  const byDate={};
  for(const e of entries){
    if(!e.date) continue;
    const d=new Date(e.date+"T12:00:00");
    if(d>=from && d<=now){ (byDate[e.date]=byDate[e.date]||[]).push(e); }
  }
  const dates=Object.keys(byDate).sort().reverse();
  if(!dates.length){ list.innerHTML = `<div class="muted">å¯¾è±¡æœŸé–“ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; return; }

  for(const dkey of dates){
    const sec=document.createElement("div"); sec.className="card";
    let html = `<b>${new Date(dkey+"T12:00:00").toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"short"})}</b>`;

    const group={};
    for(const e of byDate[dkey]){
      const skey=e.supplier_id||e.supplier_name_fallback||"æœªæŒ‡å®š";
      (group[skey]=group[skey]||[]).push(e);
    }

    for(const skey of Object.keys(group)){
      const name=supplierName(skey)||skey;
      let net=0,gross=0;
      for(const e of group[skey]){ const t=calcLineTotal(e); net+=t.excl; gross+=t.incl; }
      const headerTotals = showBoth ? `ç¨åˆ¥ ${yen(net)}ï½œç¨è¾¼ ${yen(gross)}` : `ç¨è¾¼ ${yen(gross)}`;
      html += `<div style="margin-top:6px"><u>${name}</u>ã€€<span class="muted">${headerTotals}</span>`;

      html += group[skey].map(e=>{
        const t=calcLineTotal(e);
        const show=(e.taxmode==="incl")?t.incl:t.excl; // è¡Œåˆè¨ˆï¼ˆå•†å“åˆ¥åˆè¨ˆï¼‰
        const txLabel=(e.taxmode==="incl")?"ç¨è¾¼":(e.taxrate===0?"éèª²ç¨":"ç¨åˆ¥");
        const meta = store.settings.showTaxFlags ? `<br><span class="mini-meta">å˜ä¾¡ ${yen(e.price)} / ${e.taxrate||0}% / ${txLabel}</span>` : "";
        return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
          <span>ãƒ»${prodName(e.product_id,e.product_name_fallback)} Ã—${e.qty}${meta}</span>
          <span>${yen(show)}</span>
        </div>`;
      }).join("");

      html += `</div>`;
    }

    sec.innerHTML=html; list.appendChild(sec);
  }
}
document.addEventListener("click",(e)=>{
  const el=e.target.closest("#historyList .entry");
  if(!el) return;
  const id=el.getAttribute("data-id");
  const ent=store.entries.find(x=>x.id===id);
  if(ent) openEntryModal(ent);
});

/* ===== Export ===== */
function ModalExport(){
  openModalBase("ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›","<div>Excelã§é–‹ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼ˆå½“æœˆåˆ†ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>");
  $("#modalOK").textContent="å‡ºåŠ›ã™ã‚‹";
  $("#modalOK").onclick=()=>{ exportData(); closeModal(); };
}
function exportData(){
  const dt=new Date();
  const ym=dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
  const rows=[["æ—¥ä»˜","ä»•å…¥ã‚Œå…ˆ","å•†å“","æ•°é‡","å˜ä¾¡","ç¨ç‡","åŒºåˆ†","ç¨è¾¼é¡","ãƒ¡ãƒ¢"]];
  store.entries.filter(e=>!e.deleted).forEach(e=>{
    if(e.date.slice(0,7)===ym){
      const s=supplierName(e.supplier_id)||e.supplier_name_fallback||"";
      const p=prodName(e.product_id,e.product_name_fallback);
      const g=(e.taxmode==="incl"?e.price:e.price*(1+e.taxrate/100))*e.qty;
      rows.push([e.date,s,p,e.qty,e.price,e.taxrate,(e.taxmode==="incl"?"ç¨è¾¼":"ç¨åˆ¥"),Math.round(g),e.memo||""]);
    }
  });
  const csv=rows.map(r=>r.map(x=>'"'+String(x).replace(/"/g,'""')+'"').join(",")).join("\n");
  downloadCsv("ä»•å…¥ã‚Œè¨˜éŒ²_"+ym+".csv", csv);
alert("å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆExcelã§é–‹ã‘ã¾ã™ï¼‰");

}
document.addEventListener("click",(e)=>{ if(e.target.closest("#btnExport, #btnExport2")){ e.preventDefault(); ModalExport(); }}, true);

/* ===== Backup / Restore / Fiscal Archive ===== */
function backupNow(){
  const payload={version:"1.0",exported_at:new Date().toISOString(),
    tables:{suppliers:store.suppliers,products:store.products,entries:store.entries,priceHistory:store.priceHistory,settings:store.settings}};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tabco_backup_"+fmtYMD(new Date())+".json"; a.click(); URL.revokeObjectURL(a.href);
  store.settings.lastBackupAt=Date.now(); DB.save(store); refreshHome();
  const bk=$("#bkLast"); if(bk) bk.textContent=new Date(store.settings.lastBackupAt).toLocaleString("ja-JP");
}
document.addEventListener("click",(e)=>{ if(e.target.id==="btnBackupNow") backupNow(); });
document.addEventListener("click",(e)=>{ if(e.target.id==="btnRestore") $("#fileRestore").click(); });
document.addEventListener("change",(e)=>{
  if(e.target.id!=="fileRestore") return;
  const f=e.target.files[0]; if(!f) return;
  if(!confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result); if(!data.tables) throw 0;
      store.suppliers=data.tables.suppliers||[];
      store.products=data.tables.products||[];
      store.entries=data.tables.entries||[];
      store.priceHistory=data.tables.priceHistory||{};
      store.settings=Object.assign({
        theme:store.settings.theme, plan:store.settings.plan, autoClear:true,
        historyShowBoth:true, showTaxFlags:false, recentProducts:store.settings.recentProducts||[], hisRangeDays:30
      }, data.tables.settings||{});
      DB.save(store);
      alert("å¾©å…ƒã—ã¾ã—ãŸ");
      applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); fillFilterSupplier(); renderProducts(); renderHistory(); navigate("home"); enableSelectOnFocus();
    }catch{ alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"); }
  };
  r.readAsText(f);
});

function refreshFiscalLabel(){
  const y=new Date().getFullYear();
  const el=$("#fiscalLabel"); if(el) el.textContent=`å¯¾è±¡ï¼š${y}å¹´ï¼ˆ1æœˆã€œ12æœˆï¼‰`;
}
document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnArchiveYear") return;
  const year=new Date().getFullYear();
  if(!confirm(`${year}å¹´ã®ä»•å…¥æ˜ç´°ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\nå…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  backupNow();
  const target=store.entries.filter(e=>e.date && e.date.startsWith(String(year)+"-"));
  const archivePayload={version:"1.0",fiscal_year:year,exported_at:new Date().toISOString(),tables:{entries:target}};
  const blob2=new Blob([JSON.stringify(archivePayload,null,2)],{type:"application/json"});
  const a2=document.createElement("a"); a2.href=URL.createObjectURL(blob2); a2.download=`tabco_archive_${year}å¹´åº¦.json`; a2.click(); URL.revokeObjectURL(a2.href);
  store.entries = store.entries.filter(e=>!(e.date && e.date.startsWith(String(year)+"-")));
  DB.save(store);
  alert(`${year}å¹´ã®æ˜ç´°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆä»•å…¥å…ˆãƒ»å•†å“ã¯æ®‹ã—ã¦ã„ã¾ã™ï¼‰`);
  renderTodayList(); renderHistory(); refreshHome();
});

/* ===== Factory Reset ===== */
document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnFactoryReset") return;
  if(!confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å–å¾—æ¸ˆã¿ã§ã™ã‹ï¼Ÿ\n\næœªå–å¾—ã®å ´åˆã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã¸ç§»å‹•ã—ã¾ã™ã€‚")){ navigate("backup"); return; }
  if(!confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
  const keep={
    theme:store.settings.theme, plan:store.settings.plan, autoClear:store.settings.autoClear,
    lastBackupAt:store.settings.lastBackupAt, historyShowBoth:store.settings.historyShowBoth,
    showTaxFlags:store.settings.showTaxFlags, recentProducts:store.settings.recentProducts||[], hisRangeDays:store.settings.hisRangeDays||30
  };
  store={suppliers:[],products:[],entries:[],priceHistory:{},settings:keep};
  DB.save(store);
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚");
  applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); fillFilterSupplier(); renderProducts(); renderHistory(); navigate("home");
});

/* ===== License mock ===== */
function setPlan(p){ store.settings.plan=p; DB.save(store); refreshHome(); alert("ãƒ—ãƒ©ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰"); }
document.addEventListener("click",(e)=>{ if(e.target.id==="mockBuyMid") setPlan("middle"); });
document.addEventListener("click",(e)=>{ if(e.target.id==="mockBuyPro") setPlan("pro"); });

/* ===== Init ===== */
function init(){
  try{
    ensureSample();
    applyTheme();
    refreshHome();
    initInputPage();
    renderTodayList();
    enableSelectOnFocus();
    renderSuppliers();
    fillFilterSupplier();
    renderProducts();
    refreshFiscalLabel();
    showPage(location.hash.replace("#","")||"home");
    if ((location.hash||"") === "#history") { try{ renderHistory(); }catch(e){ console.error(e); } }
  }catch(err){
    console.error("init failed:", err);
    alert("åˆæœŸåŒ–ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
  }
}
init();
</script>
<!-- ===== TLP EULA Modal (drop-in) ===== -->
<div id="tlpEula" class="tlp-eula-overlay" aria-hidden="true">
  <div class="tlp-eula-dialog" role="dialog" aria-modal="true" aria-labelledby="tlp-eula-title">
    <header class="tlp-eula-header">
      <h2 id="tlp-eula-title">ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½¿ç”¨è¨±è«¾å¥‘ç´„ï¼ˆEULAï¼‰</h2>
      <button id="tlpEulaClose" type="button" class="tlp-eula-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    </header>

    <section class="tlp-eula-body">
      <!-- â˜…ã“ã“ã‚’æœ¬ç•ªEULAæœ¬æ–‡ã«å·®ã—æ›¿ãˆã‚Œã°OKï¼ˆé››å½¢ã¯æš«å®šï¼‰ -->
      <p><strong>App:</strong> Tabco Ledger Plus / <strong>Version:</strong> 0.8.0 /
         <strong>EULA Ver:</strong> <span id="tlp-eula-ver-label">2025-09-08</span></p>
      <ol>
        <li><b>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸ï¼š</b>éç‹¬å ãƒ»è­²æ¸¡ä¸å¯ã€‚å†é…å¸ƒ/é€†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¦æ­¢ã€‚</li>
        <li><b>ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼š</b>å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ã¯åˆ©ç”¨è€…ã®è²¬ä»»ã€‚</li>
        <li><b>çŸ¥çš„è²¡ç”£ï¼š</b>æœ¬ã‚½ãƒ•ãƒˆ/åç§°/ãƒ­ã‚´ç­‰ã¯é–‹ç™ºè€…ã«å¸°å±ã€‚</li>
        <li><b>ä¿è¨¼ã®å¦èªï¼š</b>ç¾çŠ¶æœ‰å§¿ã€‚æå®³ãƒ»é€¸å¤±åˆ©ç›Šç­‰ã¯å…è²¬ã€‚</li>
        <li><b>æº–æ‹ æ³•ãƒ»è£åˆ¤ç®¡è½„ï¼š</b>æ—¥æœ¬æ³•ãƒ»äº¬éƒ½åœ°æ–¹è£åˆ¤æ‰€ã€‚</li>
      </ol>
      <p class="tlp-muted">â€»æœ¬ç•ªæ–‡é¢ã¯å¾Œã§å·®ã—æ›¿ãˆå¯èƒ½</p>
    </section>

    <footer class="tlp-eula-footer">
      <button id="tlpEulaDecline" type="button" class="btn btn-outline">åŒæ„ã—ãªã„</button>
      <!-- äº’æ›æ€§ã®ãŸã‚æ—§IDã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«JSå´ã§ä¸¡å¯¾å¿œ -->
      <button id="tlpEulaAccept" type="button" class="btn btn-primary">åŒæ„ã™ã‚‹</button>
    </footer>
  </div>
</div>

<style>
  :root{ color-scheme: light dark; --tlp-footer-h: 0px; }
  .tlp-eula-overlay{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: rgba(15,23,42,.60); /* slateç³»ã®æš—å¹• */
    z-index: 2147483647;
    padding:16px;
  }

@media print{ #tlp-app-footer{ display:none !important; } }

  .tlp-eula-overlay.is-open{ display:flex; }
  .tlp-eula-dialog{
    width:100%; max-width:720px; border-radius:16px; overflow:hidden;
    background:#fff; color:#111; border:1px solid #e5e7eb;
    box-shadow:0 16px 64px rgba(0,0,0,.35);
    box-sizing:border-box;
  }
  /* EULAãŒå¸¸ã«æœ€å‰ */
.tlp-eula-overlay { z-index: 2000 !important; }
/* === Zå±¤ã®åŸºæº– === */
:root{
  --z-eula: 2147483647;   /* æ—¢å­˜EULAæœ€å‰ */
  --z-modal: 3000;        /* ç¢ºèª/é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç­‰ */
  --z-actions: 2000;      /* ä¿å­˜/ã‚¯ãƒªã‚¢ ç­‰ã®è¡Œ */
  --z-floating: 1000;     /* ãƒãƒƒã‚¸ã‚„å°†æ¥ã®ãƒ•ãƒƒã‚¿ãƒ¼ */
}

/* æ—¢å­˜EULAãŒæœ€ä¸Šä½ã®ã¾ã¾ */
.tlp-eula-overlay{ z-index: var(--z-eula) !important; }

:where([role="dialog"],[aria-modal="true"],.modal,.dialog,.popup,.confirm,.sheet,.drawer){
  z-index: var(--z-modal) !important;   /* ä½ç½®ã¯è§¦ã‚‰ãªã„ */
}
/* ä¿å­˜/ã‚¯ãƒªã‚¢ãªã©ã®ãƒœã‚¿ãƒ³è¡Œï¼šé…ç½®ã¯è§¦ã‚‰ãš z-index ã ã‘ä¸Šã’ã‚‹ */
:where(.tlp-form-actions,.form-actions,.footer-actions,.actions,.btn-row){
  z-index: var(--z-actions) !important;
}

/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç³»ï¼ˆãƒãƒƒã‚¸ãªã©ï¼‰ã¯ä¸‹ä½ */
#tlp-brand-badge{ z-index: var(--z-floating) !important; pointer-events: none; }

/* ãƒãƒƒã‚¸ã¯EULAã‚ˆã‚Šä¸‹ã€‚å³ä¸‹å›ºå®šï¼†å°åˆ·éè¡¨ç¤º */
#tlp-brand-badge {
  position: fixed; right: 12px; bottom: 12px;z-index: 1000;pointer-events: none;
}
@media print { #tlp-brand-badge { display: none !important; } }

/* å®Ÿé¨“: ãƒŸãƒ‹åŒ–ï¼ˆv0.8.1å€™è£œãƒ»JSã‹ã‚‰ data-mini=1 ã‚’ä»˜ä¸ï¼‰ */
#tlp-brand-badge[data-mini="1"]{
  width: 10px; height: 10px; padding: 0; border-radius: 9999px;
  overflow: hidden; text-indent: -9999px;
}
  .tlp-eula-header, .tlp-eula-footer{
    display:flex; align-items:center; gap:8px; padding:12px 16px;
    background:#f9fafb; border-bottom:1px solid #e5e7eb;
  }
  .tlp-eula-footer{ justify-content:flex-end; border-top:1px solid #e5e7eb; border-bottom:none; }
  .tlp-eula-header h2{ margin:0; font-size:1.05rem; }
  .tlp-eula-close{
    margin-left:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff;
    padding:6px 10px; cursor:pointer;
  }
  .tlp-eula-body{ max-height:60vh; overflow:auto; padding:16px 18px; }
  .tlp-muted{ opacity:.7; }

  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; }
  .btn-outline{ background:#fff; color:#111; }
  .btn-primary{ background:#111; color:#fff; }

  @media (prefers-color-scheme: dark){
    .tlp-eula-overlay{ background: rgba(0,0,0,.5); }
    .tlp-eula-dialog{ background:#121212; color:#f5f5f5; border-color:#2a2a2a;
      box-shadow:0 20px 70px rgba(0,0,0,.6);
    }
    .tlp-eula-header, .tlp-eula-footer{
      background:#171717; border-color:#2a2a2a;
    }
    .tlp-eula-close{ background:#1f1f1f; color:#f5f5f5; border-color:#2a2a2a; }
    .btn-outline{ background:#1f1f1f; color:#f5f5f5; border-color:#2a2a2a; }
    .btn-primary{ background:#f5f5f5; color:#121212; border-color:#d4d4d4; }
    a{ color:#4da3ff; }
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢ï¼ˆä»˜ä¸ã‚¯ãƒ©ã‚¹ã§ONï¼‰ */
  body.tlp-modal-open{ overflow:hidden; }
</style>

<script>
(function(){
  const overlay = document.getElementById('tlpEula');
  const dlg = overlay?.querySelector('.tlp-eula-dialog');
  const btnAccept = document.getElementById('tlpEulaAccept'); // æ—¢å­˜äº’æ›ID
  const btnDecline = document.getElementById('tlpEulaDecline');
  const btnClose = document.getElementById('tlpEulaClose');
  const verLabel = document.getElementById('tlp-eula-ver-label');

  // è¨­å®šï¼šåŒæ„ãŒå¿…é ˆãªã‚‰ trueï¼ˆDecline/Ã—/èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ï¼‰
  const LOCK_MODE = false;

  // __tlp_meta ã‹ã‚‰EULAç‰ˆã‚’æ‹¾ã†ï¼ˆç„¡ã‘ã‚Œã°è¡¨ç¤ºä¸­ãƒ©ãƒ™ãƒ«å€¤ï¼‰
  const REQUIRED_EULA_VERSION =
    (window.__tlp_meta && __tlp_meta.eulaVersion) ||
    (verLabel ? verLabel.textContent.trim() : '1.0');

  // åˆæœŸè¡¨ç¤ºãƒ©ãƒ™ãƒ«ã‚‚æœ€æ–°ç‰ˆã«åŒæœŸ
  if (verLabel) verLabel.textContent = REQUIRED_EULA_VERSION;

  function isOpen(){ return overlay.classList.contains('is-open'); }
  function open(){
    overlay.classList.add('is-open');
    overlay.setAttribute('aria-hidden','false');
    document.body.classList.add('tlp-modal-open');
    // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(()=>{ (btnAccept || btnClose)?.focus(); }, 0);
  }
  function close(){
    if (LOCK_MODE) return; // å¿…é ˆãƒ¢ãƒ¼ãƒ‰ã§ã¯é–‰ã˜ã‚‰ã‚Œãªã„
    overlay.classList.remove('is-open');
    overlay.setAttribute('aria-hidden','true');
    document.body.classList.remove('tlp-modal-open');
  }

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆLOCK_MODE=falseæ™‚ã®ã¿ï¼‰
  overlay.addEventListener('click', (e)=>{
    if (!LOCK_MODE && e.target === overlay) close();
  });

  // Escã§é–‰ã˜ã‚‹ï¼ˆLOCK_MODE=falseæ™‚ã®ã¿ï¼‰
  document.addEventListener('keydown', (e)=>{
    if (!LOCK_MODE && e.key === 'Escape' && isOpen()) close();
  });

  btnClose?.addEventListener('click', close);
  btnDecline?.addEventListener('click', ()=>{ 
    // åŒæ„ã—ãªã„ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆå¿…è¦ãªã‚‰ã‚¢ãƒ—ãƒªå´ã§ãƒãƒ³ãƒ‰ãƒ«ï¼‰
    close();
    document.dispatchEvent(new CustomEvent('tlp:eula-declined'));
  });

  btnAccept?.addEventListener('click', ()=>{
  try {
    localStorage.setItem('tlp_eula_version', REQUIRED_EULA_VERSION);            // æ–°
    localStorage.setItem('tlp_eula_version_accepted', REQUIRED_EULA_VERSION);    // äº’æ›
    localStorage.setItem('tlp_eula_accepted_at', new Date().toISOString());     // äº’æ›
  } catch(_) {}
  document.dispatchEvent(new CustomEvent('tlp:eula-accepted', { detail:{ version: REQUIRED_EULA_VERSION }}));
  close();
});


  // èµ·å‹•æ™‚ï¼šä¿å­˜ç‰ˆã¨ä¸ä¸€è‡´ãªã‚‰è¡¨ç¤º
  try {
    const saved = localStorage.getItem('tlp_eula_version');
    if (saved !== REQUIRED_EULA_VERSION) open();
  } catch(_){ open(); }

  // å¤–éƒ¨ã‹ã‚‰æ“ä½œã§ãã‚‹ã‚ˆã†ã«å…¬é–‹ï¼ˆä»»æ„ï¼‰
  window.tlpOpenEula = open;
  window.tlpCloseEula = close;
})();
</script>
  
<script>
(function(){
  'use strict';

  // ==== Namespace / Meta ====
  const TLP = (window.TLP = window.TLP || {});
  const meta = (window.__tlp_meta || {});
  const REQUIRED_EULA_VERSION = String(meta.eulaVersion || '2025-09-08');

  TLP.APP = Object.assign(
    { NAME:'Tabco Ledger Plus', VERSION:'0.8.0', EULA_VERSION: REQUIRED_EULA_VERSION },
    TLP.APP || {}
  );

  // ==== LocalStorage Keys ====
  const LS = window.localStorage;
  const KEYS = {
    EULA_VER_NEW: 'tlp_eula_version',
    EULA_VER_OLD: 'tlp_eula_version_accepted',
    EULA_AT:      'tlp_eula_accepted_at',
    LICENSE:      'tlp_license_status'
  };
  TLP.keys = KEYS;

  // ==== License ====
  TLP.license = {
    get status(){ try{ return LS.getItem(KEYS.LICENSE) || 'trial'; }catch(_){ return 'trial'; } },
    set status(v){ try{ LS.setItem(KEYS.LICENSE, v); }catch(_){} },
    isTrial(){ return this.status !== 'licensed'; },
    set(v){ this.status = v; }
  };

  // ==== EULA ====
  TLP.eula = {
    needs(){
      let a=null,b=null;
      try { a = LS.getItem(KEYS.EULA_VER_NEW); b = LS.getItem(KEYS.EULA_VER_OLD); } catch(_){}
      return (a !== REQUIRED_EULA_VERSION) && (b !== REQUIRED_EULA_VERSION);
    },
    accept(){
      try{
        LS.setItem(KEYS.EULA_VER_NEW, REQUIRED_EULA_VERSION);
        LS.setItem(KEYS.EULA_VER_OLD, REQUIRED_EULA_VERSION);   // äº’æ›ã‚­ãƒ¼ã‚‚æ›´æ–°
        LS.setItem(KEYS.EULA_AT, new Date().toISOString());
      }catch(_){}
      TLP.license.set('licensed');
    }
  };

  // ==== EULAè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£…ã«ä¾å­˜ã›ãšå‹•ãï¼‰ ====
  TLP.showEula = function(){
    if (typeof window.tlpOpenEula === 'function'){ window.tlpOpenEula(); return; }
    const r = document.getElementById('tlpEula');
    if (r){
      r.style.display = 'flex';
      r.setAttribute('aria-hidden','false');
      document.body.classList.add('tlp-modal-open');
    }
  };

  // ==== CSVãƒ˜ãƒ«ãƒ‘ï¼ˆé€ã‹ã—è¡Œã¯â‘¢downloadCsvãƒ‘ãƒƒãƒå´ã§ä»˜ä¸ï¼‰ ====
  TLP.csv = {
    toCSV(rows, { sep=',' } = {}){
      if (!rows || !rows.length) return '';
      const headers = Object.keys(rows[0]);
      const esc = v => {
        v = (v ?? '') + '';
        if (v.includes('"')) v = v.replace(/"/g,'""');
        return (v.includes('\n') || v.includes('\r') || v.includes(sep)) ? `"${v}"` : v;
      };
      const lines = [ headers.map(esc).join(sep) ];
      for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(sep));
      return lines.join('\r\n');
    }
  };

  // ==== ã‚¤ãƒ™ãƒ³ãƒˆé€£æºï¼ˆãƒœã‚¿ãƒ³ç›´æ¥ã®äºŒé‡å®Ÿè£…ã‚’é¿ã‘ã‚‹ï¼‰ ====
  document.addEventListener('tlp:eula-accepted', ()=>{ TLP.eula.accept(); });
  document.addEventListener('tlp:eula-declined', ()=>{ TLP.license.set('trial'); });

  // ==== èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ ====
  document.addEventListener('DOMContentLoaded', ()=>{
    if (TLP.eula.needs()) TLP.showEula();
  });
})();
</script>
<script>
(function(){
  // å…±æœ‰ãƒ¡ã‚¿ã‚’ç”¨æ„ï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
  window.__tlp_meta = Object.assign({
    app: "Tabco Ledger Plus",
    brand: "Tabco Ledger Plus",
    version: (window.TLP && TLP.APP && TLP.APP.VERSION) || "0.8.0",
    eulaVersion: (window.TLP && TLP.APP && TLP.APP.EULA_VERSION) || "2025-09-08",
    build: "v0.8.0-20250908",
    site: "cafetabco.com"
  }, window.__tlp_meta || {});

  function mountBadge(){
    if (document.getElementById('tlp-brand-badge')) return;
    const b = document.createElement('div');
    b.id = 'tlp-brand-badge';
   b.innerHTML = `
  <span class="tlp-badge-name">${__tlp_meta.brand}<sup class="tm">TM</sup></span>
  <span class="tlp-badge-ver">v${__tlp_meta.version}</span>
`;
    Object.assign(b.style, {
      position:'fixed', right:'12px',
      padding:'4px 8px', borderRadius:'12px',
      background:'#fff', color:'#111',
      boxShadow:'0 2px 10px rgba(0,0,0,.12)',
      fontFamily:'system-ui, sans-serif', fontSize:'10px', lineHeight:'1', opacity:'0.9'
    });
    const style = document.createElement('style');
    style.textContent = `
      #tlp-brand-badge{ display:inline-block; width:max-content; white-space:normal; text-align:left; }
#tlp-brand-badge .tlp-badge-name{ display:block; line-height:1.15; }
#tlp-brand-badge .tlp-badge-ver { display:block; margin-top:2px; font-size:10px; line-height:1; opacity:.85; }
      @media (prefers-color-scheme: dark){
        #tlp-brand-badge{background:#121212;color:#f5f5f5;box-shadow:0 3px 12px rgba(0,0,0,.6)}
      }
    `;
    document.head.appendChild(style);
    (document.querySelector('header, .app-header, .tlp-header') || document.body).appendChild(b);

  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountBadge);
  } else {
    mountBadge();
  }
})();
</script>
<style>
/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼EULAä¸­ã¯éš ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯å¹²æ¸‰é˜²æ­¢ï¼‰ */
.tlp-modal-open #tlp-brand-badge{ display: none !important; }

/* å°åˆ·æ™‚ã¯éè¡¨ç¤º */
@media print{
  #tlp-brand-badge{ display: none !important; }
}

/* ãƒãƒƒã‚¸æœ¬ä½“ï¼ˆå˜ä¸€ã‚½ãƒ¼ã‚¹ãƒ»é‡è¤‡ç¦æ­¢ï¼‰ */
#tlp-brand-badge{
  position: fixed;
  left: 12px;
top: 2px;                 /* â† ã‚‚ã£ã¨ä¸Šã’ãŸã‘ã‚Œã° 2px ãªã©ã« */
right: auto; bottom: auto !important;
  z-index: 1000 !important;
  pointer-events: none;

  /* è¦‹ãŸç›® */
  display: inline-block;          /* â† inline-flex ã¯ä¸è¦ */
  width: max-content;
  max-width: 38vw;                /* å¿…è¦ãªã‚‰ 36â€“48vw ã§å¾®èª¿æ•´ */
  white-space: normal;
  text-align: left;
}

/* 2è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ */
#tlp-brand-badge .tlp-badge-name{ display:block; line-height:1.15; }
#tlp-brand-badge .tlp-badge-ver { display:block; margin-top:2px; font-size:10px; line-height:1; opacity:.85; }

bottom: calc(var(--tlp-badge-offset, 12px) + env(safe-area-inset-bottom, 0px)) !important;
ã€€z-index: 1000 !important;
  pointer-events: none;
}

/* ç‹­ã„ç”»é¢ã ã‘å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
@media (max-width: 480px){
  #tlp-brand-badge{ font-size: 11px; padding: 6px 8px; opacity: .9; }
}

/* ï¼ˆä»»æ„ï¼‰ãƒšãƒ¼ã‚¸å˜ä½ã§æ¶ˆã—ãŸã„æ™‚ã¯ <html> ã« .tlp-hide-badge ã‚’ä»˜ä¸ */
.tlp-hide-badge #tlp-brand-badge{ display: none !important; }

@media (max-width:768px), (hover:none) and (pointer:coarse){
  :root{ --tlp-badge-offset: 72px; } /* ã¾ã è¢«ã‚‹ãªã‚‰ 88px, 96px ã«èª¿æ•´ */
}
/* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã«ç½®ãå‰æã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå·¦å¯„ã›ï¼†ç¸¦ç©ã¿ï¼‰ */
header, .app-header, .tlp-header { position: relative; }

#tlp-brand-badge{
  position: absolute;       /* â† fixed ã‹ã‚‰ absolute ã«ä¸Šæ›¸ã */
  left: 12px; top: 8px;     /* ãƒ˜ãƒƒãƒ€ãƒ¼å·¦ã®ç©ºãã¸ */
  right: auto;
  bottom: auto !important;  /* ä¸‹å›ºå®šã‚’ç„¡åŠ¹åŒ– */
  max-width: 42vw;          /* ãƒ˜ãƒƒãƒ€ãƒ¼å·¦ã®ç©ºãã‚’è¶…ãˆãªã„ç¨‹åº¦ã« */
  white-space: normal;      /* æ”¹è¡Œã‚’è¨±å¯ */
  text-align: left;
  opacity: .85;             /* ç›®ç«‹ã¡ã™ãé˜²æ­¢ï¼ˆä»»æ„ï¼‰ */
}

/* 2è¡Œç›®ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚’å°ã•ããƒ»è¡Œé–“è©°ã‚ */
#tlp-brand-badge .tlp-badge-ver{
  display: block; margin-top: 2px;
  font-size: 10px; line-height: 1;
  opacity: .85;
}
.tlp-home-moved{ position:absolute; right:12px; top:8px; }
#tlp-brand-badge .tlp-badge-ver{ display:block; margin-top:2px; font-size:10px; line-height:1; opacity:.85; }
/* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã«å…¥ã£ã¦ã„ã‚‹æ™‚ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼åŸºæº–ã§çµ¶å¯¾é…ç½® */
:is(header,.app-header,.tlp-header){ position: relative; } /* æ—¢å­˜ã«å½±éŸ¿ã»ã¼ãªã— */
:is(header,.app-header,.tlp-header) #tlp-brand-badge{
  position: absolute;
  top: 4px;           /* ã‚‚ã£ã¨ä¸Šã’ãŸã‘ã‚Œã° 2px ãªã©ã« */
  left: 12px;
  right: auto;
  bottom: auto !important;
}
</style>

<script>
(function(){
  // UTF-16LE + BOM ã§CSVã‚’ä¿å­˜ï¼ˆExcelæ–‡å­—åŒ–ã‘å¯¾ç­–ã®ã¿ï¼‰
  function encodeUTF16LE(str){
    const s = String(str||'');
    const buf = new Uint8Array((s.length+1)*2);
    buf[0]=0xFF; buf[1]=0xFE;  // BOM
    for (let i=0;i<s.length;i++){
      const c=s.charCodeAt(i);
      buf[2+i*2]=c & 0xFF; buf[3+i*2]=c >>> 8;
    }
    return new Blob([buf], {type:'text/csv;charset=utf-16le;'});
  }

  function saveUTF16(name, text){
    const norm = String(text||'').replace(/\r?\n/g, '\r\n'); // æ”¹è¡Œã‚’CRLFã«çµ±ä¸€
    const blob = encodeUTF16LE(norm);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name || `tlp_export_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // æ—¢å­˜å‘¼ã³å‡ºã—åã‚’ã™ã¹ã¦ã“ã®æœ€å°å®Ÿè£…ã«å‰²ã‚Šå½“ã¦ï¼ˆäº’æ›ï¼‰
  window.downloadCsv = window.exportCsv = window.saveUTF16 = saveUTF16;
})();
</script>
<!-- === BEGIN: TLP CSV MINIMAL BLOCK (v0.8.0) === -->
<script>
(function(){
  "use strict";

  // UTF-16LE + BOM ã§CSVã‚’ä¿å­˜ï¼ˆExcelæ–‡å­—åŒ–ã‘å¯¾ç­–ã®ã¿ï¼‰
  function encodeUTF16LE(str){
    const s = String(str || "");
    const buf = new Uint8Array((s.length + 1) * 2);
    buf[0] = 0xFF; buf[1] = 0xFE; // BOM
    for (let i = 0; i < s.length; i++){
      const c = s.charCodeAt(i);
      buf[2 + i*2] = c & 0xFF;
      buf[3 + i*2] = c >>> 8;
    }
    return new Blob([buf], { type: "text/csv;charset=utf-16le;" });
  }

  function saveUTF16(name, text){
    const norm = String(text || "").replace(/\r?\n/g, "\r\n"); // CRLF çµ±ä¸€
    const blob = encodeUTF16LE(norm);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name || `tlp_export_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // äº’æ›ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆã©ã®åå‰ã§å‘¼ã°ã‚Œã¦ã‚‚ã“ã®æœ€å°å®Ÿè£…ãŒå‹•ãï¼‰
  window.downloadCsv = window.exportCsv = window.saveUTF16 = saveUTF16;

  console.log("[TLP] CSV minimal block loaded");
})();
</script>
<!-- === END: TLP CSV MINIMAL BLOCK === -->
  <script>
(() => {
  try {
    const meta = (window.__tlp_meta = window.__tlp_meta || {});
    console.log("[TLP] v0.8.0 diag boot");

    const hasDownload = typeof window.downloadCsv === "function";
    const hasOpenEula = typeof window.tlpOpenEula === "function";
    const eulaVer = meta.eulaVersion || "2025-09-08";

    // ç›®è¦–ä»£ã‚ã‚Šã®ãƒ¯ãƒ³ã‚­ãƒ¼: Alt+E ã§ EULA ã‚ªãƒ¼ãƒ—ãƒ³
    window.addEventListener("keydown", (e) => {
      if (e.altKey && e.key.toLowerCase() === "e") {
        e.preventDefault();
        if (hasOpenEula) window.tlpOpenEula();
        else console.warn("tlpOpenEula ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    });

    // EULA å—è«¾/æ‹’å¦ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ãƒƒã‚¯ï¼ˆãƒ­ã‚°ï¼†ç°¡æ˜“è¨˜éŒ²ï¼‰
    window.addEventListener("tlp:eula-accepted", () => {
      localStorage.setItem("tlpEulaAcceptedVersion", eulaVer);
      console.log("[TLP] EULA accepted:", eulaVer);
    });
    window.addEventListener("tlp:eula-declined", () => {
      console.warn("[TLP] EULA declined");
    });

    // 30ç§’ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ€ã‚¤ã‚¢ã‚°
    window.tlpDiag = {
      check() {
        console.table({
          downloadCsv: hasDownload ? "OK" : "MISSING",
          tlpOpenEula: hasOpenEula ? "OK" : "MISSING",
          eulaVersion: eulaVer,
        });
      },
      testCsv() {
        if (!hasDownload) return console.warn("downloadCsv ãŒæœªå®šç¾©");
        const csv = "A,B\r\n1,ãƒ†ã‚¹ãƒˆ\r\n2,OK";
        window.downloadCsv("test.csv", csv);
        console.log("[TLP] CSV test fired");
      },
      openEula() {
        if (hasOpenEula) window.tlpOpenEula();
        else console.warn("tlpOpenEula ãŒæœªå®šç¾©");
      },
      // å®Ÿé¨“: ãƒãƒƒã‚¸æœ€å°åŒ–ï¼ˆæ—¢å®šOFF / v0.8.1å€™è£œï¼‰
      toggleBadgeMini() {
        const b = document.querySelector("#tlp-brand-badge");
        if (!b) return console.warn("#tlp-brand-badge ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
        b.dataset.mini = b.dataset.mini === "1" ? "0" : "1";
      },
    };

    console.log("[TLP] CSV minimal block", hasDownload ? "OK" : "MISSING");
    console.log("[TLP] Ready. Try: tlpDiag.check(), tlpDiag.openEula(), tlpDiag.testCsv()");
  } catch (e) {
    console.error("[TLP] diag init error", e);
  }
})();
</script>
<script>
(()=> {
  const root = document.documentElement;
  const badge = document.getElementById('tlp-brand-badge');
  if (!badge) return;

  // å³ä¸‹ã§ãƒãƒƒã‚¸ã¨ã¶ã¤ã‹ã‚Šã‚„ã™ã„è¦ç´ ã®å€™è£œï¼ˆå¿…è¦ãªã‚‰èªã‚’è¶³ã—ã¦OKï¼‰
  const SEL = [
    '.tlp-form-actions','.form-actions','.footer-actions','.actions','.btn-row',
    '.action-bar','.button-bar','.buttons','.btns',
    '.page-controls','.page-footer',
    '[role="dialog"] .actions','[role="dialog"] .btn-row',
    '.modal .actions','.dialog .actions'
  ].join(',');

  const mm = matchMedia('(max-width:768px),(hover:none) and (pointer:coarse)'); // ä¸»ã«ã‚¹ãƒãƒ›ã§æœ‰åŠ¹
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  const update = () => {
    // PCã¯å›ºå®š12pxã€ã‚¹ãƒãƒ›ç­‰ã ã‘èª¿æ•´
    if (!mm.matches) { root.style.setProperty('--tlp-badge-offset','12px'); return; }

    const vw = innerWidth, vh = innerHeight;
    let offset = 12; // æœ€ä½ã‚ªãƒ•ã‚»ãƒƒãƒˆ

    document.querySelectorAll(SEL).forEach(el => {
      const r = el.getBoundingClientRect();
      // å³ç«¯160pxã«ã‹ã‹ã‚Šã€ã‹ã¤ä¸‹ç«¯ã‹ã‚‰64pxä»¥å†…ã«ã„ã‚‹è¡Œã ã‘ã‚’è¦‹ã‚‹
      const nearRight  = r.right > (vw - 160);
      const nearBottom = (vh - r.bottom) < 64;
      if (nearRight && nearBottom) {
        // ãã®è¡Œã®é«˜ã•ã¶ã‚“ã ã‘æŒã¡ä¸Šã’ï¼ˆä¸Šé™96pxï¼‰
        offset = Math.max(offset, clamp(Math.ceil(r.height) + 12, 12, 96));
      }
    });

    root.style.setProperty('--tlp-badge-offset', offset + 'px');
  };

  // åæ˜ ãƒˆãƒªã‚¬ãƒ¼ï¼ˆè»½é‡ï¼‰
  ['resize','scroll','orientationchange','hashchange','popstate'].forEach(ev => addEventListener(ev, update, {passive:true}));
  const mo = new MutationObserver(() => update());
  mo.observe(document.body || root, {childList:true,subtree:true});
  // åˆæœŸå®Ÿè¡Œ
  (document.readyState === 'loading') ? addEventListener('DOMContentLoaded', update) : update();
})();
</script>
<script>
  document.addEventListener('DOMContentLoaded',()=>{const b=document.getElementById('tlp-brand-badge'); if(b){b.style.removeProperty('bottom'); b.style.removeProperty('z-index');}});
</script>
<script>
(()=> {
  const header = document.querySelector('header, .app-header, .tlp-header');
  const badge  = document.getElementById('tlp-brand-badge');
  if (!header || !badge) return;

 

  // ã€Œãƒ›ãƒ¼ãƒ ã€ã‚’å³ä¸Šã¸ç§»å‹•ï¼ˆéè¡¨ç¤ºã§ã¯ãªãç§»å‹•ï¼‰
  const homeBtn = header.querySelector('#btnHome');
  if (homeBtn){
    homeBtn.classList.add('tlp-home-moved');
    header.appendChild(homeBtn);
  }

  // ãƒãƒƒã‚¸ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã¸ï¼ˆã‚ã‚Œã°ç§»å‹•ï¼‰
  header.appendChild(badge);

  // ãƒãƒƒã‚¸æ–‡è¨€ã‚’â€œå¿…ãšâ€2è¡Œã«å†æ§‹æˆï¼ˆå®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹ï¼‰
  const raw = (badge.textContent||'').replace(/\s+/g,' ').trim();
  const m   = raw.match(/^(.*?)[\sÂ·]*\b(v\d+(?:\.\d+){1,2})\b$/i);
  const name = (m? m[1] : raw).trim().replace(/\s+$/,'');
  const ver  = (m? m[2] : '').trim();
  badge.innerHTML =
    `<span class="tlp-badge-name">${name}</span>` +
    (ver ? `<span class="tlp-badge-ver">${ver}</span>` : '');

})();
</script>
<style id="rights-css">
/* === Rights pageï¼ˆãƒšãƒ¼ã‚¸å†…é™å®šã®è»½ã„ä½“è£ï¼‰ === */
#page-rights h3 { margin: 0 0 8px; }
#page-rights h4 { margin: 14px 0 6px; font-size: 0.98rem; }
#page-rights p  { margin: 0 0 8px; }

/* æ—¢å­˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®å…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒƒã‚¸ã¯â€œè¦‹ãˆãªãã™ã‚‹ã ã‘â€ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰ */
.app-header #tlp-brand-badge { display: none !important; }

/* æ¨©åˆ©ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼šå³ä¸‹å›ºå®šãƒ»æ¨ªä¸€åˆ—ã®ãƒãƒƒã‚¸ï¼ˆåˆ¥IDã§è¡çªå›é¿ï¼‰ */
#tlp-brand-badge-rights{
  position: fixed;
  right: 12px;
  bottom: 12px;
  z-index: 7000;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.12);
  background: #fff;
  font-size: 12px;
  white-space: nowrap; /* æ¨ªä¸€åˆ—å›ºå®š */
}

/* å°åˆ·æ™‚ã¯æ“ä½œUI/ãƒ¢ãƒ¼ãƒ€ãƒ«/ãƒãƒƒã‚¸ã‚’éè¡¨ç¤ºï¼ˆè¿½åŠ ï¼‰ */
@media print {
  nav, header, footer, .actions, .btn-row, .toolbar { display: none !important; }
  .modal, .dialog, .backdrop, #modalHost, #eula-modal, .modal-backdrop { display: none !important; }
  #tlp-brand-badge-rights { display: none !important; }
  body { margin: 0 !important; }
}
</style>
<script id="rights-js">
(() => {
  // EULAç‰ˆï¼šæœªå®šç¾©ãªã‚‰è£œå®Œï¼ˆæ—¢ã«å€¤ãŒã‚ã‚Œã°ä¸Šæ›¸ãã—ãªã„ï¼‰
  try {
    window.__tlp_meta = window.__tlp_meta || {};
    if (!window.__tlp_meta.eulaVersion) window.__tlp_meta.eulaVersion = '2025-09-08';
  } catch(e){}

  // æ¨©åˆ©ãƒšãƒ¼ã‚¸ã ã‘ã«æ–°IDã®ãƒãƒƒã‚¸ã‚’å‡ºã™
  function buildRightsBadge(){
    const el = document.createElement('div');
    el.id = 'tlp-brand-badge-rights';
    el.setAttribute('role','note');
    el.textContent = 'Tabco Ledger Plus\u2122 v0.8.0'; // æ¨ªä¸€åˆ—
    return el;
  }
  function mountRightsBadge(){
    const host = document.getElementById('tlp-rights-badge-host');
    if (!host) return; // ä»–ãƒšãƒ¼ã‚¸ã¯ä½•ã‚‚ã—ãªã„
    if (document.getElementById('tlp-brand-badge-rights')) return; // äºŒé‡ç”Ÿæˆé˜²æ­¢
    host.appendChild(buildRightsBadge());
  }

  // EULAãƒªãƒ³ã‚¯ï¼ˆæ—¢å­˜å®Ÿè£…ã«å§”è­²ï¼‰
  function wireEulaOpen(){
    const a = document.getElementById('open-eula');
    if (!a) return;
    a.addEventListener('click', (e) => {
      e.preventDefault();
      if (typeof window.tlpOpenEula === 'function') window.tlpOpenEula();
      else if (window.TLP && typeof TLP.showEula === 'function') TLP.showEula();
      else console.warn('EULA open handler not found.');
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { mountRightsBadge(); wireEulaOpen(); });
  } else {
    mountRightsBadge(); wireEulaOpen();
  }
})();
</script>









