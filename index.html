<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª v17</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{ --gap:8px; }
  body { font-family: system-ui, sans-serif; margin: 10px; padding-bottom: 86px; }
  h2 { margin: 14px 0; }
  input, select, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
  label { display: block; margin: 8px 0 4px; }
  .row { display: flex; gap: var(--gap); flex-wrap: wrap; }
  .row > * { flex: 1; min-width: 110px; }
  button { background: #16a34a; color: #fff; border: none; border-radius: 8px; cursor:pointer; }
  button:hover { background:#12833c; }
  .link { background:#2563eb; }
  .link:hover { background:#1f4ec0; }
  .ghost { background:#e5e7eb; color:#111; }
  .ghost:hover { background:#d1d5db; }
  .danger { background:#ef4444; }
  .danger:hover { background:#c53737; }

  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; word-break: break-all; }
  th { position: sticky; top: 0; background:#fff; z-index: 1; }
  .nav { display:flex; gap:var(--gap); margin-bottom:10px; }
  .radio-group { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .small { font-size: 12px; color:#666; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .chip { border:1px solid #ccc; padding:6px 10px; border-radius:999px; }
  .muted { color:#666; font-size:12px; }
  .nowrap { white-space:nowrap; }

  /* ä¸€è¦§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
  .table-wrap {
    max-height: 48vh;
    overflow: auto;
    border:1px solid #e5e7eb;
    border-radius:8px;
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:80; }
  .modal-content {
    background:#fff; margin:6% auto; padding:12px; width:92%; max-width:560px; border-radius:10px;
    max-height:90vh; overflow:auto; padding-bottom:96px;
  }
  .checkbox-grid {
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;
    max-height:50vh; overflow:auto; padding-right:4px;
  }
  .actions {
    display:flex; gap:8px; justify-content:center;
    position:sticky; bottom:0; background:#fff; padding:8px 0;
    box-shadow: 0 -4px 10px rgba(0,0,0,.04); z-index:60;
  }
  .modal-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }

  /* ç”»é¢ä¸‹å›ºå®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
  .fab-bar {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 20;
    background: #fff; border-top: 1px solid #e5e7eb;
    padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    box-shadow: 0 -6px 20px rgba(0,0,0,.06);
  }
  .fab-inner { display: flex; gap: 8px; max-width: 560px; margin: 0 auto; }
  .fab-inner > * { flex: 1; }
</style>
</head>
<body>

<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">ä»•å…¥ã‚Œå…¥åŠ›</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">é›»è©±å¸³</button>
  <button type="button" onclick="showPage('masters')" class="ghost">ãƒã‚¹ã‚¿ç®¡ç†</button>
  <button type="button" onclick="openSettings()" class="ghost">âš™ è¨­å®š</button>
</div>

<!-- ä»•å…¥ã‚Œå…¥åŠ› -->
<section id="page-entry">
  <h2>ä»•å…¥ã‚Œå…¥åŠ›</h2>
  <label>æ—¥ä»˜</label>
  <input type="date" id="inDate">

  <label>ä»•å…¥å…ˆ <span class="muted">ï¼ˆé¸æŠã™ã‚‹ã¨ç´ä»˜ãå•†å“ã®ã¿è¡¨ç¤ºï¼‰</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" onclick="openSupplierModal()">ï¼‹ ä»•å…¥å…ˆè¿½åŠ </button>
  </div>
  <div id="supplierQuick" class="row" style="margin:6px 0; display:none; align-items:center;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">ğŸ“ ã“ã®ä»•å…¥å…ˆã«é›»è©±</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">ğŸ“‹ é›»è©±ç•ªå·ã‚³ãƒ”ãƒ¼</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>å•†å“å</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" onclick="openItemModal()">ï¼‹ å•†å“è¿½åŠ </button>
  </div>

  <div class="row">
    <div>
      <label>æ•°é‡</label>
      <input type="number" id="inQty" value="1" step="0.1" min="0" onfocus="this.select()">
    </div>
    <div>
      <label>å˜ä¾¡</label>
      <input type="number" id="inPrice" value="0" step="1" min="0" onfocus="this.select()">
    </div>
  </div>

  <label>ç¨åŒºåˆ†</label>
  <div class="radio-group">
    <label><input type="radio" name="inTax" value="taxIncluded"> ç¨è¾¼</label>
    <label><input type="radio" name="inTax" value="taxExcluded" checked> ç¨åˆ¥</label>
    <span class="muted">åŸºæœ¬ç¨ç‡ï¼š<b id="lblRate"></b>%ï¼ˆè¨­å®šã§å¤‰æ›´ï¼‰</span>
  </div>

  <label style="margin-top:6px;">ç¨ç‡ï¼ˆ8% / 10% ã‚¯ã‚¤ãƒƒã‚¯åˆ‡æ›¿ï¼‰</label>
  <div class="radio-group" id="baseRateRadios">
    <label><input type="radio" name="baseRateChoice" value="8" checked> 8%</label>
    <label><input type="radio" name="baseRateChoice" value="10"> 10%</label>
    <span class="small">â€» ä»¥å¾Œã®è¨ˆç®—ã«ä½¿ã†ã€ŒåŸºæœ¬ç¨ç‡ã€ã‚’å³æ™‚æ›´æ–°ã—ã¾ã™ã€‚</span>
  </div>

  <h3>é›†è¨ˆ</h3>
  <div class="row">
    <div class="chip">æ—¥è¨ˆï¼š<b><span id="sumDaily">0</span> å††</b></div>
    <div class="chip">æœˆè¨ˆï¼š<b><span id="sumMonthly">0</span> å††</b></div>
  </div>

  <h3 style="display:flex; align-items:center; justify-content:space-between;">
    <span>ä»•å…¥ã‚Œä¸€è¦§</span>
    <span class="small">
      <label style="display:inline-flex; gap:6px; align-items:center;">
        <input type="checkbox" id="toggleAll" onchange="toggleAllRows(this)"> å…¨ä»¶è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæœ€æ–°50ä»¶ï¼‰
      </label>
    </span>
  </h3>

  <div class="table-wrap">
    <table id="listTable">
      <thead>
        <tr><th>æ—¥ä»˜</th><th>ä»•å…¥å…ˆ</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ç¨åŒºåˆ†</th><th>åˆè¨ˆ</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="row" style="margin-top:10px;">
    <button type="button" class="link" onclick="downloadCSV()">CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button type="button" class="ghost" onclick="wipeAll()">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
  </div>
  <div class="row" style="margin-top:6px;">
    <button type="button" class="link" onclick="backupToCloud()">OneDriveã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button type="button" class="ghost" onclick="document.getElementById('restoreInput').click()">JSONå¾©å…ƒ</button>
    <input id="restoreInput" type="file" accept="application/json" style="display:none"
           onchange="if(this.files[0]) restoreJSON(this.files[0])">
  </div>
</section>

<!-- é›»è©±å¸³ -->
<section id="page-phonebook" style="display:none;">
  <h2>ä»•å…¥å…ˆé›»è©±å¸³</h2>
  <table id="phoneTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ãƒã‚¹ã‚¿ç®¡ç† -->
<section id="page-masters" style="display:none;">
  <h2>ãƒã‚¹ã‚¿ä¸€è¦§</h2>

  <h3>ä»•å…¥å…ˆ</h3>
  <table id="supTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>å•†å“ï¼ˆç´ä»˜ã‘å…ˆï¼‰</h3>
  <table id="itemTable">
    <thead><tr><th>å•†å“å</th><th>åŸºæº–ä¾¡æ ¼</th><th>ç¨åŒºåˆ†</th><th>ç´ä»˜ã‘ä»•å…¥å…ˆ</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ä»•å…¥ã‚Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="purchaseEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥ã‚Œç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('purchaseEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editPurchaseIndex">
    <label>æ—¥ä»˜</label>
    <input type="date" id="editDate">
    <label>ä»•å…¥å…ˆ</label>
    <select id="editSupplier"></select>
    <label>å•†å“</label>
    <select id="editItem"></select>
    <div class="row">
      <div>
        <label>æ•°é‡</label>
        <input type="number" id="editQty" step="0.1" min="0">
      </div>
      <div>
        <label>å˜ä¾¡</label>
        <input type="number" id="editPrice" step="1" min="0">
      </div>
    </div>
    <label>ç¨åŒºåˆ†</label>
    <div class="radio-group">
      <label><input type="radio" name="editTax" value="taxIncluded"> ç¨è¾¼</label>
      <label><input type="radio" name="editTax" value="taxExcluded"> ç¨åˆ¥</label>
    </div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updatePurchase()">ä¿å­˜</button>
      <button type="button" class="danger" onclick="deletePurchase()">å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- ä»•å…¥å…ˆ/å•†å“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ï¼‰ -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆè¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">âœ•</button>
    </div>
    <label>ç¤¾å</label>
    <input id="supName" type="text" placeholder="ä¾‹ï¼‰Aãƒ•ãƒ¼ã‚º">
    <label>æ‹…å½“è€…</label>
    <input id="supContact" type="text" placeholder="ä¾‹ï¼‰å±±ç”°ã•ã‚“">
    <label>é›»è©±ç•ªå·</label>
    <input id="supPhone" type="tel" placeholder="090-1234-5678">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addSupplier()">ç™»éŒ²</button>
      <button type="button" class="ghost" onclick="resetSupplierForm()">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>ç¤¾å</label>
    <input id="editSupName" type="text">
    <label>æ‹…å½“è€…</label>
    <input id="editSupContact" type="text">
    <label>é›»è©±ç•ªå·</label>
    <input id="editSupPhone" type="tel">
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateSupplier()">ä¿å­˜</button>
      <button type="button" class="danger" onclick="deleteSupplier()">å‰Šé™¤</button>
    </div>
  </div>
</div>

<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“è¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">âœ•</button>
    </div>
    <label>å•†å“å</label>
    <input id="itName" type="text" placeholder="ä¾‹ï¼‰å›½ç”£ã‚‚ã‚‚è‚‰ 2kg">
    <div class="row">
      <div>
        <label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label>
        <input id="itPrice" type="number" placeholder="0">
      </div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="itTax">
          <option value="taxIncluded">ç¨è¾¼</option>
          <option value="taxExcluded">ç¨åˆ¥</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="itSuppliers" class="checkbox-grid"></div>
    <div class="small">â€» è¤‡æ•°ã®ä»•å…¥å…ˆã‹ã‚‰è³¼å…¥å¯èƒ½ãªå•†å“ã«å¯¾å¿œã—ã¾ã™ã€‚</div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="addItem()">ç™»éŒ²</button>
      <button type="button" class="ghost" onclick="resetItemForm()">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“ç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>å•†å“å</label>
    <input id="editItName" type="text">
    <div class="row">
      <div>
        <label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label>
        <input id="editItPrice" type="number">
      </div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="editItTax">
          <option value="taxIncluded">ç¨è¾¼</option>
          <option value="taxExcluded">ç¨åˆ¥</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="editItSuppliers" class="checkbox-grid"></div>
    <div class="actions" style="margin-top:8px;">
      <button type="button" onclick="updateItem()">ä¿å­˜</button>
      <button type="button" class="danger" onclick="deleteItem()">å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>è¨­å®š</h3>
      <button type="button" class="ghost" onclick="closeModal('settingsModal')">âœ•</button>
    </div>
    <label>åŸºæœ¬ç¨ç‡ï¼ˆ8% ã¾ãŸã¯ 10%ï¼‰</label>
    <div class="radio-group">
      <label><input type="radio" name="baseRatePreset" value="8"> 8%</label>
      <label><input type="radio" name="baseRatePreset" value="10"> 10%</label>
    </div>
    <div class="row" style="margin-top:8px;">
      <button type="button" onclick="saveBaseTaxRate()">ä¿å­˜</button>
      <button type="button" class="ghost" onclick="resetBaseTaxRate()">8%ã«æˆ»ã™</button>
    </div>
    <div class="small" style="margin-top:4px;">â€» ã“ã®è¨­å®šã¯ç¨åˆ¥è¨ˆç®—ã«é©ç”¨ã•ã‚Œã€ç¨è¾¼ã¯ãã®ã¾ã¾ã®é‡‘é¡ã«ãªã‚Šã¾ã™ã€‚</div>
  </div>
</div>

<!-- ç”»é¢ä¸‹å›ºå®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" onclick="savePurchase()">ä¿å­˜</button>
    <button type="button" class="ghost" onclick="clearEntry()">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<script>
/* ====== æ°¸ç¶šåŒ– ====== */
const LS_KEYS = {
  suppliers: 'suppliers_v2',
  items: 'items_v2',
  purchases: 'purchases_v2',
  taxRate: 'base_tax_rate_v1'
};

const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

/* ====== çŠ¶æ…‹ ====== */
let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

/* ====== è¡¨ç¤ºåˆ¶å¾¡ ====== */
let SHOW_ALL = false;

/* ====== ç¨ç‡ ====== */
function getBaseTaxRate(){ const v = localStorage.getItem(LS_KEYS.taxRate); return v==null ? 0.08 : Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate, String(decimal)); updateTaxRateLabel(); renderBaseRateRadios(); }
function updateTaxRateLabel(){ $('lblRate').textContent = Math.round(getBaseTaxRate()*1000)/10; }
function renderBaseRateRadios(){
  const pct = Math.round(getBaseTaxRate()*100);
  const target = pct===10 ? '10' : '8';
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  radios.forEach(r=>{
    r.checked = (r.value === target);
    r.onchange = ()=> setBaseTaxRate(Number(r.value)/100);
  });
}
function ensureBaseRateChecked(){
  const radios = document.querySelectorAll('input[name="baseRateChoice"]');
  const any = Array.from(radios).some(r => r.checked);
  if(!any){
    const pct = Math.round(getBaseTaxRate()*100);
    const target = pct===10 ? '10' : '8';
    const r = document.querySelector(`input[name="baseRateChoice"][value="${target}"]`);
    if(r) r.checked = true;
  }
}

/* ====== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ====== */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block':'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block':'none';
  $('page-masters').style.display = which==='masters' ? 'block':'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters')  { renderSupTable(); renderItemTable(); }
  if(which==='entry')    ensureBaseRateChecked();
}

/* ====== åˆæœŸæç”» ====== */
function init(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = ('0'+(today.getMonth()+1)).slice(-2);
  const dd = ('0'+today.getDate()).slice(-2);
  $('inDate').value = `${yyyy}-${mm}-${dd}`;

  // æ—¢å®šã¯ç¨åˆ¥
  const defTax = document.querySelector('input[name="inTax"][value="taxExcluded"]');
  if(defTax) defTax.checked = true;

  renderSupplierSelect();
  renderItemSelect();
  renderListTable();
  updateSums();
  updateTaxRateLabel();
  renderBaseRateRadios();
  ensureBaseRateChecked();
}
document.addEventListener('DOMContentLoaded', init);

// PWA: Service Workerï¼ˆå¼·åˆ¶æ›´æ–°ï¼‰
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js?v=17').catch(()=>{});
  });
}

/* ====== ãƒ˜ãƒ«ãƒ‘ãƒ¼æç”» ====== */
function renderSupplierSelect(){
  const sel = $('inSupplier');
  sel.innerHTML = '<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>' + suppliers.map(s=> `<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange = ()=>{ renderItemSelect(sel.value); updateSupplierQuick(sel.value); };
}
function updateSupplierQuick(supplierId){
  const wrap = $('supplierQuick');
  if(!supplierId){ wrap.style.display='none'; return; }
  const s = suppliers.find(x=>x.id===supplierId); if(!s){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  const phone = s.phone || ''; const telHref = phone ? `tel:${phone}` : '';
  $('supplierPhoneView').textContent = phone ? `é›»è©±ç•ªå·ï¼š${phone}` : 'é›»è©±ç•ªå·æœªç™»éŒ²';
  $('btnCallSupplier').onclick = ()=>{ if(!phone){ alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™'); return; } window.location.href = telHref; };
  $('btnCopySupplier').onclick = ()=> copyPhone(phone);
}
function renderItemSelect(supplierId=''){
  const sel = $('inItem');
  let list = items;
  if(supplierId){ list = items.filter(it => (it.suppliers||[]).includes(supplierId)); }
  sel.innerHTML = '<option value="">-- å•†å“ã‚’é¸æŠ --</option>' + list.map(i=> `<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange = ()=>{
    const it = items.find(x=>x.id===sel.value);
    if(it){
      const last = getLastPriceFor($('inSupplier').value, it.id);
      if (last!=null) $('inPrice').value = last;
      else if (it.price!=null) $('inPrice').value = it.price;
      const defaultTax = it.taxType || 'taxExcluded';
      const tsel = document.querySelector('input[name="inTax"][value="'+ defaultTax +'"]');
      if (tsel) tsel.checked = true;
    }
  };
}

/* ====== å…¥åŠ›ã‚¨ãƒªã‚¢ ====== */
function clearEntry(){ $('inItem').value = ''; $('inQty').value = 1; $('inPrice').value = 0; document.querySelector('input[name="inTax"][value="taxExcluded"]').checked = true; }

/* ====== ç›´è¿‘ä¾¡æ ¼å–å¾— ====== */
function getLastPriceFor(supplierId, itemId){
  for (let i = purchases.length - 1; i >= 0; i--) { const p = purchases[i]; if (p.supplierId === supplierId && p.itemId === itemId) return p.price; }
  return null;
}

/* ====== ä¿å­˜ãƒ»è¨ˆç®— ====== */
function savePurchase(){
  const date = $('inDate').value;
  const supplierId = $('inSupplier').value;
  const itemId = $('inItem').value;
  const qty = Number($('inQty').value || 0);
  const price = Number($('inPrice').value || 0);
  const selTax = document.querySelector('input[name="inTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';

  if(!date) return alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(!supplierId) return alert('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!itemId) return alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');

  const rate = getBaseTaxRate();
  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);

  purchases.push({date, supplierId, itemId, qty, price, taxType, total});
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  clearEntry(); renderListTable(); updateSums();
}

/* ====== ä¸€è¦§ & é›†è¨ˆ ====== */
function toggleAllRows(chk){
  SHOW_ALL = chk.checked;
  renderListTable();
}
function renderListTable(){
  const tb = $('listTable').querySelector('tbody'); tb.innerHTML = '';

  // æ–°ã—ã„é †ã«è¡¨ç¤º
  const arr = purchases.slice().map((p,idx)=>({p, idx})).reverse();
  const list = SHOW_ALL ? arr : arr.slice(0,50);

  list.forEach(({p, idx:origIndex})=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.date}</td>
      <td>${s ? s.name : ''}</td>
      <td>${i ? i.name : ''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
      <td>${p.total}</td>
      <td class="nowrap">
        <button class="ghost" style="padding:6px 8px;" onclick="openPurchaseEdit(${origIndex})">ç·¨é›†</button>
        <button class="danger" style="padding:6px 8px;" onclick="deletePurchaseAt(${origIndex})">å‰Šé™¤</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function updateSums(){
  const today = new Date(); const yyyy = today.getFullYear(); const mm = ('0'+(today.getMonth()+1)).slice(-2); const dd = ('0'+today.getDate()).slice(-2);
  const todayStr = `${yyyy}-${mm}-${dd}`, monthStr = `${yyyy}-${mm}`;
  let daily = 0, monthly = 0;
  purchases.forEach(p=>{ if(p.date===todayStr) daily += p.total; if((p.date||'').slice(0,7)===monthStr) monthly += p.total; });
  $('sumDaily').textContent = daily.toString(); $('sumMonthly').textContent = monthly.toString();
}

/* ====== CSV ====== */
function downloadCSV(){
  let csv = 'æ—¥ä»˜,ä»•å…¥å…ˆ,å•†å“,æ•°é‡,å˜ä¾¡,ç¨åŒºåˆ†,åˆè¨ˆ\n';
  purchases.forEach(p=>{
    const s = suppliers.find(x=>x.id===p.supplierId);
    const i = items.find(x=>x.id===p.itemId);
    csv += `${p.date},${s?s.name:''},${i?i.name:''},${p.qty},${p.price},${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'},${p.total}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== JSON ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼å¾©å…ƒï¼OneDrive ====== */
function downloadJSONBlob(){
  return new Blob([JSON.stringify({
    version: 1, savedAt: new Date().toISOString(),
    suppliers, items, purchases, taxRate: localStorage.getItem(LS_KEYS.taxRate)
  }, null, 2)], {type:'application/json'});
}
function downloadJSON(){
  const blob = downloadJSONBlob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(a.href);
}
async function backupToCloud(){
  const blob = downloadJSONBlob();
  const fileName = `shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const file = new File([blob], fileName, {type:'application/json'});

  // å…±æœ‰ã‚·ãƒ¼ãƒˆï¼ˆã‚¹ãƒãƒ›ï¼‰
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try{ await navigator.share({ title:'ä»•å…¥ã‚Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', text:'ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒªã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã§ã™ã€‚', files:[file] }); return; }
    catch(e){ if(e.name==='AbortError') return; }
  }
  // ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆPCï¼‰
  if ('showSaveFilePicker' in window) {
    try{
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description:'JSON', accept:{ 'application/json': ['.json'] } }]
      });
      const w = await handle.createWritable(); await w.write(blob); await w.close();
      alert('ä¿å­˜ã—ã¾ã—ãŸã€‚OneDriveåŒæœŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¹ã°è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã•ã‚Œã¾ã™ã€‚'); return;
    }catch(e){ if(e.name==='AbortError') return; }
  }
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé€šå¸¸DL
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName; a.click(); URL.revokeObjectURL(a.href);
  alert('ã“ã®ç«¯æœ«ã§ã¯å…±æœ‰/ä¿å­˜ãŒæœªå¯¾å¿œã®ãŸã‚ã€JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚OneDriveã¸æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
}
function restoreJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      if(!data || !data.suppliers || !data.items || !data.purchases) throw new Error('å½¢å¼ä¸æ­£');
      suppliers = data.suppliers; items = data.items; purchases = data.purchases;
      if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate, String(data.taxRate));
      localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
      localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
      localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
      renderSupplierSelect(); renderItemSelect(); renderListTable(); renderPhonebook(); renderSupTable(); renderItemTable(); updateSums(); updateTaxRateLabel();
      alert('å¾©å…ƒã—ã¾ã—ãŸ');
    }catch(e){ alert('å¾©å…ƒã«å¤±æ•—: ' + e.message); }
  };
  r.readAsText(file);
}

/* ====== é›»è©±å¸³ ====== */
function renderPhonebook(){
  const tb = $('phoneTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    const telHref = s.phone ? `tel:${s.phone}` : '';
    tr.innerHTML = `
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center; text-decoration:none; padding:8px; border-radius:8px; display:block;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>ğŸ“ é›»è©±</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
async function copyPhone(num){
  if(!num){ alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(num); }
    else{ const ta = document.createElement('textarea'); ta.value = num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    alert('é›»è©±ç•ªå·ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }catch(e){ alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š' + e.message); }
}

/* ====== ãƒã‚¹ã‚¿ä¸€è¦§ ====== */
function renderSupTable(){
  const tb = $('supTable').querySelector('tbody'); tb.innerHTML = '';
  suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.contact||''}</td><td class="nowrap">${s.phone||''}</td>
                    <td><button class="ghost" onclick="openSupplierEdit('${s.id}')">ç·¨é›†</button></td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb = $('itemTable').querySelector('tbody'); tb.innerHTML = '';
  items.forEach(it=>{
    const names = (it.suppliers||[]).map(id=> (suppliers.find(s=>s.id===id)||{}).name ).filter(Boolean);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.price!=null? it.price : ''}</td><td>${it.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td><td>${names.join(' / ')}</td><td><button class="ghost" onclick="openItemEdit('${it.id}')">ç·¨é›†</button></td>`;
    tb.appendChild(tr);
  });
}

/* ====== ä»•å…¥ã‚Œç·¨é›†ãƒ»å‰Šé™¤ ====== */
function openPurchaseEdit(index){
  // index ã¯ purchases é…åˆ—ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå¤â†’æ–°ï¼‰
  const p = purchases[index]; if(!p) return;

  $('editPurchaseIndex').value = String(index);
  $('editDate').value = p.date;

  // ä»•å…¥å…ˆãƒ»å•†å“ã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦é¸æŠçŠ¶æ…‹ã«
  const supSel = $('editSupplier'); supSel.innerHTML = suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  supSel.value = p.supplierId;

  const itemSel = $('editItem');
  const list = items.filter(it => (it.suppliers||[]).includes(p.supplierId));
  itemSel.innerHTML = list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  itemSel.value = p.itemId;

  supSel.onchange = ()=>{
    const list2 = items.filter(it => (it.suppliers||[]).includes(supSel.value));
    itemSel.innerHTML = list2.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  };

  $('editQty').value = p.qty;
  $('editPrice').value = p.price;
  const r = document.querySelector(`input[name="editTax"][value="${p.taxType}"]`);
  if(r) r.checked = true;

  $('purchaseEditModal').style.display = 'block';
}
function updatePurchase(){
  const idx = Number($('editPurchaseIndex').value);
  const date = $('editDate').value;
  const supplierId = $('editSupplier').value;
  const itemId = $('editItem').value;
  const qty = Number($('editQty').value || 0);
  const price = Number($('editPrice').value || 0);
  const selTax = document.querySelector('input[name="editTax"]:checked');
  const taxType = selTax ? selTax.value : 'taxExcluded';

  if(!date||!supplierId||!itemId) return alert('æ—¥ä»˜ãƒ»ä»•å…¥å…ˆãƒ»å•†å“ã¯å¿…é ˆã§ã™');

  const rate = getBaseTaxRate();
  const total = taxType==='taxExcluded' ? Math.round(qty*price*(1+rate)) : Math.round(qty*price);

  purchases[idx] = {date, supplierId, itemId, qty, price, taxType, total};
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));

  closeModal('purchaseEditModal');
  renderListTable(); updateSums();
}
function deletePurchase(){
  const idx = Number($('editPurchaseIndex').value);
  if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  purchases.splice(idx,1);
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  closeModal('purchaseEditModal');
  renderListTable(); updateSums();
}
function deletePurchaseAt(index){
  if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  purchases.splice(index,1);
  localStorage.setItem(LS_KEYS.purchases, JSON.stringify(purchases));
  renderListTable(); updateSums();
}

/* ====== ä»•å…¥å…ˆï¼šæ–°è¦/ç·¨é›† ====== */
function openSupplierModal(){ resetSupplierForm(); const m = $('supplierModal'); if(!m){ alert('supplierModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; } m.style.display = 'block'; }
function resetSupplierForm(){ $('supName').value=''; $('supContact').value=''; $('supPhone').value=''; }
function addSupplier(){
  const name = $('supName').value.trim(); if(!name) return alert('ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const contact = $('supContact').value.trim(); const phone = $('supPhone').value.trim();
  suppliers.push({id: uid(), name, contact, phone});
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  resetSupplierForm(); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemSupplierChecks();
}
function openSupplierEdit(id){
  const s = suppliers.find(x=>x.id===id); if(!s) return;
  $('editSupId').value = s.id; $('editSupName').value = s.name; $('editSupContact').value = s.contact||''; $('editSupPhone').value = s.phone||'';
  const m = $('supplierEditModal'); if(!m){ alert('supplierEditModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  m.style.display = 'block';
}
function updateSupplier(){
  const id = $('editSupId').value; const s = suppliers.find(x=>x.id===id); if(!s) return;
  const name = $('editSupName').value.trim(); if(!name) return alert('ç¤¾åã¯å¿…é ˆã§ã™');
  s.name = name; s.contact = $('editSupContact').value.trim(); s.phone = $('editSupPhone').value.trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
}
function deleteSupplier(){
  const id = $('editSupId').value;
  if(!confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ç´ä»˜ãå•†å“ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  suppliers = suppliers.filter(s=>s.id!==id);
  items = items.map(it=> ({...it, suppliers: (it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal'); renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

/* ====== å•†å“ï¼šæ–°è¦/ç·¨é›† ====== */
function openItemModal(){ resetItemForm(); renderItemSupplierChecks(); const m = $('itemModal'); if(!m){ alert('itemModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; } m.style.display = 'block'; }
function resetItemForm(){ $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxIncluded'; }
function renderItemSupplierChecks(target='itSuppliers'){
  const box = $(target);
  if(suppliers.length===0){ box.innerHTML = '<div class="small">ä»•å…¥å…ˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä»•å…¥å…ˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>'; return; }
  box.innerHTML = suppliers.map(s=>`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" value="${s.id}"> ${s.name}</label>`).join('');
}
function addItem(){
  const name = $('itName').value.trim(); if(!name) return alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const priceStr = $('itPrice').value.trim(); const price = priceStr==='' ? null : Number(priceStr);
  const taxType = $('itTax').value;
  const checks = Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ã‚‹ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
  items.push({id: uid(), name, price, taxType, suppliers: supIds});
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  resetItemForm(); renderItemSupplierChecks(); renderItemSelect($('inSupplier').value); renderItemTable();
}
function openItemEdit(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  $('editItemId').value = it.id; $('editItName').value = it.name; $('editItPrice').value = it.price!=null? it.price : ''; $('editItTax').value = it.taxType || 'taxIncluded';
  renderItemSupplierChecks('editItSuppliers');
  const box = $('editItSuppliers'); (it.suppliers||[]).forEach(sid=>{ const chk = box.querySelector(`input[value="${sid}"]`); if(chk) chk.checked = true; });
  const m = $('itemEditModal'); if(!m){ alert('itemEditModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  m.style.display = 'block';
}
function updateItem(){
  const id = $('editItemId').value; const it = items.find(x=>x.id===id); if(!it) return;
  const name = $('editItName').value.trim(); if(!name) return alert('å•†å“åã¯å¿…é ˆã§ã™');
  const priceStr = $('editItPrice').value.trim(); it.price = priceStr==='' ? null : Number(priceStr);
  it.name = name; it.taxType = $('editItTax').value;
  const checks = Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds = checks.map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); it.suppliers = supIds;
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}
function deleteItem(){
  const id = $('editItemId').value; if(!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  items = items.filter(x=>x.id!==id); localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}

/* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ====== */
function closeModal(id){ const m = $(id); if(m) m.style.display='none'; }
window.addEventListener('click', (e)=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('purchaseEditModal')) closeModal('purchaseEditModal');
  if(e.target===$('settingsModal')) closeModal('settingsModal');
});

/* ====== åˆæœŸåŒ–ç³» ====== */
function wipeAll(){
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ãƒ»ä»•å…¥å±¥æ­´ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  suppliers=[]; items=[]; purchases=[];
  localStorage.removeItem(LS_KEYS.suppliers); localStorage.removeItem(LS_KEYS.items); localStorage.removeItem(LS_KEYS.purchases);
  renderSupplierSelect(); renderItemSelect(); renderListTable(); renderPhonebook(); renderSupTable(); renderItemTable(); updateSums();
}
</script>
</body>
</html>
