<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tabco Ledger Plus</title>
<style>
:root{--bg:#0b0b0c;--fg:#f4f6f8;--mut:#b6bec9;--card:#15171a;--accent:#3ea6ff;--ok:#15b374;--warn:#ffb020;--bad:#ff5f5f;--line:#2a2d31}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans JP,Meiryo,sans-serif;background:var(--bg);color:var(--fg)}
.hidden{display:none}
.container{max-width:920px;margin:0 auto;padding:12px}
.row{display:flex;gap:8px;align-items:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.section-title{font-weight:700;margin-bottom:8px}
.label{color:var(--mut);font-size:12px}
.input, input, select, textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0e1013;color:var(--fg)}
button.btn{padding:10px 14px;border:none;border-radius:999px;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;font-weight:700}
.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
.btn.small{padding:6px 10px;font-size:12px}
.btn.neg{border-color:var(--bad);color:var(--bad)}
.btn.pos{border-color:var(--ok);color:var(--ok)}
.fixed-bar{position:sticky;bottom:0;left:0;right:0;background:rgba(12,13,16,.9);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid var(--line);padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0d1117;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
.list-item{padding:10px;border-bottom:1px solid var(--line)}
.mini-meta{font-size:12px;color:var(--mut)}
.pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#0e1013;border-radius:999px;padding:4px 10px}
.badge{position:fixed;right:10px;bottom:10px;border-radius:12px;background:#0d1117cc;border:1px solid var(--line);padding:6px 10px;color:var(--mut);backdrop-filter:blur(5px)}
hr{border:none;border-top:1px solid var(--line);margin:8px 0}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0007;z-index:10000}
.modal .sheet{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.modal .row{gap:10px}
.modal .grid{grid-template-columns:1fr 1fr}
.modal input[type=radio]{transform:translateY(1px)}
.modal .label{font-size:12px;color:var(--mut)}
.modal h3{margin:2px 0 8px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
  <header class="container" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <div class="row" style="gap:10px">
      <div class="pill"><span>Tabco Ledger Plus</span><span id="pillPlan" class="mini-meta">free</span></div>
    </div>
    <nav class="row" style="gap:6px">
      <a href="#home" class="btn ghost small">ホーム</a>
      <a href="#input" class="btn ghost small">入力</a>
      <a href="#suppliers" class="btn ghost small">仕入先</a>
      <a href="#products" class="btn ghost small">商品</a>
      <a href="#backup" class="btn ghost small">バックアップ</a>
    </nav>
  </header>

  <main class="container">
    <div id="page-home" class="card">
      <div class="section-title">今日の入力</div>
      <div id="todayList"></div>
      <div class="mini-meta" id="bkLast"></div>
      <div class="row" style="gap:6px;margin-top:8px">
        <button id="btnExport2" class="btn primary">データ出力</button>
        <button id="btnGoInput" class="btn ghost">入力へ</button>
      </div>
    </div>

    <div id="page-input" class="card hidden">
      <div class="section-title">仕入れ入力</div>
      <div class="grid">
        <div>
          <div class="label">日付</div>
          <input id="inDate" type="date">
        </div>
        <div>
          <div class="label">仕入先</div>
          <select id="inSupplier"></select>
        </div>
        <div>
          <div class="label">商品</div>
          <select id="inProduct"></select>
        </div>
        <div>
          <div class="label">数量</div>
          <input id="inQty" type="number" step="1" inputmode="numeric">
        </div>
        <div>
          <div class="label">単価</div>
          <input id="inPrice" type="number" step="1" inputmode="numeric">
        </div>
        <div>
          <div class="label">税率</div>
          <div class="row">
            <label class="row" style="gap:6px"><input type="radio" name="taxrate" value="0" checked> 0%</label>
            <label class="row" style="gap:6px"><input type="radio" name="taxrate" value="8"> 8%</label>
            <label class="row" style="gap:6px"><input type="radio" name="taxrate" value="10"> 10%</label>
          </div>
        </div>
        <div>
          <div class="label">税区分</div>
          <div class="row">
            <label class="row" style="gap:6px"><input type="radio" name="taxmode" value="excl" checked> 税別</label>
            <label class="row" style="gap:6px"><input type="radio" name="taxmode" value="incl"> 税込</label>
          </div>
        </div>
        <div>
          <div class="label">メモ</div>
          <input id="inMemo" type="text">
        </div>
      </div>
      <div class="fixed-bar">
        <button id="btnClear" class="btn ghost small neg" type="button">クリア</button>
        <button id="btnSave" class="btn primary pos" type="button">完了（ホームへ）</button>
      </div>
    </div>

    <div id="page-suppliers" class="card hidden">
      <div class="section-title">仕入先</div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:6px">
          <button id="btnAddSupplier" class="btn ghost small">＋仕入先</button>
        </div>
        <div class="row" style="gap:6px">
          <input id="filterSup" class="input" placeholder="検索…">
        </div>
      </div>
      <div id="supplierList" style="margin-top:8px"></div>
    </div>

    <div id="page-products" class="card hidden">
      <div class="section-title">商品</div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:6px">
          <button id="btnAddProduct" class="btn ghost small">＋商品</button>
          <select id="filterProdSupplier"></select>
        </div>
        <div class="row" style="gap:6px">
          <input id="filterProd" class="input" placeholder="検索…">
        </div>
      </div>
      <div id="productList" style="margin-top:8px"></div>
    </div>

    <div id="page-backup" class="card hidden">
      <div class="section-title">バックアップ</div>
      <div class="row" style="gap:10px;align-items:center">
        <button id="btnBackupNow" class="btn primary">今すぐバックアップ</button>
        <button id="btnRestore" class="btn ghost">復元</button>
        <input id="fileRestore" type="file" accept="application/json" class="hidden">
      </div>
      <div class="row" style="gap:10px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleAutoClear" checked> ＋明細追加後に入力欄をクリア</label>
      </div>
      <hr>
      <div class="row" style="gap:8px">
        <label class="row" style="gap:6px"><input type="radio" name="bksched" value="daily"> 毎日</label>
        <label class="row" style="gap:6px"><input type="radio" name="bksched" value="weekly" id="bksched"> 毎週 月曜</label>
        <label class="row" style="gap:6px"><input type="radio" name="bksched" value="manual"> 手動のみ</label>
      </div>
      <div class="mini-meta" style="margin-top:8px">※ プランは端末ごとです。バックアップには含まれません</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="section-title">年度アーカイブ</div>
      <div class="row" style="justify-content:space-between;align-items:center;gap:6px">
        <div class="row" style="gap:6px"><input id="inFiscalYear" type="number" inputmode="numeric" class="input" style="width:120px"></div>
        <div class="row" style="gap:6px">
          <button id="btnArchiveFiscal" class="btn ghost">年度アーカイブ作成＆リセット</button>
        </div>
      </div>
    </div>
  </main>

  <div class="badge">Tabco Ledger Plus — v0.8.0</div>

<script>
"use strict";

/* ===== 小ユーティリティ ===== */
const $ = (q,el=document)=>el.querySelector(q);
const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
const YMD = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function planJp(p){ return p==='free'?'Free（無料）':p==='middle'?'Middle（ミドル）':p==='pro'?'Pro（プロ）':String(p) }

/* ===== データ永続化（擬似DB） ===== */
const DB={
  load(){ try{ return JSON.parse(localStorage.getItem("tlp_store")||"null")||{settings:{plan:'free',theme:'dark',autoClear:true,historyShowBoth:true,showTaxFlags:false,recentProducts:[],hisRangeDays:30},suppliers:[],products:[],entries:[],priceHistory:{}} }catch{return{settings:{plan:'free'},suppliers:[],products:[],entries:[],priceHistory:{}}} },
  save(s){ localStorage.setItem("tlp_store",JSON.stringify(s)); }
};
let store=DB.load();

/* === Plans: 単一の真実（SOT） ============================= */
const PlanRules = {
  free:   { exportMax: 'month',  supplierMax: 5,  productTotalMax: 50,  productPerSupplierMax: 10,  ads: true  },
  middle: { exportMax: 'fiscal', supplierMax: 15, productTotalMax: 225, productPerSupplierMax: 15,  ads: false },
  pro:    { exportMax: 'all',    supplierMax: Infinity, productTotalMax: Infinity, productPerSupplierMax: Infinity, ads: false }
};
const EXPORT_KEYS = ['month','fiscal','all'];
function clampExportKey(req, plan){
  const p = (plan ?? PLAN());
  const rules = PlanRules[p] || PlanRules.free;
  const key = (EXPORT_KEYS.includes(req)? req : 'month');
  if (rules.exportMax === 'month') return 'month';
  if (rules.exportMax === 'fiscal' && key === 'all') return 'fiscal';
  return key;
}
window.clampExportKey = clampExportKey; // コンソール診断用に公開（任意）

// === Plan Caps ===
const PlanCap = {
  free   : { suppliers: 5,  productsPerSupplier: 10,  productsTotal: 50  },
  middle : { suppliers: 15, productsPerSupplier: 15,  productsTotal: 225 },
  pro    : { suppliers: Infinity, productsPerSupplier: Infinity, productsTotal: Infinity }
};
const PLAN  = ()=> (store?.settings?.plan || 'free');  // 既にあればそのままでOK
const CAPS = (p = PLAN()) => (PlanCap[p] || PlanCap.free);
window.CAPS = CAPS; // 診断用に公開（任意）
const capLabel = (n, unit)=> (n===Infinity ? '無制限' : `${n}${unit}`);
window.PlanRules = PlanRules;
window.PlanCap   = PlanCap;
window.PLAN      = PLAN;
window.capLabel  = capLabel;


/* === 期間ユーティリティ === */
function _ym(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
function _startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function _endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
function getExportRange(key){
  const now=new Date();
  if(key==="all") return {from:null,to:null,label:"全期間",key:"all"};
  if(key==="fiscal"){ const from=new Date(now.getFullYear(),0,1); const to=_endOfDay(new Date()); return {from,to,label:`${now.getFullYear()}年1月〜${_ym(now)}`,key:"fiscal"}; }
  // default: 当月
  const from=_startOfMonth(now), to=_endOfDay(new Date());
  return {from,to,label:_ym(now),key:"month"};
}
function _inRange(ymd, range){
  if(!ymd) return false;
  const d=new Date(ymd+"T12:00:00");
  if(range.from && d<range.from) return false;
  if(range.to && d>range.to) return false;
  return true;
}

/* ===== Theme & Header ===== */
function applyTheme(){
  document.documentElement.dataset.theme=store.settings.theme||'dark';
  $('#pillPlan').textContent = planJp(store.settings.plan||'free');
}

/* ===== ルーター（ハッシュ） ===== */
function navigate(page){ location.hash = page; }
function onRoute(){
  const page=(location.hash||'#home').replace('#','');
  $$('#page-home,#page-input,#page-suppliers,#page-products,#page-backup').forEach(el=>el.classList.add('hidden'));
  const el=$(`#page-${page}`); if(el) el.classList.remove('hidden');
}
window.addEventListener('hashchange', onRoute);

/* ===== 初期化 ===== */
function refreshHome(){
  const list=$('#todayList'); if(!list) return;
  const today=YMD(new Date());
  const entries=(store.entries||[]).filter(e=>!e.deleted && e.date===today);
  list.innerHTML='';
  entries.forEach(e=>{
    const sName = (store.suppliers.find(s=>s.id===e.supplier_id)?.name)||'-';
    const pName = (store.products.find(p=>p.id===e.product_id)?.name)||'-';
    const row=document.createElement('div'); row.className='list-item';
    row.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${e.date}</b> ${sName} / ${pName} ×${e.qty}</div><div class="mini-meta">¥${e.incl||e.excl||0}</div></div>`;
    list.appendChild(row);
  });
}

function initInputPage(){
  const selSup=$('#inSupplier'); const selProd=$('#inProduct'); if(!selSup||!selProd) return;
  selSup.innerHTML = `<option value="">-</option>` + (store.suppliers||[]).filter(s=>!s.deleted).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  const supId=selSup.value||store.suppliers[0]?.id||'';
  selProd.innerHTML = (store.products||[]).filter(p=>!p.deleted && (!supId||p.supplier_id===supId)).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}

function renderSuppliers(){
  const list=$('#supplierList'); if(!list) return; const q=($('#filterSup').value||'').toLowerCase();
  const items=(store.suppliers||[]).filter(s=>!s.deleted && (!q || s.name.toLowerCase().includes(q)));
  list.innerHTML='';
  items.forEach(s=>{
    const el=document.createElement('div'); el.className='list-item';
    el.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div><b>${s.name}</b><div class="mini-meta">${s.contact||''} ${s.phone||''}</div></div><div class="row"><button class="btn small ghost" data-edit-sup="${s.id}">編集</button></div></div>`;
    list.appendChild(el);
  });
}

function renderProducts(){
  const list=$('#productList'); if(!list) return;
  const sid=$('#filterProdSupplier').value;
  const items=store.products.filter(p=>!p.deleted&&(!sid||p.supplier_id===sid));
  list.innerHTML='';
  items.forEach(p=>{
    const sName=supplierName(p.supplier_id)||"-";
    const item=document.createElement("div"); item.className="list-item";
    item.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${p.name}</b>
          <div class="mini-meta">${sName} / ¥${p.default_price||0} / 税${p.tax_rate||0}% ${p.tax_mode||'excl'}</div>
        </div>
        <div class="row"><button class="btn small ghost" data-edit-product="${p.id}">編集</button></div>
      </div>`;
    list.appendChild(item);
  });
}

function supplierName(id){ return (store.suppliers.find(s=>s.id===id)?.name)||null }

function enableSelectOnFocus(){
  $$('#page-input input[type="number"]').forEach(inp=>{
    const sel=()=>inp.select();
    inp.addEventListener("focus",sel);
    inp.addEventListener("click",sel);
  });
}

/* ====== 仕入先 / 商品モーダル ====== */
function openSupplierModal(s){
  openModalBase(s?"仕入先を編集":"仕入先を追加", `
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><div class="label">社名</div><input id="mSupName" type="text" value="${s?.name||""}"></div>
      <div><div class="label">担当</div><input id="mSupContact" type="text" value="${s?.contact||""}"></div>
      <div><div class="label">電話</div><input id="mSupPhone" type="tel" value="${s?.phone||""}" inputmode="tel"></div>
      <div><div class="label">インボイス番号</div><input id="mSupInv" type="text" value="${s?.invoice_number||""}"></div>
    </div>`);
  const onOK=()=>{
    const name=$("#mSupName").value.trim(); if(!name){ alert("社名を入力してください"); return; }
    if(!s){
      const cap = CAPS();
      const count = store.suppliers.filter(x=>!x.deleted).length;
      if(count >= cap.suppliers){ alert(`現在のプランでは仕入先は ${capLabel(cap.suppliers,'社')} までです。\nPlans からアップグレードをご検討ください。`); return; }
    }
    const contact=$("#mSupContact").value.trim();
    const phone  =$(`#mSupPhone`).value.trim();
    const inv    =$(`#mSupInv`).value.trim();
    if(s){ s.name=name; s.contact=contact; s.phone=phone; s.invoice_number=inv; }
    else{ store.suppliers.push({id:uid(),name,contact,phone,invoice_number:inv}); }
    DB.save(store); renderSuppliers(); closeModal();
  };
  const delBtn=document.createElement('button'); delBtn.className='btn small neg ghost'; delBtn.textContent='削除'; delBtn.onclick=()=>{ if(confirm('削除しますか？')){ s.deleted=true; DB.save(store); renderSuppliers(); closeModal(); } };
  const ok=$('#modalOK'); ok.onclick=onOK; $('.actions').insertBefore(delBtn, $('#modalCancel'));
}

function tryAddSupplier(){
  const cap = CAPS();
  const count = store.suppliers.filter(x=>!x.deleted).length;
  if(count >= cap.suppliers){
    alert(`現在のプランでは仕入先は ${capLabel(cap.suppliers,'社')} までです。\nPlans からアップグレードをご検討ください。`);
    return;
  }
  openSupplierModal(null);
}

function openProductModal(p,defaultSid){
  const supOpts=store.suppliers.filter(s=>!s.deleted).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  openModalBase(p?"商品を編集":"商品を追加", `
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><div class="label">商品名</div><input id="mProdName" type="text" value="${p?.name||""}"></div>
      <div><div class="label">仕入先</div><select id="mProdSup">${supOpts}</select></div>
      <div><div class="label">標準単価</div><input id="mProdPrice" type="number" inputmode="numeric" value="${p?.default_price||""}"></div>
      <div>
        <div class="label">税</div>
        <div class="row">
          <label class="row" style="gap:6px"><input type="radio" name="mTaxrate" value="0" ${String(p?.tax_rate||0)==='0'?'checked':''}> 0%</label>
          <label class="row" style="gap:6px"><input type="radio" name="mTaxrate" value="8" ${String(p?.tax_rate||8)==='8'?'checked':''}> 8%</label>
          <label class="row" style="gap:6px"><input type="radio" name="mTaxrate" value="10" ${String(p?.tax_rate||10)==='10'?'checked':''}> 10%</label>
        </div>
      </div>
      <div>
        <div class="label">税区分</div>
        <div class="row">
          <label class="row" style="gap:6px"><input type="radio" name="mTaxmode" value="excl" ${(p?.tax_mode||'excl')==='excl'?'checked':''}> 税別</label>
          <label class="row" style="gap:6px"><input type="radio" name="mTaxmode" value="incl" ${(p?.tax_mode||'excl')==='incl'?'checked':''}> 税込</label>
        </div>
      </div>
    </div>`);
  if(!p){ $('#mProdSup').value = (defaultSid||store.suppliers[0]?.id||''); }
  const onOK=()=>{
    const name=$('#mProdName').value.trim(); if(!name){ alert('商品名を入力してください'); return; }
    const sid=$('#mProdSup').value; if(!sid){ alert('仕入先を選択してください'); return; }
    if(!p){
      const cap = CAPS();
      const total = store.products.filter(x=>!x.deleted).length;
      if (total >= cap.productsTotal){
        alert(`現在のプランでは商品合計は ${capLabel(cap.productsTotal,'品')} までです。\nPlans からアップグレードをご検討ください。`);
        return;
      }
      const per = store.products.filter(x=>!x.deleted && x.supplier_id===sid).length;
      if (per >= cap.productsPerSupplier){
        alert(`現在のプランではこの仕入先の登録は ${capLabel(cap.productsPerSupplier,'品/カード')} までです。`);
        return;
      }
      store.products.push({id:uid(),supplier_id:sid,name,default_price:Number($('#mProdPrice').value||0),tax_rate:Number(document.querySelector('input[name="mTaxrate"]:checked').value),tax_mode:document.querySelector('input[name="mTaxmode"]:checked').value});
    }else{
      p.name=name; p.supplier_id=sid; p.default_price=Number($('#mProdPrice').value||0); p.tax_rate=Number(document.querySelector('input[name="mTaxrate"]:checked').value); p.tax_mode=document.querySelector('input[name="mTaxmode"]:checked').value;
    }
    DB.save(store); renderProducts(); closeModal();
  };
  $('#modalOK').onclick=onOK;
}

function tryAddProductStart(defaultSid){
  const cap = CAPS();
  const total = store.products.filter(x=>!x.deleted).length;
  if(total >= cap.productsTotal){
    alert(`このプランでは商品は合計 ${capLabel(cap.productsTotal,'品')} までです。Plans からアップグレードをご検討ください。`);
    return;
  }
  openProductModal(null, defaultSid);
}

/* ===== 明細編集（Lite：数量・単価・税率） ===== */
function _findEntryById(id){
  if(!id) return null;
  return (store.entries||[]).find(e=>e && !e.deleted && e.id===id) || null;
}
function _pushPriceHistoryIfNeeded(e){
  try{
    if(!e || !e.product_id) return;
    const arr = store.priceHistory[e.product_id] || (store.priceHistory[e.product_id] = []);
    const key = `${e.qty||1}×${e.tax_rate||0}%/${e.tax_mode||'excl'}`;
    const exists = arr.some(x => x && !x.deleted && x.unit_price===e.price && x.key===key);
    if(!exists){ arr.unshift({id:uid(),unit_price:e.price||0,key,created_at:Date.now()}); arr.splice(0,50); }
  }catch{}
}

/* ===== 入力画面：行追加 ===== */
function addLine(){
  const date=$('#inDate').value||YMD(new Date());
  const sid=$('#inSupplier').value||store.suppliers[0]?.id||'';
  const pid=$('#inProduct').value||store.products.find(p=>p.supplier_id===sid)?.id||'';
  const qty=Number($('#inQty').value||1);
  const price=Number($('#inPrice').value||0);
  const taxrate=Number(document.querySelector('input[name="taxrate"]:checked').value);
  const taxmode=document.querySelector('input[name="taxmode"]:checked').value;
  const memo=$('#inMemo').value.trim();
  const e={id:uid(),date,supplier_id:sid,product_id:pid,qty,price,tax_rate:taxrate,tax_mode:taxmode,memo};
  const {excl,incl} = calcLineTotal(e); e.excl=excl; e.incl=incl;
  store.entries.unshift(e); DB.save(store);
  if(store.settings.autoClear){ $('#inQty').value=''; $('#inPrice').value=''; $('#inMemo').value=''; }
  renderTodayList();
}

function calcLineTotal(e){
  const p=Number(e.price)||0, q=Number(e.qty)||0, r=Number(e.tax_rate)||0;
  const base = p*q;
  if(e.tax_mode==="incl"||e.taxmode==="incl"){ const excl = Math.round(base/(1+r/100)); return {excl, incl: base}; }
  else if(e.tax_mode==="excl"||e.taxmode==="excl"){ const incl = Math.round(base*(1+r/100)); return {excl: base, incl}; }
  else { return {excl: base, incl: base}; }
}

function bumpRecentProduct(pid){
  if(!pid) return;
  const arr = store.settings.recentProducts || [];
  const i = arr.indexOf(pid);
  if(i>=0) arr.splice(i,1);
  arr.unshift(pid);
  store.settings.recentProducts = arr.slice(0,20);
}

/* === 出力処理（Excel XML） === */
function exportXml(rows, name){
  const esc = (s)=>String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
  const xmlHeader = `<?xml version="1.0"?>\n<?mso-application progid="Excel.Sheet"?>`;
  const wbOpen = `<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">`;
  const wbClose = `</Workbook>`;
  const shOpen = `<Worksheet ss:Name="export"><Table>`;
  const shClose = `</Table></Worksheet>`;
  const rowsXml = rows.map(r=>`<Row>`+r.map(c=>`<Cell><Data ss:Type="String">${esc(c)}</Data></Cell>`).join('')+`</Row>`).join('');
  const xml = [xmlHeader, wbOpen, shOpen, rowsXml, shClose, wbClose].join('');
  const blob = new Blob([xml], { type: "application/vnd.ms-excel" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (name || `tlp_export_${Date.now()}.xml`).replace(/\.\n\w+$/, '') + ".xml";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

function exportData(rangeKey){
  const plan = (store && store.settings && store.settings.plan) || 'free';
  const key  = clampExportKey(rangeKey, plan);
  const range = getExportRange(key);

  const rows = [["日付","仕入れ先","商品","数量","単価","税率","区分","税込額","メモ"]];
  const entries = (store.entries||[]).filter(e => e && !e.deleted && (!range.from || _inRange(e.date, range)));
  entries.forEach(e=>{
    const sName = supplierName(e.supplier_id)||'-';
    const pName = (store.products.find(p=>p.id===e.product_id)?.name) || '-';
    rows.push([e.date, sName, pName, e.qty, e.price, `${e.tax_rate||0}%`, e.tax_mode||e.taxmode||'excl', e.incl||e.excl||0, e.memo||'']);
  });
  exportXml(rows, `tlp_${key}_${YMD(new Date())}.xml`);
}

/* === 出力モーダル（プラン連動） === */
function ModalExport(){
  const plan = store.settings.plan || "free";
  openModalBase("データ出力", `
    <div class="grid" id="ModalExport">
      <div class="label">出力範囲</div>
      <label><input type="radio" name="exRange" value="month"> 当月</label>
      <label><input type="radio" name="exRange" value="fiscal"> 年度（1月〜今月）</label>
      <label><input type="radio" name="exRange" value="all"> 全期間</label>
      <div class="mini-meta">プラン：${planJp(plan)}</div>
    </div>
  `);
  const radios = Array.from(document.querySelectorAll('input[name="exRange"]'));
  radios.forEach(r => { r.disabled = (clampExportKey(r.value, plan) !== r.value); });
  const def = clampExportKey('all', plan);
  const defRadio = document.querySelector(`input[name="exRange"][value="${def}"]`);
  if(defRadio) defRadio.checked = true;
  const ok=$('#modalOK');
  ok.textContent="出力する";
  ok.onclick=()=>{
    const chosen = document.querySelector('input[name="exRange"]:checked')?.value || def;
    closeModal();
    exportData(chosen);
  };
}

document.addEventListener("click", (e)=>{ const btn = e.target.closest("#btnExport2"); if(!btn) return; e.preventDefault(); ModalExport(); });

/* ===== Backup / Restore / Fiscal Archive ===== */
function backupNow(){
  const { plan, ...settingsNoPlan } = (store.settings||{});
  const payload = {
    version: "1.1",
    exported_at: new Date().toISOString(),
    tables: {
      suppliers: store.suppliers,
      products: store.products,
      entries: store.entries,
      priceHistory: store.priceHistory,
      settings: settingsNoPlan
    }
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tlp_backup_"+YMD(new Date())+".json"; a.click(); URL.revokeObjectURL(a.href);
  store.settings.lastBackupAt=Date.now(); DB.save(store); refreshHome();
  const bk=$("#bkLast"); if(bk) bk.textContent=new Date(store.settings.lastBackupAt).toLocaleString("ja-JP");
}

document.addEventListener("click",(e)=>{ if(e.target.id==="btnBackupNow") backupNow(); });
document.addEventListener("click",(e)=>{ if(e.target.id==="btnRestore") $("#fileRestore").click(); });
document.addEventListener("change",(e)=>{
  if(e.target.id!=="fileRestore") return;
  const f=e.target.files[0]; if(!f) return;
  if(!confirm("バックアップから復元します。現在のデータは置き換えられます。続行しますか？")) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result); if(!data.tables) throw 0;
      store.suppliers=data.tables.suppliers||[];
      store.products=data.tables.products||[];
      store.entries=data.tables.entries||[];
      store.priceHistory=data.tables.priceHistory||{};
      {
      const localPlan = store.settings.plan;
      const incoming = Object.assign({
        theme:store.settings.theme, autoClear:true,
        historyShowBoth:true, showTaxFlags:false,
        recentProducts:store.settings.recentProducts||[], hisRangeDays:30
      }, data.tables.settings||{});
      delete incoming.plan;
      store.settings = Object.assign({}, store.settings, incoming, { plan: localPlan });
    }
      DB.save(store);
      alert("復元しました");
      applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); renderProducts(); renderTodayList(); navigate("home"); enableSelectOnFocus();
    }catch{ alert("復元に失敗しました。ファイルをご確認ください。"); }
  };
  r.readAsText(f);
});

function refreshFiscalLabel(){
  // 省略（必要なら年度アーカイブのラベル更新を実装）
}

document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnArchiveFiscal") return;
  const year = Number($('#inFiscalYear').value||new Date().getFullYear());
  if(!year) return;
  if(!confirm(`${year}年の明細をアーカイブし、当年の明細をリセットします。よろしいですか？`)) return;
  backupNow();
  const target=store.entries.filter(e=>e.date && e.date.startsWith(String(year)+"-"));
  const archivePayload={version:"1.0",fiscal_year:year,exported_at:new Date().toISOString(),tables:{entries:target}};
  const blob2=new Blob([JSON.stringify(archivePayload,null,2)],{type:"application/json"});
  const a2=document.createElement("a"); a2.href=URL.createObjectURL(blob2); a2.download=`tlp_archive_${year}年度.json`; a2.click(); URL.revokeObjectURL(a2.href);
  store.entries = store.entries.filter(e=>!(e.date && e.date.startsWith(String(year)+"-")));
  DB.save(store);
  alert(`${year}年の明細をリセットしました（仕入先・商品は残しています）`);
  renderTodayList(); renderHistory(); refreshHome();
});

/* ===== 工場出荷状態に戻す（初期化） ===== */
document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnFactoryReset") return;
  if(!confirm("バックアップは取得済みですか？\n\n未取得の場合は「キャンセル」でバックアップ設定へ移動します。")){ navigate('backup'); return; }
  if(!confirm("本当に初期化しますか？")) return;
  localStorage.removeItem('tlp_store'); store=DB.load(); DB.save(store);
  applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); renderProducts(); enableSelectOnFocus();
  alert("初期化しました");
});

/* ===== モーダル基盤 ===== */
function openModalBase(title, html){
  const wrap=document.createElement('div'); wrap.className='modal'; wrap.innerHTML=`
    <div class="sheet">
      <h3>${title}</h3>
      <div class="body">${html}</div>
      <div class="actions">
        <button id="modalCancel" class="btn ghost">キャンセル</button>
        <button id="modalOK" class="btn primary">OK</button>
      </div>
    </div>`;
  document.body.appendChild(wrap);
  setTimeout(()=>$('#modalOK').focus(), 0);
  $('#modalCancel').onclick=closeModal;
}
function closeModal(){ const m=$('.modal'); if(m) m.remove(); }

document.addEventListener('click',(e)=>{
  const t=e.target.closest('[data-edit-sup]'); if(!t) return; const id=t.getAttribute('data-edit-sup'); const s=store.suppliers.find(x=>x.id===id); openSupplierModal(s);
});

document.addEventListener('click',(e)=>{
  const t=e.target.closest('[data-edit-product]'); if(!t) return; const id=t.getAttribute('data-edit-product'); const p=store.products.find(x=>x.id===id); openProductModal(p,p?.supplier_id);
});

document.addEventListener('click',(e)=>{ if(e.target.id==='btnAddSupplier') tryAddSupplier(); });
document.addEventListener('click',(e)=>{ if(e.target.id==='btnAddProduct') { const sid=$('#filterProdSupplier').value || (store.suppliers[0]?.id || ""); tryAddProductStart(sid); }});

document.addEventListener('click',(e)=>{ if(e.target.id==='btnAddLine') addLine(); });

/* ===== 初回描画 ===== */
applyTheme(); onRoute(); refreshHome(); initInputPage(); renderSuppliers(); renderProducts(); enableSelectOnFocus();

</script>
</body>
</html>
