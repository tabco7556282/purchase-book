<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª V24</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#38bdf8; --danger:#ef4444; --warn:#f59e0b; --ring:#334155;
      --chip:#1f2937; --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg,var(--bg),#030712 60%); color:var(--text);
    }
    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(6px);
      background:rgba(2,6,23,.75); border-bottom:1px solid var(--ring)}
    .wrap{max-width:1000px; margin:0 auto; padding:12px 16px}
    h1{font-size:20px; margin:0; letter-spacing:.02em}
    .subtitle{color:var(--muted); font-size:12px}

    nav.tabs{display:flex; gap:8px; margin:10px 0 0 0; flex-wrap:wrap}
    .tab-btn{padding:10px 12px; border:1px solid var(--ring); border-radius:12px; background:var(--chip);
      color:var(--text); cursor:pointer; font-size:14px; box-shadow:var(--shadow)}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--accent2); background:#0a192f}

    main{padding:16px}
    section.panel{display:none}
    section.panel.active{display:block}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow); margin:12px 0}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (min-width:900px){ .row-3{grid-template-columns:1fr 1fr 1fr} }
    label{font-size:12px; color:var(--muted)}
    input, select, textarea, button{font:inherit}
    input[type="text"],input[type="number"],input[type="date"],input[type="tel"],select,textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:#0a1426; color:var(--text)}
    input[type="number"]{appearance:textfield}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--ring); background:#0c1b2e; color:var(--text); cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); border-color:#0369a1}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#15803d}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border-color:#b45309}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626); border-color:#b91c1c}
    .btn.ghost{background:#0a1426}
    .btn.small{padding:6px 10px; font-size:12px}
    .flex{display:flex; gap:8px; align-items:center}
    .right{margin-left:auto}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; background:#0c1b2e; border:1px solid var(--ring); color:var(--text)}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--ring); padding:8px; text-align:left; vertical-align:middle}
    .table th{color:var(--muted); font-weight:600; font-size:12px}
    .num{text-align:right}
    .hint{font-size:12px; color:var(--muted)}
    .toast{position:fixed; bottom:16px; left:0; right:0; display:flex; justify-content:center; pointer-events:none}
    .toast > div{pointer-events:auto; background:#0b1324; border:1px solid var(--ring); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}
    details > summary{cursor:pointer; user-select:none}
    .pill{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--ring); background:#0b1730; padding:4px 8px; border-radius:999px}
    .search{display:flex; gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª <span class="chip">V24</span></h1>
      <div class="subtitle">ä»•å…¥å…ˆã®é›»è©±/æ‹…å½“è€…ãƒ»ç·¨é›†ãƒ»æœˆæ¬¡é›†è¨ˆãƒ»ä¸€æ‹¬ç™»éŒ²ï¼†ç´ã¥ã‘</div>
      <nav class="tabs" role="tablist">
        <button class="tab-btn" role="tab" data-tab="purchase" aria-selected="true">ğŸ§¾ ä»•å…¥ã‚Œå…¥åŠ›</button>
        <button class="tab-btn" role="tab" data-tab="master">ğŸ—‚ï¸ ãƒã‚¹ã‚¿ï¼ˆä»•å…¥å…ˆï¼‹å•†å“ï¼‰</button>
        <button class="tab-btn" role="tab" data-tab="list">ğŸ“š ä»•å…¥ä¸€è¦§</button>
        <button class="tab-btn" role="tab" data-tab="summary">ğŸ“Š æœˆæ¬¡é›†è¨ˆ</button>
        <button class="tab-btn" role="tab" data-tab="settings">âš™ï¸ è¨­å®š/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- ä»•å…¥ã‚Œå…¥åŠ› -->
    <section class="panel active" id="tab-purchase">
      <div class="card">
        <div class="row row-3">
          <div>
            <label>æ—¥ä»˜</label>
            <input type="date" id="p-date" />
          </div>
          <div>
            <label>ä»•å…¥å…ˆ</label>
            <select id="p-supplier"></select>
            <div class="hint" id="p-supplier-hint"></div>
          </div>
          <div>
            <label>æŒ‡å®šç¨ç‡ï¼ˆã‚«ãƒ¼ãƒ‰ã®ç¨è¾¼è¨ˆç®—ï¼‰</label>
            <div class="flex">
              <label class="pill"><input type="radio" name="p-card-tax" value="0"> 0%</label>
              <label class="pill"><input type="radio" name="p-card-tax" value="8" checked> 8%</label>
              <label class="pill"><input type="radio" name="p-card-tax" value="10"> 10%</label>
            </div>
          </div>
        </div>

        <div class="flex" style="margin:10px 0">
          <button class="btn primary" id="add-line">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          <span class="right"></span>
        </div>

        <table class="table" id="p-lines">
          <thead>
            <tr>
              <th style="width:28%">å•†å“</th>
              <th style="width:12%">æ•°é‡</th>
              <th style="width:20%">å˜ä¾¡</th>
              <th style="width:16%">ä¾¡æ ¼æ–¹å¼</th>
              <th style="width:12%">ç¨ç‡</th>
              <th style="width:12%" class="num">ç¨åˆ¥å°è¨ˆ</th>
              <th style="width:8%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="flex" style="margin-top:12px">
          <div class="hint">â€» å•†å“é¸æŠã§ç™»éŒ²å˜ä¾¡ãƒ»æ–¹å¼ãƒ»ç¨ç‡ãŒè‡ªå‹•å…¥åŠ›ã€‚ç”Ÿé®®ç­‰ã¯å˜ä¾¡æ¬„ã®Â±ãƒœã‚¿ãƒ³ã§å¾®èª¿æ•´ã€‚</div>
          <span class="right"></span>
          <button class="btn success" id="save-purchase">ğŸ§¾ ä»•å…¥ã‚Œç™»éŒ²</button>
        </div>
      </div>
    </section>

    <!-- ãƒã‚¹ã‚¿ç™»éŒ²ï¼†ç·¨é›† -->
    <section class="panel" id="tab-master">
      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ—‚ï¸ ä»•å…¥å…ˆï¼‹å•†å“ ä¸€æ‹¬ç™»éŒ²</h3>
        <div class="row row-3">
          <div>
            <label>æ—¢å­˜ã®ä»•å…¥å…ˆ</label>
            <select id="m-exist-supplier"></select>
          </div>
          <div>
            <label>æ–°è¦ä»•å…¥å…ˆåï¼ˆæ–°è¦ç™»éŒ²ã™ã‚‹å ´åˆï¼‰</label>
            <input id="m-new-supplier" type="text" placeholder="ä¾‹ï¼‰ç‰å±‹çˆç²" />
          </div>
          <div>
            <label>æ‹…å½“è€…å</label>
            <input id="m-supp-contact" type="text" placeholder="ä¾‹ï¼‰ç”°ä¸­ã•ã‚“" />
          </div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div>
            <label>é›»è©±ç•ªå·ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ç™ºä¿¡ï¼‰</label>
            <input id="m-supp-phone" type="tel" placeholder="090-1234-5678" />
          </div>
          <div>
            <label>ä»•å…¥å…ˆãƒ¡ãƒ¢</label>
            <input id="m-supp-memo" type="text" placeholder="ä»»æ„" />
          </div>
          <div>
            <label>ã“ã®ä»•å…¥å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ï¼ˆä»»æ„ï¼‰</label>
            <select id="m-supp-tax">
              <option value="">æœªè¨­å®š</option>
              <option value="0">0%</option>
              <option value="8" selected>8%</option>
              <option value="10">10%</option>
            </select>
          </div>
        </div>

        <div class="spacer"></div>
        <table class="table" id="m-products">
          <thead>
            <tr>
              <th style="width:28%">å•†å“å</th>
              <th style="width:14%">å˜ä¾¡</th>
              <th style="width:18%">ä¾¡æ ¼æ–¹å¼</th>
              <th style="width:12%">ç¨ç‡</th>
              <th style="width:20%">ãƒ¡ãƒ¢</th>
              <th style="width:8%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="flex" style="margin-top:10px">
          <button class="btn" id="m-add-product">ï¼‹ å•†å“è¡Œè¿½åŠ </button>
          <span class="right"></span>
          <button class="btn success" id="m-save">ğŸ’¾ ä¿å­˜</button>
        </div>
        <div class="hint" style="margin-top:8px">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå•†å“ã¯ã€Œç¨åˆ¥ãƒ»8%ã€ã€‚ä¿å­˜ã§ä»•å…¥å…ˆã¨è¤‡æ•°å•†å“ã‚’åŒæ™‚ç™»éŒ²ã—ã€å„å•†å“ã‚’ã“ã®ä»•å…¥å…ˆã«ç´ã¥ã‘ã¾ã™ã€‚</div>
      </div>

      <div class="card">
        <details open>
          <summary><b>âœï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†</b>ï¼ˆä»•å…¥å…ˆãƒ»å•†å“ï¼‰</summary>
          <div class="spacer"></div>
          <h4 style="margin:6px 0">ä»•å…¥å…ˆã®ç·¨é›†</h4>
          <table class="table" id="suppliers-table"></table>
          <div class="spacer"></div>
          <h4 style="margin:6px 0">å•†å“ã®ç·¨é›†</h4>
          <div class="search">
            <div class="row" style="flex:1">
              <div>
                <label>ä»•å…¥å…ˆã§çµã‚Šè¾¼ã¿</label>
                <select id="prod-filter-supplier"></select>
              </div>
              <div>
                <label>å•†å“åã§æ¤œç´¢</label>
                <input id="prod-filter-q" type="text" placeholder="ä¾‹ï¼‰ãƒã‚¿ãƒ¼" />
              </div>
            </div>
            <button class="btn" id="prod-refresh">å†è¡¨ç¤º</button>
          </div>
          <table class="table" id="products-table"></table>
        </details>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ”— æ—¢å­˜å•†å“ã®ç´ã¥ã‘</h3>
        <div class="row">
          <div>
            <label>ä»•å…¥å…ˆ</label>
            <select id="link-supplier"></select>
          </div>
          <div>
            <label>å•†å“ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <select id="link-products" multiple size="6" style="min-height:120px"></select>
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="btn primary" id="link-do">ç´ã¥ã‘ã™ã‚‹</button>
        </div>
      </div>
    </section>

    <!-- ä»•å…¥ä¸€è¦§ -->
    <section class="panel" id="tab-list">
      <div id="list-container"></div>
    </section>

    <!-- æœˆæ¬¡é›†è¨ˆ -->
    <section class="panel" id="tab-summary">
      <div class="card">
        <div class="row">
          <div>
            <label>å¯¾è±¡æœˆ</label>
            <input type="month" id="sum-month" />
          </div>
          <div class="flex" style="align-items:flex-end">
            <button class="btn" id="sum-refresh">å†è¨ˆç®—</button>
            <span class="right"></span>
            <button class="btn" id="sum-export">CSVæ›¸ãå‡ºã—</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h4 style="margin:6px 0">ä»•å…¥å…ˆåˆ¥ é›†è¨ˆ</h4>
        <table class="table" id="sum-by-supplier"></table>
        <div class="spacer"></div>
        <div class="flex" style="justify-content:flex-end">
          <div class="chip" id="sum-overall"></div>
        </div>
      </div>
    </section>

    <!-- è¨­å®š/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
    <section class="panel" id="tab-settings">
      <div class="card">
        <h3 style="margin:0 0 8px 0">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ</h3>
        <div class="flex">
          <button class="btn" id="export-json">JSONã‚’æ›¸ãå‡ºã—</button>
          <input type="file" id="import-file" accept="application/json" />
          <button class="btn warn" id="import-json">JSONã‹ã‚‰å¾©å…ƒ</button>
          <span class="right"></span>
          <button class="btn danger" id="wipe-all">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
        <div class="hint" style="margin-top:8px">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã€‚ã‚¹ã‚­ãƒ¼ãƒ <span class="chip">24.0</span>ã€‚V21.1/V22/V23ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒã«å¯¾å¿œã—ã¾ã™ï¼ˆPart 3ã®JSã§å®Ÿè£…ï¼‰ã€‚</div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" style="display:none"><div></div></div>

  <!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ Part 2/3ï¼šåŒä¸€HTMLã® Part 1 ç›´å¾Œã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼ -->
<script>
// ==========================
// V24 Part 2/3 - ãƒ™ãƒ¼ã‚¹JS
//  - ã‚¿ãƒ–åˆ‡æ›¿
//  - å½“æ—¥æ—¥ä»˜ã®åˆæœŸåŒ–
//  - Part 3ãŒæœªé©ç”¨ã§ã‚‚UIãŒç´ ç›´ã«å‹•ããŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
//  â€» ãƒ‡ãƒ¼ã‚¿ä¿å­˜/é›†è¨ˆ/å¾©å…ƒãªã©ã®æœ¬ä½“ã¯ Part 3 ã§å®Ÿè£…ã•ã‚Œã¾ã™ã€‚
// ==========================
(function(){
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  // è»½é‡ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆPart 3ã«ã‚‚åŒåé–¢æ•°ãŒã‚ã‚Šã¾ã™ãŒå®‰å…¨ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰
  function showToast(msg){
    const t = document.getElementById('toast');
    if(!t) return alert(msg);
    t.style.display = 'flex';
    t.firstElementChild.textContent = msg;
    setTimeout(()=>{ t.style.display = 'none'; }, 1400);
  }

  function initTabs(){
    $$('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('.tab-btn').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const key = btn.dataset.tab;
        $$('.panel').forEach(p=>p.classList.remove('active'));
        const target = document.getElementById('tab-'+key);
        if(target) target.classList.add('active');
      });
    });
  }

  function initDefaults(){
    const date = document.getElementById('p-date');
    if(date && !date.value){ date.value = new Date().toISOString().slice(0,10); }
  }

  // Part 3 ãŒå…¥ã‚‹å‰ã®ä»®é…ç·šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã«æ¡ˆå†…ã‚’å‡ºã™ï¼‰
  function wirePlaceholders(){
    const needP3 = () => showToast('ã“ã®æ“ä½œã¯ Part 3 ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™');

    const addLine = document.getElementById('add-line');
    if(addLine) addLine.addEventListener('click', needP3);

    const saveBtn = document.getElementById('save-purchase');
    if(saveBtn) saveBtn.addEventListener('click', needP3);

    const prodRefresh = document.getElementById('prod-refresh');
    if(prodRefresh) prodRefresh.addEventListener('click', needP3);

    const linkDo = document.getElementById('link-do');
    if(linkDo) linkDo.addEventListener('click', needP3);

    const sumRefresh = document.getElementById('sum-refresh');
    if(sumRefresh) sumRefresh.addEventListener('click', needP3);

    const sumExport = document.getElementById('sum-export');
    if(sumExport) sumExport.addEventListener('click', needP3);

    const exportJson = document.getElementById('export-json');
    if(exportJson) exportJson.addEventListener('click', needP3);

    const importJson = document.getElementById('import-json');
    if(importJson) importJson.addEventListener('click', needP3);

    const wipeAll = document.getElementById('wipe-all');
    if(wipeAll) wipeAll.addEventListener('click', needP3);
  }

  document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    initDefaults();
    wirePlaceholders();
  });
})();
</script>
<!-- â–²â–²â–² ã“ã“ã¾ã§ Part 2/3 â–²â–²â–² -->

  <!-- === V24 PART 3/3 ã‚’ã“ã®ç›´å¾Œã«è²¼ã‚Šä»˜ã‘ï¼ˆJSæœ¬ä½“ï¼‰ === -->
  <!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ Part 3/3ï¼šPart 2 ã®ç›´å¾Œã€</body> ã®ç›´å‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼ -->
<script>
// ==========================
// ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª V24 - JSæœ¬ä½“
//  - ãƒ‡ãƒ¼ã‚¿ç®¡ç†(localStorage)
//  - V21.1 / V22 / V23 â†’ V24 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
//  - ä»•å…¥ã‚Œå…¥åŠ›ï¼ˆåŒæ—¥Ã—åŒä»•å…¥å…ˆã§ã‚«ãƒ¼ãƒ‰è‡ªå‹•ã¾ã¨ã‚ï¼‰
//  - ãƒã‚¹ã‚¿ç·¨é›†ï¼ˆä»•å…¥å…ˆ/å•†å“ï¼‰
//  - ä¸€è¦§è¡¨ç¤ºãƒ»å‰Šé™¤
//  - æœˆæ¬¡é›†è¨ˆãƒ»CSVå‡ºåŠ›
//  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒï¼ˆV21.1å¯¾å¿œï¼‰
// ==========================
(function(){
  // ===== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const APP_KEY = 'tabco-purchase-v24';
  const SCHEMA_VERSION = '24.0';
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);}));
  const today = () => new Date().toISOString().slice(0,10);
  const ymNow = () => new Date().toISOString().slice(0,7);
  const toNum = (v) => Number(String(v ?? '').replace(/[,\s]/g,'')) || 0;
  const yen  = (n) => Math.round(n).toLocaleString('ja-JP');
  const telSanitize = (s) => (s||'').replace(/[^0-9+]/g,'');
  function showToast(msg){ const t=$('#toast'); if(!t) return alert(msg); t.style.display='flex'; t.firstElementChild.textContent=msg; setTimeout(()=>{ t.style.display='none'; }, 1600); }
  const byNameJa = (a,b) => (a.name||'').localeCompare((b.name||''),'ja');

  // ===== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª­ã¿æ›¸ã =====
  function save(db){ localStorage.setItem(APP_KEY, JSON.stringify(db)); }
  function load(){
    // ã¾ãšV24
    const raw = localStorage.getItem(APP_KEY);
    if(raw){ try{ const db=JSON.parse(raw); patchToV24(db); return db; }catch(_){} }
    // æ—§ã‚­ãƒ¼ã‹ã‚‰ã®å¼•ãç¶™ãï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
    for(const key of ['tabco-purchase-v23','tabco-purchase-v22','tabco-purchase-v21','tabco-purchase-v21_1']){
      const r = localStorage.getItem(key); if(!r) continue; try{ const old=JSON.parse(r); const db = migrateFromAny(old); save(db); return db; }catch(_){ /* ignore */ }
    }
    // åˆæœŸãƒ‡ãƒ¼ã‚¿
    const seed = { version: SCHEMA_VERSION, suppliers: [], products: [], purchases: [] };
    save(seed); return seed;
  }

  // ===== ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ / ãƒ‘ãƒƒãƒ =====
  function patchSupplier(s){ s.contact ??=''; s.phone ??=''; s.memo ??=''; if(s.defaultTaxRate===undefined) s.defaultTaxRate = null; return s; }
  function patchToV24(db){ db.version = SCHEMA_VERSION; db.suppliers = (db.suppliers||[]).map(patchSupplier); db.products ||= []; db.purchases ||= []; return db; }

  function migrateFromAny(data){
    try{
      // æ˜ç¤ºãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¤å®š
      const v = (data && data.version) ? String(data.version) : '';
      if(v.startsWith('24')){ return patchToV24(structuredClone(data)); }
      if(v.startsWith('23')){ const d = structuredClone(data); // è¶³ã‚Šãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è£œå®Œ
        d.suppliers = (d.suppliers||[]).map(patchSupplier); d.version = SCHEMA_VERSION; return d; }
      if(v.startsWith('22')){ const d = structuredClone(data); d.suppliers = (d.suppliers||[]).map(patchSupplier); d.version = SCHEMA_VERSION; return d; }
      if(v.startsWith('21.1')){ return migrateFromV211(data); }
      // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç„¡ã—ã¯ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
      return heuristicMigrateV211Like(data);
    }catch(e){ console.error('migrateFromAny error', e); return { version: SCHEMA_VERSION, suppliers: [], products: [], purchases: [] }; }
  }

  // V21.1æƒ³å®šã®æŸ”è»Ÿãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONç”¨ï¼‰
  function migrateFromV211(src){ return heuristicMigrateV211Like(src); }

  function safeArr(x){ return Array.isArray(x) ? x : []; }
  function normalizePriceMode(x){ if(x==='incl' || x===true || x==='ç¨è¾¼') return 'incl'; return 'excl'; }
  function heuristicMigrateV211Like(src){
    // å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®å€™è£œã‚’è§£é‡ˆã—ã¤ã¤ã€æ–°DBã‚’ç”Ÿæˆ
    const now = Date.now();
    const supKey = src.suppliers ? 'suppliers' : (src.vendors ? 'vendors' : null);
    const prodKey = src.products ? 'products' : (src.items ? 'items' : null);
    const purKeyCandidates = ['purchases','cards','purchaseList','entries','lines'];
    const purKey = purKeyCandidates.find(k => Array.isArray(src[k]));

    const suppliers = [];
    const products  = [];
    const purchases = [];

    const nameToSuppId = new Map();

    // ------- ä»•å…¥å…ˆ -------
    for(const s of safeArr(supKey? src[supKey] : [])){
      const name = String(s.name ?? s.title ?? '').trim(); if(!name) continue;
      const obj = patchSupplier({ id: uuid(), name, contact: s.contact||'', phone: s.phone||'', memo: s.memo||'', defaultTaxRate: s.defaultTaxRate ?? null, createdAt: now });
      suppliers.push(obj); nameToSuppId.set(name, obj.id);
    }

    // ------- å•†å“ -------
    // v21.1 ã§ã¯ supplierName ãªã©ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„
    for(const p of safeArr(prodKey? src[prodKey] : [])){
      const name = String(p.name ?? p.productName ?? p.title ?? '').trim(); if(!name) continue;
      const basePrice = toNum(p.basePrice ?? p.price ?? p.unitPrice ?? 0);
      const priceMode = normalizePriceMode(p.priceMode ?? p.taxIncluded ?? false);
      const taxRate   = Number(p.taxRate ?? p.tax ?? 8);
      let supplierId = null;
      const sname = p.supplierName ?? p.vendorName ?? '';
      if(sname && nameToSuppId.has(sname)) supplierId = nameToSuppId.get(sname);
      const note = p.note || p.memo || '';
      products.push({ id: uuid(), name, basePrice, priceMode, taxRate, supplierId, note, createdAt: now });
    }

    // ------- è³¼å…¥ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ¼ãƒ‰åŒ– -------
    // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¯èƒ½ãªå½¢ï¼š
    // - { date, supplierName, items:[{name/ productName, qty, unitPrice/price, priceMode/taxIncluded, taxRate}] }
    // - è¡Œå‹ï¼š{ date, supplierName, productName, qty, unitPrice, priceMode, taxRate }
    const byKey = new Map(); // key = date|supplierId => card

    for(const ent of safeArr(purKey? src[purKey] : [])){
      if(ent.items && Array.isArray(ent.items)){
        // ã‚«ãƒ¼ãƒ‰â†’ã‚«ãƒ¼ãƒ‰
        const d = (ent.date || ent.day || ent.at || today()).slice(0,10);
        const sname = ent.supplierName ?? ent.vendorName ?? ent.supplier ?? '';
        let sid = nameToSuppId.get(sname);
        if(!sid && sname){ // æœªç™»éŒ²ä»•å…¥å…ˆã¯è¿½åŠ 
          const s = patchSupplier({ id: uuid(), name: sname, contact:'', phone:'', memo:'', defaultTaxRate:null, createdAt: now });
          suppliers.push(s); nameToSuppId.set(sname, s.id); sid = s.id;
        }
        if(!sid) continue;
        const key = `${d}|${sid}`;
        let card = byKey.get(key);
        if(!card){ card = { id: uuid(), date: d, supplierId: sid, cardTaxRate: Number(ent.cardTaxRate ?? ent.taxRate ?? 8), items: [], createdAt: now }; byKey.set(key, card); }
        for(const it of safeArr(ent.items)){
          const name = String(it.name ?? it.productName ?? '').trim() || 'æœªç™»éŒ²å•†å“';
          const qty = toNum(it.qty ?? it.quantity ?? 1);
          const unitPrice = toNum(it.unitPrice ?? it.price ?? 0);
          const priceMode = normalizePriceMode(it.priceMode ?? it.taxIncluded ?? false);
          const taxRate   = Number(it.taxRate ?? ent.taxRate ?? 8);
          // æ—¢å­˜å•†å“ã«åå‰ä¸€è‡´ãŒã‚ã‚Œã°ç´ã¥ã‘
          const prod = products.find(p=>p.name===name && (!p.supplierId || p.supplierId===sid));
          const productId = prod ? prod.id : null;
          card.items.push({ id: uuid(), productId, name, qty, unitPrice, priceMode, taxRate });
        }
      }else{
        // è¡Œâ†’ã‚«ãƒ¼ãƒ‰
        const d = (ent.date || ent.day || ent.at || today()).slice(0,10);
        const sname = ent.supplierName ?? ent.vendorName ?? ent.supplier ?? '';
        let sid = nameToSuppId.get(sname);
        if(!sid && sname){ const s = patchSupplier({ id: uuid(), name: sname, contact:'', phone:'', memo:'', defaultTaxRate:null, createdAt: now }); suppliers.push(s); nameToSuppId.set(sname, s.id); sid = s.id; }
        if(!sid) continue;
        const key = `${d}|${sid}`;
        let card = byKey.get(key);
        if(!card){ card = { id: uuid(), date: d, supplierId: sid, cardTaxRate: Number(ent.cardTaxRate ?? ent.taxRate ?? 8), items: [], createdAt: now }; byKey.set(key, card); }
        const name = String(ent.name ?? ent.productName ?? '').trim() || 'æœªç™»éŒ²å•†å“';
        const qty = toNum(ent.qty ?? ent.quantity ?? 1);
        const unitPrice = toNum(ent.unitPrice ?? ent.price ?? 0);
        const priceMode = normalizePriceMode(ent.priceMode ?? ent.taxIncluded ?? false);
        const taxRate   = Number(ent.taxRate ?? 8);
        const prod = products.find(p=>p.name===name && (!p.supplierId || p.supplierId===sid));
        const productId = prod ? prod.id : null;
        card.items.push({ id: uuid(), productId, name, qty, unitPrice, priceMode, taxRate });
      }
    }

    for(const [,card] of byKey){ purchases.push(card); }

    // ä»•å…¥å…ˆãƒ»å•†å“ã®é‡è¤‡åã‚’è»½ãæ­£è¦åŒ–ï¼ˆåŒåã®å®Œå…¨é‡è¤‡ã ã‘æ’é™¤ï¼‰
    const uniqBy = (arr, key) => { const m=new Map(); for(const x of arr){ const k=x[key]; if(!m.has(k)) m.set(k,x); } return Array.from(m.values()); };
    const suppliersUniq = uniqBy(suppliers, 'name').sort(byNameJa);

    // productsã¯ (name + supplierId + priceMode + taxRate + basePrice) ã‚’ã‚­ãƒ¼ã«ã—ã¦è»½ããƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
    const pMap = new Map();
    for(const p of products){ const k=[p.name,p.supplierId||'',p.priceMode,p.taxRate,Math.round(p.basePrice)].join('|'); if(!pMap.has(k)) pMap.set(k,p); }
    const productsUniq = Array.from(pMap.values()).sort(byNameJa);

    return { version: SCHEMA_VERSION, suppliers: suppliersUniq, products: productsUniq, purchases };
  }

  // ===== DBï¼ˆãƒ¡ãƒ¢ãƒªï¼‰ =====
  let DB = load();

  // ===== ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ =====
  const dal = {
    suppliers(){ return DB.suppliers; },
    products(){ return DB.products; },
    purchases(){ return DB.purchases; },

    addSupplier({name,contact,phone,memo,defaultTaxRate}){
      const s={ id:uuid(), name:name.trim(), contact:(contact||'').trim(), phone:(phone||'').trim(), memo:memo||'', defaultTaxRate: defaultTaxRate===''?null:Number(defaultTaxRate), createdAt:Date.now() };
      DB.suppliers.push(s); save(DB); return s;
    },
    upsertSupplierByName({name,contact,phone,memo,defaultTaxRate}){
      const e = DB.suppliers.find(x=>x.name.trim()===name.trim());
      if(e){ if(contact!==undefined) e.contact=contact; if(phone!==undefined) e.phone=phone; if(memo!==undefined) e.memo=memo; if(defaultTaxRate!==undefined) e.defaultTaxRate=(defaultTaxRate===''?null:Number(defaultTaxRate)); save(DB); return e; }
      return this.addSupplier({name,contact,phone,memo,defaultTaxRate});
    },
    updateSupplier(id,patch){ const s=DB.suppliers.find(x=>x.id===id); if(!s) return null; Object.assign(s,patch); save(DB); return s; },

    addProduct({name, basePrice, priceMode, taxRate, supplierId, note}){
      const p={ id:uuid(), name:name.trim(), basePrice:toNum(basePrice), priceMode, taxRate:Number(taxRate), supplierId:supplierId||null, note:note||'', createdAt:Date.now() };
      DB.products.push(p); save(DB); return p;
    },
    updateProduct(id,patch){ const p=DB.products.find(x=>x.id===id); if(!p) return null; Object.assign(p,patch); save(DB); return p; },
    linkProductsToSupplier(prodIds,supplierId){ DB.products.forEach(p=>{ if(prodIds.includes(p.id)) p.supplierId=supplierId; }); save(DB); },

    addPurchaseLines({date, supplierId, cardTaxRate, lines}){
      let card = DB.purchases.find(x=>x.date===date && x.supplierId===supplierId);
      if(!card){ card={ id:uuid(), date, supplierId, cardTaxRate:Number(cardTaxRate), items:[], createdAt:Date.now() }; DB.purchases.push(card); }
      else{ card.cardTaxRate=Number(cardTaxRate); }
      for(const ln of lines){ const item={ id:uuid(), productId:ln.productId||null, name:ln.name, qty:Number(ln.qty||1), unitPrice:toNum(ln.unitPrice||0), priceMode:ln.priceMode, taxRate:Number(ln.taxRate) }; card.items.push(item); }
      save(DB); return card;
    },
    deletePurchase(cardId){ DB.purchases = DB.purchases.filter(x=>x.id!==cardId); save(DB); },
    deleteLine(cardId,lineId){ const c=DB.purchases.find(x=>x.id===cardId); if(!c) return; c.items = c.items.filter(i=>i.id!==lineId); save(DB); }
  };

  // ===== UIè£œåŠ© =====
  function renderSupplierOptions(){
    const sels = ['#p-supplier','#m-exist-supplier','#link-supplier','#prod-filter-supplier'];
    for(const sel of sels){ const el=$(sel); if(!el) continue; el.innerHTML=''; const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='â€” é¸æŠ â€”'; el.appendChild(opt0); DB.suppliers.slice().sort(byNameJa).forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.appendChild(o); }); }
  }
  function productOptionLabel(p){ return `${p.name} / ${p.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'} ${yen(p.basePrice)} / ç¨ç‡${p.taxRate}%`; }
  function renderPurchaseProductOptions(){
    const sid = $('#p-supplier').value; const hint = $('#p-supplier-hint');
    const supp = DB.suppliers.find(s=>s.id===sid);
    hint.textContent = supp ? `æ‹…å½“: ${supp.contact||'-'} / TEL: ${supp.phone||'-'}` : '';
    $$('#p-lines select[data-role="product"]').forEach(sel=>{
      const products = DB.products.filter(p=> sid? (p.supplierId===sid) : true).sort(byNameJa);
      sel.innerHTML=''; const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='â€” å•†å“ â€”'; sel.appendChild(opt0);
      products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=productOptionLabel(p); sel.appendChild(o); });
    });
  }
  function renderLinkProductsOptions(){ const all=DB.products.slice().sort(byNameJa); const el=$('#link-products'); if(!el) return; el.innerHTML=''; all.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=productOptionLabel(p); el.appendChild(o); }); }

  // ===== ä»•å…¥ã‚Œå…¥åŠ› =====
  function addPurchaseRow(prefill){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><select data-role="product"></select></td>
      <td><input type="number" min="0" step="1" value="${prefill?.qty??1}" data-role="qty" /></td>
      <td>
        <div class="flex">
          <input type="number" min="0" step="1" value="${prefill?.unitPrice??''}" data-role="price" />
          <div class="flex">
            <button class="btn small ghost" data-bump="-10">-10</button>
            <button class="btn small ghost" data-bump="-1">-1</button>
            <button class="btn small ghost" data-bump="1">+1</button>
            <button class="btn small ghost" data-bump="10">+10</button>
          </div>
        </div>
      </td>
      <td>
        <select data-role="mode"><option value="excl">ç¨åˆ¥</option><option value="incl">ç¨è¾¼</option></select>
      </td>
      <td>
        <select data-role="rate"><option value="0">0%</option><option value="8" selected>8%</option><option value="10">10%</option></select>
      </td>
      <td class="num" data-role="ex">0</td>
      <td class="num"><button class="btn small danger" data-role="del">å‰Šé™¤</button></td>`;
    $('#p-lines tbody').appendChild(tr);
    renderPurchaseProductOptions();

    const sel = tr.querySelector('select[data-role="product"]');
    sel.addEventListener('change', ()=>{
      const id = sel.value; if(!id) return; const p = DB.products.find(x=>x.id===id); if(!p) return;
      tr.querySelector('input[data-role="price"]').value = p.basePrice;
      tr.querySelector('select[data-role="mode"]').value = p.priceMode;
      tr.querySelector('select[data-role="rate"]').value = String(p.taxRate);
      updateRowEx(tr);
    });
    tr.querySelectorAll('input,select').forEach(el=>{ el.addEventListener('input', ()=>updateRowEx(tr)); el.addEventListener('change', ()=>updateRowEx(tr)); });
    tr.querySelectorAll('button[data-bump]').forEach(btn=>{ btn.addEventListener('click',()=>{ const delta=Number(btn.dataset.bump); const inp=tr.querySelector('input[data-role="price"]'); inp.value=toNum(inp.value)+delta; updateRowEx(tr); }); });
    tr.querySelector('button[data-role="del"]').addEventListener('click',()=> tr.remove());
    if(prefill){ if(prefill.productId){ sel.value=prefill.productId; } if(prefill.mode){ tr.querySelector('select[data-role="mode"]').value=prefill.mode; } if(prefill.rate!==undefined){ tr.querySelector('select[data-role="rate"]').value=String(prefill.rate); } updateRowEx(tr); }
  }
  function updateRowEx(tr){ const qty=toNum(tr.querySelector('input[data-role="qty"]').value||1); const price=toNum(tr.querySelector('input[data-role="price"]').value||0); const mode=tr.querySelector('select[data-role="mode"]').value; const rate=Number(tr.querySelector('select[data-role="rate"]').value||8); const unitEx = mode==='excl' ? price : Math.round(price / (1 + rate/100)); const ex = unitEx * qty; tr.querySelector('[data-role="ex"]').textContent = yen(ex); return ex; }
  function collectLines(){ const rows=Array.from($('#p-lines tbody').children); const lines=[]; for(const tr of rows){ const productId = tr.querySelector('select[data-role="product"]').value || null; const qty=toNum(tr.querySelector('input[data-role="qty"]').value||1); const unitPrice=toNum(tr.querySelector('input[data-role="price"]').value||0); const priceMode=tr.querySelector('select[data-role="mode"]').value; const taxRate=Number(tr.querySelector('select[data-role="rate"]').value||8); let name='æœªç™»éŒ²å•†å“'; if(productId){ const p=DB.products.find(x=>x.id===productId); if(p) name=p.name; } if(qty<=0) continue; lines.push({productId, name, qty, unitPrice, priceMode, taxRate}); } return lines; }
  function initPurchase(){ $('#p-date').value = $('#p-date').value || today(); renderSupplierOptions(); renderPurchaseProductOptions(); $('#p-supplier').addEventListener('change', renderPurchaseProductOptions); $('#add-line').addEventListener('click', ()=> addPurchaseRow()); if(!$('#p-lines tbody').children.length) addPurchaseRow(); $('#save-purchase').addEventListener('click', ()=>{ const date=$('#p-date').value||today(); const supplierId=$('#p-supplier').value; if(!supplierId){ showToast('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const cardTaxRate = Number(document.querySelector('input[name="p-card-tax"]:checked')?.value||8); const lines = collectLines(); if(!lines.length){ showToast('è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; } dal.addPurchaseLines({date, supplierId, cardTaxRate, lines}); $('#p-lines tbody').innerHTML=''; addPurchaseRow(); showToast('ä»•å…¥ã‚Œã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆåŒæ—¥Ã—åŒä»•å…¥å…ˆã§è‡ªå‹•ã¾ã¨ã‚ï¼‰'); }); }

  // ===== ãƒã‚¹ã‚¿ï¼ˆç™»éŒ²/ç·¨é›†ï¼‰ =====
  function addMasterRow(prefill){ const tr=document.createElement('tr'); tr.innerHTML = `
      <td><input type="text" data-role="name" placeholder="å•†å“å" value="${prefill?.name||''}" /></td>
      <td><input type="number" min="0" step="1" data-role="price" placeholder="0" value="${prefill?.price||''}" /></td>
      <td><select data-role="mode"><option value="excl" ${!prefill||prefill.mode==='excl'?'selected':''}>ç¨åˆ¥</option><option value="incl" ${prefill?.mode==='incl'?'selected':''}>ç¨è¾¼</option></select></td>
      <td><select data-role="rate"><option value="0">0%</option><option value="8" selected>8%</option><option value="10">10%</option></select></td>
      <td><input type="text" data-role="note" placeholder="ä»»æ„" value="${prefill?.note||''}" /></td>
      <td class="num"><button class="btn small danger" data-role="del">å‰Šé™¤</button></td>`; $('#m-products tbody').appendChild(tr); tr.querySelector('[data-role="del"]').addEventListener('click',()=>tr.remove()); }
  function renderMasterCombos(){ renderSupplierOptions(); renderLinkProductsOptions(); if(!$('#m-products tbody').children.length) addMasterRow(); }
  function initMaster(){
    $('#m-add-product').addEventListener('click',()=> addMasterRow());
    $('#m-save').addEventListener('click',()=>{
      let supplierId = $('#m-exist-supplier').value || null;
      const newName = $('#m-new-supplier').value.trim();
      const contact = $('#m-supp-contact').value.trim();
      const phone = $('#m-supp-phone').value.trim();
      const memo = $('#m-supp-memo').value.trim();
      const defTax = $('#m-supp-tax').value;
      if(!supplierId && !newName){ showToast('æ—¢å­˜ã®ä»•å…¥å…ˆã‚’é¸ã¶ã‹ã€æ–°è¦åã‚’å…¥åŠ›'); return; }
      if(!supplierId && newName){ const s = dal.upsertSupplierByName({name:newName, contact, phone, memo, defaultTaxRate:defTax}); supplierId=s.id; }
      if(supplierId && (contact||phone||memo||defTax!=='')) dal.updateSupplier(supplierId, { contact, phone, memo, defaultTaxRate: defTax===''?null:Number(defTax) });
      const rows = Array.from($('#m-products tbody').children); if(!rows.length){ showToast('å•†å“è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      let count=0; for(const tr of rows){ const name = tr.querySelector('[data-role="name"]').value.trim(); const price = toNum(tr.querySelector('[data-role="price"]').value); const mode = tr.querySelector('[data-role="mode"]').value; const rate = Number(tr.querySelector('[data-role="rate"]').value||8); const note = tr.querySelector('[data-role="note"]').value.trim(); if(!name) continue; dal.addProduct({name, basePrice:price, priceMode:mode, taxRate:rate, supplierId, note}); count++; }
      if(count===0){ showToast('æœ‰åŠ¹ãªå•†å“ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      $('#m-products tbody').innerHTML=''; addMasterRow(); $('#m-new-supplier').value=''; $('#m-supp-memo').value=''; $('#m-supp-contact').value=''; $('#m-supp-phone').value=''; renderSupplierOptions(); renderLinkProductsOptions(); showToast(`${count}ä»¶ã®å•†å“ã‚’ç™»éŒ²ãƒ»ç´ã¥ã‘ã—ã¾ã—ãŸ`);
    });

    $('#link-do').addEventListener('click',()=>{ const sid=$('#link-supplier').value; if(!sid){ showToast('ä»•å…¥å…ˆã‚’é¸æŠ'); return; } const prodIds = Array.from($('#link-products').selectedOptions).map(o=>o.value); if(!prodIds.length){ showToast('å•†å“ã‚’é¸æŠ'); return; } dal.linkProductsToSupplier(prodIds, sid); showToast(`${prodIds.length}ä»¶ã‚’ç´ã¥ã‘ã¾ã—ãŸ`); });
  }

  // ===== ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šä»•å…¥å…ˆ =====
  function supplierRowView(s){ const phoneHref = telSanitize(s.phone); return `<tr data-id="${s.id}">\
      <td>${s.name}<div class=\"hint\">${s.memo? s.memo:''}</div></td>\
      <td>${s.contact||''}</td>\
      <td>${s.phone? `<a class=\\"btn small\\" href=\\"tel:${phoneHref}\\">ğŸ“ ç™ºä¿¡</a>`:''}</td>\
      <td class=\"num\">${s.defaultTaxRate==null?'-':s.defaultTaxRate+'%'}</td>\
      <td class=\"num\"><button class=\"btn small\" data-edit-supp>ç·¨é›†</button></td>`; }
  function supplierRowEdit(s){ return `<tr data-id="${s.id}">\
      <td><input type=\"text\" data-role=\"name\" value=\"${s.name}\" /><div class=\"hint\">ãƒ¡ãƒ¢:<input type=\"text\" data-role=\"memo\" value=\"${s.memo||''}\"></div></td>\
      <td><input type=\"text\" data-role=\"contact\" value=\"${s.contact||''}\" /></td>\
      <td><input type=\"tel\" data-role=\"phone\" value=\"${s.phone||''}\" /></td>\
      <td><select data-role=\"tax\"><option value=\"\">æœªè¨­å®š</option><option value=\"0\" ${s.defaultTaxRate===0?'selected':''}>0%</option><option value=\"8\" ${s.defaultTaxRate===8?'selected':''}>8%</option><option value=\"10\" ${s.defaultTaxRate===10?'selected':''}>10%</option></select></td>\
      <td class=\"num\">\
        <button class=\"btn small success\" data-save-supp>ä¿å­˜</button>\
        <button class=\"btn small ghost\" data-cancel-supp>å–æ¶ˆ</button>\
      </td>`; }
  function renderSuppliersTable(){ const el=$('#suppliers-table'); if(!el) return; const rows = DB.suppliers.slice().sort(byNameJa).map(s=>supplierRowView(s)).join(''); el.innerHTML = `<thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±</th><th class=\"num\">æ—¢å®šç¨ç‡</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="5">æœªç™»éŒ²</td></tr>'}</tbody>`; el.querySelectorAll('[data-edit-supp]').forEach(btn=>{ btn.addEventListener('click',()=>{ const tr=btn.closest('tr'); const id=tr.dataset.id; const s=DB.suppliers.find(x=>x.id===id); tr.outerHTML = supplierRowEdit(s); const row = $('#suppliers-table').querySelector(`tr[data-id="${id}"]`); row.querySelector('[data-save-supp]').addEventListener('click',()=>{ const patch = { name: row.querySelector('[data-role="name"]').value.trim(), memo: row.querySelector('[data-role="memo"]').value.trim(), contact: row.querySelector('[data-role="contact"]').value.trim(), phone: row.querySelector('[data-role="phone"]').value.trim(), defaultTaxRate: (row.querySelector('[data-role="tax"]').value==='')?null:Number(row.querySelector('[data-role="tax"]').value) }; dal.updateSupplier(id, patch); renderSuppliersTable(); showToast('ä»•å…¥å…ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }); row.querySelector('[data-cancel-supp]').addEventListener('click', renderSuppliersTable); }); }); }

  // ===== ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå•†å“ =====
  function productRowView(p){ const s = p.supplierId? DB.suppliers.find(x=>x.id===p.supplierId):null; const sname = s? s.name:'(æœªç´ã¥ã‘)'; return `<tr data-id="${p.id}">\
      <td>${p.name}<div class=\"hint\">${p.note||''}</div></td>\
      <td class=\"num\">Â¥${yen(p.basePrice)}</td>\
      <td>${p.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'}</td>\
      <td class=\"num\">${p.taxRate}%</td>\
      <td>${sname}</td>\
      <td class=\"num\"><button class=\"btn small\" data-edit-prod>ç·¨é›†</button></td>`; }
  function productRowEdit(p){ const supplierOpts = ['<option value="">(æœªç´ã¥ã‘)</option>'].concat(DB.suppliers.slice().sort(byNameJa).map(s=>`<option value="${s.id}" ${p.supplierId===s.id?'selected':''}>${s.name}</option>`)).join(''); return `<tr data-id="${p.id}">\
      <td><input type=\"text\" data-role=\"name\" value=\"${p.name}\" /><div class=\"hint\">ãƒ¡ãƒ¢:<input type=\"text\" data-role=\"note\" value=\"${p.note||''}\"></div></td>\
      <td><input type=\"number\" min=\"0\" step=\"1\" data-role=\"price\" value=\"${p.basePrice}\" /></td>\
      <td><select data-role=\"mode\"><option value=\"excl\" ${p.priceMode==='excl'?'selected':''}>ç¨åˆ¥</option><option value=\"incl\" ${p.priceMode==='incl'?'selected':''}>ç¨è¾¼</option></select></td>\
      <td><select data-role=\"rate\"><option value=\"0\" ${p.taxRate===0?'selected':''}>0%</option><option value=\"8\" ${p.taxRate===8?'selected':''}>8%</option><option value=\"10\" ${p.taxRate===10?'selected':''}>10%</option></select></td>\
      <td><select data-role=\"supplier\">${supplierOpts}</select></td>\
      <td class=\"num\">\
        <button class=\"btn small success\" data-save-prod>ä¿å­˜</button>\
        <button class=\"btn small ghost\" data-cancel-prod>å–æ¶ˆ</button>\
      </td>`; }
  function renderProductsTable(){ const el=$('#products-table'); if(!el) return; const sid=$('#prod-filter-supplier').value; const q=($('#prod-filter-q').value||'').trim(); let items=DB.products.slice(); if(sid) items=items.filter(p=>p.supplierId===sid); if(q) items=items.filter(p=> p.name.includes(q) || (p.note||'').includes(q)); items.sort(byNameJa); const rows = items.map(p=>productRowView(p)).join(''); el.innerHTML = `<thead><tr><th>å•†å“</th><th class=\"num\">å˜ä¾¡</th><th>æ–¹å¼</th><th class=\"num\">ç¨ç‡</th><th>ä»•å…¥å…ˆ</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="6">è©²å½“ãªã—</td></tr>'}</tbody>`; el.querySelectorAll('[data-edit-prod]').forEach(btn=>{ btn.addEventListener('click',()=>{ const tr=btn.closest('tr'); const id=tr.dataset.id; const p=DB.products.find(x=>x.id===id); tr.outerHTML = productRowEdit(p); const row = $('#products-table').querySelector(`tr[data-id="${id}"]`); row.querySelector('[data-save-prod]').addEventListener('click',()=>{ const patch={ name:row.querySelector('[data-role="name"]').value.trim(), note:row.querySelector('[data-role="note"]').value.trim(), basePrice:toNum(row.querySelector('[data-role="price"]').value), priceMode:row.querySelector('[data-role="mode"]').value, taxRate:Number(row.querySelector('[data-role="rate"]').value||8), supplierId:row.querySelector('[data-role="supplier"]').value||null }; dal.updateProduct(id, patch); renderProductsTable(); showToast('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }); row.querySelector('[data-cancel-prod]').addEventListener('click', renderProductsTable); }); }); }
  $('#prod-refresh')?.addEventListener('click', renderProductsTable);

  // ===== ä»•å…¥ä¸€è¦§ =====
  function computeLineEx(it){ return (it.priceMode==='excl' ? it.unitPrice : Math.round(it.unitPrice / (1 + it.taxRate/100))) * it.qty; }
  function computeCardTotals(card){ let exTotal=0; for(const it of card.items){ exTotal += computeLineEx(it); } const taxRate=Number(card.cardTaxRate||8); const incTotal=Math.round(exTotal * (1 + taxRate/100)); return { exTotal, incTotal, taxRate }; }
  function renderList(){ const cont=$('#list-container'); cont.innerHTML=''; if(!DB.purchases.length){ cont.innerHTML='<div class="card">ã¾ã ä»•å…¥ã‚ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>'; return; } const sorted = DB.purchases.slice().sort((a,b)=> b.date.localeCompare(a.date) || b.createdAt - a.createdAt); for(const card of sorted){ const supp = DB.suppliers.find(s=>s.id===card.supplierId); const sname = supp? supp.name : 'ä¸æ˜ãªä»•å…¥å…ˆ'; const { exTotal, incTotal, taxRate } = computeCardTotals(card); const phoneHref = supp && supp.phone ? telSanitize(supp.phone) : ''; const div=document.createElement('div'); div.className='card'; div.innerHTML = `
        <div class="flex" style="gap:12px; align-items:flex-end">
          <div>
            <div class="chip">${card.date}</div>
            <div style="font-size:18px; font-weight:600; margin-top:6px">${sname} ${supp&&supp.contact?`<span class=\"hint\">(${supp.contact})</span>`:''}</div>
            ${supp&&supp.memo?`<div class=\"hint\">${supp.memo}</div>`:''}
          </div>
          <span class="right"></span>
          ${phoneHref? `<a class=\"btn small\" href=\"tel:${phoneHref}\">ğŸ“ ç™ºä¿¡</a>`:''}
          <button class="btn small danger" data-del-card>ã‚«ãƒ¼ãƒ‰å‰Šé™¤</button>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>æŒ‡å®šç¨ç‡ï¼ˆã‚«ãƒ¼ãƒ‰ç¨è¾¼è¨ˆç®—ï¼‰</label>
            <select data-card-tax>
              <option value="0" ${taxRate===0?'selected':''}>0%</option>
              <option value="8" ${taxRate===8?'selected':''}>8%</option>
              <option value="10" ${taxRate===10?'selected':''}>10%</option>
            </select>
          </div>
          <div class="flex" style="justify-content:flex-end; align-items:flex-end">
            <div class="chip">ç¨åˆ¥åˆè¨ˆï¼š<b>Â¥${yen(exTotal)}</b></div>
            <div class="chip">ç¨è¾¼åˆè¨ˆï¼ˆæŒ‡å®šç¨ç‡${taxRate}%ï¼‰ï¼š<b>Â¥${yen(incTotal)}</b></div>
          </div>
        </div>
        <div class="spacer"></div>
        <table class="table">
          <thead><tr><th>å•†å“</th><th class=\"num\">æ•°é‡</th><th class=\"num\">å˜ä¾¡</th><th>æ–¹å¼</th><th class=\"num\">ç¨ç‡</th><th class=\"num\">ç¨åˆ¥å°è¨ˆ</th><th></th></tr></thead>
          <tbody>
            ${card.items.map(it=>{ const p = it.productId? DB.products.find(x=>x.id===it.productId): null; const unitEx = it.priceMode==='excl' ? it.unitPrice : Math.round(it.unitPrice / (1 + it.taxRate/100)); const ex = unitEx * it.qty; const name = p? p.name : it.name; return `<tr data-line-id=\"${it.id}\"><td>${name}</td><td class=\"num\">${yen(it.qty)}</td><td class=\"num\">Â¥${yen(it.unitPrice)}</td><td>${it.priceMode==='excl'?'ç¨åˆ¥':'ç¨è¾¼'}</td><td class=\"num\">${it.taxRate}%</td><td class=\"num\">Â¥${yen(ex)}</td><td class=\"num\"><button class=\"btn small danger\" data-del-line>å‰Šé™¤</button></td>`; }).join('')}
          </tbody>
        </table>`; cont.appendChild(div); div.querySelector('[data-card-tax]').addEventListener('change', e=>{ card.cardTaxRate = Number(e.target.value); save(DB); renderList(); }); div.querySelector('[data-del-card]').addEventListener('click',()=>{ if(confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ dal.deletePurchase(card.id); renderList(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ'); } }); div.querySelectorAll('[data-del-line]').forEach(btn=>{ btn.addEventListener('click',()=>{ const lineId = btn.closest('tr').dataset.lineId; dal.deleteLine(card.id, lineId); renderList(); showToast('è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); }); }); }
  }

  // ===== æœˆæ¬¡é›†è¨ˆ =====
  function setupSummaryDefaults(){ const m=$('#sum-month'); if(m && !m.value) m.value = ymNow(); }
  function summaryForMonth(ym){ const map = new Map(); let overallEx=0, overallInc=0; for(const card of DB.purchases){ if(!card.date.startsWith(ym)) continue; for(const it of card.items){ const unitEx = it.priceMode==='excl' ? it.unitPrice : Math.round(it.unitPrice / (1 + it.taxRate/100)); const ex = unitEx * it.qty; const inc = Math.round(ex * (1 + it.taxRate/100)); overallEx += ex; overallInc += inc; const key = card.supplierId; const cur = map.get(key)||{ex:0, inc:0}; cur.ex+=ex; cur.inc+=inc; map.set(key,cur); } } return { map, overallEx, overallInc }; }
  function renderSummary(){ const ym=$('#sum-month').value||ymNow(); const el=$('#sum-by-supplier'); const {map, overallEx, overallInc} = summaryForMonth(ym); const rows = Array.from(map.entries()).sort((a,b)=>{ const sa=DB.suppliers.find(s=>s.id===a[0]); const sb=DB.suppliers.find(s=>s.id===b[0]); const na=sa?sa.name:'(ä¸æ˜)'; const nb=sb?sb.name:'(ä¸æ˜)'; return na.localeCompare(nb,'ja'); }).map(([sid,tot])=>{ const s=DB.suppliers.find(x=>x.id===sid); const phoneHref = s && s.phone? telSanitize(s.phone):''; return `<tr><td>${s? s.name:'(ä¸æ˜)'} ${s&&s.contact?`<span class=\"hint\">(${s.contact})</span>`:''}</td><td class=\"num\">Â¥${yen(tot.ex)}</td><td class=\"num\">Â¥${yen(tot.inc)}</td><td>${phoneHref?`<a class=\"btn small\" href=\"tel:${phoneHref}\">ğŸ“</a>`:''}</td></tr>`; }).join(''); el.innerHTML = `<thead><tr><th>ä»•å…¥å…ˆ</th><th class=\"num\">ç¨åˆ¥åˆè¨ˆ</th><th class=\"num\">ç¨è¾¼åˆè¨ˆï¼ˆè¡Œç¨ç‡ï¼‰</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="4">ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>'}</tbody>`; $('#sum-overall').textContent = `ã™ã¹ã¦ã®åˆè¨ˆï¼š ç¨åˆ¥ Â¥${yen(overallEx)} / ç¨è¾¼ï¼ˆè¡Œç¨ç‡ï¼‰ Â¥${yen(overallInc)}`; }
  $('#sum-refresh')?.addEventListener('click', renderSummary);
  $('#sum-export')?.addEventListener('click',()=>{ const ym=$('#sum-month').value||ymNow(); const {map, overallEx, overallInc}=summaryForMonth(ym); const lines=[['ä»•å…¥å…ˆ','ç¨åˆ¥åˆè¨ˆ','ç¨è¾¼åˆè¨ˆ(è¡Œç¨ç‡)']]; for(const [sid,tot] of map.entries()){ const s=DB.suppliers.find(x=>x.id===sid); lines.push([s? s.name:'(ä¸æ˜)', tot.ex, tot.inc]); } lines.push(['ã™ã¹ã¦ã®åˆè¨ˆ', overallEx, overallInc]); const csv = lines.map(r=> r.map(v=> typeof v==='string'? '"'+v.replace(/"/g,'""')+'"' : v).join(',')).join('\n'); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`summary-${ym}.csv`; a.click(); URL.revokeObjectURL(url); });

  // ===== è¨­å®š/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— =====
  function initSettings(){
    $('#export-json').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`purchase-backup-v24-${today()}.json`; a.click(); URL.revokeObjectURL(url); });
    $('#import-json').addEventListener('click',()=>{ const f=$('#import-file').files?.[0]; if(!f){ showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ'); return; } const reader=new FileReader(); reader.onload=()=>{ try{ const raw = JSON.parse(reader.result); const data = migrateFromAny(raw); DB = data; save(DB); // ç”»é¢å†æç”»
          renderSupplierOptions(); renderList(); renderMasterCombos(); renderSuppliersTable(); renderProductsTable(); setupSummaryDefaults(); renderSummary();
          showToast('å¾©å…ƒã—ã¾ã—ãŸï¼ˆè‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼‰');
        }catch(e){ console.error(e); showToast('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); } }; reader.readAsText(f); });
    $('#wipe-all').addEventListener('click',()=>{ if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ DB={ version:SCHEMA_VERSION, suppliers:[], products:[], purchases:[] }; save(DB); renderSupplierOptions(); $('#p-lines tbody').innerHTML=''; addPurchaseRow(); $('#list-container').innerHTML=''; renderSuppliersTable(); renderProductsTable(); setupSummaryDefaults(); renderSummary(); showToast('åˆæœŸåŒ–ã—ã¾ã—ãŸ'); } });
  }

  // ===== èµ·å‹• =====
  function boot(){
    // Part 2ã®ã‚¿ãƒ–åˆæœŸåŒ–ã¯ã™ã§ã«å‹•ä½œä¸­ã€‚ã“ã“ã§ã¯æ©Ÿèƒ½ã‚’é…ç·š
    renderSupplierOptions();
    initPurchase();
    initMaster();
    initSettings();
    setupSummaryDefaults();
    renderList();
    renderSuppliersTable();
    renderProductsTable();
    renderSummary();
  }
  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<!-- â–²â–²â–² ã“ã“ã¾ã§ Part 3/3 â–²â–²â–² -->

</body>
</html>
