<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>仕入れ管理アプリ v25.2</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ff9800">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192-v223i.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="仕入れ管理">

<style>
:root{
  --gap:8px;
  --bg:#fff8e1; --text:#333; --muted:#666;
  --card:#ffffff; --border:#e0e0e0;
  --btn:#ff9800; --btn-hover:#fb8c00;
  --link:#ffc107; --link-hover:#ffb300;
  --ghost-bg:#f5f5f5; --ghost-hover:#e0e0e0; --ghost-text:#333;
  --danger:#e53935; --danger-hover:#c62828;
}
body.dark{
  --bg:#0f0f0f; --text:#e7e7e7; --muted:#a3a3a3;
  --card:#151515; --border:#2a2a2a;
  --btn:#f7931a; --btn-hover:#e07f00;
  --link:#ffb300; --link-hover:#ffa000;
  --ghost-bg:#1e1e1e; --ghost-hover:#262626; --ghost-text:#e7e7e7;
  --danger:#cc3b3b; --danger-hover:#a63030;
}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  margin:10px;background:var(--bg);color:var(--text);
  padding-bottom:86px;overflow-x:hidden;
}
h2{margin:14px 0} h3{margin:10px 0}
input,select,button{font-size:16px;padding:10px;width:100%;box-sizing:border-box}
label{display:block;margin:8px 0 4px}
.small{font-size:12px} .muted{color:var(--muted);font-size:12px}
.nowrap{white-space:nowrap}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.row>*{flex:1;min-width:110px}

/* ボタン（右＝ポジティブ、左＝ネガティブ） */
button{background:var(--btn);color:#fff;border:none;border-radius:10px;cursor:pointer}
button:hover{background:var(--btn-hover)}
.link{background:var(--link)!important}
.link:hover{background:var(--link-hover)!important}
.ghost{background:var(--ghost-bg)!important;color:var(--ghost-text)!important}
.ghost:hover{background:var(--ghost-hover)!important}
.danger{background:var(--danger)!important;color:#fff}
.danger:hover{background:var(--danger-hover)!important}

/* ナビ */
.nav{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* 表/カード */
.table-wrap{max-height:48vh;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--card)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:6px;text-align:center;word-break:break-all}
th{position:sticky;top:0;background:var(--card);z-index:1}
.cards{display:flex;flex-direction:column;gap:8px}
.card{border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--card)}
.card-top{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card-meta{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:6px 0}
.meta-left{display:flex;gap:12px;flex-wrap:wrap;color:#555;font-size:13px}
.total{font-weight:700}

/* “真下に文字” */
.choice-vertical label{display:flex;flex-direction:column;align-items:center;gap:4px}
.choice-vertical input[type="radio"],
.choice-vertical input[type="checkbox"]{width:20px;height:20px}

/* 単価/税 入力を広く */
.wide-inputs input[type="number"], .wide-inputs select{padding:12px}

/* 操作ボタンのサイズ統一 */
.actions-cell{display:flex;gap:10px;justify-content:flex-end;align-items:center;flex-wrap:wrap}
.btn-edit{background:var(--link)!important}
.btn-del{background:var(--danger)!important}
.btn-sm{padding:6px 10px!important;font-size:13px!important;border-radius:8px!important}
.btn-lg{padding:12px 16px!important;font-size:16px!important;border-radius:10px!important}
td.col-actions{width:1%;white-space:nowrap}

/* FAB */
.fab-bar{position:fixed;left:0;right:0;bottom:0;z-index:10;background:var(--card);
  border-top:1px solid var(--border);padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
  box-shadow:0 -6px 20px rgba(0,0,0,.06)}
.fab-inner{display:flex;gap:8px;max-width:560px;margin:0 auto}
.fab-inner>*{flex:1;min-width:0}

/* モーダル */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100}
.modal-content{background:var(--card);margin:6% auto;padding:12px;width:92%;max-width:560px;border-radius:10px;max-height:90vh;overflow:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;gap:8px}

/* 一括登録 行間圧縮 */
.bulk-area .bulk-row{display:grid;grid-template-columns:1.3fr 1fr 1fr auto auto;gap:8px;align-items:center}
@media (max-width:480px){
  .bulk-area .bulk-row{grid-template-columns:1fr 1fr}
  .bulk-area .bulk-row .bm-rate{grid-column:1 / -2}
}
/* 1) ダーク時の小さな文字を見やすく（コントラストUP） */
body.dark .muted,
body.dark .meta-left { color:#d6d6d6 !important; }     /* 重要な小文字帯 */
body.dark .table-wrap,
body.dark .card { background:#131313 !important; }
body.dark th, body.dark td { border-color:#333 !important; }

/* 2) ナビのボタンが縦積み＆文字が縦っぽく見える対策
      3) すべて横書きの強制 */
html, body, button, input, select, label, .nav * {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
}
.nav button {                 /* “幅100%”の影響を打ち消す */
  width:auto !important;      /* ←これでボタンの横幅は内容に合わせる */
  padding:10px 16px;
}

/* 4) 削除・編集ボタン：横並び＆同サイズに統一（表・カード両方） */
.actions, .actions-cell { display:flex !important; gap:10px; align-items:center; }
.meta-right { display:flex; align-items:center; gap:12px; }  /* 合計＋ボタンを横並び */

.btn-sm, .btn-lg {                   /* 既存クラス名はそのまま揃える */
  padding:10px 14px !important;
  font-size:15px !important;
  border-radius:10px !important;
  min-width:100px;                   /* 視認性のため固定幅を少し持たせる */
}

/* カード内の金額・テキストの読みやすさ微調整 */
.card .total { font-weight:700; }
body.dark .card .total { color:#fff; }
</style>
</head>
<body>

<!-- ナビ -->
<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">仕入れ入力</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">電話帳</button>
  <button type="button" onclick="showPage('masters')" class="ghost">マスタ管理</button>
  <button type="button" onclick="openBulkMaster()" class="link">🧩 一括マスタ登録</button>
  <div class="nav-right">
    <button type="button" class="link" onclick="forceUpdateSW()">🔄 更新</button>
    <button type="button" id="btnTheme" class="ghost" onclick="toggleTheme()">🌓 ダーク</button>
    <span id="appVersion" class="muted">v25.2</span>
  </div>
</div>

<!-- 仕入れ入力 -->
<section id="page-entry">
  <h2>仕入れ入力</h2>

  <label>日付</label>
  <input type="date" id="inDate">

  <label>仕入先 <span class="muted">（選択すると紐付く商品のみ表示）</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" class="ghost" onclick="openSupplierModal()">＋ 仕入先追加</button>
  </div>

  <div id="supplierQuick" class="row" style="margin:6px 0; display:none;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">📞 この仕入先に電話</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">📋 電話番号コピー</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>商品名</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" class="ghost" onclick="openItemModal()">＋ 商品を追加</button>
  </div>

  <div class="row wide-inputs">
    <div><label>単価</label><input type="number" id="inPrice" value="0" step="1" min="0" onfocus="this.select()"></div>
    <div><label>数量</label><input type="number" id="inQty" value="1" step="0.1" min="0" onfocus="this.select()"></div>
  </div>

  <label>税区分</label>
  <div class="row">
    <div class="choice-vertical" style="flex:0 0 auto;">
      <label><input type="radio" name="inTax" value="taxIncluded"><span>税込</span></label>
    </div>
    <div class="choice-vertical" style="flex:0 0 auto;">
      <label><input type="radio" name="inTax" value="taxExcluded" checked><span>税別</span></label>
    </div>
    <span class="muted" style="flex:1;">基本税率：<b id="lblRate"></b>%（設定で変更）</span>
  </div>

  <label style="margin-top:6px;">税率（8% / 10% クイック切替）</label>
  <div class="row choice-vertical" id="baseRateRadios" style="gap:18px;">
    <label style="flex:0 0 auto;"><input type="radio" name="baseRateChoice" value="8" checked><span>8%</span></label>
    <label style="flex:0 0 auto;"><input type="radio" name="baseRateChoice" value="10"><span>10%</span></label>
    <span class="small" style="flex:1;">※ 「合計」の計算に使う税率</span>
  </div>

  <h3 class="row" style="align-items:center; margin-top:16px;">
    <span style="flex:0 0 auto;">仕入れ一覧</span>
    <span class="view-switch" style="flex:1 1 auto; display:flex; gap:10px; justify-content:flex-end; align-items:center;">
      <span>表示：</span>
      <label style="display:flex; align-items:center; gap:6px;"><input type="radio" name="viewMode" value="table"> <span>表</span></label>
      <label style="display:flex; align-items:center; gap:6px;"><input type="radio" name="viewMode" value="cards" checked> <span>カード</span></label>
      <label style="display:flex; align-items:center; gap:6px; margin-left:10px;">
        <input type="checkbox" id="toggleAll" onchange="toggleAllRows(this)">
        <span>全件表示（デフォルト：最新50件）</span>
      </label>
    </span>
  </h3>

  <div class="table-wrap" id="wrap-table" style="display:none;">
    <table id="listTable">
      <thead>
        <tr><th>日付</th><th>仕入先</th><th>商品</th><th>数量</th><th>単価</th><th>税区分</th><th>合計</th><th>操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="wrap-cards" class="cards"></div>

  <div class="row" style="margin-top:10px;">
    <button type="button" class="ghost" onclick="openRestoreChooser()">復元</button>
    <button type="button" class="link"  onclick="backupJSON()">バックアップ</button>
  </div>
  /* 復元UI */
<div id="restoreChooser" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>復元</h3>
      <button type="button" class="ghost" onclick="closeModal('restoreChooser')">✕</button>
    </div>
    <p class="muted" id="lastBackupHint" style="margin:6px 0;"></p>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="restoreFromFile(); closeModal('restoreChooser')">ファイルから復元</button>
      <button type="button" onclick="quickRestore(); closeModal('restoreChooser')">直近バックアップから復元</button>
    </div>
  </div>
</div>
<input id="restoreInput" type="file" accept="application/json" style="display:none" onchange="if(this.files[0]) restoreJSON(this.files[0])">

</section>

<!-- 電話帳 -->
<section id="page-phonebook" style="display:none;">
  <h2>仕入先電話帳</h2>
  <table id="phoneTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- マスタ管理 -->
<section id="page-masters" style="display:none;">
  <h2>マスタ一覧</h2>

  <h3>仕入先</h3>
  <table id="supTable">
    <thead><tr><th>仕入先</th><th>担当者</th><th>電話番号</th><th>インボイス番号</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>商品（紐付け先）</h3>
  <table id="itemTable">
    <thead><tr><th>商品名</th><th>基準価格</th><th>税区分</th><th>紐付け仕入先</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- 仕入れ編集 -->
<div id="purchaseEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入れ編集</h3>
      <button type="button" class="ghost" onclick="closeModal('purchaseEditModal')">✕</button>
    </div>
    <input type="hidden" id="editPurchaseIndex">
    <label>日付</label><input type="date" id="editDate">
    <label>仕入先</label><select id="editSupplier"></select>
    <label>商品</label><select id="editItem"></select>
    <div class="row wide-inputs">
      <div><label>単価</label><input type="number" id="editPrice" step="1" min="0"></div>
      <div><label>数量</label><input type="number" id="editQty" step="0.1" min="0"></div>
    </div>
    <label>税区分</label>
    <div class="row">
      <div class="choice-vertical" style="flex:0 0 auto;">
        <label><input type="radio" name="editTax" value="taxIncluded"><span>税込</span></label>
      </div>
      <div class="choice-vertical" style="flex:0 0 auto;">
        <label><input type="radio" name="editTax" value="taxExcluded"><span>税別</span></label>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button type="button" class="btn-del btn-sm"  onclick="deletePurchase()">削除</button>
      <button type="button" class="btn-edit btn-lg" onclick="updatePurchase()">保存</button>
    </div>
  </div>
</div>

<!-- 仕入先：追加/編集 -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先追加</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">✕</button>
    </div>
    <label>社名</label><input id="supName" type="text" placeholder="例）Aフーズ">
    <label>担当者</label><input id="supContact" type="text" placeholder="例）山田さん">
    <label>電話番号</label><input id="supPhone" type="tel" placeholder="090-1234-5678">
    <label>インボイス番号（任意）</label><input id="supInvoice" type="text" placeholder="例）T1234567890123">
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetSupplierForm()">クリア</button>
      <button type="button" onclick="addSupplier()">登録</button>
    </div>
  </div>
</div>
<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>仕入先編集</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">✕</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>社名</label><input id="editSupName" type="text">
    <label>担当者</label><input id="editSupContact" type="text">
    <label>電話番号</label><input id="editSupPhone" type="tel">
    <label>インボイス番号（任意）</label><input id="editSupInvoice" type="text">
    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="deleteSupplier()">削除</button>
      <button type="button" class="btn-edit btn-lg" onclick="updateSupplier()">保存</button>
    </div>
  </div>
</div>

<!-- 商品：追加/編集 -->
<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品追加</h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">✕</button>
    </div>
    <label>商品名</label><input id="itName" type="text" placeholder="例）国産もも肉 2kg">
    <div class="row wide-inputs">
      <div><label>基準価格（任意）</label><input id="itPrice" type="number" placeholder="0"></div>
      <div>
        <label>税区分</label>
        <select id="itTax">
          <option value="taxExcluded" selected>税別</option>
          <option value="taxIncluded">税込</option>
        </select>
      </div>
    </div>
    <label>紐付け仕入先（複数可）</label>
    <div id="itSuppliers" class="row" style="align-items:flex-start;"></div>
    <div class="muted">※ 複数の仕入先から購入可能な商品に対応します。</div>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetItemForm()">クリア</button>
      <button type="button" onclick="addItem()">登録</button>
    </div>
  </div>
</div>
<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>商品編集</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">✕</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>商品名</label><input id="editItName" type="text">
    <div class="row wide-inputs">
      <div><label>基準価格（任意）</label><input id="editItPrice" type="number"></div>
      <div>
        <label>税区分</label>
        <select id="editItTax">
          <option value="taxExcluded">税別</option>
          <option value="taxIncluded">税込</option>
        </select>
      </div>
    </div>
    <label>紐付け仕入先（複数可）</label>
    <div id="editItSuppliers" class="row" style="align-items:flex-start;"></div>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="deleteItemDirect(document.getElementById('editItemId').value)">削除</button>
      <button type="button" class="btn-edit btn-lg" onclick="updateItem()">保存</button>
    </div>
  </div>
</div>

<!-- 価格履歴 -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>価格履歴</h3>
      <button type="button" class="ghost" onclick="closeModal('historyModal')">✕</button>
    </div>
    <div class="table-wrap" style="max-height:50vh; margin-top:8px;">
      <table>
        <thead><tr><th>日付</th><th>仕入先</th><th>商品</th><th>数量</th><th>単価</th><th>税区分</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 一括マスタ登録 -->
<div id="bulkMasterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>一括マスタ登録（仕入先＋複数商品）</h3>
      <button type="button" class="ghost" onclick="closeModal('bulkMasterModal')">✕</button>
    </div>

    <h4>仕入先</h4>
    <label>社名</label><input id="bmSupName" type="text" placeholder="例）B水産">
    <div class="row">
      <div><label>担当者</label><input id="bmSupContact" type="text"></div>
      <div><label>電話番号</label><input id="bmSupPhone" type="tel"></div>
    </div>

    <h4 style="margin-top:12px;">商品（複数行追加可）</h4>
    <div class="bulk-area">
      <div id="bmProducts"></div>
      <div class="row" style="margin-top:6px;">
        <button type="button" class="ghost" onclick="bmAddRow()">＋ 商品を追加</button>
        <button type="button" class="ghost" onclick="bmClearRows()">商品を全クリア</button>
      </div>
    </div>

    <div id="bmDupArea" class="small muted" style="display:none; margin-top:6px;"></div>

    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="closeModal('bulkMasterModal')">中止</button>
      <button type="button" class="btn-edit btn-lg" onclick="bmSubmit()">まとめて登録</button>
    </div>
  </div>
</div>

<!-- 下部FAB -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" class="ghost" onclick="clearEntry()">入力クリア</button>
    <button type="button" onclick="savePurchase()">保存</button>
  </div>
</div>

<script>
const APP_VERSION = 'v25.2';
document.addEventListener('DOMContentLoaded',()=>{ const el=document.getElementById('appVersion'); if(el) el.textContent=APP_VERSION; });

const LS_KEYS = { suppliers:'suppliers_v2', items:'items_v3', purchases:'purchases_v3', taxRate:'base_tax_rate_v1' };
const LS_LAST_BACKUP = 'last_backup_json_v1';
const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

let SHOW_ALL=false, VIEW_MODE='cards', FILTER_MONTH='';

/* 税率 */
function getBaseTaxRate(){ const v=localStorage.getItem(LS_KEYS.taxRate); return v==null?0.08:Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate,String(decimal)); updateTaxRateLabel(); renderBaseRateRadios(); }
function updateTaxRateLabel(){ $('lblRate').textContent=Math.round(getBaseTaxRate()*1000)/10; }
function renderBaseRateRadios(){
  const pct=Math.round(getBaseTaxRate()*100); const target=pct===10?'10':'8';
  document.querySelectorAll('input[name="baseRateChoice"]').forEach(r=>{
    r.checked=(r.value===target); r.onchange=()=>setBaseTaxRate(Number(r.value)/100);
  });
}
function ensureBaseRateChecked(){
  const radios=document.querySelectorAll('input[name="baseRateChoice"]');
  if(!Array.from(radios).some(r=>r.checked)){
    const pct=Math.round(getBaseTaxRate()*100); const target=pct===10?'10':'8';
    const r=document.querySelector(`input[name="baseRateChoice"][value="${target}"]`); if(r) r.checked=true;
  }
}

/* テーマ */
const THEME_KEY='app_theme_v1_alt';
function applyTheme(mode){
  const isDark=mode==='dark';
  document.body.classList.toggle('dark',isDark);
  const meta=document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute('content',isDark?'#0f0f0f':'#ff9800');
  const b=$('btnTheme'); if(b) b.textContent=isDark?'☀ ライト':'🌓 ダーク';
  localStorage.setItem(THEME_KEY,mode);
}
function initTheme(){
  const saved=localStorage.getItem(THEME_KEY);
  if(saved==='dark'||saved==='light') applyTheme(saved);
  else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  const mq=window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener?.('change',e=>{ if(!localStorage.getItem(THEME_KEY)) applyTheme(e.matches?'dark':'light'); });
}
function toggleTheme(){ applyTheme(document.body.classList.contains('dark')?'light':'dark'); }

/* ページ切替 */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block' : 'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block' : 'none';
  $('page-masters').style.display = which==='masters' ? 'block' : 'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters') { renderSupTable(); renderItemTable(); }
  if(which==='entry') ensureBaseRateChecked();
}

/* 初期化 */
function init(){
  const d=new Date();
  $('inDate').value=`${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;
  const defTax=document.querySelector('input[name="inTax"][value="taxExcluded"]'); if(defTax) defTax.checked=true;

  document.querySelectorAll('input[name="viewMode"]').forEach(r=> r.onchange=()=>{ VIEW_MODE=r.value; renderList(); });

  renderSupplierSelect(); renderItemSelect(); renderList();
  updateTaxRateLabel(); renderBaseRateRadios(); ensureBaseRateChecked();
  initTheme();
}
document.addEventListener('DOMContentLoaded', init);

/* セレクタ */
function renderSupplierSelect(){
  const sel=$('inSupplier');
  sel.innerHTML='<option value="">-- 仕入先を選択 --</option>'+suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange=()=>{ renderItemSelect(sel.value); updateSupplierQuick(sel.value); };
}
function updateSupplierQuick(supplierId){
  const wrap=$('supplierQuick'); if(!supplierId){wrap.style.display='none'; return;}
  const s=suppliers.find(x=>x.id===supplierId); if(!s){wrap.style.display='none'; return;}
  wrap.style.display='flex';
  const phone=s.phone||''; const telHref=phone?`tel:${phone}`:'';
  $('supplierPhoneView').textContent=phone?`電話番号：${phone}`:'電話番号未登録';
  $('btnCallSupplier').onclick=()=>{ if(!phone){alert('電話番号が未登録です');return;} location.href=telHref; };
  $('btnCopySupplier').onclick=()=>copyPhone(phone);
}
function renderItemSelect(supplierId=''){
  const sel=$('inItem'); let list=items;
  if(supplierId) list=items.filter(it=>(it.suppliers||[]).includes(supplierId));
  sel.innerHTML='<option value="">-- 商品を選択 --</option>'+list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange=()=>{
    const it=items.find(x=>x.id===sel.value);
    if(it){
      const last=getLastPriceFor($('inSupplier').value,it.id);
      $('inPrice').value = last!=null ? last : (it.price!=null ? it.price : 0);
      const tsel=document.querySelector(`input[name="inTax"][value="${it.taxType||'taxExcluded'}"]`); if(tsel) tsel.checked=true;
    }
  };
}
/* 仕入先：新規/編集 */
function resetSupplierForm(){
  $('supName').value='';
  $('supContact').value='';
  $('supPhone').value='';
  const inv=$('supInvoice'); if(inv) inv.value='';
}
function addSupplier(){
  const name=$('supName').value.trim();
  if(!name) return alert('社名を入力してください');
  const sup={
    id: uid(),
    name,
    contact: $('supContact').value.trim(),
    phone: $('supPhone').value.trim(),
    invoice: ($('supInvoice')?.value||'').trim()
  };
  suppliers.push(sup);
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  resetSupplierForm();
  closeModal('supplierModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable();
}
function openSupplierEdit(id){
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  $('editSupId').value=s.id;
  $('editSupName').value=s.name||'';
  $('editSupContact').value=s.contact||'';
  $('editSupPhone').value=s.phone||'';
  if($('editSupInvoice')) $('editSupInvoice').value=s.invoice||'';
  $('supplierEditModal').style.display='block';
}
function updateSupplier(){
  const id=$('editSupId').value;
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  const name=$('editSupName').value.trim();
  if(!name) return alert('社名は必須です');
  s.name=name;
  s.contact=$('editSupContact').value.trim();
  s.phone=$('editSupPhone').value.trim();
  s.invoice=($('editSupInvoice')?.value||'').trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable();
}
function deleteSupplier(){
  const id=$('editSupId').value;
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  if(!confirm(`仕入先「${s.name}」を削除します（商品紐付けからも除外）。よろしいですか？`)) return;
  suppliers=suppliers.filter(x=>x.id!==id);
  items=items.map(it=>({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}
/* 入力エリア */
function clearEntry(){ $('inItem').value=''; $('inQty').value=1; $('inPrice').value=0; const r=document.querySelector('input[name="inTax"][value="taxExcluded"]'); if(r) r.checked=true; }
function getLastPriceFor(supplierId,itemId){
  for(let i=purchases.length-1;i>=0;i--){ const p=purchases[i]; if(p.supplierId===supplierId&&p.itemId===itemId) return p.price; }
  return null;
}

/* 保存（重複は数量加算を提案） */
function savePurchase(){
  const date=$('inDate').value;
  const supplierId=$('inSupplier').value;
  const itemId=$('inItem').value;
  const qty=Number($('inQty').value||0);
  const price=Number($('inPrice').value||0);
  const taxType=(document.querySelector('input[name="inTax"]:checked')||{}).value||'taxExcluded';
  const rate=getBaseTaxRate();

  if(!date) return alert('日付を入力してください');
  if(!supplierId) return alert('仕入先を選択してください');
  if(!itemId) return alert('商品を選択してください');

  const dupIndex=purchases.findIndex(p=>p.date===date&&p.supplierId===supplierId&&p.itemId===itemId);
  if(dupIndex>=0){
    if(confirm('同日の同仕入先・同商品が見つかりました。数量を加算しますか？')){
      const old=purchases[dupIndex];
      const newQty=Number(old.qty)+qty;
      const total=taxType==='taxExcluded'?Math.round(newQty*price*(1+rate)):Math.round(newQty*price);
      purchases[dupIndex]={...old, qty:newQty, price, taxType, total};
      localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
      clearEntry(); renderList(); return;
    }
  }
  const total=taxType==='taxExcluded'?Math.round(qty*price*(1+rate)):Math.round(qty*price);
  purchases.push({date,supplierId,itemId,qty,price,taxType,total});
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  clearEntry(); renderList();
}

/* 一覧表示 */
function toggleAllRows(chk){ SHOW_ALL=chk.checked; renderList(); }
function getFilteredArray(){
  let arr=purchases.slice().map((p,idx)=>({p,idx})).reverse();
  if(FILTER_MONTH) arr=arr.filter(({p})=>(p.date||'').slice(0,7)===FILTER_MONTH);
  return SHOW_ALL?arr:arr.slice(0,50);
}
function renderList(){
  const wrapTable=$('wrap-table'), wrapCards=$('wrap-cards');
  if(VIEW_MODE==='table'){ wrapTable.style.display='block'; wrapCards.style.display='none'; renderListTable(); }
  else{ wrapTable.style.display='none'; wrapCards.style.display='block'; renderListCards(); }
}
function renderListTable(){
  const tb=$('listTable').querySelector('tbody'); tb.innerHTML='';
  const list=getFilteredArray();
  list.forEach(({p,idx:origIndex})=>{
    const s=suppliers.find(x=>x.id===p.supplierId);
    const i=items.find(x=>x.id===p.itemId);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.date}</td>
      <td>${s?s.name:''}</td>
      <td>${i?i.name:''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'税別':'税込'}</td>
      <td>${p.total}</td>
      <td class="nowrap col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deletePurchaseAt(${origIndex})">削除</button>
          <button class="btn-edit btn-lg" onclick="openPurchaseEdit(${origIndex})">編集</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderListCards(){
  const box=$('wrap-cards'); box.innerHTML='';
  const rate=getBaseTaxRate();
  const map=new Map();
  getFilteredArray().forEach(({p,idx})=>{
    const key=`${p.date}|${p.supplierId}`;
    if(!map.has(key)) map.set(key,[]);
    map.get(key).push({p,idx});
  });
  Array.from(map.entries()).forEach(([key,rows])=>{
    const [date,supId]=key.split('|');
    const s=suppliers.find(x=>x.id===supId);
    const name=s? s.name:'(不明)';
    let ex=0; rows.forEach(({p})=>{ ex += p.taxType==='taxExcluded' ? (p.qty*p.price) : (p.qty*p.price/(1+rate)); });
    const total=Math.round(ex*(1+rate));
    const lines=rows.map(({p,idx})=>{
      const it=items.find(x=>x.id===p.itemId);
      return `
        <div class="card-meta" style="justify-content:space-between;">
          <div class="meta-left">
            <span>${it?it.name:''}</span>
            <span>${p.qty} × ${p.price}</span>
            <span>${p.taxType==='taxExcluded'?'税別':'税込'}</span>
          </div>
          <div class="meta-right">
            <span class="total">${p.total} 円</span>
            <span class="actions">
              <button class="btn-del btn-sm"  onclick="deletePurchaseAt(${idx})">削除</button>
              <button class="btn-edit btn-lg" onclick="openPurchaseEdit(${idx})">編集</button>
            </span>
          </div>
        </div>`;
    }).join('');
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-top">
        <div>${date}</div>
        <div style="font-weight:700;">${name}</div>
      </div>
      <div class="meta-left" style="margin:6px 0;">
        <span>税別小計：<b>${Math.round(ex)}</b> 円</span>
        <span>合計（${Math.round(rate*100)}%）：<b class="total">${total}</b> 円</span>
      </div>
      ${lines}`;
    box.appendChild(card);
  });
}

/* バックアップ／復元 */
async function backupJSON(){
  const fileName=`shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const data={version:1,savedAt:new Date().toISOString(),suppliers,items,purchases,taxRate:localStorage.getItem(LS_KEYS.taxRate)};
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const file=new File([blob],fileName,{type:'application/json'});
  try{ localStorage.setItem(LS_LAST_BACKUP,json); }catch(_){}
  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{ await navigator.share({title:'仕入れバックアップ',text:'バックアップJSONです。',files:[file]}); alert('バックアップを保存しました'); return; }
    catch(e){ if(e.name==='AbortError') return; }
  }
  if('showSaveFilePicker' in window){
    try{
      const handle=await window.showSaveFilePicker({suggestedName:fileName,types:[{description:'JSON',accept:{'application/json':['.json']}}]});
      const w=await handle.createWritable(); await w.write(blob); await w.close(); alert('バックアップを保存しました'); return;
    }catch(e){ if(e.name==='AbortError') return; }
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href); alert('JSONをダウンロードしました。');
}
function openRestoreChooser(){
  const hint=document.getElementById('lastBackupHint');
  const has=!!localStorage.getItem(LS_LAST_BACKUP);
  hint.textContent= has ? '端末内に直近バックアップが見つかりました。ワンタップで復元できます。'
                         : '直近バックアップがありません。ファイルを選んで復元してください。';
  document.getElementById('restoreChooser').style.display='block';
}
async function restoreFromFile(){
  try{
    if('showOpenFilePicker' in window){
      const [handle]=await window.showOpenFilePicker({types:[{description:'JSONバックアップ',accept:{'application/json':['.json']}}]});
      const f=await handle.getFile(); const text=await f.text(); const data=JSON.parse(text);
      _applyRestore(data); alert('復元しました'); return;
    }
  }catch(e){ if(e.name!=='AbortError') alert('復元に失敗しました: '+e.message); return; }
  const input=document.getElementById('restoreInput'); if(input) input.click();
}
function quickRestore(){
  try{
    const json=localStorage.getItem(LS_LAST_BACKUP);
    if(!json){ alert('直近バックアップがありません。先にバックアップしてください。'); return; }
    const data=JSON.parse(json); _applyRestore(data); alert('直近バックアップから復元しました');
  }catch(e){ alert('復元に失敗しました: '+e.message); }
}
function restoreJSON(file){
  const r=new FileReader();
  r.onload=()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('復元しました'); }catch(e){ alert('復元に失敗しました: '+e.message); } };
  r.readAsText(file);
}
function _applyRestore(data){
  if(!data||!data.suppliers||!data.items||!data.purchases) throw new Error('形式不正');
  suppliers=data.suppliers; items=data.items; purchases=data.purchases;
  if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate,String(data.taxRate));
  localStorage.setItem(LS_KEYS.suppliers,JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  renderSupplierSelect(); renderItemSelect(); renderList(); renderPhonebook(); renderSupTable(); renderItemTable(); updateTaxRateLabel();
}

/* 電話帳 */
function renderPhonebook(){
  const tb=$('phoneTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    const telHref=s.phone?`tel:${s.phone}`:'';
    tr.innerHTML=`
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center;text-decoration:none;padding:8px;border-radius:8px;display:block;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>📞 電話</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">📋 コピー</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
async function copyPhone(num){
  if(!num){ alert('電話番号が未登録です'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(num); }
    else{ const ta=document.createElement('textarea'); ta.value=num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    alert('電話番号をコピーしました');
  }catch(e){ alert('コピーできませんでした：'+e.message); }
}

/* マスタ一覧 */
function renderSupTable(){
  const tb=$('supTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.contact||''}</td>
      <td class="nowrap">${s.phone||''}</td>
      <td class="nowrap">${s.invoice||''}</td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deleteSupplierById('${s.id}')">削除</button>
          <button class="btn-edit btn-lg" onclick="openSupplierEdit('${s.id}')">編集</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb=$('itemTable').querySelector('tbody'); tb.innerHTML='';
  items.forEach(it=>{
    const names=(it.suppliers||[]).map(id=>(suppliers.find(s=>s.id===id)||{}).name).filter(Boolean);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.name}</td>
      <td>${it.price!=null?it.price:''}</td>
      <td>${it.taxType==='taxExcluded'?'税別':'税込'}</td>
      <td>${names.join(' / ')}</td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deleteItemDirect('${it.id}')">削除</button>
          <button class="btn-edit btn-lg" onclick="openItemEdit('${it.id}')">編集</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}

/* 編集・削除 */
function openPurchaseEdit(index){
  const p=purchases[index]; if(!p) return;
  $('editPurchaseIndex').value=String(index);
  $('editDate').value=p.date;

  const supSel=$('editSupplier'); supSel.innerHTML=suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); supSel.value=p.supplierId;
  const itemSel=$('editItem'); const list=items.filter(it=>(it.suppliers||[]).includes(p.supplierId));
  itemSel.innerHTML=list.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); itemSel.value=p.itemId;
  supSel.onchange=()=>{ const list2=items.filter(it=>(it.suppliers||[]).includes(supSel.value)); itemSel.innerHTML=list2.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); };

  $('editQty').value=p.qty; $('editPrice').value=p.price;
  const r=document.querySelector(`input[name="editTax"][value="${p.taxType}"]`); if(r) r.checked=true;

  $('purchaseEditModal').style.display='block';
}
function updatePurchase(){
  const idx=Number($('editPurchaseIndex').value);
  const date=$('editDate').value;
  const supplierId=$('editSupplier').value;
  const itemId=$('editItem').value;
  const qty=Number($('editQty').value||0);
  const price=Number($('editPrice').value||0);
  const taxType=(document.querySelector('input[name="editTax"]:checked')||{}).value||'taxExcluded';
  const rate=getBaseTaxRate();
  if(!date||!supplierId||!itemId) return alert('日付・仕入先・商品は必須です');
  const total=taxType==='taxExcluded'?Math.round(qty*price*(1+rate)):Math.round(qty*price);
  purchases[idx]={date,supplierId,itemId,qty,price,taxType,total};
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  closeModal('purchaseEditModal'); renderList();
}
function deletePurchase(){ const idx=Number($('editPurchaseIndex').value); if(!confirm('この仕入れ記録を削除します。よろしいですか？')) return; purchases.splice(idx,1); localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases)); closeModal('purchaseEditModal'); renderList(); }
function deletePurchaseAt(index){ if(!confirm('この仕入れ記録を削除します。よろしいですか？')) return; purchases.splice(index,1); localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases)); renderList(); }
function deleteSupplierById(id){
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  if(!confirm(`仕入先「${s.name}」を削除します（商品紐付けからも除外）。よろしいですか？`)) return;
  suppliers=suppliers.filter(x=>x.id!==id);
  items=items.map(it=>({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers,JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

/* 商品：新規/編集 */
function openItemModal(){ resetItemForm(); renderItemSupplierChecks(); const m=$('itemModal'); if(!m){alert('itemModal が見つかりません');return;} m.style.display='block'; }
function resetItemForm(){ $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded'; }
function renderItemSupplierChecks(target='itSuppliers'){
  const box=$(target);
  if(suppliers.length===0){ box.innerHTML='<div class="muted">仕入先がありません。先に仕入先を登録してください。</div>'; return; }
  box.innerHTML=suppliers.map(s=>`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" value="${s.id}"> ${s.name}</label>`).join('');
}
function addItem(){
  const name=normName($('itName').value); if(!name) return alert('商品名を入力してください');
  if(items.some(it=>normName(it.name)===name) && !confirm('同名の商品が存在します。追加しますか？')) return;
  const priceStr=$('itPrice').value.trim(); const price=priceStr===''?null:Number(priceStr);
  const taxType=$('itTax').value;
  const checks=Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds=checks.map(c=>c.value);
  if(supIds.length===0) return alert('紐付ける仕入先を1つ以上選択してください');
  items.push({id:uid(),name,price,taxType,suppliers:supIds});
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  resetItemForm(); renderItemSupplierChecks(); renderItemSelect($('inSupplier').value); renderItemTable();
}
function openItemEdit(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  $('editItemId').value=it.id; $('editItName').value=it.name; $('editItPrice').value=it.price!=null?it.price:''; $('editItTax').value=it.taxType||'taxExcluded';
  renderItemSupplierChecks('editItSuppliers');
  (it.suppliers||[]).forEach(sid=>{ const chk=$('editItSuppliers').querySelector(`input[value="${sid}"]`); if(chk) chk.checked=true; });
  $('itemEditModal').style.display='block';
}
function updateItem(){
  const id=$('editItemId').value; const it=items.find(x=>x.id===id); if(!it) return;
  const name=normName($('editItName').value); if(!name) return alert('商品名は必須です');
  if(name!==normName(it.name) && items.some(x=>normName(x.name)===name) && !confirm('同名の商品が存在します。続行しますか？')) return;
  const priceStr=$('editItPrice').value.trim(); it.price=priceStr===''?null:Number(priceStr);
  it.name=name; it.taxType=$('editItTax').value;
  const supIds=Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked')).map(c=>c.value);
  if(supIds.length===0) return alert('紐付け仕入先を1つ以上選択してください');
  it.suppliers=supIds;
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}
function deleteItemDirect(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  if(purchases.some(p=>p.itemId===id)){ alert('この商品は仕入れ履歴で使われています。先に該当の仕入れを削除/編集してください。'); return; }
  if(!confirm(`商品「${it.name}」を削除します。よろしいですか？`)) return;
  items=items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  renderItemSelect($('inSupplier').value); renderItemTable();
}

/* 一括マスタ登録 */
let bmRowCounter=0;
function bmRowTemplate(idx){
  return `
    <div class="bulk-row">
      <input type="text"  class="bm-name"  placeholder="商品名">
      <input type="number" class="bm-price" placeholder="価格">
      <select class="bm-tax" aria-label="税区分">
        <option value="taxExcluded" selected>税別</option>
        <option value="taxIncluded">税込</option>
      </select>
      <div class="bm-rate choice-vertical" style="justify-self:start;">
        <label><input type="radio" name="bmRate${idx}" value="0.08" checked><span>8%</span></label>
        <label><input type="radio" name="bmRate${idx}" value="0.10"><span>10%</span></label>
      </div>
      <button type="button" class="danger" onclick="this.closest('.bulk-row').remove()">削除</button>
    </div>`;
}
function openBulkMaster(){
  bmClearRows(); bmAddRow();
  $('bmSupName').value=''; $('bmSupContact').value=''; $('bmSupPhone').value='';
  $('bmDupArea').style.display='none'; $('bmDupArea').innerHTML='';
  $('bulkMasterModal').style.display='block';
}
function bmAddRow(){ const wrap=$('bmProducts'); const idx=++bmRowCounter; const div=document.createElement('div'); div.innerHTML=bmRowTemplate(idx); wrap.appendChild(div.firstElementChild); }
function bmClearRows(){ $('bmProducts').innerHTML=''; }
function bmSubmit(){
  const supName=$('bmSupName').value.trim(); if(!supName) return alert('仕入先名を入力してください');
  const rows=Array.from(document.querySelectorAll('#bmProducts .bulk-row')); if(rows.length===0) return alert('商品行を追加してください');

  const names=rows.map(r=>normName(r.querySelector('.bm-name').value)).filter(Boolean);
  const dups=names.filter(n=>items.some(it=>normName(it.name)===n));
  if(dups.length>0){
    const area=$('bmDupArea');
    area.style.display='block';
    area.innerHTML='既存と同名の商品があります：<br>・'+Array.from(new Set(dups)).join('<br>・')+'<br>続行すると新規として追加されます。';
    if(!confirm('重複候補があります。続行しますか？')) return;
  }

  const sup={id:uid(),name:supName,contact:$('bmSupContact').value.trim(),phone:$('bmSupPhone').value.trim()};
  suppliers.push(sup);

  rows.forEach(row=>{
    const name=normName(row.querySelector('.bm-name').value); if(!name) return;
    const priceStr=row.querySelector('.bm-price').value.trim();
    const price=priceStr===''?null:Number(priceStr);
    const taxType=row.querySelector('.bm-tax').value;
    const taxRate=Number((row.querySelector('input[type="radio"]:checked')||{value:'0.08'}).value);
    items.push({ id:uid(), name, price, taxType, taxRate, suppliers:[sup.id] });
  });

  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  closeModal('bulkMasterModal'); renderSupplierSelect(); renderItemSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
  alert('一括登録しました');
}

/* 共通 */
function closeModal(id){ const m=$(id); if(m) m.style.display='none'; }
window.addEventListener('click',e=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('purchaseEditModal')) closeModal('purchaseEditModal');
  if(e.target===$('historyModal')) closeModal('historyModal');
  if(e.target===$('bulkMasterModal')) closeModal('bulkMasterModal');
  if(e.target===$('restoreChooser')) closeModal('restoreChooser');
});

/* PWA */
if('serviceWorker' in navigator){
  window.addEventListener('load', async ()=>{
    try{
      const reg=await navigator.serviceWorker.register('./sw.js?ver=25.2',{updateViaCache:'none'});
      document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') reg.update(); });
    }catch(e){}
  });
}
async function forceUpdateSW(){
  if(!('serviceWorker' in navigator)){ alert('この環境は未対応です'); return; }
  try{
    const reg=await navigator.serviceWorker.getRegistration();
    if(!reg){ alert('Service Worker未登録です'); return; }
    await reg.update();
    if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(!window.__reloading){ window.__reloading=true; location.reload(); } });
    alert('更新処理を実行しました。数秒で画面が更新されます。');
  }catch(e){ alert('更新に失敗: '+e.message); }
}

/* util */
function normName(s){ return String(s||'').trim().replace(/\s+/g,' '); }
</script>
</body>
</html>
