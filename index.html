<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»•å…¥ã‚Œç®¡ç†ã‚¢ãƒ—ãƒª v25.2</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ff9800">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192-v223i.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ä»•å…¥ã‚Œç®¡ç†">

<style>
:root{
  --gap:8px;
  --bg:#fff8e1; --text:#333; --muted:#666;
  --card:#ffffff; --border:#e0e0e0;
  --btn:#ff9800; --btn-hover:#fb8c00;
  --link:#ffc107; --link-hover:#ffb300;
  --ghost-bg:#f5f5f5; --ghost-hover:#e0e0e0; --ghost-text:#333;
  --danger:#e53935; --danger-hover:#c62828;
}
body.dark{
  --bg:#0f0f0f; --text:#e7e7e7; --muted:#a3a3a3;
  --card:#151515; --border:#2a2a2a;
  --btn:#f7931a; --btn-hover:#e07f00;
  --link:#ffb300; --link-hover:#ffa000;
  --ghost-bg:#1e1e1e; --ghost-hover:#262626; --ghost-text:#e7e7e7;
  --danger:#cc3b3b; --danger-hover:#a63030;
}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  margin:10px;background:var(--bg);color:var(--text);
  padding-bottom:86px;overflow-x:hidden;
}
h2{margin:14px 0} h3{margin:10px 0}
input,select,button{font-size:16px;padding:10px;width:100%;box-sizing:border-box}
label{display:block;margin:8px 0 4px}
.small{font-size:12px} .muted{color:var(--muted);font-size:12px}
.nowrap{white-space:nowrap}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.row>*{flex:1;min-width:110px}

/* ãƒœã‚¿ãƒ³ï¼ˆå³ï¼ãƒã‚¸ãƒ†ã‚£ãƒ–ã€å·¦ï¼ãƒã‚¬ãƒ†ã‚£ãƒ–ï¼‰ */
button{background:var(--btn);color:#fff;border:none;border-radius:10px;cursor:pointer}
button:hover{background:var(--btn-hover)}
.link{background:var(--link)!important}
.link:hover{background:var(--link-hover)!important}
.ghost{background:var(--ghost-bg)!important;color:var(--ghost-text)!important}
.ghost:hover{background:var(--ghost-hover)!important}
.danger{background:var(--danger)!important;color:#fff}
.danger:hover{background:var(--danger-hover)!important}

/* ãƒŠãƒ“ */
.nav{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* è¡¨/ã‚«ãƒ¼ãƒ‰ */
.table-wrap{max-height:48vh;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--card)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:6px;text-align:center;word-break:break-all}
th{position:sticky;top:0;background:var(--card);z-index:1}
.cards{display:flex;flex-direction:column;gap:8px}
.card{border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--card)}
.card-top{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card-meta{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:6px 0}
.meta-left{display:flex;gap:12px;flex-wrap:wrap;color:#555;font-size:13px}
.total{font-weight:700}

/* â€œçœŸä¸‹ã«æ–‡å­—â€ */
.choice-vertical label{display:flex;flex-direction:column;align-items:center;gap:4px}
.choice-vertical input[type="radio"],
.choice-vertical input[type="checkbox"]{width:20px;height:20px}

/* å˜ä¾¡/ç¨ å…¥åŠ›ã‚’åºƒã */
.wide-inputs input[type="number"], .wide-inputs select{padding:12px}

/* æ“ä½œãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºçµ±ä¸€ */
.actions-cell{display:flex;gap:10px;justify-content:flex-end;align-items:center;flex-wrap:wrap}
.btn-edit{background:var(--link)!important}
.btn-del{background:var(--danger)!important}
.btn-sm{padding:6px 10px!important;font-size:13px!important;border-radius:8px!important}
.btn-lg{padding:12px 16px!important;font-size:16px!important;border-radius:10px!important}
td.col-actions{width:1%;white-space:nowrap}

/* FAB */
.fab-bar{position:fixed;left:0;right:0;bottom:0;z-index:10;background:var(--card);
  border-top:1px solid var(--border);padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
  box-shadow:0 -6px 20px rgba(0,0,0,.06)}
.fab-inner{display:flex;gap:8px;max-width:560px;margin:0 auto}
.fab-inner>*{flex:1;min-width:0}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100}
.modal-content{background:var(--card);margin:6% auto;padding:12px;width:92%;max-width:560px;border-radius:10px;max-height:90vh;overflow:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;gap:8px}

/* ä¸€æ‹¬ç™»éŒ² è¡Œé–“åœ§ç¸® */
.bulk-area .bulk-row{display:grid;grid-template-columns:1.3fr 1fr 1fr auto auto;gap:8px;align-items:center}
@media (max-width:480px){
  .bulk-area .bulk-row{grid-template-columns:1fr 1fr}
  .bulk-area .bulk-row .bm-rate{grid-column:1 / -2}
}
/* 1) ãƒ€ãƒ¼ã‚¯æ™‚ã®å°ã•ãªæ–‡å­—ã‚’è¦‹ã‚„ã™ãï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆUPï¼‰ */
body.dark .muted,
body.dark .meta-left { color:#d6d6d6 !important; }     /* é‡è¦ãªå°æ–‡å­—å¸¯ */
body.dark .table-wrap,
body.dark .card { background:#131313 !important; }
body.dark th, body.dark td { border-color:#333 !important; }

/* 2) ãƒŠãƒ“ã®ãƒœã‚¿ãƒ³ãŒç¸¦ç©ã¿ï¼†æ–‡å­—ãŒç¸¦ã£ã½ãè¦‹ãˆã‚‹å¯¾ç­–
      3) ã™ã¹ã¦æ¨ªæ›¸ãã®å¼·åˆ¶ */
html, body, button, input, select, label, .nav * {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
}
.nav button {                 /* â€œå¹…100%â€ã®å½±éŸ¿ã‚’æ‰“ã¡æ¶ˆã™ */
  width:auto !important;      /* â†ã“ã‚Œã§ãƒœã‚¿ãƒ³ã®æ¨ªå¹…ã¯å†…å®¹ã«åˆã‚ã›ã‚‹ */
  padding:10px 16px;
}

/* 4) å‰Šé™¤ãƒ»ç·¨é›†ãƒœã‚¿ãƒ³ï¼šæ¨ªä¸¦ã³ï¼†åŒã‚µã‚¤ã‚ºã«çµ±ä¸€ï¼ˆè¡¨ãƒ»ã‚«ãƒ¼ãƒ‰ä¸¡æ–¹ï¼‰ */
.actions, .actions-cell { display:flex !important; gap:10px; align-items:center; }
.meta-right { display:flex; align-items:center; gap:12px; }  /* åˆè¨ˆï¼‹ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ */

.btn-sm, .btn-lg {                   /* æ—¢å­˜ã‚¯ãƒ©ã‚¹åã¯ãã®ã¾ã¾æƒãˆã‚‹ */
  padding:10px 14px !important;
  font-size:15px !important;
  border-radius:10px !important;
  min-width:100px;                   /* è¦–èªæ€§ã®ãŸã‚å›ºå®šå¹…ã‚’å°‘ã—æŒãŸã›ã‚‹ */
}

/* ã‚«ãƒ¼ãƒ‰å†…ã®é‡‘é¡ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ã‚„ã™ã•å¾®èª¿æ•´ */
.card .total { font-weight:700; }
body.dark .card .total { color:#fff; }
</style>
</head>
<body>

<!-- ãƒŠãƒ“ -->
<div class="nav">
  <button type="button" onclick="showPage('entry')" class="ghost">ä»•å…¥ã‚Œå…¥åŠ›</button>
  <button type="button" onclick="showPage('phonebook')" class="ghost">é›»è©±å¸³</button>
  <button type="button" onclick="showPage('masters')" class="ghost">ãƒã‚¹ã‚¿ç®¡ç†</button>
  <button type="button" onclick="openBulkMaster()" class="link">ğŸ§© ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²</button>
  <div class="nav-right">
    <button type="button" class="link" onclick="forceUpdateSW()">ğŸ”„ æ›´æ–°</button>
    <button type="button" id="btnTheme" class="ghost" onclick="toggleTheme()">ğŸŒ“ ãƒ€ãƒ¼ã‚¯</button>
    <span id="appVersion" class="muted">v25.2</span>
  </div>
</div>

<!-- ä»•å…¥ã‚Œå…¥åŠ› -->
<section id="page-entry">
  <h2>ä»•å…¥ã‚Œå…¥åŠ›</h2>

  <label>æ—¥ä»˜</label>
  <input type="date" id="inDate">

  <label>ä»•å…¥å…ˆ <span class="muted">ï¼ˆé¸æŠã™ã‚‹ã¨ç´ä»˜ãå•†å“ã®ã¿è¡¨ç¤ºï¼‰</span></label>
  <div class="row">
    <select id="inSupplier"></select>
    <button type="button" class="ghost" onclick="openSupplierModal()">ï¼‹ ä»•å…¥å…ˆè¿½åŠ </button>
  </div>

  <div id="supplierQuick" class="row" style="margin:6px 0; display:none;">
    <button type="button" id="btnCallSupplier" class="link" style="flex:0 0 auto;">ğŸ“ ã“ã®ä»•å…¥å…ˆã«é›»è©±</button>
    <button type="button" id="btnCopySupplier" class="ghost" style="flex:0 0 auto;">ğŸ“‹ é›»è©±ç•ªå·ã‚³ãƒ”ãƒ¼</button>
    <div id="supplierPhoneView" class="muted" style="flex:1 1 auto;"></div>
  </div>

  <label>å•†å“å</label>
  <div class="row">
    <select id="inItem"></select>
    <button type="button" class="ghost" onclick="openItemModal()">ï¼‹ å•†å“ã‚’è¿½åŠ </button>
  </div>

  <div class="row wide-inputs">
    <div><label>å˜ä¾¡</label><input type="number" id="inPrice" value="0" step="1" min="0" onfocus="this.select()"></div>
    <div><label>æ•°é‡</label><input type="number" id="inQty" value="1" step="0.1" min="0" onfocus="this.select()"></div>
  </div>

  <label>ç¨åŒºåˆ†</label>
  <div class="row">
    <div class="choice-vertical" style="flex:0 0 auto;">
      <label><input type="radio" name="inTax" value="taxIncluded"><span>ç¨è¾¼</span></label>
    </div>
    <div class="choice-vertical" style="flex:0 0 auto;">
      <label><input type="radio" name="inTax" value="taxExcluded" checked><span>ç¨åˆ¥</span></label>
    </div>
    <span class="muted" style="flex:1;">åŸºæœ¬ç¨ç‡ï¼š<b id="lblRate"></b>%ï¼ˆè¨­å®šã§å¤‰æ›´ï¼‰</span>
  </div>

  <label style="margin-top:6px;">ç¨ç‡ï¼ˆ8% / 10% ã‚¯ã‚¤ãƒƒã‚¯åˆ‡æ›¿ï¼‰</label>
  <div class="row choice-vertical" id="baseRateRadios" style="gap:18px;">
    <label style="flex:0 0 auto;"><input type="radio" name="baseRateChoice" value="8" checked><span>8%</span></label>
    <label style="flex:0 0 auto;"><input type="radio" name="baseRateChoice" value="10"><span>10%</span></label>
    <span class="small" style="flex:1;">â€» ã€Œåˆè¨ˆã€ã®è¨ˆç®—ã«ä½¿ã†ç¨ç‡</span>
  </div>

  <h3 class="row" style="align-items:center; margin-top:16px;">
    <span style="flex:0 0 auto;">ä»•å…¥ã‚Œä¸€è¦§</span>
    <span class="view-switch" style="flex:1 1 auto; display:flex; gap:10px; justify-content:flex-end; align-items:center;">
      <span>è¡¨ç¤ºï¼š</span>
      <label style="display:flex; align-items:center; gap:6px;"><input type="radio" name="viewMode" value="table"> <span>è¡¨</span></label>
      <label style="display:flex; align-items:center; gap:6px;"><input type="radio" name="viewMode" value="cards" checked> <span>ã‚«ãƒ¼ãƒ‰</span></label>
      <label style="display:flex; align-items:center; gap:6px; margin-left:10px;">
        <input type="checkbox" id="toggleAll" onchange="toggleAllRows(this)">
        <span>å…¨ä»¶è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæœ€æ–°50ä»¶ï¼‰</span>
      </label>
    </span>
  </h3>

  <div class="table-wrap" id="wrap-table" style="display:none;">
    <table id="listTable">
      <thead>
        <tr><th>æ—¥ä»˜</th><th>ä»•å…¥å…ˆ</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ç¨åŒºåˆ†</th><th>åˆè¨ˆ</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="wrap-cards" class="cards"></div>

  <div class="row" style="margin-top:10px;">
    <button type="button" class="ghost" onclick="openRestoreChooser()">å¾©å…ƒ</button>
    <button type="button" class="link"  onclick="backupJSON()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>
  /* å¾©å…ƒUI */
<div id="restoreChooser" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å¾©å…ƒ</h3>
      <button type="button" class="ghost" onclick="closeModal('restoreChooser')">âœ•</button>
    </div>
    <p class="muted" id="lastBackupHint" style="margin:6px 0;"></p>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="restoreFromFile(); closeModal('restoreChooser')">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
      <button type="button" onclick="quickRestore(); closeModal('restoreChooser')">ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
    </div>
  </div>
</div>
<input id="restoreInput" type="file" accept="application/json" style="display:none" onchange="if(this.files[0]) restoreJSON(this.files[0])">

</section>

<!-- é›»è©±å¸³ -->
<section id="page-phonebook" style="display:none;">
  <h2>ä»•å…¥å…ˆé›»è©±å¸³</h2>
  <table id="phoneTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ãƒã‚¹ã‚¿ç®¡ç† -->
<section id="page-masters" style="display:none;">
  <h2>ãƒã‚¹ã‚¿ä¸€è¦§</h2>

  <h3>ä»•å…¥å…ˆ</h3>
  <table id="supTable">
    <thead><tr><th>ä»•å…¥å…ˆ</th><th>æ‹…å½“è€…</th><th>é›»è©±ç•ªå·</th><th>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>å•†å“ï¼ˆç´ä»˜ã‘å…ˆï¼‰</h3>
  <table id="itemTable">
    <thead><tr><th>å•†å“å</th><th>åŸºæº–ä¾¡æ ¼</th><th>ç¨åŒºåˆ†</th><th>ç´ä»˜ã‘ä»•å…¥å…ˆ</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ä»•å…¥ã‚Œç·¨é›† -->
<div id="purchaseEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥ã‚Œç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('purchaseEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editPurchaseIndex">
    <label>æ—¥ä»˜</label><input type="date" id="editDate">
    <label>ä»•å…¥å…ˆ</label><select id="editSupplier"></select>
    <label>å•†å“</label><select id="editItem"></select>
    <div class="row wide-inputs">
      <div><label>å˜ä¾¡</label><input type="number" id="editPrice" step="1" min="0"></div>
      <div><label>æ•°é‡</label><input type="number" id="editQty" step="0.1" min="0"></div>
    </div>
    <label>ç¨åŒºåˆ†</label>
    <div class="row">
      <div class="choice-vertical" style="flex:0 0 auto;">
        <label><input type="radio" name="editTax" value="taxIncluded"><span>ç¨è¾¼</span></label>
      </div>
      <div class="choice-vertical" style="flex:0 0 auto;">
        <label><input type="radio" name="editTax" value="taxExcluded"><span>ç¨åˆ¥</span></label>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button type="button" class="btn-del btn-sm"  onclick="deletePurchase()">å‰Šé™¤</button>
      <button type="button" class="btn-edit btn-lg" onclick="updatePurchase()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä»•å…¥å…ˆï¼šè¿½åŠ /ç·¨é›† -->
<div id="supplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆè¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('supplierModal')">âœ•</button>
    </div>
    <label>ç¤¾å</label><input id="supName" type="text" placeholder="ä¾‹ï¼‰Aãƒ•ãƒ¼ã‚º">
    <label>æ‹…å½“è€…</label><input id="supContact" type="text" placeholder="ä¾‹ï¼‰å±±ç”°ã•ã‚“">
    <label>é›»è©±ç•ªå·</label><input id="supPhone" type="tel" placeholder="090-1234-5678">
    <label>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·ï¼ˆä»»æ„ï¼‰</label><input id="supInvoice" type="text" placeholder="ä¾‹ï¼‰T1234567890123">
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetSupplierForm()">ã‚¯ãƒªã‚¢</button>
      <button type="button" onclick="addSupplier()">ç™»éŒ²</button>
    </div>
  </div>
</div>
<div id="supplierEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä»•å…¥å…ˆç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('supplierEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editSupId">
    <label>ç¤¾å</label><input id="editSupName" type="text">
    <label>æ‹…å½“è€…</label><input id="editSupContact" type="text">
    <label>é›»è©±ç•ªå·</label><input id="editSupPhone" type="tel">
    <label>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·ï¼ˆä»»æ„ï¼‰</label><input id="editSupInvoice" type="text">
    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="deleteSupplier()">å‰Šé™¤</button>
      <button type="button" class="btn-edit btn-lg" onclick="updateSupplier()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å•†å“ï¼šè¿½åŠ /ç·¨é›† -->
<div id="itemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“è¿½åŠ </h3>
      <button type="button" class="ghost" onclick="closeModal('itemModal')">âœ•</button>
    </div>
    <label>å•†å“å</label><input id="itName" type="text" placeholder="ä¾‹ï¼‰å›½ç”£ã‚‚ã‚‚è‚‰ 2kg">
    <div class="row wide-inputs">
      <div><label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label><input id="itPrice" type="number" placeholder="0"></div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="itTax">
          <option value="taxExcluded" selected>ç¨åˆ¥</option>
          <option value="taxIncluded">ç¨è¾¼</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="itSuppliers" class="row" style="align-items:flex-start;"></div>
    <div class="muted">â€» è¤‡æ•°ã®ä»•å…¥å…ˆã‹ã‚‰è³¼å…¥å¯èƒ½ãªå•†å“ã«å¯¾å¿œã—ã¾ã™ã€‚</div>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="ghost" onclick="resetItemForm()">ã‚¯ãƒªã‚¢</button>
      <button type="button" onclick="addItem()">ç™»éŒ²</button>
    </div>
  </div>
</div>
<div id="itemEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å•†å“ç·¨é›†</h3>
      <button type="button" class="ghost" onclick="closeModal('itemEditModal')">âœ•</button>
    </div>
    <input type="hidden" id="editItemId">
    <label>å•†å“å</label><input id="editItName" type="text">
    <div class="row wide-inputs">
      <div><label>åŸºæº–ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰</label><input id="editItPrice" type="number"></div>
      <div>
        <label>ç¨åŒºåˆ†</label>
        <select id="editItTax">
          <option value="taxExcluded">ç¨åˆ¥</option>
          <option value="taxIncluded">ç¨è¾¼</option>
        </select>
      </div>
    </div>
    <label>ç´ä»˜ã‘ä»•å…¥å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <div id="editItSuppliers" class="row" style="align-items:flex-start;"></div>
    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="deleteItemDirect(document.getElementById('editItemId').value)">å‰Šé™¤</button>
      <button type="button" class="btn-edit btn-lg" onclick="updateItem()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä¾¡æ ¼å±¥æ­´ -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä¾¡æ ¼å±¥æ­´</h3>
      <button type="button" class="ghost" onclick="closeModal('historyModal')">âœ•</button>
    </div>
    <div class="table-wrap" style="max-height:50vh; margin-top:8px;">
      <table>
        <thead><tr><th>æ—¥ä»˜</th><th>ä»•å…¥å…ˆ</th><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ç¨åŒºåˆ†</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ² -->
<div id="bulkMasterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆä»•å…¥å…ˆï¼‹è¤‡æ•°å•†å“ï¼‰</h3>
      <button type="button" class="ghost" onclick="closeModal('bulkMasterModal')">âœ•</button>
    </div>

    <h4>ä»•å…¥å…ˆ</h4>
    <label>ç¤¾å</label><input id="bmSupName" type="text" placeholder="ä¾‹ï¼‰Bæ°´ç”£">
    <div class="row">
      <div><label>æ‹…å½“è€…</label><input id="bmSupContact" type="text"></div>
      <div><label>é›»è©±ç•ªå·</label><input id="bmSupPhone" type="tel"></div>
    </div>

    <h4 style="margin-top:12px;">å•†å“ï¼ˆè¤‡æ•°è¡Œè¿½åŠ å¯ï¼‰</h4>
    <div class="bulk-area">
      <div id="bmProducts"></div>
      <div class="row" style="margin-top:6px;">
        <button type="button" class="ghost" onclick="bmAddRow()">ï¼‹ å•†å“ã‚’è¿½åŠ </button>
        <button type="button" class="ghost" onclick="bmClearRows()">å•†å“ã‚’å…¨ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div id="bmDupArea" class="small muted" style="display:none; margin-top:6px;"></div>

    <div class="row" style="margin-top:8px;">
      <button type="button" class="btn-del btn-sm"  onclick="closeModal('bulkMasterModal')">ä¸­æ­¢</button>
      <button type="button" class="btn-edit btn-lg" onclick="bmSubmit()">ã¾ã¨ã‚ã¦ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- ä¸‹éƒ¨FAB -->
<div class="fab-bar">
  <div class="fab-inner">
    <button type="button" class="ghost" onclick="clearEntry()">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
    <button type="button" onclick="savePurchase()">ä¿å­˜</button>
  </div>
</div>

<script>
const APP_VERSION = 'v25.2';
document.addEventListener('DOMContentLoaded',()=>{ const el=document.getElementById('appVersion'); if(el) el.textContent=APP_VERSION; });

const LS_KEYS = { suppliers:'suppliers_v2', items:'items_v3', purchases:'purchases_v3', taxRate:'base_tax_rate_v1' };
const LS_LAST_BACKUP = 'last_backup_json_v1';
const $ = (id)=>document.getElementById(id);
const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10);

let suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || '[]');
let items     = JSON.parse(localStorage.getItem(LS_KEYS.items) || '[]');
let purchases = JSON.parse(localStorage.getItem(LS_KEYS.purchases) || '[]');

let SHOW_ALL=false, VIEW_MODE='cards', FILTER_MONTH='';

/* ç¨ç‡ */
function getBaseTaxRate(){ const v=localStorage.getItem(LS_KEYS.taxRate); return v==null?0.08:Number(v); }
function setBaseTaxRate(decimal){ localStorage.setItem(LS_KEYS.taxRate,String(decimal)); updateTaxRateLabel(); renderBaseRateRadios(); }
function updateTaxRateLabel(){ $('lblRate').textContent=Math.round(getBaseTaxRate()*1000)/10; }
function renderBaseRateRadios(){
  const pct=Math.round(getBaseTaxRate()*100); const target=pct===10?'10':'8';
  document.querySelectorAll('input[name="baseRateChoice"]').forEach(r=>{
    r.checked=(r.value===target); r.onchange=()=>setBaseTaxRate(Number(r.value)/100);
  });
}
function ensureBaseRateChecked(){
  const radios=document.querySelectorAll('input[name="baseRateChoice"]');
  if(!Array.from(radios).some(r=>r.checked)){
    const pct=Math.round(getBaseTaxRate()*100); const target=pct===10?'10':'8';
    const r=document.querySelector(`input[name="baseRateChoice"][value="${target}"]`); if(r) r.checked=true;
  }
}

/* ãƒ†ãƒ¼ãƒ */
const THEME_KEY='app_theme_v1_alt';
function applyTheme(mode){
  const isDark=mode==='dark';
  document.body.classList.toggle('dark',isDark);
  const meta=document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute('content',isDark?'#0f0f0f':'#ff9800');
  const b=$('btnTheme'); if(b) b.textContent=isDark?'â˜€ ãƒ©ã‚¤ãƒˆ':'ğŸŒ“ ãƒ€ãƒ¼ã‚¯';
  localStorage.setItem(THEME_KEY,mode);
}
function initTheme(){
  const saved=localStorage.getItem(THEME_KEY);
  if(saved==='dark'||saved==='light') applyTheme(saved);
  else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  const mq=window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener?.('change',e=>{ if(!localStorage.getItem(THEME_KEY)) applyTheme(e.matches?'dark':'light'); });
}
function toggleTheme(){ applyTheme(document.body.classList.contains('dark')?'light':'dark'); }

/* ãƒšãƒ¼ã‚¸åˆ‡æ›¿ */
function showPage(which){
  $('page-entry').style.display = which==='entry' ? 'block' : 'none';
  $('page-phonebook').style.display = which==='phonebook' ? 'block' : 'none';
  $('page-masters').style.display = which==='masters' ? 'block' : 'none';
  if(which==='phonebook') renderPhonebook();
  if(which==='masters') { renderSupTable(); renderItemTable(); }
  if(which==='entry') ensureBaseRateChecked();
}

/* åˆæœŸåŒ– */
function init(){
  const d=new Date();
  $('inDate').value=`${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;
  const defTax=document.querySelector('input[name="inTax"][value="taxExcluded"]'); if(defTax) defTax.checked=true;

  document.querySelectorAll('input[name="viewMode"]').forEach(r=> r.onchange=()=>{ VIEW_MODE=r.value; renderList(); });

  renderSupplierSelect(); renderItemSelect(); renderList();
  updateTaxRateLabel(); renderBaseRateRadios(); ensureBaseRateChecked();
  initTheme();
}
document.addEventListener('DOMContentLoaded', init);

/* ã‚»ãƒ¬ã‚¯ã‚¿ */
function renderSupplierSelect(){
  const sel=$('inSupplier');
  sel.innerHTML='<option value="">-- ä»•å…¥å…ˆã‚’é¸æŠ --</option>'+suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  sel.onchange=()=>{ renderItemSelect(sel.value); updateSupplierQuick(sel.value); };
}
function updateSupplierQuick(supplierId){
  const wrap=$('supplierQuick'); if(!supplierId){wrap.style.display='none'; return;}
  const s=suppliers.find(x=>x.id===supplierId); if(!s){wrap.style.display='none'; return;}
  wrap.style.display='flex';
  const phone=s.phone||''; const telHref=phone?`tel:${phone}`:'';
  $('supplierPhoneView').textContent=phone?`é›»è©±ç•ªå·ï¼š${phone}`:'é›»è©±ç•ªå·æœªç™»éŒ²';
  $('btnCallSupplier').onclick=()=>{ if(!phone){alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™');return;} location.href=telHref; };
  $('btnCopySupplier').onclick=()=>copyPhone(phone);
}
function renderItemSelect(supplierId=''){
  const sel=$('inItem'); let list=items;
  if(supplierId) list=items.filter(it=>(it.suppliers||[]).includes(supplierId));
  sel.innerHTML='<option value="">-- å•†å“ã‚’é¸æŠ --</option>'+list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  sel.onchange=()=>{
    const it=items.find(x=>x.id===sel.value);
    if(it){
      const last=getLastPriceFor($('inSupplier').value,it.id);
      $('inPrice').value = last!=null ? last : (it.price!=null ? it.price : 0);
      const tsel=document.querySelector(`input[name="inTax"][value="${it.taxType||'taxExcluded'}"]`); if(tsel) tsel.checked=true;
    }
  };
}
/* ä»•å…¥å…ˆï¼šæ–°è¦/ç·¨é›† */
function resetSupplierForm(){
  $('supName').value='';
  $('supContact').value='';
  $('supPhone').value='';
  const inv=$('supInvoice'); if(inv) inv.value='';
}
function addSupplier(){
  const name=$('supName').value.trim();
  if(!name) return alert('ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const sup={
    id: uid(),
    name,
    contact: $('supContact').value.trim(),
    phone: $('supPhone').value.trim(),
    invoice: ($('supInvoice')?.value||'').trim()
  };
  suppliers.push(sup);
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  resetSupplierForm();
  closeModal('supplierModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable();
}
function openSupplierEdit(id){
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  $('editSupId').value=s.id;
  $('editSupName').value=s.name||'';
  $('editSupContact').value=s.contact||'';
  $('editSupPhone').value=s.phone||'';
  if($('editSupInvoice')) $('editSupInvoice').value=s.invoice||'';
  $('supplierEditModal').style.display='block';
}
function updateSupplier(){
  const id=$('editSupId').value;
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  const name=$('editSupName').value.trim();
  if(!name) return alert('ç¤¾åã¯å¿…é ˆã§ã™');
  s.name=name;
  s.contact=$('editSupContact').value.trim();
  s.phone=$('editSupPhone').value.trim();
  s.invoice=($('editSupInvoice')?.value||'').trim();
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  closeModal('supplierEditModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable();
}
function deleteSupplier(){
  const id=$('editSupId').value;
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  if(!confirm(`ä»•å…¥å…ˆã€Œ${s.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå•†å“ç´ä»˜ã‘ã‹ã‚‰ã‚‚é™¤å¤–ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  suppliers=suppliers.filter(x=>x.id!==id);
  items=items.map(it=>({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));
  closeModal('supplierEditModal');
  renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}
/* å…¥åŠ›ã‚¨ãƒªã‚¢ */
function clearEntry(){ $('inItem').value=''; $('inQty').value=1; $('inPrice').value=0; const r=document.querySelector('input[name="inTax"][value="taxExcluded"]'); if(r) r.checked=true; }
function getLastPriceFor(supplierId,itemId){
  for(let i=purchases.length-1;i>=0;i--){ const p=purchases[i]; if(p.supplierId===supplierId&&p.itemId===itemId) return p.price; }
  return null;
}

/* ä¿å­˜ï¼ˆé‡è¤‡ã¯æ•°é‡åŠ ç®—ã‚’ææ¡ˆï¼‰ */
function savePurchase(){
  const date=$('inDate').value;
  const supplierId=$('inSupplier').value;
  const itemId=$('inItem').value;
  const qty=Number($('inQty').value||0);
  const price=Number($('inPrice').value||0);
  const taxType=(document.querySelector('input[name="inTax"]:checked')||{}).value||'taxExcluded';
  const rate=getBaseTaxRate();

  if(!date) return alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(!supplierId) return alert('ä»•å…¥å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!itemId) return alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');

  const dupIndex=purchases.findIndex(p=>p.date===date&&p.supplierId===supplierId&&p.itemId===itemId);
  if(dupIndex>=0){
    if(confirm('åŒæ—¥ã®åŒä»•å…¥å…ˆãƒ»åŒå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ•°é‡ã‚’åŠ ç®—ã—ã¾ã™ã‹ï¼Ÿ')){
      const old=purchases[dupIndex];
      const newQty=Number(old.qty)+qty;
      const total=taxType==='taxExcluded'?Math.round(newQty*price*(1+rate)):Math.round(newQty*price);
      purchases[dupIndex]={...old, qty:newQty, price, taxType, total};
      localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
      clearEntry(); renderList(); return;
    }
  }
  const total=taxType==='taxExcluded'?Math.round(qty*price*(1+rate)):Math.round(qty*price);
  purchases.push({date,supplierId,itemId,qty,price,taxType,total});
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  clearEntry(); renderList();
}

/* ä¸€è¦§è¡¨ç¤º */
function toggleAllRows(chk){ SHOW_ALL=chk.checked; renderList(); }
function getFilteredArray(){
  let arr=purchases.slice().map((p,idx)=>({p,idx})).reverse();
  if(FILTER_MONTH) arr=arr.filter(({p})=>(p.date||'').slice(0,7)===FILTER_MONTH);
  return SHOW_ALL?arr:arr.slice(0,50);
}
function renderList(){
  const wrapTable=$('wrap-table'), wrapCards=$('wrap-cards');
  if(VIEW_MODE==='table'){ wrapTable.style.display='block'; wrapCards.style.display='none'; renderListTable(); }
  else{ wrapTable.style.display='none'; wrapCards.style.display='block'; renderListCards(); }
}
function renderListTable(){
  const tb=$('listTable').querySelector('tbody'); tb.innerHTML='';
  const list=getFilteredArray();
  list.forEach(({p,idx:origIndex})=>{
    const s=suppliers.find(x=>x.id===p.supplierId);
    const i=items.find(x=>x.id===p.itemId);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.date}</td>
      <td>${s?s.name:''}</td>
      <td>${i?i.name:''}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
      <td>${p.total}</td>
      <td class="nowrap col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deletePurchaseAt(${origIndex})">å‰Šé™¤</button>
          <button class="btn-edit btn-lg" onclick="openPurchaseEdit(${origIndex})">ç·¨é›†</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderListCards(){
  const box=$('wrap-cards'); box.innerHTML='';
  const rate=getBaseTaxRate();
  const map=new Map();
  getFilteredArray().forEach(({p,idx})=>{
    const key=`${p.date}|${p.supplierId}`;
    if(!map.has(key)) map.set(key,[]);
    map.get(key).push({p,idx});
  });
  Array.from(map.entries()).forEach(([key,rows])=>{
    const [date,supId]=key.split('|');
    const s=suppliers.find(x=>x.id===supId);
    const name=s? s.name:'(ä¸æ˜)';
    let ex=0; rows.forEach(({p})=>{ ex += p.taxType==='taxExcluded' ? (p.qty*p.price) : (p.qty*p.price/(1+rate)); });
    const total=Math.round(ex*(1+rate));
    const lines=rows.map(({p,idx})=>{
      const it=items.find(x=>x.id===p.itemId);
      return `
        <div class="card-meta" style="justify-content:space-between;">
          <div class="meta-left">
            <span>${it?it.name:''}</span>
            <span>${p.qty} Ã— ${p.price}</span>
            <span>${p.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</span>
          </div>
          <div class="meta-right">
            <span class="total">${p.total} å††</span>
            <span class="actions">
              <button class="btn-del btn-sm"  onclick="deletePurchaseAt(${idx})">å‰Šé™¤</button>
              <button class="btn-edit btn-lg" onclick="openPurchaseEdit(${idx})">ç·¨é›†</button>
            </span>
          </div>
        </div>`;
    }).join('');
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-top">
        <div>${date}</div>
        <div style="font-weight:700;">${name}</div>
      </div>
      <div class="meta-left" style="margin:6px 0;">
        <span>ç¨åˆ¥å°è¨ˆï¼š<b>${Math.round(ex)}</b> å††</span>
        <span>åˆè¨ˆï¼ˆ${Math.round(rate*100)}%ï¼‰ï¼š<b class="total">${total}</b> å††</span>
      </div>
      ${lines}`;
    box.appendChild(card);
  });
}

/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼å¾©å…ƒ */
async function backupJSON(){
  const fileName=`shiire-backup_${new Date().toISOString().slice(0,10)}.json`;
  const data={version:1,savedAt:new Date().toISOString(),suppliers,items,purchases,taxRate:localStorage.getItem(LS_KEYS.taxRate)};
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const file=new File([blob],fileName,{type:'application/json'});
  try{ localStorage.setItem(LS_LAST_BACKUP,json); }catch(_){}
  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{ await navigator.share({title:'ä»•å…¥ã‚Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',text:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã§ã™ã€‚',files:[file]}); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return; }
    catch(e){ if(e.name==='AbortError') return; }
  }
  if('showSaveFilePicker' in window){
    try{
      const handle=await window.showSaveFilePicker({suggestedName:fileName,types:[{description:'JSON',accept:{'application/json':['.json']}}]});
      const w=await handle.createWritable(); await w.write(blob); await w.close(); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); return;
    }catch(e){ if(e.name==='AbortError') return; }
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href); alert('JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
}
function openRestoreChooser(){
  const hint=document.getElementById('lastBackupHint');
  const has=!!localStorage.getItem(LS_LAST_BACKUP);
  hint.textContent= has ? 'ç«¯æœ«å†…ã«ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å¾©å…ƒã§ãã¾ã™ã€‚'
                         : 'ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§å¾©å…ƒã—ã¦ãã ã•ã„ã€‚';
  document.getElementById('restoreChooser').style.display='block';
}
async function restoreFromFile(){
  try{
    if('showOpenFilePicker' in window){
      const [handle]=await window.showOpenFilePicker({types:[{description:'JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',accept:{'application/json':['.json']}}]});
      const f=await handle.getFile(); const text=await f.text(); const data=JSON.parse(text);
      _applyRestore(data); alert('å¾©å…ƒã—ã¾ã—ãŸ'); return;
    }
  }catch(e){ if(e.name!=='AbortError') alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); return; }
  const input=document.getElementById('restoreInput'); if(input) input.click();
}
function quickRestore(){
  try{
    const json=localStorage.getItem(LS_LAST_BACKUP);
    if(!json){ alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚'); return; }
    const data=JSON.parse(json); _applyRestore(data); alert('ç›´è¿‘ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ');
  }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); }
}
function restoreJSON(file){
  const r=new FileReader();
  r.onload=()=>{ try{ _applyRestore(JSON.parse(r.result)); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(e){ alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); } };
  r.readAsText(file);
}
function _applyRestore(data){
  if(!data||!data.suppliers||!data.items||!data.purchases) throw new Error('å½¢å¼ä¸æ­£');
  suppliers=data.suppliers; items=data.items; purchases=data.purchases;
  if(data.taxRate!=null) localStorage.setItem(LS_KEYS.taxRate,String(data.taxRate));
  localStorage.setItem(LS_KEYS.suppliers,JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  renderSupplierSelect(); renderItemSelect(); renderList(); renderPhonebook(); renderSupTable(); renderItemTable(); updateTaxRateLabel();
}

/* é›»è©±å¸³ */
function renderPhonebook(){
  const tb=$('phoneTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    const telHref=s.phone?`tel:${s.phone}`:'';
    tr.innerHTML=`
      <td>${s.name||''}</td>
      <td>${s.contact||''}</td>
      <td>${s.phone||''}</td>
      <td>
        <div class="row">
          <a class="link" style="text-align:center;text-decoration:none;padding:8px;border-radius:8px;display:block;" href="${telHref}" ${s.phone?'':'onclick="return false;"'}>ğŸ“ é›»è©±</a>
          <button type="button" class="ghost" onclick="copyPhone('${s.phone||''}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
async function copyPhone(num){
  if(!num){ alert('é›»è©±ç•ªå·ãŒæœªç™»éŒ²ã§ã™'); return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(num); }
    else{ const ta=document.createElement('textarea'); ta.value=num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    alert('é›»è©±ç•ªå·ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }catch(e){ alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š'+e.message); }
}

/* ãƒã‚¹ã‚¿ä¸€è¦§ */
function renderSupTable(){
  const tb=$('supTable').querySelector('tbody'); tb.innerHTML='';
  suppliers.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.contact||''}</td>
      <td class="nowrap">${s.phone||''}</td>
      <td class="nowrap">${s.invoice||''}</td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deleteSupplierById('${s.id}')">å‰Šé™¤</button>
          <button class="btn-edit btn-lg" onclick="openSupplierEdit('${s.id}')">ç·¨é›†</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderItemTable(){
  const tb=$('itemTable').querySelector('tbody'); tb.innerHTML='';
  items.forEach(it=>{
    const names=(it.suppliers||[]).map(id=>(suppliers.find(s=>s.id===id)||{}).name).filter(Boolean);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.name}</td>
      <td>${it.price!=null?it.price:''}</td>
      <td>${it.taxType==='taxExcluded'?'ç¨åˆ¥':'ç¨è¾¼'}</td>
      <td>${names.join(' / ')}</td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn-del btn-sm"  onclick="deleteItemDirect('${it.id}')">å‰Šé™¤</button>
          <button class="btn-edit btn-lg" onclick="openItemEdit('${it.id}')">ç·¨é›†</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ç·¨é›†ãƒ»å‰Šé™¤ */
function openPurchaseEdit(index){
  const p=purchases[index]; if(!p) return;
  $('editPurchaseIndex').value=String(index);
  $('editDate').value=p.date;

  const supSel=$('editSupplier'); supSel.innerHTML=suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); supSel.value=p.supplierId;
  const itemSel=$('editItem'); const list=items.filter(it=>(it.suppliers||[]).includes(p.supplierId));
  itemSel.innerHTML=list.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); itemSel.value=p.itemId;
  supSel.onchange=()=>{ const list2=items.filter(it=>(it.suppliers||[]).includes(supSel.value)); itemSel.innerHTML=list2.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); };

  $('editQty').value=p.qty; $('editPrice').value=p.price;
  const r=document.querySelector(`input[name="editTax"][value="${p.taxType}"]`); if(r) r.checked=true;

  $('purchaseEditModal').style.display='block';
}
function updatePurchase(){
  const idx=Number($('editPurchaseIndex').value);
  const date=$('editDate').value;
  const supplierId=$('editSupplier').value;
  const itemId=$('editItem').value;
  const qty=Number($('editQty').value||0);
  const price=Number($('editPrice').value||0);
  const taxType=(document.querySelector('input[name="editTax"]:checked')||{}).value||'taxExcluded';
  const rate=getBaseTaxRate();
  if(!date||!supplierId||!itemId) return alert('æ—¥ä»˜ãƒ»ä»•å…¥å…ˆãƒ»å•†å“ã¯å¿…é ˆã§ã™');
  const total=taxType==='taxExcluded'?Math.round(qty*price*(1+rate)):Math.round(qty*price);
  purchases[idx]={date,supplierId,itemId,qty,price,taxType,total};
  localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases));
  closeModal('purchaseEditModal'); renderList();
}
function deletePurchase(){ const idx=Number($('editPurchaseIndex').value); if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; purchases.splice(idx,1); localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases)); closeModal('purchaseEditModal'); renderList(); }
function deletePurchaseAt(index){ if(!confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; purchases.splice(index,1); localStorage.setItem(LS_KEYS.purchases,JSON.stringify(purchases)); renderList(); }
function deleteSupplierById(id){
  const s=suppliers.find(x=>x.id===id); if(!s) return;
  if(!confirm(`ä»•å…¥å…ˆã€Œ${s.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå•†å“ç´ä»˜ã‘ã‹ã‚‰ã‚‚é™¤å¤–ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  suppliers=suppliers.filter(x=>x.id!==id);
  items=items.map(it=>({...it, suppliers:(it.suppliers||[]).filter(sid=>sid!==id)}));
  localStorage.setItem(LS_KEYS.suppliers,JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  renderSupplierSelect(); renderPhonebook(); renderSupTable(); renderItemTable(); renderItemSelect($('inSupplier').value);
}

/* å•†å“ï¼šæ–°è¦/ç·¨é›† */
function openItemModal(){ resetItemForm(); renderItemSupplierChecks(); const m=$('itemModal'); if(!m){alert('itemModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} m.style.display='block'; }
function resetItemForm(){ $('itName').value=''; $('itPrice').value=''; $('itTax').value='taxExcluded'; }
function renderItemSupplierChecks(target='itSuppliers'){
  const box=$(target);
  if(suppliers.length===0){ box.innerHTML='<div class="muted">ä»•å…¥å…ˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä»•å…¥å…ˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>'; return; }
  box.innerHTML=suppliers.map(s=>`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" value="${s.id}"> ${s.name}</label>`).join('');
}
function addItem(){
  const name=normName($('itName').value); if(!name) return alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(items.some(it=>normName(it.name)===name) && !confirm('åŒåã®å•†å“ãŒå­˜åœ¨ã—ã¾ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const priceStr=$('itPrice').value.trim(); const price=priceStr===''?null:Number(priceStr);
  const taxType=$('itTax').value;
  const checks=Array.from($('itSuppliers').querySelectorAll('input[type="checkbox"]:checked')); const supIds=checks.map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ã‚‹ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
  items.push({id:uid(),name,price,taxType,suppliers:supIds});
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  resetItemForm(); renderItemSupplierChecks(); renderItemSelect($('inSupplier').value); renderItemTable();
}
function openItemEdit(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  $('editItemId').value=it.id; $('editItName').value=it.name; $('editItPrice').value=it.price!=null?it.price:''; $('editItTax').value=it.taxType||'taxExcluded';
  renderItemSupplierChecks('editItSuppliers');
  (it.suppliers||[]).forEach(sid=>{ const chk=$('editItSuppliers').querySelector(`input[value="${sid}"]`); if(chk) chk.checked=true; });
  $('itemEditModal').style.display='block';
}
function updateItem(){
  const id=$('editItemId').value; const it=items.find(x=>x.id===id); if(!it) return;
  const name=normName($('editItName').value); if(!name) return alert('å•†å“åã¯å¿…é ˆã§ã™');
  if(name!==normName(it.name) && items.some(x=>normName(x.name)===name) && !confirm('åŒåã®å•†å“ãŒå­˜åœ¨ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  const priceStr=$('editItPrice').value.trim(); it.price=priceStr===''?null:Number(priceStr);
  it.name=name; it.taxType=$('editItTax').value;
  const supIds=Array.from($('editItSuppliers').querySelectorAll('input[type="checkbox"]:checked')).map(c=>c.value);
  if(supIds.length===0) return alert('ç´ä»˜ã‘ä»•å…¥å…ˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
  it.suppliers=supIds;
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  closeModal('itemEditModal'); renderItemSelect($('inSupplier').value); renderItemTable();
}
function deleteItemDirect(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  if(purchases.some(p=>p.itemId===id)){ alert('ã“ã®å•†å“ã¯ä»•å…¥ã‚Œå±¥æ­´ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«è©²å½“ã®ä»•å…¥ã‚Œã‚’å‰Šé™¤/ç·¨é›†ã—ã¦ãã ã•ã„ã€‚'); return; }
  if(!confirm(`å•†å“ã€Œ${it.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  items=items.filter(x=>x.id!==id);
  localStorage.setItem(LS_KEYS.items,JSON.stringify(items));
  renderItemSelect($('inSupplier').value); renderItemTable();
}

/* ä¸€æ‹¬ãƒã‚¹ã‚¿ç™»éŒ² */
let bmRowCounter=0;
function bmRowTemplate(idx){
  return `
    <div class="bulk-row">
      <input type="text"  class="bm-name"  placeholder="å•†å“å">
      <input type="number" class="bm-price" placeholder="ä¾¡æ ¼">
      <select class="bm-tax" aria-label="ç¨åŒºåˆ†">
        <option value="taxExcluded" selected>ç¨åˆ¥</option>
        <option value="taxIncluded">ç¨è¾¼</option>
      </select>
      <div class="bm-rate choice-vertical" style="justify-self:start;">
        <label><input type="radio" name="bmRate${idx}" value="0.08" checked><span>8%</span></label>
        <label><input type="radio" name="bmRate${idx}" value="0.10"><span>10%</span></label>
      </div>
      <button type="button" class="danger" onclick="this.closest('.bulk-row').remove()">å‰Šé™¤</button>
    </div>`;
}
function openBulkMaster(){
  bmClearRows(); bmAddRow();
  $('bmSupName').value=''; $('bmSupContact').value=''; $('bmSupPhone').value='';
  $('bmDupArea').style.display='none'; $('bmDupArea').innerHTML='';
  $('bulkMasterModal').style.display='block';
}
function bmAddRow(){ const wrap=$('bmProducts'); const idx=++bmRowCounter; const div=document.createElement('div'); div.innerHTML=bmRowTemplate(idx); wrap.appendChild(div.firstElementChild); }
function bmClearRows(){ $('bmProducts').innerHTML=''; }
function bmSubmit(){
  const supName=$('bmSupName').value.trim(); if(!supName) return alert('ä»•å…¥å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const rows=Array.from(document.querySelectorAll('#bmProducts .bulk-row')); if(rows.length===0) return alert('å•†å“è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„');

  const names=rows.map(r=>normName(r.querySelector('.bm-name').value)).filter(Boolean);
  const dups=names.filter(n=>items.some(it=>normName(it.name)===n));
  if(dups.length>0){
    const area=$('bmDupArea');
    area.style.display='block';
    area.innerHTML='æ—¢å­˜ã¨åŒåã®å•†å“ãŒã‚ã‚Šã¾ã™ï¼š<br>ãƒ»'+Array.from(new Set(dups)).join('<br>ãƒ»')+'<br>ç¶šè¡Œã™ã‚‹ã¨æ–°è¦ã¨ã—ã¦è¿½åŠ ã•ã‚Œã¾ã™ã€‚';
    if(!confirm('é‡è¤‡å€™è£œãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  const sup={id:uid(),name:supName,contact:$('bmSupContact').value.trim(),phone:$('bmSupPhone').value.trim()};
  suppliers.push(sup);

  rows.forEach(row=>{
    const name=normName(row.querySelector('.bm-name').value); if(!name) return;
    const priceStr=row.querySelector('.bm-price').value.trim();
    const price=priceStr===''?null:Number(priceStr);
    const taxType=row.querySelector('.bm-tax').value;
    const taxRate=Number((row.querySelector('input[type="radio"]:checked')||{value:'0.08'}).value);
    items.push({ id:uid(), name, price, taxType, taxRate, suppliers:[sup.id] });
  });

  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(suppliers));
  localStorage.setItem(LS_KEYS.items, JSON.stringify(items));

  closeModal('bulkMasterModal'); renderSupplierSelect(); renderItemSelect(); renderPhonebook(); renderSupTable(); renderItemTable();
  alert('ä¸€æ‹¬ç™»éŒ²ã—ã¾ã—ãŸ');
}

/* å…±é€š */
function closeModal(id){ const m=$(id); if(m) m.style.display='none'; }
window.addEventListener('click',e=>{
  if(e.target===$('supplierModal')) closeModal('supplierModal');
  if(e.target===$('supplierEditModal')) closeModal('supplierEditModal');
  if(e.target===$('itemModal')) closeModal('itemModal');
  if(e.target===$('itemEditModal')) closeModal('itemEditModal');
  if(e.target===$('purchaseEditModal')) closeModal('purchaseEditModal');
  if(e.target===$('historyModal')) closeModal('historyModal');
  if(e.target===$('bulkMasterModal')) closeModal('bulkMasterModal');
  if(e.target===$('restoreChooser')) closeModal('restoreChooser');
});

/* PWA */
if('serviceWorker' in navigator){
  window.addEventListener('load', async ()=>{
    try{
      const reg=await navigator.serviceWorker.register('./sw.js?ver=25.2',{updateViaCache:'none'});
      document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') reg.update(); });
    }catch(e){}
  });
}
async function forceUpdateSW(){
  if(!('serviceWorker' in navigator)){ alert('ã“ã®ç’°å¢ƒã¯æœªå¯¾å¿œã§ã™'); return; }
  try{
    const reg=await navigator.serviceWorker.getRegistration();
    if(!reg){ alert('Service Workeræœªç™»éŒ²ã§ã™'); return; }
    await reg.update();
    if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(!window.__reloading){ window.__reloading=true; location.reload(); } });
    alert('æ›´æ–°å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚æ•°ç§’ã§ç”»é¢ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚');
  }catch(e){ alert('æ›´æ–°ã«å¤±æ•—: '+e.message); }
}

/* util */
function normName(s){ return String(s||'').trim().replace(/\s+/g,' '); }
</script>
</body>
</html>
