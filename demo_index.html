<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self'; connect-src 'self' https://cafetabco.pussycat.jp https://cafetabco.com https://www.cafetabco.com https://www.google-analytics.com https://region1.google-analytics.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; manifest-src 'self'">
<link rel="manifest" href="/demo/manifest.webmanifest?v=20260110">
<link rel="apple-touch-icon" href="/icons/icon-180-v223i.png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/dark.css">

<style>
  :root { --fp-accent: #ffb300; } /* アクセント色（見やすい黄橙） */

  /* 全体を少し大きく＆数字を太く */
  .flatpickr-calendar { font-size: 16px; }
  .flatpickr-day {
    font-weight: 700;
    letter-spacing: .2px;           /* ほんの少し字間を足して読みやすく */
    border-radius: 10px;
  }

  /* 今日の枠をくっきり */
  .flatpickr-day.today:not(.selected) {
    box-shadow: inset 0 0 0 2px var(--fp-accent);
  }

  /* 選択色を高コントラストに */
  .flatpickr-day.selected,
  .flatpickr-day.startRange,
  .flatpickr-day.endRange {
    background: var(--fp-accent) !important;
    color: #111 !important;         /* 黒字でくっきり */
  }

  /* 曜日ヘッダもしっかり */
  .flatpickr-weekday { font-weight: 800; color:#e9e9e9; }

  /* 無効/他月の日付は弱めに（暗色テーマ向け） */
  .flatpickr-day.disabled, .flatpickr-day.nextMonthDay, .flatpickr-day.prevMonthDay {
    color: #888 !important;
  }
</style>
<style>
  /* flatpickr が付いた入力にカレンダーアイコンを表示 */
  .flatpickr-input{
    background:
      no-repeat right .6rem center / 1.1rem
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23bfbfbf' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='4' width='18' height='18' rx='2' ry='2'/><line x1='16' y1='2' x2='16' y2='6'/><line x1='8' y1='2' x2='8' y2='6'/><line x1='3' y1='10' x2='21' y2='10'/></svg>");
    padding-right: 2rem; /* アイコン分の余白 */
    cursor: pointer;
  }
</style>

  <title>Tabco Ledger Plus 1.0仕入れ管理</title>
<style>
:root{
  --brand:#FFC107; --brand-ink:#1A1300;
  --bg:#FFFBEA; --card:#FFFDF3;
  --text:#111; --muted:#6B6B6B; --divider:#EEDB9A;
  --danger:#D73C3C; --shadow:0 2px 10px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#18191B; --text:#F5F5F5; --muted:#BABABA; --card:#222325; --divider:#2B2C2F;
  --shadow:0 2px 10px rgba(0,0,0,.5);
}
/* === ダーク時の淡色カード対策 ================== */
:root{ --card-bg-soft:#FFF8D6; --card-fg-soft:#2A1A00; }
[data-theme="dark"]{ --card-bg-soft:#FFF2B8; --card-fg-soft:#2A1A00; }
#todayList .list-item{ background:var(--card-bg-soft)!important; color:var(--card-fg-soft)!important; }
#todayList .list-item b,#todayList .list-item u,#todayList .list-item .muted,#todayList .list-item .entry span{ color:var(--card-fg-soft)!important; opacity:1; }
#btnAddLine{ background:var(--card-bg-soft)!important; color:var(--card-fg-soft)!important; border:2px solid rgba(0,0,0,.18); }
[data-theme="dark"] #btnAddLine{ border-color: rgba(0,0,0,.26); }

html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}

/* ヘッダー */
.app-header{position:sticky;top:0;z-index:10;background:var(--brand);color:var(--brand-ink);
  padding:10px 12px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;box-shadow:var(--shadow)}
.app-header h1{margin:0;text-align:center;font-size:18px;letter-spacing:.04em}
.hdr-left{justify-self:start}.hdr-right{justify-self:end;display:flex;gap:8px;align-items:center}
#btnHome{font-size:12px;padding:4px 8px}
.ver{background:#ffffff80;border:1px solid #ffffffa6;border-radius:999px;padding:2px 8px}
#btnHome{background:#FFE082;color:#5A3A00;border:1px solid #FFFFFF99;box-shadow:0 1px 0 rgba(0,0,0,.06)}

/* ベース */
.container{padding:14px;max-width:960px;margin:0 auto}
.nav-vertical{display:flex;flex-direction:column;gap:10px;margin:10px 0}
.btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-weight:700;letter-spacing:.02em;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.btn.primary{background:var(--brand);color:var(--brand-ink)}
.btn.ghost{background:var(--card);border:1px solid var(--divider);color:var(--text)}
.btn.danger{background:#fff;border:1px solid var(--danger);color:var(--danger)}
.btn.small{padding:8px 12px;font-weight:600}
.btn.square{width:100%;height:56px;padding:8px 10px;line-height:1.1;text-align:center;flex-direction:column}
.btn.square .twoline{display:block;line-height:1.1}
#btnAddLine{background:#FFF7CC;border:2px solid #E0B600}
.btn.op{background:#FFF3B0;border:2px solid #E0B600;color:#5A3A00}
.btn.op:active,#btnHome:active{transform:translateY(1px)}

.label{font-size:13px;color:var(--muted);margin:0 0 6px 2px}
.card{background:var(--card);border:1px solid var(--divider);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
input,select,textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--divider);background:#fff;color:var(--text);padding:12px;font-size:16px}
textarea{min-height:84px;resize:vertical}
.row{display:flex;gap:10px;align-items:center}
.row .grow{flex:1}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#FFECB3;color:#5A3A00;font-size:12px}
.section-title{font-weight:800;margin:6px 0 8px}
.fixed-bar{position:sticky;bottom:0;display:flex;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 30%);padding:12px 14px}
.fixed-bar .neg{flex:1}.fixed-bar .pos{flex:2}
.list{display:flex;flex-direction:column;gap:8px}
.list-item{padding:10px 12px;border:1px solid var(--divider);border-radius:12px;background:var(--card)}
#todayList .list-item{background:#FFFDF8;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.list-item.supplier{display:grid;grid-template-columns:1fr 102px;gap:10px;min-height:120px}
.ops-col{display:flex;flex-direction:column;gap:8px;align-items:stretch}
/* Purchase CTA (購入ボタン) */
:root { --tlp-buy-width: 320px; }  /* 必要があればここで全体幅を調整 */

.tlp-buy-btn-group{
  display:flex; flex-direction:column; align-items:center;
  gap:12px; margin:12px 0;
 }
#plans-cta.tlp-buy-btn-group{ display:flex; gap:0px; flex-wrap:wrap; }

.tlp-buy-btn{
  display:block; width:var(--tlp-buy-width); max-width:var(--tlp-buy-width);
  margin:0 auto; padding:10px 16px;
  font-size:17px; line-height:1.1; font-weight:800;
  color:#fff; background:#f6bf50; border:1px solid rgba(0,0,0,.12);
  border-radius:14px; text-align:center; text-decoration:none; box-shadow:none;
}
.tlp-buy-btn[aria-disabled="true"]{ pointer-events:none; opacity:.6; }

.tlp-cta-note{ opacity:.7; font-size:12px; }
@media (pointer:fine){ .tlp-buy-btn:hover{ opacity:.98; } }
#plans-cta [hidden]{ display:none !important; }

/* テーマトグル */
.theme-toggle{width:40px;height:28px;border-radius:20px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.9);display:flex;align-items:center;padding:2px;cursor:pointer}
.theme-toggle .knob{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#FFD54F;transition:transform .2s ease}
[data-theme="dark"] .theme-toggle{background:#2C2C2E;border-color:#444}
[data-theme="dark"] .theme-toggle .knob{background:#B0B3FF;transform:translateX(12px)}

/* 年度モード表示（前年度のときは注意色） */
.hdr-pill{background:#ffffff80;border:1px solid #ffffffa6;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800;white-space:nowrap}
body.mode-prev-year .hdr-pill{background:#fff;border-color:var(--danger);color:var(--danger)}


/* モーダル */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:flex-end}
.modal{width:100%;background:var(--card);border-radius:16px 16px 0 0;border:1px solid var(--divider);box-shadow:var(--shadow);padding:14px}
.modal h3{margin:2px 0 8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:12px;flex-wrap:nowrap}
.modal .actions .btn{height:44px}
.modal .actions .btn--save{flex:0 0 45%}
.modal .actions .btn--cancel{flex:0 0 30%}
.modal .actions .btn--delete{flex:0 0 18%}
@media (min-width:560px){
  .modal .actions .btn--save{flex-basis:38%}
  .modal .actions .btn--cancel{flex-basis:24%}
  .modal .actions .btn--delete{flex-basis:16%}
}
.sheet{max-width:560px;margin:0 auto}
.hidden{display:none!important}
.mini-meta{font-size:.85em;opacity:.7}
[data-theme="dark"] select,[data-theme="dark"] input,[data-theme="dark"] textarea{background:var(--card);color:var(--text);border-color:#3a3b3f}
[data-theme="dark"] select option{background:#2a2b2e;color:#f5f5f5}
[data-theme="dark"] input::placeholder,[data-theme="dark"] textarea::placeholder{color:rgba(245,245,245,.6)}
[data-theme="dark"] .label{color:#ddd}
[data-theme="dark"] #hisRange{background:var(--card)!important;color:var(--text)!important;border-color:#3a3b3f!important}

/* 広告（Freeのみ） */
#adSlot{ display:none; }
#adSlot.visible{ display:block; }
#adSlot .ad{ display:flex; gap:10px; align-items:center; border:1px dashed #e0b600; padding:10px; border-radius:12px; background:#fffef5; }
[data-theme="dark"] #adSlot .ad{ background:#2a2a1f; border-color:#8a7b1b; }
#adSlot small{ color:var(--muted); }
.tlp-badge, #tlpBadge { pointer-events: none; }

</style>
<style>
  /* === EULA Hard Consent === */
  #eulaOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);z-index:2147483647;}
  #eulaOverlay.show{display:flex;}
  #eulaDialog{max-width:640px;width:min(92vw,640px);background:#111;color:#fff;border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,.45); padding:20px; outline:0;}
  #eulaDialog h2{margin:0 0 8px;font-size:1.1rem}
  #eulaDialog p{margin:.6em 0;line-height:1.6}
  #eulaActions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  #btnEulaAgree{padding:.7em 1.1em;border:0;border-radius:10px;cursor:pointer}
  #btnEulaAgree{background:#00a86b;color:#fff}
  #eulaLinks a{color:#9ad5ff;text-decoration:underline}
  body.eula-locked{overflow:hidden}
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-STPSS3412P"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-STPSS3412P');
</script>
<script>
(() => {
  const send = (name, params = {}) => {
    if (typeof gtag !== 'function') return;
    gtag('event', name, { event_category: 'pwa', ...params });
  };

  // 「インストールできます」状態になった回数（Chrome/Edge中心）
  window.addEventListener('beforeinstallprompt', (e) => {
    try {
      send('pwa_install_prompt_shown', { page_location: location.href });
    } catch (_) {}

    // 既存のインストール導線があるなら、必要に応じて参照できるように保持（邪魔しない）
    window.tlpInstallPromptEvent = e;

    // outcomeが取れる環境だけ取る（取れなくてもOK）
    if (e && e.userChoice && typeof e.userChoice.then === 'function') {
      e.userChoice.then((choice) => {
        send('pwa_install_prompt_choice', { outcome: choice.outcome });
      }).catch(() => {});
    }
  });

  // 実際にインストール完了した回数（取れる環境のみ）
  window.addEventListener('appinstalled', () => {
    try { send('pwa_install_installed'); } catch (_) {}
  });
})();
</script>

</head>
<body>
<header class="app-header">
  <div class="hdr-left"><button id="btnHome" class="btn ghost small hidden" type="button">HOME</button></div>
  <h1 id="pageTitle">仕入れ管理</h1>
  <div class="hdr-right">
    <button id="themeBtn" class="theme-toggle" aria-label="テーマ切替"><div class="knob"><span id="themeIcon">☀</span></div></button>
    <span id="pillYearMode" class="hdr-pill" aria-label="対象年度">-</span>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="page-home">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <span class="pill" id="pillBackup">最終バックアップ：未実施</span>
      <span class="pill" id="pillPlan">プラン：無料</span>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      <div class="card"><div class="label">今週の仕入れ合計（税込）</div><div id="kpiWeek" style="font-weight:800;font-size:20px">¥0</div></div>
      <div class="card"><div class="label">今月の仕入れ合計（税込）</div><div id="kpiMonth" style="font-weight:800;font-size:20px">¥0</div></div>
    </div>
    <div class="nav-vertical" style="margin-top:12px">
      <button class="btn primary" data-goto="input" type="button">仕入入力</button>
      <button class="btn ghost" data-goto="history" type="button">履歴・集計</button>
      <button class="btn ghost" data-goto="suppliers" type="button">仕入れ先マスタ</button>
      <button class="btn ghost" data-goto="products" type="button">商品マスタ</button>
      <button class="btn ghost" id="btnExport" type="button">データ出力</button>
      <button class="btn ghost" data-goto="backup" type="button">バックアップ設定</button>
      <button class="btn ghost" data-goto="license" type="button">Plans</button>
      <button class="btn ghost" data-goto="rights" type="button">Licenses＆Notices</button>
     <button class="btn danger" id="btnFactoryReset" type="button">データ初期化</button>
      <div class="label">※初期化の前にバックアップを取ってください。</div>
    </div>

    <!-- HOME 広告カード -->
<div id="homeAdCard" class="home-card">
  <a id="homeAdLink" class="home-ad-link" target="_blank" rel="noopener">
    <div id="homeAdTitle" class="home-ad-main"></div>
    <div id="homeAdBody"  class="home-ad-sub"></div>
  </a>
</div>
<style>
/* HOME広告リンクの色（チョコレート色） */
#homeAdLink,
#homeAdLink:visited {
  color: #8B4513 !important;  /* chocolate */
  text-decoration: none;
}
</style>  
</section>

  <!-- INPUT -->
  <section id="page-input" class="hidden" data-title="仕入入力">
    <div class="card grid">
      <div class="grid cols-2">
        <div><div class="label" id="lblInDate">日付</div><input type="date" id="inDate"></div>
        <div><div class="label">仕入れ先</div><select id="inSupplier"></select></div>
      </div>
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">商品（仕入れ先で絞込）</div>
          <label class="row" style="gap:6px"><input type="checkbox" id="chkFree"> 未登録で入力</label>
        </div>
        <input id="prodSearch" type="text" placeholder="商品名で検索（部分一致）" class="grow" />
        <select id="inProduct" style="margin-top:6px"></select>
        <div id="freeFields" class="grid cols-2 hidden" style="margin-top:8px">
          <div><div class="label">仕入れ先名（未登録）</div><input id="freeSupplier" type="text"></div>
          <div><div class="label">商品名（未登録）</div><input id="freeProduct" type="text"></div>
        </div>
      </div>
      <div class="grid cols-2">
        <div><div class="label">価格</div><input type="number" id="inPrice" inputmode="numeric" pattern="[0-9]*"></div>
        <div><div class="label">数量</div><input type="number" id="inQty" value="1" inputmode="numeric" pattern="[0-9]*"></div>
      </div>
      <div class="row">
        <div class="row" style="gap:16px">
          <label><input type="radio" name="taxmode" value="incl"> 税込</label>
          <label><input type="radio" name="taxmode" value="excl" checked> 税別</label>
        </div>
        <div class="row" style="gap:10px;margin-left:auto">
          <span class="label">税率</span>
          <label><input type="radio" name="taxrate" value="10">10%</label>
          <label><input type="radio" name="taxrate" value="8" checked>8%</label>
          <label><input type="radio" name="taxrate" value="0">非課税</label>
        </div>
      </div>
      <div><div class="label">価格履歴（直近）</div><div id="priceHistory" class="row" style="flex-wrap:wrap"></div></div>
      <div><div class="label">メモ（任意）</div><input id="inMemo"></div>
      <button class="btn ghost" id="btnAddLine" type="button">＋ 明細を追加</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="section-title">本日の明細（仕入れ先で自動グループ）</div>
      <div id="todayList" class="list"></div>
    </div>
   <div class="fixed-bar">
  <button class="btn ghost small neg" id="btnClear" type="button">クリア</button>
  <button class="btn primary pos" id="btnSave" type="button" title="入力が残っていると確認が出ます">完了（ホームへ）</button>
</div>
  </section>

  <!-- SUPPLIERS -->
  <section id="page-suppliers" class="hidden" data-title="仕入れ先マスタ">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="section-title">仕入れ先一覧</div>
      <button class="btn primary small" id="btnAddSupplier" type="button">＋ 追加</button>
    </div>
    <div id="supplierList" class="list"></div>
  </section>

  <!-- PRODUCTS -->
  <section id="page-products" class="hidden" data-title="商品マスタ">
    <div class="row" style="gap:8px;align-items:center">
      <div class="grow"><div class="label">仕入れ先で絞込</div><select id="filterProdSupplier"></select></div>
      <button class="btn primary small" id="btnAddProduct" type="button">＋ 追加</button>
    </div>
    <div id="productList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- HISTORY -->
  <section id="page-history" class="hidden" data-title="履歴・集計">
    <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div><div class="label">期間</div><select id="hisRange">
        <option value="7">今週（月〜日）</option>
        <option value="30">今月（1日〜月末）</option>
        <option value="fiscal">年度（1月〜今月）</option>
      </select></div>
      <div class="grow">
        <div class="label">仕入れ先で絞込</div>
        <select id="hisSupplier"></select>
      </div>
      <div class="row" style="gap:16px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleGross" checked> 税別小計＋税込表示</label>
        <label class="row" style="gap:6px"><input type="checkbox" id="showDetail"> 明細の詳細（単価・税情報）</label>
      </div>
    </div>

    <div id="historyList" class="list" style="margin-top:10px"></div>
    <div class="fixed-bar"><button class="btn ghost neg" id="btnExport2" type="button">データ出力</button><button class="btn primary pos" data-goto="home" type="button">ホームへ</button></div>
  </section>

  <!-- BACKUP -->
  <section id="page-backup" class="hidden" data-title="バックアップ設定">
    <div class="card">
      <div class="label">最終バックアップ</div><div id="bkLast">未実施</div>
      <p id="bkMemo" class="muted" style="font-size:12px;margin:4px 0 0">プラン情報は端末ごとに保持され、バックアップには含まれません。</p><hr>
      <div class="label">自動バックアップ（将来拡張）</div>
      <div class="row" style="gap:16px">
        <label><input type="radio" name="bksched" value="daily" checked> 毎日22:00</label>
        <label><input type="radio" name="bksched" value="weekly"> 毎週 月曜</label>
        <label><input type="radio" name="bksched" value="manual"> 手動のみ</label>
      </div><hr>
      <div class="row" style="gap:10px;align-items:center">
        <label class="row" style="gap:6px"><input type="checkbox" id="toggleAutoClear" checked> ＋明細追加後に入力欄をクリア</label>
      </div><hr>
      <div class="row" style="gap:10px"><button class="btn primary" id="btnBackupNow" type="button">今すぐバックアップ</button><button class="btn ghost" id="btnRestore" type="button">バックアップから復元</button><input type="file" id="fileRestore" accept="application/json" class="hidden"></div>
    </div>
   

    <div class="card" style="margin-top:12px">
      <div class="section-title">年度アーカイブ</div>
      <div class="row" style="justify-content:space-between;align-items:center;gap:6px">
        <div>
          <div class="label">対象年度（個人事業主：1月〜12月）</div>
          <div id="fiscalLabel" style="font-weight:800">-</div>
        </div>
        <select id="selActiveYear" aria-label="対象年度" style="width:160px"></select>
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end;gap:8px;flex-wrap:wrap">
        <button id="btnFinalizePrevYear" class="btn danger small" type="button">前年度を確定（出力→削除）</button>
      </div>
      <div class="muted" style="margin-top:6px">※ 前年度（1月〜12月）の明細をExcel XMLで出力した後、前年度の明細だけを削除します（仕入れ先・商品マスタは残ります）。</div>
      <div class="label" style="margin-top:8px">※ 仕入先・商品マスタは年度に関係なく共通です。明細・集計・出力は選択年度のみ対象です。</div>
    </div>
  </section>

  <!-- LICENSE -->
  <section id="page-license" class="hidden" data-title="ライセンス">
    <div class="grid" style="grid-template-columns:1fr;gap:12px">
      <div class="card">
        <h3>無料版</h3>
        <ul>
          <li>広告あり（控えめ表示）</li>
          <li>仕入れ先 <b>5社</b>まで／商品 <b>合計50品</b></li>
          <li>出力範囲：<b>当月のみ</b></li>
        </ul>
        <button class="btn ghost small" id="btnUseFree" type="button">このプランを使う</button>
      </div>

      <div class="card">
        <h3>ミドル（¥700）</h3>
        <ul>
          <li>広告なし</li>
          <li>仕入れ先 <b>15社</b>まで／商品<b>合計200品</b></li>
          <li>出力範囲：<b>年度（1月〜今月）</b></li>
        </ul>
        <button id="btnEnterLicenseMiddle" class="btn ghost small" type="button">コードを入力</button>
　　　</div>

      <div class="card">
        <h3>プロ（¥1,500）</h3>
        <ul>
          <li>広告なし</li>
          <li>仕入先数・商品数に上限なし</li>
          <li>出力範囲：<b>無制限</b></li>
        </ul>
        <button id="btnEnterLicense" class="btn ghost small" type="button">コードを入力</button>
      </div>
    </div>
  </section>

  <!-- RIGHTS（省略せず既存どおり） -->
  <div id="license-actions" style="margin:12px 0; display:flex; gap:8px; flex-wrap:wrap;">
  <button id="btnOpenLicense">コードを入力</button>
  <button id="btnVerifyNow">再検証</button>
  <span id="licensePlanLabel" style="opacity:.7;"></span>
</div>
<section id="page-rights" class="hidden" data-title="Licenses & Notices">
    <div class="card">
      <h3>Licenses & Notices</h3>
      <section><h4>App & Version</h4><p>Tabco Ledger Plus<sup>™</sup> v1.0</p></section>
      <section><h4>Copyright</h4><p>© 2025 チカキッサ.タブコ. All rights reserved.</p></section>
      <section><h4>Trademark Notice</h4><p><strong>Tabco Ledger Plus<sup>™</sup></strong> and related logos are trademarks of Tabco.</p></section>
   <section id="rights"><h4>EULA（使用許諾）</h4><p>本アプリのご利用によりEULA（使用許諾契約）に同意したものとみなされます。</p><ol>
        <li><b>ライセンス付与：</b>非独占・譲渡不可。再配布/逆コンパイル禁止。</li>
        <li><b>データとプライバシー：</b>出力データの管理は利用者の責任。</li>
        <li><b>知的財産：</b>本ソフト/名称/ロゴ等は開発者に帰属。</li>
        <li><b>保証の否認：</b>現状有姿。損害・逸失利益等は免責。</li>
        <li><b>準拠法・裁判管轄：</b>日本法・京都地方裁判所。</li>
      </ol></section>
      <section><h4>データとプライバシー</h4><p>データは基本的にお使いの端末に保存されます。クラウドバックアップを選んだ場合は、お客様自身のアカウントへ保存されます。</p></section>
      <section>
        <h4>エクスポート（Excel XML）</h4>
        <p>Excelで直接開ける <b>XML Spreadsheet 2003 形式（.xml）</b>で出力します。</p>
        <ul>
          <li>Excel：ダブルクリック or <em>ファイル → 開く</em> で読み込み可。</li>
          <li>Googleスプレッドシート：<em>直接は開けません</em>。PCのExcelで <code>.xlsx</code> に保存してからアップロードしてください。</li>
        </ul>
      </section>
      <section><h4>サードパーティ表記</h4><p>本アプリにはオープンソースコンポーネントが含まれる場合があり、そのライセンスを記載します。</p></section>
            <div id="tlp-rights-badge-host" aria-hidden="true"></div>
    </div>
  </section>
</main>

<!-- モーダル（共通） -->
<div id="modalHost" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">タイトル</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button class="btn danger small btn--delete delbtn hidden" id="modalDelete">削除</button>
      <button class="btn ghost small btn--cancel" id="modalCancel">キャンセル</button>
      <button class="btn primary btn--save" id="modalOK">保存</button>
    </div>
  </div>
</div>
<div id="plans-cta" class="tlp-buy-btn-group" aria-live="polite">
  <a id="btnBuyMiddle" class="tlp-buy-btn" data-plan="middle" href="https://buy.stripe.com/3cI14g5DR5r88O0bn58EM02">Middle（¥700）を購入</a>
 <a id="btnBuyPro" class="tlp-buy-btn" data-plan="pro" href="https://buy.stripe.com/28EbIU5DR1aSggs3UD8EM03">Pro（¥1,500）を購入</a>
  <small id="purchaseNudge" class="tlp-cta-note" hidden>テスト環境：実課金は発生しません</small>
</div>

<script>

  window.tlpCheckoutMiddle = "https://buy.stripe.com/3cI14g5DR5r88O0bn58EM02";
  window.tlpCheckoutPro    = "https://buy.stripe.com/28EbIU5DR1aSggs3UD8EM03";
  window.tlpRedeemURL      = "https://www.cafetabco.com/api/license/redeem.php";
  window.tlpRedeemURL = 'https://www.cafetabco.com/api/license/redeem.php';
  window.tlpVerifyURL = 'https://www.cafetabco.com/api/license/verify.php';

 
// HOMEメニューの最初のボタン幅を購入ボタンへ同期（0px対策つき）
(function syncBuyWidth(){
  // 購入ボタン幅の自動同期は一旦停止（幅ゆらぎ対策）
})();

 

document.addEventListener('DOMContentLoaded', () => {
  // 本番では非表示、dev/testのみ表示
  const nudge = document.getElementById('purchaseNudge');
  if (!nudge) return;
  const host = location.hostname;
  const isLocal   = /localhost|127\.0\.0\.1/.test(host);
  const isStaging = /(dev|stage|staging|test)/i.test(host);
  const hasTestKey = typeof window.STRIPE_PK === 'string' && /^pk_test_/.test(window.STRIPE_PK);
  const isTest = isLocal || isStaging || hasTestKey || window.__ENV === 'test';
  if (isTest) nudge.hidden = false; else nudge.remove();
});

  function tlpDeviceId(){
    let id = localStorage.getItem('tlpDeviceId');
    if (!id) { id = crypto.randomUUID(); localStorage.setItem('tlpDeviceId', id); }
    return id;
  }
  window.tlpVerifyURL = "https://www.cafetabco.com/api/license/verify.php";

  window.verifyLicense = async () => {
  const currentPlan = (typeof getPlan === 'function' ? getPlan() : 'free') || 'free';

  try {
    const res = await fetch(window.tlpVerifyURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ device: tlpDeviceId(), app: 'tlp' })
    });
    const j = await res.json().catch(() => ({ ok:false }));

    if (j && j.ok) {
      try { localStorage.setItem('tlpLicenseFreshAt', String(Date.now())); } catch (_){}

      const serverPlanRaw = j.plan || 'free';
      const serverPlan = String(serverPlanRaw).toLowerCase();

      if (serverPlan === 'middle' || serverPlan === 'pro') {
        // ★ サーバー側が有料プランと言っている場合：必ずそちらを優先
        if (serverPlan !== currentPlan) {
          try {
            if (window.applyLicensed) { applyLicensed({ plan: serverPlan, via: 'verify' }); }
            else { window.setPlan?.(serverPlan); }
          } catch(_){ window.setPlan?.(serverPlan); }

          alert(
            'サーバーの記録に基づき、この端末を ' +
            serverPlan + ' プランとして再設定しました。'
          );
        } else {
          // もともと同じプラン
          alert('再検証完了：現在のプラン（' + serverPlan + '）は有効です。');
        }
      } else {
        // ★ サーバー側は free / 不明 → 自動ダウングレードはしない
        if (currentPlan === 'middle' || currentPlan === 'pro') {
          alert(
            'サーバー側にこの端末の有料プラン記録が見つかりませんでした。\n' +
            '安全のため、自動でプランを変更せず現在の ' + currentPlan + ' プランのままにしています。\n' +
            'ご購入済みの場合は、購入時のメールを添えてサポートまでご連絡ください。'
          );
        } else {
          alert(
            '再検証完了：この端末の有料プラン記録は見つかりませんでした。\n' +
            '購入済みでプランが反映されない場合は、ライセンスコード入力か、\n' +
            '購入時のメールを添えてサポートまでご連絡ください。'
          );
        }
      }
    } else {
      const reason = (j && (j.error || j.reason)) || 'unknown';
      alert(
        '再検証に失敗しました。\n' +
        'しばらくしてからもう一度お試しください。\n' +
        '（エラー内容：' + reason + '）'
      );
    }
    return j;
  } catch(e) {
    console.error(e);
    alert(
      '再検証に失敗しました（通信エラー）。\n' +
      'ネット接続を確認してから、もう一度お試しください。'
    );
    return { ok:false, error:'network' };
  }
};


  window.redeemCode = async (code) => {
  // コード形式が明らかにおかしい場合は、何もせず静かにスキップ
  const raw  = String(code || '').trim();
  const norm = raw.toUpperCase().replace(/[^A-Z0-9-]/g, '');
  const PAT_TEST = /^TEST-(MIDDLE|PRO)$/;
  const PAT_PROD = /^TLP-[A-Z0-9-]{8,}$/;

  // TEST- / TLP- 形式以外ならアラートを出さず終了
  if (!PAT_TEST.test(norm) && !PAT_PROD.test(norm)) {
    console.warn('redeemCode: invalid format, skip', raw);
    return { ok: false, error: 'invalid_format', skipped: true };
  }

  const payload = { code: norm, device: tlpDeviceId(), app: 'tlp' };

  try {
    const res = await tlpApiFetch('/api/license/redeem.php', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(() => ({ ok: false }));
    console.log('redeem:', json);

    if (json && json.ok) {
      // 成功時
      try { localStorage.setItem('tlpLicenseFreshAt', String(Date.now())); } catch (_){}
      try { window.setPlan?.(json.plan); } catch (_){}

      if (json.plan === 'pro') {
        localStorage.setItem(PRO_KEY, '1');
      } else {
        localStorage.removeItem(PRO_KEY);
      }

      if (window.applyLicensed) {
        try { applyLicensed({ plan: json.plan, via: 'redeem' }); } catch (_){}
      }

      alert(
        'ライセンス適用：' + (json.plan || 'unknown') +
        '\n\nこのライセンスコードは大切に保管してください。\n' +
        '（機種変更や再インストール時に必要になることがあります）'
      );
    } else {
      // 失敗時
      const reason = (json && (json.error || json.reason)) || 'unknown';
      console.warn('redeem failed:', reason, json);

      const currentPlan = (typeof getPlan === 'function' ? getPlan() : 'free') || 'free';
      let msg;

      if (reason === 'used' || reason === 'invalid' || reason === 'invalid_code') {
        if (currentPlan === 'middle' || currentPlan === 'pro') {
          msg =
            'この端末はすでに ' + currentPlan + ' プランとして有効になっています。\n' +
            'Stripe経由で購入された場合は、コード入力は不要です。\n' +
            'ライセンスコードは念のため保管しておいてください。';
        } else {
          msg =
            'このライセンスコードを認識できませんでした。\n' +
            '入力内容（コピペ漏れ・全角／半角など）を確認しても改善しない場合は、\n' +
            '購入時のメールを添えてサポートまでご連絡ください。';
        }
      } else {
        msg =
          'コードの引き換えに失敗しました。\n' +
          'しばらくしてからもう一度お試しください。\n' +
          '（エラー内容：' + reason + '）';
      }
      alert(msg);
    }

    return json;
  } catch (e) {
    console.error(e);
    alert(
      'コードの引き換えに失敗しました（通信エラー）。\n' +
      'ネット接続を確認してから、もう一度お試しください。'
    );
    return { ok: false, error: 'network' };
  }
};





      window.DEBUG_PAY = false;
 window.buyMiddle = () => window.open(window.tlpCheckoutMiddle, "_blank", "noopener");
  window.buyPro    = () => window.open(window.tlpCheckoutPro,    "_blank", "noopener");
    // 4D: 画面右下にテスト購入ボタン（後で削除OK）
  (() => {
    if (!window.DEBUG_PAY) return;
        const inject = () => {
      if (document.getElementById('tlp-buy-test')) return;
      const box = document.createElement('div');
      box.id = 'tlp-buy-test';
      box.style = 'position:fixed;right:12px;bottom:12px;z-index:9999;background:#fff;padding:8px 10px;border:1px solid #ddd;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);font-size:12px';
      const label = document.createElement('span'); label.textContent = '購入テスト：'; label.style = 'margin-right:6px';
      const m = document.createElement('button'); m.textContent='Middle(¥700)'; m.style='margin-right:6px'; m.onclick=buyMiddle;
      const p = document.createElement('button'); p.textContent='Pro(¥1,500)'; p.onclick=buyPro;
      box.append(label, m, p);
      document.body.appendChild(box);
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', inject);
    else inject();
  })();
   
/* ===== DEMO (Simulator) ===== */
const URLP = new URLSearchParams(location.search);
const IS_DEMO = URLP.get("demo") === "1";
const DEMO_DATA_URL = URLP.get("demoData") || "/demo/demo_restaurant.json";
// demoは本番データと絶対に混ざらないようにキーを分離
const STORE_KEY = IS_DEMO ? "tabco-store-demo" : "tabco-store";
const PLAN_KEY  = IS_DEMO ? "tlpPlan_demo"  : "tlpPlan";
const PRO_KEY   = IS_DEMO ? "tlpPro_demo"   : "tlpPro";
const DEMO_READY_KEY = "tlpDemoLoaded_v1";

/* demo用：サンプルJSON（バックアップ形式）を初回だけ自動復元 */
async function demoAutoLoadIfNeeded(){
  if(!IS_DEMO) return;
  try{
    // すでにデモ用ストレージにデータがあれば何もしない（体験中の編集を保持）
    const existing = localStorage.getItem(STORE_KEY);
    if(existing && existing.trim()) return;

    // セッション内の二重ロード防止
    if (sessionStorage.getItem(DEMO_READY_KEY) === "1") return;

    // demoは操作体験のため pro 扱い（本番の tlpPlan とは別キー）
    try{
      if(!localStorage.getItem(PLAN_KEY)) localStorage.setItem(PLAN_KEY, "pro");
      if(localStorage.getItem(PLAN_KEY) === "pro") localStorage.setItem(PRO_KEY, "1");
    }catch(_){}

    const res = await fetch(DEMO_DATA_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("fetch failed: " + res.status);
    const j = await res.json();

    // 形式を吸収（backup形式 or store形式）
    let tables = null, settings = null;
    if(j && typeof j === "object" && j.tables){
      tables = j.tables;
      settings = j.settings || null;
    }else{
      tables = {
        suppliers: j.suppliers || [],
        products: j.products || [],
        entries: j.entries || [],
        priceHistory: j.priceHistory || {}
      };
      settings = j.settings || null;
    }

    // 年ズレを軽く補正（デモで履歴が空に見えないように）
    const curY = new Date().getFullYear();
    const years = new Set();
    (tables.entries||[]).forEach(e=>{
      if(e && typeof e.date === "string" && /^\d{4}-\d{2}-\d{2}/.test(e.date)) years.add(Number(e.date.slice(0,4)));
    });
    if(years.size){
      const maxY = Math.max(...Array.from(years));
      const minY = Math.min(...Array.from(years));
      // 今年/前年の範囲から外れていたら、最大年が今年になるようにスライド
      if(maxY < curY-1 || minY > curY){
        const diff = curY - maxY;
        (tables.entries||[]).forEach(e=>{
          if(!e || typeof e.date !== "string") return;
          const m = e.date.match(/^(\d{4})-(\d{2})-(\d{2})(.*)$/);
          if(!m) return;
          const y = Number(m[1]) + diff;
          e.date = String(y).padStart(4,"0")+"-"+m[2]+"-"+m[3]+(m[4]||"");
        });
      }
    }

    // storeへ反映して保存
    const demoStore = DB.load(); // defaults + merge
    demoStore.suppliers = Array.isArray(tables.suppliers) ? tables.suppliers : [];
    demoStore.products  = Array.isArray(tables.products) ? tables.products : [];
    demoStore.entries   = Array.isArray(tables.entries) ? tables.entries : [];
    demoStore.priceHistory = (tables.priceHistory && typeof tables.priceHistory === "object") ? tables.priceHistory : {};
    if(settings && typeof settings === "object"){
      // デモは基本触りやすい設定に寄せる（ただし見た目は維持）
      demoStore.settings = Object.assign({}, demoStore.settings || {}, settings);
    }
    // デモは対象年度を今年に
    demoStore.settings = demoStore.settings || {};
    demoStore.settings.activeYear = curY;

    DB.save(demoStore);
    sessionStorage.setItem(DEMO_READY_KEY, "1");
    location.reload();
  }catch(e){
    console.warn("[demo] auto load failed", e);
  }
}

/* demo用UI（バッジ/リセット） */
function mountDemoUI(){
  if(!IS_DEMO) return;
  try{
    const badge = document.createElement("div");
    badge.id = "tlpDemoBadge";
    badge.innerHTML = '<b>DEMO</b> <span style="opacity:.85">体験モード</span> <button id="tlpDemoResetBtn" type="button">リセット</button>';
    document.body.appendChild(badge);

    const st = document.createElement("style");
    st.textContent = `
#tlpDemoBadge{
  position: fixed; z-index: 9999;
  left: 12px; top: 12px;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(20,20,20,.92);
  color: #fff;
  font-size: 12px;
  display:flex; gap:10px; align-items:center;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
#tlpDemoBadge button{
  padding: 6px 8px;
  border-radius: 10px;
  border: 0;
  cursor: pointer;
}
    `.trim();
    document.head.appendChild(st);

    document.getElementById("tlpDemoResetBtn")?.addEventListener("click", ()=>{
      try{
        localStorage.removeItem(STORE_KEY);
        sessionStorage.removeItem(DEMO_READY_KEY);
      }catch(_){}
      location.reload();
    });

    // 事故防止：危険ボタンはデモでは無効化
    const btnFin = document.getElementById("btnFinalizePrevYear");
    if(btnFin){
      btnFin.disabled = true;
      btnFin.title = "デモでは実行できません";
    }
    const btnFR = document.getElementById("btnFactoryReset");
    if(btnFR){
      btnFR.disabled = true;
      btnFR.title = "デモでは実行できません";
    }
  }catch(e){
    console.warn("[demo] ui mount failed", e);
  }
}


/* ===== Storage ===== */
const DB = {
  load(){
    const defaults = {
      suppliers: [], products: [], entries: [], priceHistory: {},
      settings: {
        theme: "light", lastBackupAt: null, plan: "free",
        autoClear: true, historyShowBoth: true, showTaxFlags: false,
        recentProducts: [],
        hisRange: "30",      // 新キー
        hisRangeDays: 30,     // 互換用（読みはしない）
        activeYear: new Date().getFullYear() // 追加：対象年度（手動切替用）
      }
    };

    // 破損対策付きパース
    let raw = {};
    try{
      const s = localStorage.getItem(STORE_KEY);
      raw = s ? JSON.parse(s) : {};
    }catch(e){
      console.warn("[DB] parse error, fallback to defaults", e);
      try{
        localStorage.setItem("tabco-store_corrupt", localStorage.getItem(STORE_KEY) || "");
      }catch(_){}
      }

    // 深いマージ（settingsだけ個別にマージ）
    const out = {
      suppliers:Array.isArray(raw.suppliers) ? raw.suppliers : defaults.suppliers,
      products:Array.isArray(raw.products)  ? raw.products  : defaults.products,
      entries:Array.isArray(raw.entries)   ? raw.entries   : defaults.entries,
      priceHistory: (raw.priceHistory && typeof raw.priceHistory === "object") ? raw.priceHistory : {},
      settings: Object.assign({}, defaults.settings, (raw.settings || {}))
    };
    return out;
  },
  save(d){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(d)); }
    catch(e){ console.error("[DB] save error", e); }
  }
};
let store = DB.load();
// demo: 初回だけサンプル自動復元
try{ demoAutoLoadIfNeeded(); }catch(_){ }

// ===== ActiveYear guard (年度切替の基準) =====
(function(){
  try{
    var nowY = new Date().getFullYear();
    if(!store || typeof store !== 'object') return;
    store.settings = store.settings || {};
    var ay = Number(store.settings.activeYear);
    if(!isFinite(ay) || ay < 2000 || ay > 2100){
      store.settings.activeYear = nowY;
      DB.save(store);
    }
  }catch(e){
    console.warn('[fiscal] activeYear init', e);
  }
})();
// ===== Plan/Storage guard (cold start: free戻り＆操作不能対策) =====
(function(){
  try{
    if(!window.DB || typeof DB.save!=='function' || DB.save.__planGuard) return;
    var _save = DB.save.bind(DB);
    DB.save = function(s){
      try{
        if(s && typeof s === 'object'){
          s.settings = s.settings || {};
          var lp = (localStorage.getItem(PLAN_KEY) || '').toLowerCase();
          var dp = (lp==='free'||lp==='middle'||lp==='pro') ? lp : ((localStorage.getItem(PRO_KEY)==='1') ? 'pro' : 'free');
          var rank = { free:0, middle:1, pro:2 };
          var sp0 = (s.settings.plan || '').toLowerCase();
          var sp = (sp0==='free'||sp0==='middle'||sp0==='pro') ? sp0 : 'free';
          if ((rank[dp]||0) > (rank[sp]||0)) s.settings.plan = dp; // 端末プランより下には保存しない
        }
      }catch(_){}
      return _save(s);
    };
    DB.save.__planGuard = true;
  }catch(_){}
})();

(function(){
  try{
    if(!store || typeof store !== 'object') return;
    store.settings = store.settings || {};
    var lp = (localStorage.getItem(PLAN_KEY) || '').toLowerCase();
    var devPlan = (lp==='free'||lp==='middle'||lp==='pro') ? lp : ((localStorage.getItem(PRO_KEY)==='1') ? 'pro' : 'free');
    var sp0 = (store.settings.plan || '').toLowerCase();
    var storePlan = (sp0==='free'||sp0==='middle'||sp0==='pro') ? sp0 : 'free';
    var rank = { free:0, middle:1, pro:2 };
    var chosen = ((rank[devPlan]||0) >= (rank[storePlan]||0)) ? devPlan : storePlan;

    if(store.settings.plan !== chosen) store.settings.plan = chosen;

    // 端末側も上位に寄せる（freeへダウングレードはしない）
    if (chosen !== devPlan && (rank[chosen]||0) > (rank[devPlan]||0)) {
      localStorage.setItem(PLAN_KEY, chosen);
      if (chosen === 'pro') localStorage.setItem(PRO_KEY,'1');
      else localStorage.removeItem(PRO_KEY);
    }

    DB.save(store);
  }catch(e){
    console.warn('[plan] sync boot', e);
  }
})();


/* ===== Utils ===== */
const $  = (s,el)=>(el||document).querySelector(s);
const $$ = (s,el)=>Array.from((el||document).querySelectorAll(s));
const yen=n=>"¥"+(Math.round(n||0)).toLocaleString();
const uid=()=>Math.random().toString(36).slice(2,10);
const fmtYMD=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
/* 対象年度（今年/前年度） */
function getActiveYear(){
  try{
    var cur = new Date().getFullYear();
    var y = Number(store && store.settings && store.settings.activeYear);
    if (!(isFinite(y) && y >= 2000 && y <= 2100)) y = cur;
    // 今年度/前年度のみ許可（それ以外は今年度へ）
    if (y !== cur && y !== (cur - 1)) y = cur;
    return y;
  }catch(_){
    return new Date().getFullYear();
  }
}
/* 選択年度の「今日」（月日を合わせる。存在しない日付は月末に丸める） */
function activeNow(){
  const cur = new Date();
  const y = getActiveYear();
  const m = cur.getMonth();
  const last = new Date(y, m+1, 0).getDate();
  const d = Math.min(cur.getDate(), last);
  const dt = new Date(y, m, d);
  dt.setHours(cur.getHours(), cur.getMinutes(), cur.getSeconds(), cur.getMilliseconds());
  return dt;
}
const todayStr=()=>fmtYMD(activeNow());
function enableSelectOnFocus(){
  $$('input[type="number"], input[type="text"]').forEach(inp=>{
    const sel=()=>inp.select&&inp.select();
    inp.addEventListener("focus",sel);
    inp.addEventListener("click",sel);
  });
}

/* === Plans: 単一の真実（SOT） ============================= */
const PlanRules = {
  free:   { exportMax: 'month',  supplierMax: 5,  productTotalMax: 50,  productPerSupplierMax: 10,  ads: true  },
  middle: { exportMax: 'fiscal', supplierMax: 15, productTotalMax: 200, productPerSupplierMax: 15,  ads: false },
  pro:    { exportMax: 'all',    supplierMax: Infinity, productTotalMax: Infinity, productPerSupplierMax: Infinity, ads: false }
};
const EXPORT_KEYS = ['month','fiscal','all'];
function clampExportKey(req, plan){
  const p = (plan ?? PLAN());
  const rules = PlanRules[p] || PlanRules.free;
  const key = EXPORT_KEYS.includes(req) ? req : 'month';
  if (rules.exportMax === 'month') return 'month';
  if (rules.exportMax === 'fiscal' && key === 'all') return 'fiscal';
  return key;
}
window.clampExportKey = clampExportKey; // コンソール診断用に公開（任意）

// === Plan Caps ===
const PlanCap = {
  free   : { suppliers: 5,  products: 50,  perSupplier: 10 },
  middle : { suppliers: 15, products: 200, perSupplier: 15 },
  pro    : { suppliers: Infinity, products: Infinity, perSupplier: Infinity }
};
const PLAN = () => getPlan();
const CAPS = (p = PLAN()) => {
  const c = PlanCap[p] || PlanCap.free;
  return {
    suppliers: c.suppliers,
    // aliases for backward-compat:
    productsPerSupplier: c.perSupplier,
    productsTotal: c.products,
    // legacy keys still used in a few places:
    products: c.products,
    perSupplier: c.perSupplier,
  };
};
window.CAPS = CAPS; // 診断用に公開（任意）
const capLabel = (n, unit)=> (n===Infinity ? '無制限' : `${n}${unit}`);
window.PlanRules = PlanRules;
window.PlanCap   = PlanCap;
window.PLAN      = PLAN;
window.capLabel  = capLabel;


/* === 期間ユーティリティ === */
function _ym(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
function _startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function _endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
function getExportRange(key){
  const realNow = new Date();
  const now = activeNow();
  if(key==="fiscal"){
    const fy = getActiveYear();
    const from = new Date(fy,0,1);
    const to = _endOfDay((fy===realNow.getFullYear()) ? now : new Date(fy,11,31));
    const toLabelDate = (fy===realNow.getFullYear()) ? now : new Date(fy,11,31);
    return {from,to,label:`${_ym(from)}〜${_ym(toLabelDate)}`,key:"fiscal"};
  }
  if(key==="all"){ return {from:null,to:null,label:"全期間",key:"all"}; }
  // default: 当月（選択年度）
  const from=_startOfMonth(now), to=_endOfDay(now);
  return {from,to,label:_ym(now),key:"month"};
}

function _inRange(ymd, range){
  if(!ymd) return false;
  const d=new Date(ymd+"T12:00:00");
  if(range.from && d<range.from) return false;
  if(range.to && d>range.to) return false;
  return true;
}

/* ===== Theme & Header ===== */
function applyTheme(){
  document.documentElement.setAttribute("data-theme", store.settings.theme==="dark" ? "dark" : "light");
  const ic = $("#themeIcon"); if(ic) ic.textContent = store.settings.theme==="dark" ? "☾" : "☀";
}
document.addEventListener("click",(e)=>{
  if(e.target.closest("#themeBtn")){
    store.settings.theme = store.settings.theme==="dark" ? "light" : "dark";
    DB.save(store); applyTheme();
  }
});
function planJp(p){ return p==="pro" ? "プロ" : (p==="middle" ? "ミドル" : "無料"); }
function setHeaderTitleByPage(id){
  const map = {
    home:"仕入れ管理",
    input:"仕入入力",
    suppliers:"仕入れ先マスタ",
    products:"商品マスタ",
    history:"履歴・集計",
    backup:"バックアップ設定",
    license:"Plans",
    rights:"Licenses & Notices",
  };
  const el=$("#pageTitle"); if(el) el.textContent = map[id] || "";
}

/* ===== History Controls（一本化） ===== */
window.HistoryUI = (function(){
  let bound = false;

  function sync(){
    if (store.settings.hisRange == null) {
      const d = store.settings.hisRangeDays;
      store.settings.hisRange = (d === 7 || d === 30) ? String(d) : "30";
      DB.save(store);
    }
    const cbGross = $("#toggleGross"); if (cbGross) cbGross.checked = !!store.settings.historyShowBoth;
    const cbDet = $("#showDetail"); if (cbDet) cbDet.checked = !!store.settings.showTaxFlags;
    const sel = $("#hisRange"); if (sel) sel.value = String(store.settings.hisRange ?? "30");
    try { fillHistorySupplierSelect(); } catch(e) {}
  }


  function bindOnce(){
    if (bound) return;
    document.addEventListener("change", (e) => {
      const t = e.target; if (!t) return;
      if (t.id === "toggleGross") { store.settings.historyShowBoth = !!t.checked; DB.save(store); renderHistory(); }
      if (t.id === "showDetail")  { store.settings.showTaxFlags  = !!t.checked; DB.save(store); renderHistory(); }
      if (t.id === "hisRange")    { store.settings.hisRange = String(t.value || "30"); DB.save(store); renderHistory(); }
      if (t.id === "hisSupplier") {
        store.settings.historySupplierFilter = String(t.value || "");
        DB.save(store);
        renderHistory();
      }
    });
    bound = true;
  }
  return { sync, bindOnce };
})();

/* ===== Router ===== */
let internalNav=false;
function showPage(id){
  if(id==="backup"){ try{ refreshBackupPageLabels(); }catch(e){} }

  try { id = normalizeRoute(id); } catch (_) { id = (id || "home"); }
 $$("main > section").forEach(s=>s.classList.add("hidden")); // 子ページだけ隠す

  let page = $("#page-"+id) || $("#"+id);
  if (!page && id !== "home") {
    console.warn("unknown page:", id, "-> home");
    id = "home";
    page = $("#page-home") || $("#home");
  }
  if (page) { page.classList.remove("hidden"); page.hidden=false; }
  if(id==="home"){
    $("#btnHome")?.classList.add("hidden");
    const t=$("#pageTitle"); if(t) t.textContent="仕入れ管理";
  }else{
    $("#btnHome")?.classList.remove("hidden");
    setHeaderTitleByPage(id);
  }
  if(id==="history"){ HistoryUI.sync(); HistoryUI.bindOnce(); try{ renderHistory(); }catch(err){ console.error("renderHistory failed:", err); } }
  if(id==="rights" || id==="license"){ try{ window.syncLicenseButtons?.(); }catch(e){} try{ window.renderRights?.(); }catch(e){} }
if (id === 'rights') {
  const html = `<h4>プライバシーポリシー</h4>
  <p>本アプリは入力データを<b>端末ローカル</b>に保存します。バックアップ機能利用時のみ、利用者自身のクラウドに保存されます。</p>
  <p>詳細は <a href="https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/" target="_blank" rel="noopener noreferrer">プライバシーポリシー</a> をご覧ください。</p>`;
  const card = document.querySelector('#page-rights .card');
  let box = document.getElementById('rights-privacy');
  if (!box && card) { box = document.createElement('div'); box.id = 'rights-privacy'; card.prepend(box); }
  if (box) box.innerHTML = html;
}
  if(id==="rights"){  const l=document.getElementById("page-license"); if(l){ l.classList.add("hidden"); l.hidden=true; } }
  if(id==="license"){ const r=document.getElementById("page-rights");  if(r){ r.classList.add("hidden"); r.hidden=true; } }

  window.scrollTo(0,0);
}
function normalizeRoute(raw){
  let s = (raw==null? "": String(raw)).trim();
  // location.hash の場合は先頭#を除去
  if (s.startsWith("#")) s = s.slice(1);
  // "#/home" のような形式を許容
  if (s.startsWith("/")) s = s.replace(/^\/+/, "");
  // クエリは捨てる
  const q = s.indexOf("?");
  if (q >= 0) s = s.slice(0, q);
  if (!s) s = "home";
  return s;
}
function navigate(id){
  internalNav = true;
  try {
    const r = normalizeRoute(id);
    location.hash = r;
    showPage(r);
  } catch (err) {
    console.error("navigate failed:", err);
    try { location.hash = "home"; showPage("home"); } catch (_) {}
  } finally {
    internalNav = false;
  }
}
window.addEventListener("hashchange", ()=>{
  if (internalNav) return;
  try { showPage(normalizeRoute(location.hash)); }
  catch (err) { console.error("hashchange failed:", err); try { showPage("home"); } catch (_) {} }
});
document.addEventListener("click", (e)=>{
  const b = e.target.closest("[data-goto]");
  if (!b) return;
  e.preventDefault();
  e.stopPropagation();
  navigate(b.getAttribute("data-goto"));
}, true);
document.addEventListener("click", (e)=>{ if (e.target.closest("#btnHome")) navigate("home"); }, true);

/* ===== Home KPIs / Ads ===== */
// --- HOME広告ローテーション（FREEプラン向け） ---
// ※リンク先URLは実際のページに差し替え推奨
const HOME_ADS = [
  {
    id: 'gateau',
    href: 'https://cafetabco.com/%e3%82%ac%e3%83%88%e3%83%bc%e3%82%b7%e3%83%a7%e3%82%b3%e3%83%a9/', // ← ガトーショコラ注文ページ
    title: 'ガトーショコラ通販',
    body: 'チカキッサ.タブコの人気ガトーショコラをご自宅で。ご予約フォームはこちら。',
  },
  {
    id: 'app-middle',
    href: 'https://cafetabco.com/app/', // ← アプリの案内/Middle・Proページ
    title: 'Tabco Ledger Plus 有料プラン',
    body: '仕入れ先15社・商品200品まで管理できるMiddle / Proプランのご案内。',
  }
];

let homeAdIndex = 0;
let homeAdTimer = null;

function renderHomeAdOnce() {
  const link   = document.getElementById('homeAdLink');
  const titleE = document.getElementById('homeAdTitle');
  const bodyE  = document.getElementById('homeAdBody');
  if (!link || !titleE || !bodyE) return;

  const ad = HOME_ADS[homeAdIndex];

  link.href = ad.href;
  titleE.textContent = ad.title;
  bodyE.textContent  = ad.body;

  homeAdIndex = (homeAdIndex + 1) % HOME_ADS.length;
}

function startHomeAdRotation() {
  // Freeだけ表示（既に他で制御していればこの if は省略OK）
  if (typeof getPlan === 'function' && getPlan() !== 'free') {
    const card = document.getElementById('homeAdCard');
    if (card) card.hidden = true;
    return;
  }

  const card = document.getElementById('homeAdCard');
  if (card) card.hidden = false;

  renderHomeAdOnce();                 // まず1回即表示
  if (homeAdTimer) clearInterval(homeAdTimer);
  homeAdTimer = setInterval(renderHomeAdOnce, 5000); // 5秒ごとに切り替え
}
function calcTotals(days){
  const y = getActiveYear();
  const now = activeNow();
  now.setHours(23,59,59,999);
  const yearStart = new Date(y,0,1); yearStart.setHours(0,0,0,0);
  const yearEnd   = new Date(y,11,31); yearEnd.setHours(23,59,59,999);

  let from = new Date(now.getTime() - days*86400000);
  if (from < yearStart) from = yearStart;
  let to = now;
  if (to > yearEnd) to = yearEnd;

  return store.entries.reduce((sum,e)=>{
    if(!e || e.deleted || !e.date) return sum;
    if(!String(e.date).startsWith(String(y)+"-")) return sum; // 選択年度のみ
    const t = new Date(e.date+"T00:00:00");
    if(t>=from && t<=to){
      const base = e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100);
      sum += base*e.qty;
    }
    return sum;
  },0);
}
function refreshAds(){
  const slot = $("#adSlot");
  if(!slot) return;
  const on = getPlan()==='free';   // ※ 括弧は不要。機能は同じ
  slot.classList.toggle("visible", on);
}

function refreshBackupPageLabels(){
  try{
    const bk = store.settings.lastBackupAt ? new Date(store.settings.lastBackupAt) : null;
    const el = document.getElementById('bkLast');
    if (el) el.textContent = bk ? bk.toLocaleString('ja-JP') : '未実施';
  }catch(_){}
}

function refreshHome(){
  try{
  const p = getPlan();
  const label = (p==='pro' ? 'プロ' : p==='middle' ? 'ミドル' : '無料');
  const root = document.getElementById('home') || document;

  // まずは想定セレクタ群
  let ok = false;
  root.querySelectorAll('#pillPlan,[data-plan-pill],.plan-pill').forEach(el=>{
    el.textContent = label; el.dataset.plan = p; ok = true;
  });

  // 見つからなければ、「プラン：」で始まる要素をフォールバックで更新
  if(!ok){
    root.querySelectorAll('span,small,div').forEach(el=>{
      const t = (el.textContent||'').trim();
      if(/^プラン：/.test(t)) { el.textContent = 'プラン：' + label; ok = true; }
    });
  }
}catch(_){}
try { startHomeAdRotation(); } catch (e) { console.error('homeAd', e); }
}


  $("#kpiWeek").textContent = yen(calcTotals(7));
  $("#kpiMonth").textContent = yen(calcTotals(30));
  { const pill = document.querySelector('#pillPlan');
   if (pill) pill.textContent = `プラン：${planJp(getPlan())}`; }
  const bk=store.settings.lastBackupAt?new Date(store.settings.lastBackupAt):null;
  $("#pillBackup").textContent = bk?("最終バックアップ："+bk.toLocaleString("ja-JP")):"最終バックアップ：未実施";
  refreshAds();
queueMicrotask(()=>{
  try{
    const p = getPlan();
    const label = (p==='pro' ? 'プロ' : p==='middle' ? 'ミドル' : '無料');
    document.querySelectorAll('#pillPlan,[data-plan-pill],.plan-pill').forEach(el=>{
      const t = (el.textContent||'').trim();
      el.textContent = /^プラン：/.test(t) ? ('プラン：'+label) : label;
      el.dataset.plan = p;
    });
  }catch(_){}
});


/* ===== Input ===== */
function fillSupplierSelect(sel){
  sel.innerHTML="";
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
}
function buildProductOptionsForSupplier(supplierId, searchText=""){
  const recents=(store.settings.recentProducts||[]).slice(0,20);
  const list=store.products.filter(p=>!p.deleted&&(!supplierId||p.supplier_id===supplierId));
  const mru=list.filter(p=>recents.includes(p.id));
  const others=list.filter(p=>!recents.includes(p.id));
  const needle=(searchText||"").trim().toLowerCase();
  const match=p=>!needle||p.name.toLowerCase().includes(needle);
  return [...mru.filter(match), ...others.filter(match)]; // ★ 修正：スプレッド
}
function renderProductSelect(sel,supplierId,searchText=""){
  const items=buildProductOptionsForSupplier(supplierId,searchText);
  const prev=sel.value;
  sel.innerHTML='<option value="">（選択してください）</option>';
  items.forEach(p=>{const o=document.createElement("option");o.value=p.id;o.textContent=p.name;sel.appendChild(o)});
  if(items.some(p=>p.id===prev)) sel.value=prev;
  $("#inPrice").value=""; $("#inQty").value=1;
  $$('input[name=taxrate]').forEach(r=>r.checked=(r.value==="8"));
  $$('input[name=taxmode]').forEach(r=>r.checked=(r.value==="excl"));
  $("#priceHistory").innerHTML="";
}
function fillProductSelect(sel,supplierId){ renderProductSelect(sel,supplierId,$("#prodSearch").value||""); }
function renderPriceHistory(pid){
  const w=$("#priceHistory"); w.innerHTML="";
  (store.priceHistory[pid]||[]).slice(-3).reverse().forEach(v=>{
    const b=document.createElement("button");
    b.className="btn ghost small"; b.type="button"; b.textContent="¥"+v.price;
    b.onclick=()=>$("#inPrice").value=v.price; w.appendChild(b);
  });
}
const supplierName=id=>(store.suppliers.find(x=>x.id===id)||{}).name||null;
const prodName=(id,fb)=>(store.products.find(x=>x.id===id)||{}).name||(fb||"未登録");
function toggleFreeInput(){
  const on=$("#chkFree").checked;
  $("#freeFields").classList.toggle("hidden",!on);
  $("#inSupplier").disabled=on; $("#inProduct").disabled=on; $("#prodSearch").disabled=on;
}
function initInputPage(){
  $("#inDate").value=todayStr();
  fillSupplierSelect($("#inSupplier"));
  const sid=$("#inSupplier").value;
  renderProductSelect($("#inProduct"),sid,"");
  $("#prodSearch").value=""; $("#inQty").value=1; $("#inPrice").value=""; $("#inMemo").value="";
  toggleFreeInput();
}
document.addEventListener("change",(e)=>{ if(e.target.id==="chkFree") toggleFreeInput(); });

document.addEventListener("click",(e)=>{
  const t = e.target;
  if(!t || t.id !== "btnFinalizePrevYear") return;

  const cur = new Date().getFullYear();
  const py = Number(t.dataset.year || (cur-1));
  if(!Number.isFinite(py)) return;

  // まずは出力（キャンセル可能）
  const msg1 = `前年度（${py}年）の明細を「年度出力（Excel XML）」してから削除します。\n\n※必要なら先に「バックアップ（JSON）」も取ってください。\n\n出力を開始しますか？`;
  if(!confirm(msg1)) return;

  const ok = exportYearXML(py);
  if(!ok) return;

  const msg2 = `前年度（${py}年）の明細を削除します。\n\nこの操作は元に戻せません。\n削除してよいですか？`;
  if(!confirm(msg2)) return;

  const removed = deleteEntriesOfYear(py);
  alert(`前年度（${py}年）の明細を削除しました（${removed}件）。`);

  // 画面更新
  try{ refreshFiscalLabel(); }catch(_){}
  try{ initInputPage(); }catch(_){}
  try{ renderTodayList(); }catch(_){}
  try{ if ((location.hash||"") === "#history") renderHistory(); }catch(_){}
  try{
    const w = document.getElementById("kpiWeek"); if(w) w.textContent = yen(calcTotals(7));
    const m = document.getElementById("kpiMonth"); if(m) m.textContent = yen(calcTotals(30));
  }catch(_){}
});

document.addEventListener("change",(e)=>{ if(e.target.id==="inSupplier") renderProductSelect($("#inProduct"),e.target.value,$("#prodSearch").value||""); });
document.addEventListener("input",(e)=>{ if(e.target.id==="prodSearch") renderProductSelect($("#inProduct"),$("#inSupplier").value,e.target.value); });
document.addEventListener("change",(e)=>{
  if(e.target.id==="inProduct"){
    const p=store.products.find(x=>x.id===e.target.value);
    if(p){
      $("#inPrice").value=p.default_price||"";
      $$('input[name=taxrate]').forEach(r=>r.checked=String(p.tax_rate)===r.value);
      $$('input[name=taxmode]').forEach(r=>r.checked=(p.tax_mode||"excl")==="excl");
      renderPriceHistory(p.id);
    }else{
      $("#priceHistory").innerHTML="";
    }
  }
});
document.addEventListener("click",(e)=>{ if(e.target.id==="btnAddSupplier") tryAddSupplier(); });
document.addEventListener("click",(e)=>{ if(e.target.id==="btnAddProduct"){ const sid = $("#filterProdSupplier")?.value || (store.suppliers[0]?.id || ""); tryAddProductStart(sid); }});
function calcLineTotal(e){
  const p=Number(e.price)||0, q=Number(e.qty)||0, r=Number(e.taxrate)||0;
  const base = p*q;
  if(e.taxmode==="incl"){ const excl = Math.round(base/(1+r/100)); return {excl, incl: base}; }
  else if(e.taxmode==="excl"){ const incl = Math.round(base*(1+r/100)); return {excl: base, incl}; }
  else { return {excl: base, incl: base}; }
}
function bumpRecentProduct(pid){
  if(!pid) return;
  const arr = store.settings.recentProducts || [];
  const i = arr.indexOf(pid);
  if(i>=0) arr.splice(i,1);
  arr.unshift(pid);
  store.settings.recentProducts = arr.slice(0,20);
}
document.addEventListener("click",(e)=>{ if(e.target.id==="btnAddLine") addLine(); });
function addLine(){
  const date=$("#inDate").value||todayStr();
  const free=$("#chkFree").checked;
  const supplier_id=free?null:($("#inSupplier").value||null);
  const product_id=free?null:($("#inProduct").value||null);
  const supplier_name_fallback=free?($("#freeSupplier").value||"未登録"):(supplierName(supplier_id)||"未登録");
  const product_name_fallback=free?($("#freeProduct").value||"未登録"):null;
  const qty=Number($("#inQty").value||1);
  const price=Number($("#inPrice").value||0);
  const taxrate=Number(document.querySelector('input[name=taxrate]:checked').value);
  const taxmode=document.querySelector('input[name=taxmode]:checked').value;
  if(!price||!qty){alert("価格と数量を入力してください");return}
  store.entries.push({id:uid(),date,supplier_id,product_id,supplier_name_fallback,product_name_fallback,qty,price,taxrate,taxmode,memo:$("#inMemo").value||""});
  if(product_id){
    const arr=store.priceHistory[product_id]||[];
    arr.push({price,ts:Date.now(),taxrate,taxmode});
    store.priceHistory[product_id]=arr.slice(-5);
  }
  bumpRecentProduct(product_id);
  DB.save(store); renderTodayList(); refreshHome();
  if(store.settings.autoClear){
    $("#inProduct").value=""; $("#inPrice").value=""; $("#inQty").value=1; $("#inMemo").value=""; $("#priceHistory").innerHTML="";
  }
}

document.addEventListener("click", (e) => {
  if (e.target.id !== "btnClear") return;

  const set = (sel, val) => {
    const el = document.querySelector(sel);
    if (!el) return;
    el.value = val;
    el.dispatchEvent(new Event("input",  { bubbles:true }));
    el.dispatchEvent(new Event("change", { bubbles:true }));
  };

  // 基本欄
  set("#inQty", 1);
  set("#inPrice", "");
  set("#inMemo", "");
  set("#inProduct", "");

  // フリー入力
  set("#freeSupplier", "");
  set("#freeProduct", "");

  // 検索欄（存在するものだけ全て空に）
  ["#productSearch","#inProductSearch",'input[name="productSearch"]','input[placeholder*="商品"]']
    .forEach(s => set(s, ""));
  ["#supplierSearch","#inSupplierSearch",'input[name="supplierSearch"]','input[placeholder*="仕入"]']
    .forEach(s => set(s, ""));

  const ph = document.querySelector("#priceHistory");
  if (ph) ph.innerHTML = "";
});



/* 商品編集委譲 */
document.addEventListener("click",(e)=>{
  const btn = e.target.closest("#productList .edit");
  if(!btn) return;
  const pid = btn.getAttribute("data-id");
  if(!pid){ alert("商品IDが見つかりません"); return; }
  const p = store.products.find(x=>!x.deleted && x.id===pid);
  if(!p){ alert("商品が見つかりません"); return; }
  openProductModal(p);
});

/* Today list */
function renderTodayList(){
  const cont=$("#todayList"); if(!cont) return;
  cont.innerHTML="";
  const d=todayStr(); const group={};
  store.entries.filter(x=>!x.deleted && x.date===d).forEach(e=>{
    const key=e.supplier_id||e.supplier_name_fallback||"未指定";
    (group[key]=group[key]||[]).push(e);
  });
  Object.keys(group).forEach(k=>{
    const sup=supplierName(k)||k;
    const div=document.createElement("div"); div.className="list-item";
    let net=0,gross=0; group[k].forEach(e=>{const t=calcLineTotal(e); net+=t.excl; gross+=t.incl;});
    let html=`<b>${sup}</b><div class="muted">税別 ${yen(net)}｜税込 ${yen(gross)}</div>`;
    html+=group[k].map(e=>{
      const t=calcLineTotal(e);
      const txLabel=e.taxmode==="incl"?"税込":(e.taxrate===0?"非課税":"税別");
      const show=(e.taxmode==="incl")?t.incl:t.excl;
      const meta = store.settings.showTaxFlags ? `<br><span class="mini-meta">単価 ${yen(e.price)} / ${e.taxrate}% / ${txLabel}</span>` : "";
      return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
        <span>・${prodName(e.product_id,e.product_name_fallback)} ×${e.qty}${meta}</span>
        <span>${yen(show)}</span>
      </div>`;
    }).join("");
    div.innerHTML=html; cont.appendChild(div);
  });
}

/* ===== Supplier/Product ===== */
function renderSuppliers(){
  const list = $("#supplierList");
  if (!list) return;
  list.innerHTML = "";

  const suppliers = (store.suppliers || []).filter(s => !s.deleted);
  const products  = (store.products || store.items || []);

  suppliers.forEach(s => {
    const prodCount = products.filter(p => !p?.deleted && (p.supplier_id ?? p.supplierId) === s.id).length;

    const item = document.createElement("div");
    item.className = "list-item supplier";
    item.setAttribute("data-id", s.id);            // ← 行にIDを通す

    item.innerHTML = `
      <div class="tapzone" data-id="${s.id}">
        <b>${s.name}</b>
        <div class="muted">担当:${s.contact || "-" } TEL:${s.phone || "-" } INV:${s.invoice_number || "-" }</div>
        <div class="muted">｜商品${prodCount}件</div>
      </div>
      <div class="ops-col">
        <button class="btn op small square addp" type="button" data-id="${s.id}">
          <span class="twoline">＋<br>商品追加</span>
        </button>
        <button class="btn op small square edit" type="button" data-id="${s.id}">編集</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function fillFilterSupplier(){
  const sel=$("#filterProdSupplier"); if(!sel) return;
  const cur=sel.value;
  sel.innerHTML='<option value="">すべて</option>';
  store.suppliers.filter(s=>!s.deleted).forEach(s=>{
    const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}
function fillHistorySupplierSelect(){
  const sel = $("#hisSupplier"); if (!sel) return;
  const current = String(store.settings.historySupplierFilter || "");

  sel.innerHTML = '<option value="">すべて</option>';

  (store.suppliers || []).filter(s => !s.deleted).forEach(s => {
    const o = document.createElement("option");
    o.value = s.id;
    o.textContent = s.name;
    sel.appendChild(o);
  });

  if (current && [...sel.options].some(o => o.value === current)) {
    sel.value = current;
  } else {
    sel.value = "";
  }
}
document.addEventListener("click",(e)=>{
  const root = document.getElementById("supplierList");
  if (!root) return;

  const addp = e.target.closest("#supplierList .addp");
  const edit = e.target.closest("#supplierList .edit");
  const tap  = e.target.closest("#supplierList .tapzone");
  const host = e.target.closest("#supplierList .list-item.supplier,[data-id]");

  // 押された要素 or 行から ID を取得（最優先で data-id を参照）
  const id = (e.target.getAttribute?.("data-id"))
          || (host && host.getAttribute("data-id"));

  if (addp){
    if (!id) return alert("仕入先IDが見つかりません");
    tryAddProductStart(id);
    return;
  }
  if (edit){
    if (!id) return alert("仕入先IDが見つかりません");
    const sup = (store.suppliers||[]).find(s=>s.id===id);
    if (!sup) return alert("仕入先が見つかりません");
    openSupplierModal(sup);
    return;
  }
  if (tap){
    if (!id) return;
    navigate("products");
    const sel = $("#filterProdSupplier");
    if (sel){ sel.value = id; }
    renderProducts();
    return;
  }
});

function renderProducts(){
  const list=$("#productList"); if(!list) return;
  const sid=$("#filterProdSupplier").value;
  const items=store.products.filter(p=>!p.deleted&&(!sid||p.supplier_id===sid));
  list.innerHTML="";
  items.forEach(p=>{
    const sName=supplierName(p.supplier_id)||"-";
    const item=document.createElement("div"); item.className="list-item";
    item.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${p.name}</b>
          <div class="muted">${sName}｜既定価格 ${yen(p.default_price||0)}｜${p.tax_rate}%｜${p.tax_mode==="incl"?"税込":"税別"}</div>
          ${p.note?(`<div class="muted">メモ：${p.note}</div>`):""}
        </div>
        <div style="width:102px">
          <button class="btn op small square edit" type="button" data-id="${p.id}">編集</button>
        </div>
      </div>`;
    list.appendChild(item);
  });
}
document.addEventListener("change",(e)=>{ if(e.target.id==="filterProdSupplier") renderProducts(); });

/* ===== モーダル基盤 ===== */
function closeModal(){
  const host = document.getElementById('modalHost');
  const pickOutside = () =>
    (window._prevFocus && document.contains(window._prevFocus) && window._prevFocus) ||
    document.querySelector('#btnHome, header a, header button, nav a, main, body') || document.body;

  let out = pickOutside();
  if (host && host.contains(document.activeElement)) {
    if (out === document.body && !out.hasAttribute('tabindex')) out.setAttribute('tabindex','-1');
    out.focus({ preventScroll:true });
    if (out === document.body) out.removeAttribute('tabindex');
  }
  requestAnimationFrame(() => {
    if (host && host.contains(document.activeElement)) {
      out = pickOutside();
      if (out === document.body && !out.hasAttribute('tabindex')) out.setAttribute('tabindex','-1');
      out.focus({ preventScroll:true });
      if (out === document.body) out.removeAttribute('tabindex');
    }
    host?.classList.add('hidden');
    host?.setAttribute('aria-hidden','true');
  });
}
function openModalBase(title,bodyHTML){
  window._prevFocus = document.activeElement;
  $("#modalTitle").textContent=title;
  $("#modalBody").innerHTML=bodyHTML;
  const host=$("#modalHost");
  const ok=$("#modalOK"), cancel=$("#modalCancel"), del=$("#modalDelete");
  ok.textContent="保存"; cancel.textContent="キャンセル"; del.textContent="削除";
  ok.onclick=null; del.onclick=null; cancel.onclick=closeModal;
  del.classList.add("hidden");
  ok.classList.add("btn--save"); cancel.classList.add("btn--cancel"); del.classList.add("btn--delete");
  host.classList.remove("hidden"); host.setAttribute("aria-hidden","false");
$("#modalHost :is(input,button,select,textarea,[tabindex]:not([tabindex='-1']))")?.focus();
}
(function(){
  const host=$("#modalHost"); if(!host||host.__bound) return;
  host.addEventListener("click",e=>{ if(e.target===host) closeModal(); });
  document.addEventListener("keydown",e=>{ if(e.key==="Escape" && !host.classList.contains("hidden")) closeModal(); });
  host.__bound=true;
})();

/* ===== 仕入先 / 商品モーダル ===== */
function openSupplierModal(s){
  openModalBase(s?"仕入れ先を編集":"仕入れ先を追加",`
    <div class="grid cols-2">
      <div><div class="label">社名</div><input id="mSupName" type="text" value="${s?.name||""}"></div>
      <div><div class="label">担当者</div><input id="mSupContact" type="text" value="${s?.contact||""}"></div>
      <div><div class="label">電話</div><input id="mSupPhone" type="text" value="${s?.phone||""}" inputmode="tel"></div>
      <div><div class="label">インボイス番号</div><input id="mSupInv" type="text" value="${s?.invoice_number||""}"></div>
    </div>`);
  const onOK=()=>{
    const name=$("#mSupName").value.trim(); if(!name){ alert("社名を入力してください"); return; }
    if(!s){
      const limit = PlanRules[getPlan()].supplierMax;
      const count = store.suppliers.filter(x=>!x.deleted).length;
      if(count >= limit){ alert(`このプランでは仕入れ先は ${limit} 社までです。Plans からアップグレードをご検討ください。`); return; }
    }
    const contact=$("#mSupContact").value.trim();
    const phone  =$("#mSupPhone").value.trim();
    const inv    =$("#mSupInv").value.trim();
    if(s){ s.name=name; s.contact=contact; s.phone=phone; s.invoice_number=inv; }
   else {  const cap = CAPS();const supCount = store.suppliers.filter(x=>!x.deleted).length;
  	if (supCount >= cap.suppliers){
    alert(`現在のプランでは仕入先は ${capLabel(cap.suppliers,'社')} までです。\nPlans からアップグレードをご検討ください。`);
    return;
  }
  store.suppliers.push({id:uid(),name,contact,phone,invoice_number:inv});
}
    DB.save(store); renderSuppliers(); refreshHome(); fillSupplierSelect($("#inSupplier")); closeModal();
  };
  $("#modalOK").onclick=onOK;

 if (s) {
  var delBtn = document.querySelector("#modalDelete");
  if (delBtn) delBtn.classList.remove("hidden");

  if (delBtn) delBtn.onclick = function () {
    var sid = s.id;
    var products = Array.isArray(store.products) ? store.products : [];
    var prodLinked = products.filter(function(p){
      return !p.deleted && p.supplier_id === sid;
    }).length;

    var ok = confirm(
      "仕入先「" + s.name + "」を削除します。\n" +
      "関連商品 " + prodLinked + " 件も同時に削除されます。よろしいですか？"
    );
    if (!ok) return;

    // 1) 商品カスケード（物理削除）
    if (Array.isArray(store.products)) {
      store.products = store.products.filter(function(p){ return p.supplier_id !== sid; });
    }

    // 2) 仕入先を物理削除（配列から除去）
    var i = (store.suppliers || []).findIndex(function(x){ return x && x.id === sid; });
    if (i >= 0) store.suppliers.splice(i, 1);

    // 3) 保存 & 再描画 & プランUI更新
    DB.save(store);
    renderSuppliers();
    fillFilterSupplier();
    renderProducts();
    refreshHome();
    try { enforcePlan(); applyPlanUI(); } catch(e) {}

    closeModal();
  };

  var actions = document.querySelector(".actions");
  var cancelBtn = document.querySelector("#modalCancel");
  if (actions && delBtn && cancelBtn) actions.insertBefore(delBtn, cancelBtn);
}
} 
function tryAddSupplier(){
  const limit = PlanRules[getPlan()].supplierMax;
  const count = store.suppliers.filter(x=>!x.deleted).length;
  if(count >= limit){ alert(`このプランでは仕入れ先は ${limit} 社までです。Plans からアップグレードをご検討ください。`); return; }
  openSupplierModal(null);
}

function openProductModal(p,defaultSid){
  const supOpts=store.suppliers.filter(s=>!s.deleted).map(s=>`<option value="${s.id}" ${(p?.supplier_id||defaultSid)===s.id?"selected":""}>${s.name}</option>`).join("");
  openModalBase(p?"商品を編集":"商品を追加",`
    <div class="grid cols-2">
      <div><div class="label">仕入れ先</div><select id="mProdSup">${supOpts}</select></div>
      <div><div class="label">商品名</div><input id="mProdName" type="text" value="${p?.name||""}"></div>
      <div><div class="label">既定価格</div><input id="mProdPrice" type="number" inputmode="numeric" value="${p?.default_price??""}"></div>
      <div><div class="label">税率</div><select id="mProdRate">
        <option value="10" ${p?.tax_rate===10?"selected":""}>10%</option>
        <option value="8" ${p?.tax_rate===8||p==null?"selected":""}>8%</option>
        <option value="0" ${p?.tax_rate===0?"selected":""}>非課税</option>
      </select></div>
      <div><div class="label">区分</div><select id="mProdMode">
        <option value="excl" ${(p?.tax_mode||"excl")==="excl"?"selected":""}>税別</option>
        <option value="incl" ${(p?.tax_mode||"excl")==="incl"?"selected":""}>税込</option>
      </select></div>
      <div style="grid-column:1/-1">
        <div class="label">商品メモ（任意）</div>
        <textarea id="mProdNote" placeholder="例：入数24・リードタイム2日など">${p?.note||""}</textarea>
      </div>
    </div>`);
  const onOK=()=>{
    const sid=$("#mProdSup").value;
    const name=$("#mProdName").value.trim();
    if(!sid||!name){ alert("仕入れ先と商品名を入力してください"); return; }
    if(!p && store.products.some(x=>!x.deleted&&x.supplier_id===sid&&x.name===name)){
      if(!confirm("同一仕入れ先に同名の商品があります。登録しますか？")) return;
    }
    // プラン制限チェック
    if(!p){
      const rules = PlanRules[getPlan()];
      const total = store.products.filter(x=>!x.deleted).length;
      if(total >= rules.productTotalMax){ alert(`このプランでは商品は合計 ${rules.productTotalMax} 品までです。Plans からアップグレードをご検討ください。`); return; }
      const per = store.products.filter(x=>!x.deleted && x.supplier_id===sid).length;
      if(per >= rules.productPerSupplierMax){ alert(`このプランでは1社あたり ${rules.productPerSupplierMax} 品までです。別カードに同じ仕入先を追加して分割も可能です（ミドル以上）。`); return; }
    }
    const price=Number($("#mProdPrice").value||0);
    const tax_rate=Number($("#mProdRate").value||8);
    const tax_mode=$("#mProdMode").value||"excl";
    const note=$("#mProdNote").value||"";
    if(p){ p.supplier_id=sid; p.name=name; p.default_price=price; p.tax_rate=tax_rate; p.tax_mode=tax_mode; p.note=note; }
   else {const cap = CAPS(); const total = store.products.filter(x=>!x.deleted).length;
  if (total >= cap.products){
     alert(`現在のプランでは商品合計は ${capLabel(cap.products,'品')} までです。\nPlans からアップグレードをご検討ください。`);
     return;
  }
   const per = store.products.filter(x=>!x.deleted && x.supplier_id===sid).length;
   if (per >= cap.perSupplier){
     alert(`現在のプランではこの仕入先の登録は ${capLabel(cap.perSupplier,'品/カード')} までです。`);
     return;
  }
   store.products.push({id:uid(),supplier_id:sid,name,default_price:price,tax_rate:tax_rate,tax_mode:tax_mode,note});
 }
    DB.save(store); renderProducts();renderSuppliers(); renderProductSelect($("#inProduct"),$("#inSupplier").value,$("#prodSearch").value||""); closeModal();
  };
  $("#modalOK").onclick=onOK;

  if(p){
    const delBtn=$("#modalDelete"); delBtn.classList.remove("hidden");
    delBtn.onclick=()=>{ if(confirm("削除しますか？")){ p.deleted=true; DB.save(store); renderProducts(); renderSuppliers();closeModal(); } };
    $(".actions").insertBefore(delBtn, $("#modalCancel"));
  }
}
function tryAddProductStart(defaultSid){
  const rules = PlanRules[getPlan()];
  const total = store.products.filter(x=>!x.deleted).length;
  if(total >= rules.productTotalMax){ alert(`このプランでは商品は合計 ${rules.productTotalMax} 品までです。Plans からアップグレードをご検討ください。`); return; }
  openProductModal(null, defaultSid);
}

/* ===== 明細編集（Lite：数量・単価・税率） ===== */
function _findEntryById(id){
  if(!id) return null;
  return (store.entries||[]).find(e=>e && !e.deleted && e.id===id) || null;
}
function _pushPriceHistoryIfNeeded(e){
  try{
    if(!e || !e.product_id) return;
    const arr = store.priceHistory[e.product_id] || [];
    arr.push({ price: Number(e.price)||0, ts: Date.now(), taxrate: Number(e.taxrate)||0, taxmode: e.taxmode||"excl" });
    store.priceHistory[e.product_id] = arr.slice(-5);
  }catch(_){}}
function openEntryEditModalLite(entry){
  if(!entry){ alert("明細が見つかりません"); return; }
  const pname = (store.products.find(p=>p.id===entry.product_id)||{}).name || (entry.product_name_fallback || "未登録");
  const sName = (store.suppliers.find(s=>s.id===entry.supplier_id)||{}).name || (entry.supplier_name_fallback || "未指定");
  const modeLabel = entry.taxmode==="incl" ? "税込" : "税別";
  openModalBase("明細を編集", `
    <div class="grid cols-2">
      <div style="grid-column:1/-1"><div class="label">仕入れ先</div><input type="text" value="${sName}" disabled></div>
      <div style="grid-column:1/-1"><div class="label">商品</div><input type="text" value="${pname}" disabled></div>
      <div><div class="label">数量</div><input id="mLiteQty" type="number" inputmode="numeric" min="0" step="1" value="${entry.qty}"></div>
      <div><div class="label">単価</div><input id="mLitePrice" type="number" inputmode="numeric" min="0" step="1" value="${entry.price}"></div>
      <div><div class="label">税率</div>
        <select id="mLiteRate">
          <option value="10" ${entry.taxrate===10?"selected":""}>10%</option>
          <option value="8"  ${entry.taxrate===8 ?"selected":""}>8%</option>
          <option value="0"  ${entry.taxrate===0 ?"selected":""}>非課税</option>
        </select>
      </div>
      <div><div class="label">区分（参照）</div><input type="text" value="${modeLabel}" disabled></div>
      <div style="grid-column:1/-1" class="mini-meta">※ この画面では <b>数量・単価・税率</b>のみ変更できます。区分とメモは編集対象外です。</div>
    </div>
  `);
  const ok = $("#modalOK"); const del = $("#modalDelete");
  del.classList.remove("hidden");
  del.onclick = function(){
    if(!confirm("この明細を削除します。よろしいですか？")) return;
    try{
      // まず完全に配列から除去（なければフラグ）
      var idx = (store.entries||[]).findIndex(function(x){ return x && x.id === entry.id; });
      if (idx >= 0) store.entries.splice(idx, 1);
      else entry.deleted = true;
      DB.save(store);
      try{ window.renderTodayList?.(); window.renderHistory?.(); window.refreshHome?.(); }catch(_){}
    }finally{
      try{ window.closeModal?.(); }catch(_){}
    }
  };
ok.textContent="更新";
  ok.onclick = ()=>{
    console.log("edit-lite OK clicked");
    const q = Number($("#mLiteQty").value || 0);
    const p = Number($("#mLitePrice").value || 0);
    const r = Number($("#mLiteRate").value || entry.taxrate || 8);
    if(!Number.isFinite(q) || q<=0){ alert("数量を正しく入力してください"); return; }
    if(!Number.isFinite(p) || p< 0){ alert("単価を正しく入力してください"); return; }
    if(![0,8,10].includes(r)){ alert("税率を選択してください"); return; }
    entry.qty=q; entry.price=p; entry.taxrate=r;
    _pushPriceHistoryIfNeeded(entry);
    DB.save(store);
    try{ renderTodayList(); }catch(_){}
    try{ renderHistory(); }catch(_){}
    try{ refreshHome(); }catch(_){}
    closeModal();
  };
document.addEventListener("click", (e)=>{
  const row = e.target.closest("#historyList .entry, #todayList .entry");
  if(!row) return;
  const id = row.getAttribute("data-id");
  const entry = _findEntryById(id);
  if(!entry){ alert("編集対象が見つかりません"); return; }
  e.preventDefault();
  openEntryEditModalLite(entry);
});
}

/* ===== HISTORY（描画） ===== */
function renderHistory(){
  const list = $("#historyList"); if(!list) return;
  const rangeKey = String(store.settings.hisRange || "30"); // "7"|"30"|"fiscal"
  const showBoth = !!store.settings.historyShowBoth;
  const showDetail = !!store.settings.showTaxFlags;
  const supFilter = String(store.settings.historySupplierFilter || "");
  const realNow = new Date();
  const now = activeNow();
  now.setHours(23,59,59,999);
  const ay = getActiveYear();
  const yearStart = new Date(ay,0,1); yearStart.setHours(0,0,0,0);
  const yearEnd   = new Date(ay,11,31); yearEnd.setHours(23,59,59,999);
  let from;
  let end = now;

  if (rangeKey === "fiscal") {
    const fy = getActiveYear();
    from = new Date(fy, 0, 1);
    from.setHours(0,0,0,0);
    if (fy !== realNow.getFullYear()) {
      end = new Date(fy, 11, 31);
      end.setHours(23,59,59,999);
    }
  } else if (rangeKey === "7") {
    // 今週（月曜〜日曜）
    const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const day = base.getDay() || 7; // 月=1, ..., 日=7
    from = new Date(base);
    from.setDate(base.getDate() - (day - 1)); // その週の月曜
    from.setHours(0,0,0,0);
    const sunday = new Date(from);
    sunday.setDate(from.getDate() + 6); // 日曜
    sunday.setHours(23,59,59,999);
    end = sunday;
  } else if (rangeKey === "30") {
    // 今月（1日〜月末）
    from = new Date(now.getFullYear(), now.getMonth(), 1);
    from.setHours(0,0,0,0);
    const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    last.setHours(23,59,59,999);
    end = last;
  } else {
    // フォールバック（念のため従来の「直近n日」挙動）
    let days = Number(rangeKey); if(!Number.isFinite(days)||days<=0) days = 30;
    from = new Date(now.getTime() - (days-1)*86400000);
    from.setHours(0,0,0,0);
  }


  // 選択年度の範囲にクランプ（年を跨いで表示しない）
  if (from && from < yearStart) from = yearStart;
  if (end && end > yearEnd) end = yearEnd;

  list.innerHTML = "";
  const entries = (store.entries||[]).filter(e=>{
    if(!e || e.deleted || !e.date) return false;
    if(!String(e.date).startsWith(String(ay)+"-")) return false;
    const d = new Date(e.date+"T12:00:00");
    if (!(d >= from && d <= end)) return false;
    if (supFilter && e.supplier_id !== supFilter) return false;
    return true;
  });
  if(!entries.length){ list.innerHTML = `<div class="muted">対象期間の履歴はありません。</div>`; return; }

  // 期間と仕入れ先フィルタを反映した合計カード（先頭に表示）
  let totalNet = 0, totalGross = 0;
  for (const e of entries){
    const t = calcLineTotal(e);
    totalNet += t.excl;
    totalGross += t.incl;
  }
  const sumCard = document.createElement("div");
  sumCard.className = "card";
  const titleParts = ["期間合計"];
  if (supFilter) {
    const name = supplierName(supFilter) || "";
    if (name) titleParts.push(`（${name}）`);
  }
  const headText = showBoth ? `税別 ${yen(totalNet)}｜税込 ${yen(totalGross)}` : `税込 ${yen(totalGross)}`;
  sumCard.innerHTML = `<b>${titleParts.join("")}</b><div class="muted" style="margin-top:4px">${headText}</div>`;
  list.appendChild(sumCard);

  if (rangeKey === "fiscal"){
    const byMonth = {};
    for (const e of entries){
      const d = new Date(e.date+"T12:00:00");
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      (byMonth[ym] = byMonth[ym] || []).push(e);
    }
    const months = Object.keys(byMonth).sort().reverse();
    for (const ym of months){
      const sec = document.createElement("div"); sec.className = "card";
      let html = `<b>${ym}</b>`;
      const group = {};
      for (const e of byMonth[ym]){ const sk = e.supplier_id || e.supplier_name_fallback || "未指定"; (group[sk] = group[sk] || []).push(e); }
      for (const sk of Object.keys(group)){
        const name = supplierName(sk) || sk;
        let net=0,gross=0; for (const e of group[sk]){ const t=calcLineTotal(e); net+=t.excl; gross+=t.incl; }
        const head = showBoth ? `税別 ${yen(net)}｜税込 ${yen(gross)}` : `税込 ${yen(gross)}`;
        html += `<div style="margin-top:6px"><u>${name}</u> <span class="muted">${head}</span>`;
        html += group[sk].map(e=>{
          const t=calcLineTotal(e);
          const show=(e.taxmode==="incl")?t.incl:t.excl;
          const txLabel=(e.taxmode==="incl")?"税込":(e.taxrate===0?"非課税":"税別");
          const meta = showDetail ? `<br><span class="mini-meta">単価 ${yen(e.price)} / ${e.taxrate||0}% / ${txLabel}</span>` : "";
          return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
            <span>・${e.date} ${prodName(e.product_id,e.product_name_fallback)} ×${e.qty}${meta}</span>
            <span>${yen(show)}</span>
          </div>`;
        }).join("");
        html += `</div>`;
      }
      sec.innerHTML = html; list.appendChild(sec);
    }
    return;
  }

  const byDate = {};
  for (const e of entries){ (byDate[e.date] = byDate[e.date] || []).push(e); }
  const dates = Object.keys(byDate).sort().reverse();

  for (const dkey of dates){
    const sec=document.createElement("div"); sec.className="card";
    let html = `<b>${new Date(dkey+"T12:00:00").toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"short"})}</b>`;
    const group={};
    for (const e of byDate[dkey]){ const sk=e.supplier_id||e.supplier_name_fallback||"未指定"; (group[sk]=group[sk]||[]).push(e); }
    for (const sk of Object.keys(group)){
      const name=supplierName(sk)||sk;
      let net=0,gross=0; for(const e of group[sk]){ const t=calcLineTotal(e); net+=t.excl; gross+=t.incl; }
      const head = showBoth ? `税別 ${yen(net)}｜税込 ${yen(gross)}` : `税込 ${yen(gross)}`;
      html += `<div style="margin-top:6px"><u>${name}</u> <span class="muted">${head}</span>`;
      html += group[sk].map(e=>{
        const t=calcLineTotal(e);
        const show=(e.taxmode==="incl")?t.incl:t.excl;
        const txLabel=(e.taxmode==="incl")?"税込":(e.taxrate===0?"非課税":"税別");
        const meta = showDetail ? `<br><span class="mini-meta">単価 ${yen(e.price)} / ${e.taxrate||0}% / ${txLabel}</span>` : "";
        return `<div class="row entry" data-id="${e.id}" style="justify-content:space-between;cursor:pointer">
          <span>・${prodName(e.product_id,e.product_name_fallback)} ×${e.qty}${meta}</span>
          <span>${yen(show)}</span>
        </div>`;
      }).join("");
      html += `</div>`;
    }
    sec.innerHTML=html; list.appendChild(sec);
  }
}

/* ===== Export（Excel XML一本化） ===== */
function saveExcelXML(name, rows2d){
  const esc = s => String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  const toCell = (val, isHeader) => {
    if (!isHeader && typeof val === "number" && Number.isFinite(val)) {
      return `<Cell ss:StyleID="s1"><Data ss:Type="Number">${val}</Data></Cell>`;
    }
    return `<Cell ss:StyleID="s1"><Data ss:Type="String">${esc(val)}</Data></Cell>`;
  };
  const rowsXml = rows2d.map((row, i)=>"<Row>"+row.map(v=>toCell(v, i===0)).join("")+"</Row>").join("");
  const xml =
`<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
          xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
  <Styles>
    <Style ss:ID="s1">
      <Borders>
        <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
        <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
        <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
        <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
      </Borders>
    </Style>
  </Styles>
  <Worksheet ss:Name="Sheet1">
    <Table>${rowsXml}</Table>
  </Worksheet>
</Workbook>`;
  const blob = new Blob([xml], { type: "application/vnd.ms-excel" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (name || `tlp_export_${Date.now()}.xml`).replace(/\.\w+$/,'') + ".xml";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}


function exportYearXML(year){
  const plan = PLAN();
  // 年度出力が許可されているか（Freeは不可）
  if (clampExportKey("fiscal", plan) !== "fiscal"){
    alert("年度出力は有料プランで利用できます。");
    return false;
  }
  const y = Number(year);
  if(!Number.isFinite(y)) return false;

  const rows = [["日付","仕入れ先","商品","数量","単価","税率","区分","税込額","メモ"]];
  const entries = (store.entries||[]).filter(e=>{
    if(!e || e.deleted || !e.date) return false;
    return String(e.date).startsWith(String(y)+"-");
  }).sort((a,b)=> String(a.date).localeCompare(String(b.date)));

  if(!entries.length){
    alert("前年度の明細がありません。");
    return false;
  }

  entries.forEach(e=>{
    const s = supplierName(e.supplier_id) || e.supplier_name_fallback || "";
    const p = prodName(e.product_id, e.product_name_fallback);
    const g = (e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100)) * e.qty;
    rows.push([ e.date, s, p, e.qty, e.price, e.taxrate,
      (e.taxmode==="incl"?"税込":"税別"), Math.round(g), e.memo||"" ]);
  });

  const from = new Date(y,0,1);
  const to = new Date(y,11,31);
  const label = `${_ym(from)}〜${_ym(to)}`;
  saveExcelXML(`仕入れ記録_年度_${label}.xml`, rows);
  return true;
}

function deleteEntriesOfYear(year){
  const y = Number(year);
  if(!Number.isFinite(y)) return 0;
  const before = (store.entries||[]).length;
  store.entries = (store.entries||[]).filter(e=>{
    if(!e || !e.date) return true;
    return !String(e.date).startsWith(String(y)+"-");
  });
  const removed = before - store.entries.length;
  DB.save(store);
  return removed;
}

function exportData(rangeKey){
  const plan = PLAN(); // もしくは getPlan()
  const key  = clampExportKey(rangeKey, plan);
  const range = getExportRange(key);

  const rows = [["日付","仕入れ先","商品","数量","単価","税率","区分","税込額","メモ"]];
  const ay = getActiveYear();
  const entries = (store.entries||[]).filter(e => e && !e.deleted && e.date && String(e.date).startsWith(String(ay)+"-") && (!range.from || _inRange(e.date, range)));
  if (!entries.length){ alert("選択した期間にデータがありません。"); return; }

  entries.forEach(e=>{
    const s = supplierName(e.supplier_id) || e.supplier_name_fallback || "";
    const p = prodName(e.product_id, e.product_name_fallback);
    const g = (e.taxmode==="incl" ? e.price : e.price*(1+e.taxrate/100)) * e.qty;
    rows.push([ e.date, s, p, e.qty, e.price, e.taxrate,
      (e.taxmode==="incl"?"税込":"税別"), Math.round(g), e.memo||"" ]);
  });

  const base = key==='month' ? range.label : (key==='fiscal' ? `年度_${range.label}` : "全期間");
  saveExcelXML(`仕入れ記録_${base}.xml`, rows);
  alert("Excel XML（.xml）で出力しました。");
}

/* === 出力モーダル（プラン連動） === */
function ModalExport(){
  const plan = getPlan();
  openModalBase("データ出力", `
    <div class="grid" id="ModalExport">
      <div class="label">出力範囲</div>
      <label><input type="radio" name="exRange" value="month"> 当月</label>
      <label><input type="radio" name="exRange" value="fiscal"> 年度（1月〜今月）</label>
      <label><input type="radio" name="exRange" value="all"> 全期間</label>
      <div class="mini-meta">プラン：${planJp(plan)}</div>
    </div>
  `);
  const radios = Array.from(document.querySelectorAll('input[name="exRange"]'));
  radios.forEach(r => { r.disabled = (clampExportKey(r.value, plan) !== r.value); });
  const def = PlanRules[plan].exportMax;
  (radios.find(r=>r.value===def) || radios[0]).checked = true;
  const ok=$("#modalOK");
  ok.textContent="出力する";
  ok.onclick=()=>{
    const chosen = document.querySelector('input[name="exRange"]:checked')?.value || def;
    closeModal();
    exportData(chosen);
  };
}
document.addEventListener("click", (e)=>{ const btn = e.target.closest("#btnExport, #btnExport2"); if(!btn) return; e.preventDefault(); ModalExport(); });

// ---- Plan enforcement (端末プランに基づくロック計算) ----
function getPlan(){
  try {
    const p = (localStorage.getItem(PLAN_KEY) || '').toLowerCase();
    if (p === 'pro' || p === 'middle' || p === 'free') return p;
    // 互換: 旧キー（tlpPro=1）は pro 扱い
    return (localStorage.getItem(PRO_KEY) === '1') ? 'pro' : 'free';
  } catch(_) { return 'free'; }
}


// 復元直後などに呼んで“ロック対象”だけ計算して保存

// Fallback plan limits used by enforcePlan (locks). Keep in sync with PlanCap.
window.PLAN_LIMITS = window.PLAN_LIMITS || {
  free:   { suppliers: 5,  products: 50,  entries: Infinity },
  middle: { suppliers: 15, products: 200, entries: Infinity },
  pro:    { suppliers: Infinity, products: Infinity, entries: Infinity }
};
window.enforcePlan = function(){
  const plan = getPlan();
 const lim  = window.PLAN_LIMITS[plan] || window.PLAN_LIMITS.free;

  const mkLocks = (arr, limit) => {
    if (!Array.isArray(arr)) return [];
    const locks = [];
    for (let i = limit; i < arr.length; i++) {
      const it = arr[i];
      const id = it && (it.id ?? it.uuid ?? it.code);
      locks.push(id != null ? id : i);
    }
    return locks;
  };

  store.planLocks = {
    suppliers: mkLocks(store.suppliers, lim.suppliers),
    products:  mkLocks(store.products,  lim.products),
    entries:   mkLocks(store.entries,   lim.entries),
  };

  try { DB.save(store); } catch(_) {}
};
// ---- Central guards (まだUIには接続しない) ----

// entity: "suppliers" | "products" | "entries"
window.canCreate = function(entity){
  const plan = getPlan();
  const lim  = window.PLAN_LIMITS[plan] || window.PLAN_LIMITS.free;
  const count = (store && Array.isArray(store[entity])) ? store[entity].length : 0;
  const limit = lim[entity] ?? 0;
  return count < limit;               // 上限未満なら新規追加OK
};

// itemを編集できるか（超過分は閲覧のみ）
window.isLocked = function(entity, item, index){
  if (!store || !store.planLocks) return false;
  const locks = store.planLocks[entity] || [];
  const id = item && (item.id ?? item.uuid ?? item.code);
  const key = (id != null) ? id : index;
  return locks.includes(key);         // trueなら“編集不可”
};
// ---- Plan UI wiring (Addボタンだけ最小で無効化) ----
window.applyPlanUI = function(){
  const btns = [
    { sel: '#btnAddSupplier', entity: 'suppliers', label: '仕入先の追加' },
    { sel: '#btnAddProduct',  entity: 'products',  label: '商品の追加' },
    { sel: '#btnAddEntry',    entity: 'entries',   label: '仕入入力の追加' },
  ];
  btns.forEach(({sel, entity, label})=>{
    const el = document.querySelector(sel);
    if(!el) return; // ボタンが存在しなければ何もしない（安全）
    const ok = window.canCreate ? window.canCreate(entity) : true;
    el.disabled = !ok;
    el.title = ok ? '' : `この端末のプランでは「${label}」の上限に達しています`;
    el.classList.toggle('is-disabled', !ok); // あれば見た目用
  });
};
// ---- 保存ガード：ロック行は保存できないよう中央で止める ----
document.addEventListener('click', (e) => {
  // 保存ボタン候補（IDは必要に応じて実IDに置換）
  const targets = new Map([
    ['#btnSaveSupplier', {entity:'suppliers', getIndex:()=> document.querySelector('#supplierForm [name="index"]')?.value}],
    ['#btnSaveProduct',  {entity:'products',  getIndex:()=> document.querySelector('#productForm  [name="index"]')?.value}],
    ['#btnSaveEntry',    {entity:'entries',   getIndex:()=> document.querySelector('#entryForm    [name="index"]')?.value}],
  ]);

  for (const [sel, cfg] of targets) {
    const btn = e.target.closest(sel);
    if (!btn) continue;

    if (!(window.isLocked && window.canCreate)) return; // まだ未定義なら何もしない

    const {entity, getIndex} = cfg;
    // 編集対象インデックス（フォームの隠しinputなどから取得）
    let idx = Number(window.getIndex?.() ?? -1);
    if (Number.isNaN(idx)) idx = -1;

    // 新規作成は canCreate() を、既存編集は isLocked() をチェック
    const isCreate = (idx < 0);
    let blocked = false;

    if (isCreate) {
      blocked = !canCreate(entity);
      if (blocked) alert(`この端末のプランでは ${entity} の新規作成上限に達しています。`);
    } else {
      const item = (store?.[entity] ?? [])[idx];
      blocked = isLocked(entity, item, idx);
      if (blocked) alert(`この端末のプランでは、この${entity==='entries'?'仕入入力':entity==='products'?'商品':'仕入先'}は編集できません。`);
    }

    if (blocked) { e.preventDefault(); e.stopPropagation(); return; }
  }
}, true);

  document.addEventListener("click",(e)=>{ if(e.target.id==="btnBackupNow") saveBackupStrict(); });

// Restore: クリック → 毎回クリアして同一ファイルでも change が発火
document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnRestore") return;
  const input = document.getElementById("fileRestore");
  if(!input) return;
  input.value = "";   // ←重要：同じファイルでも再選択で発火させる
  input.click();
});

// Restore: 読み込み＋適用（全ての終了経路で input をリセット）
document.addEventListener("change",(e)=>{
  if(e.target.id!=="fileRestore") return;

  const input = e.target;
  const f = input.files && input.files[0];
  if(!f){ input.value=''; return; }

  if(!confirm("バックアップから復元します。現在のデータは置き換えられます。続行しますか？")){
    input.value='';   // ←キャンセル時もクリア
    return;
  }

  const r = new FileReader();

  r.onerror = () => {
    alert("バックアップの読み込みに失敗しました（I/Oエラー）");
    input.value = '';
  };

  r.onload = () => {
    try{
      const data = JSON.parse(String(r.result||""));
      if(!data || !data.tables) throw 0;

      // 既存の適用処理（そのまま）
store.suppliers = data.tables.suppliers || [];
store.products  = data.tables.products  || [];
store.entries   = data.tables.entries   || [];
store.priceHistory = data.tables.priceHistory || {};
store.settings = Object.assign({
  theme: store.settings.theme,
  autoClear: true,
  historyShowBoth: true,
  showTaxFlags: false,
  recentProducts: store.settings.recentProducts || [],
  hisRangeDays: 30
}, data.tables.settings || {});
DB.save(store);

      // v9.1: 復元直後に年度ラベルを即時反映（リロード不要）
      try{
        if (typeof refreshFiscalLabel === 'function') refreshFiscalLabel();
        requestAnimationFrame(()=>{ if (typeof refreshFiscalLabel === 'function') refreshFiscalLabel(); });
      }catch(_){}


      alert("復元しました");
      try{ window.refreshBackupPageLabels?.(); }catch(_){}

      enforcePlan();
      applyPlanUI();
      applyTheme(); refreshHome(); initInputPage();
      renderSuppliers(); fillFilterSupplier(); renderProducts();
      renderHistory(); renderTodayList(); navigate("home");
      enableSelectOnFocus();
    }catch{
      alert("復元に失敗しました。ファイルをご確認ください。");
    }finally{
      input.value = '';  // ←毎回必ずクリア（Android/PC 連続選択・無反応対策）
    }
  };

  r.readAsText(f);
});

function refreshFiscalLabel(){
  try{
    const cur = new Date().getFullYear();
    const y = getActiveYear(); // 今年度/前年度にクランプ済み

    // 保存値も正規化（過去に「次年度へ切り替え」で先の年に行っていても戻せる）
    if(!store.settings) store.settings = {};
    if (Number(store.settings.activeYear) !== y) {
      store.settings.activeYear = y;
      DB.save(store);
    }

    const el=$("#fiscalLabel"); if(el) el.textContent=`対象：${y}年（1月〜12月）`;

    const sel = $("#selActiveYear");
    if(sel){
      // 毎回同期（軽量）
      sel.innerHTML = "";
      [cur, cur-1].forEach(yy=>{
        const o=document.createElement("option");
        o.value = String(yy);
        o.textContent = `${yy}年`;
        sel.appendChild(o);
      });
      sel.value = String(y);
    }

    // === 視認性（前年度モードの見分け） ===
    const isPrev = (y === (cur - 1));
    try{ document.body.classList.toggle("mode-prev-year", isPrev); }catch(_){}
    const pill = $("#pillYearMode");
    if(pill){
      pill.textContent = isPrev ? `前年度：${y}年` : `今年度：${y}年`;
      pill.title = isPrev ? "前年度モード" : "今年度モード";
    }
    const lbl = $("#lblInDate");
    if(lbl){
      lbl.textContent = isPrev ? `日付（前年度：${y}年）` : `日付（${y}年）`;
    }

    // === 前年度の確定（出力→削除）ボタン状態 ===
    const btnFin = $("#btnFinalizePrevYear");
    if(btnFin){
      const py = cur - 1;
      const canFiscal = (clampExportKey("fiscal", PLAN()) === "fiscal");
      const hasPrev = (store.entries||[]).some(e => e && e.date && String(e.date).startsWith(String(py)+"-"));
      btnFin.dataset.year = String(py);
      btnFin.textContent = `前年度（${py}年）を確定（出力→削除）`;
      btnFin.disabled = (!canFiscal || !hasPrev);
      btnFin.title = !canFiscal ? "年度出力は有料プランで利用できます" : (!hasPrev ? "前年度の明細がありません" : "前年度の明細を出力して削除します");
    }
  }catch(_){}
}
document.addEventListener("change",(e)=>{
  if(e.target.id!=="selActiveYear") return;
  const y = Number(e.target.value);
  if(!isFinite(y)) return;

  if(!store.settings) store.settings = {};
  store.settings.activeYear = y;
  DB.save(store);

  // 選択年度で全画面を再描画
  try{ refreshFiscalLabel(); }catch(_){}
  try{ initInputPage(); }catch(_){}
  try{ renderTodayList(); }catch(_){}
  try{ if ((location.hash||"") === "#history") renderHistory(); }catch(_){}
  try{
    const w = document.getElementById("kpiWeek"); if(w) w.textContent = yen(calcTotals(7));
    const m = document.getElementById("kpiMonth"); if(m) m.textContent = yen(calcTotals(30));
    const k30 = document.getElementById("kpi30"); if(k30) k30.textContent = yen(calcTotals(30));
  }catch(_){}
});

/* ===== Factory Reset ===== */
document.addEventListener("click",(e)=>{
  if(e.target.id!=="btnFactoryReset") return;
  if(!confirm("バックアップは取得済みですか？\n\n未取得の場合は「キャンセル」でバックアップ設定へ移動します。")){ navigate("backup"); return; }
  if(!confirm("本当に全データを削除しますか？\nこの操作は取り消せません。")) return;
  const keep={ theme:store.settings.theme,autoClear:store.settings.autoClear,
    lastBackupAt:store.settings.lastBackupAt, historyShowBoth:store.settings.historyShowBoth,
    showTaxFlags:store.settings.showTaxFlags, recentProducts:store.settings.recentProducts||[], hisRangeDays:store.settings.hisRangeDays||30
  };
  store={suppliers:[],products:[],entries:[],priceHistory:{},settings:keep};
  DB.save(store);
  alert("データを初期化しました。");
  applyTheme(); refreshHome(); initInputPage(); renderSuppliers(); fillFilterSupplier(); renderProducts(); renderHistory();renderTodayList(); navigate("home");
});

/* ===== License mock & UI sync ===== */
function setPlan(p){
  p = (p || '').toLowerCase();
  try {
    if (p === 'pro') {
      localStorage.setItem(PLAN_KEY, 'pro');
      localStorage.setItem(PRO_KEY, '1');  // legacy
    } else if (p === 'middle') {
      localStorage.setItem(PLAN_KEY, 'middle');
      localStorage.removeItem(PRO_KEY);
    } else {
      p = 'free';
      localStorage.setItem(PLAN_KEY, 'free');
      localStorage.removeItem(PRO_KEY);
    }

    // ★重要：store側のplanも必ず同期（コールド起動でFREE化しない）
    try{
      if(store && typeof store === 'object'){
        store.settings = store.settings || {};
        store.settings.plan = p;
      }
    }catch(_){}

    DB.save(store);

    // 以降は存在するものだけ呼ぶ（未定義でも落とさない）
    window.enforcePlan?.();
    window.applyPlanUI?.();
    window.refreshHome?.();

  } finally {
    window.updatePlanPill?.();
    window.syncLicenseButtons?.();
    window.refreshLicenseUI?.();
  }
}

function renderRights(){
  try{
    const sec = document.getElementById('page-rights');
    if(!sec) return;
    sec.classList.remove('hidden');
    sec.hidden = false;
    sec.style.removeProperty('display');
    // ensure inner .card exists and basic sections present (no-op if already there)
    // add mini memo about plan & backup if note element present
    const memoHost = document.getElementById('bkMemo');
    if(memoHost) memoHost.textContent = 'プラン情報は端末ごとに保持され、バックアップには含まれません。';
  }catch(e){ console.warn('renderRights skipped:', e); }
}
function syncLicenseButtons(){
  const p = getPlan();
  // --- Freeカードのボタン（このプランを使う／使用中） ---
const btnFree = document.getElementById('btnUseFree');
if (btnFree) {
  const isFree = (p === 'free');
  btnFree.disabled = isFree;
  btnFree.setAttribute('aria-disabled', isFree ? 'true' : 'false');
  btnFree.textContent = isFree ? '使用中' : 'このプランを使う';
}

const root = document.getElementById('plans-cta') || document;

  // Middle… Freeの時だけ表示
  root.querySelectorAll('a.tlp-buy-btn[data-plan="middle"]')
    .forEach(el => {
      el.toggleAttribute('hidden', p !== 'free');
      el.setAttribute('aria-hidden', (p !== 'free') ? 'true' : 'false');
    });

  // Pro… Proの時だけ非表示
  root.querySelectorAll('a.tlp-buy-btn[data-plan="pro"]')
    .forEach(el => {
      el.toggleAttribute('hidden', p === 'pro');
      el.setAttribute('aria-hidden', (p === 'pro') ? 'true' : 'false');
    });
}

document.addEventListener("click",(e)=>{ if(e.target.id==="btnUseFree") setPlan("free"); });
function openLicenseModal(){
  openModalBase("ライセンスコード", `
    <div class="grid">
      <div class="label">コード</div>
      <input id="licenseKey" type="text" placeholder="TLP-XXXX-XXXX-XXXX / TEST-MIDDLE / TEST-PRO">
    </div>
  `);

  const ok = document.getElementById('modalOK');
  const cancel = document.getElementById('modalCancel');
  const del = document.getElementById('modalDelete');
  if (del) del.classList.add('hidden');

  ok.textContent = "適用";
  cancel.textContent = "閉じる";

  const inp = document.getElementById('licenseKey');
  const PAT_TEST = /^TEST-(MIDDLE|PRO)$/i;
  const PAT_PROD = /^TLP-[A-Z0-9-]{8,}$/i;


  const norm = () => (inp?.value || '').toUpperCase().replace(/[^A-Z0-9-]/g,'');

  const setOkState = () => {
    const v = norm();
    ok.disabled = !(PAT_TEST.test(v) || PAT_PROD.test(v));
  };
  setOkState();

  inp?.addEventListener('input', setOkState);
  inp?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !ok.disabled) { e.preventDefault(); ok.click(); }
  });
 }

// === ライセンスモーダルの自動配線（MutationObserver; 二重発火防止付き） ===
(() => {
  const host = document.getElementById('modalHost');
  if (!host) return;
  const PAT_TEST = /^TEST-(MIDDLE|PRO)$/i;
 const PAT_PROD = /^TLP-[A-Z0-9-]{8,}$/i;

  const norm = (v) => String(v||'').toUpperCase().replace(/[^A-Z0-9-]/g,'');
  const mo = new MutationObserver(() => {
    const inp = document.getElementById('licenseKey');
    const ok  = document.getElementById('modalOK');
    if (!inp || !ok || ok.__wiredRedeem) return;
    ok.__wiredRedeem = true;
    const toggle = () => { const v = norm(inp.value); ok.disabled = !(PAT_TEST.test(v) || PAT_PROD.test(v)); };
    toggle();
    inp.addEventListener('input', toggle, { passive:true });
    ok.addEventListener('click', async (e) => {
      const v = norm(inp.value);
      if (!(PAT_TEST.test(v) || PAT_PROD.test(v))) return;
      e.preventDefault();
      closeModal();
      try {
        const r = await (window.redeemCode?.(v) || Promise.resolve({ ok:false }));
        if (r?.ok && r?.plan) setPlan(r.plan);
      } finally {
        // UI 同期の最後の砦
        window.updatePlanPill?.();
        window.refreshHome?.();
        window.refreshLicenseUI?.();
      }
    }, { once:false });
  });
  mo.observe(host, { childList:true, subtree:true });
})();

document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnEnterLicense') openLicenseModal();
});
/* === syncOfflineGrace fallback (起動時クラッシュ防止) === */
  (() => {
    if (typeof window.syncOfflineGrace !== 'function') {
      window.syncOfflineGrace = async function (_ms) { /* no-op */ };
    }
  })();

/* ===== Init ===== */
function init(){
  try{
    window.syncOfflineGrace?.();
    applyTheme();
    refreshHome();
    try{ refreshBackupPageLabels(); }catch(_){}
    initInputPage();
    renderTodayList();
    enableSelectOnFocus();
    renderSuppliers();
    fillFilterSupplier();
    renderProducts();
    refreshFiscalLabel();
    showPage(location.hash.replace("#", "")||"home");
　 if ((location.hash||"") === "#history") { try{ renderHistory(); }catch(e){ console.error(e); } }
    syncLicenseButtons();
    enforcePlan();
    applyPlanUI();
  }catch(err){
    console.error("init failed:", err);
    alert("初期化中に問題が発生しました。 ページを再読み込みしてください。");
  }
}
// --- API helper (verify/redeem 共有) ---
window.tlpApiFetch ||= function(path, opt = {}) {
  return fetch(`https://app.cafetabco.com${path}`, {
    mode: 'cors',
    cache: 'no-store',
    credentials: 'omit',
    headers: { 'Content-Type': 'application/json', 'X-License-Sig': '1' },
    ...opt
  });
};
// --- Re-verify（即時反映） ---
window.reverifyNow ||= async function () {
  try {
    const url =
      `/api/license/verify.php?device=${encodeURIComponent(tlpDeviceId())}&app=tlp`;

    // ★ここは tlpApiFetch を使わず、生の fetch を使う
    const res  = await fetch(url);
    const body = await res.json().catch(() => ({}));

    if (res.ok && body?.ok) {
      // 最終検証タイムスタンプを更新
      localStorage.setItem('tlpLicenseFreshAt', String(Date.now()));

          // 返ってきた plan を保存
    // - サーバーが middle / pro を返したらそれを優先
    // - それ以外（free / 空など）は、端末側がまだ free のときだけ採用
    try {
      const store = getStore();
      const currentPlan = store?.settings?.plan || 'free';
      let nextPlan = currentPlan;

      if (body && typeof body.plan === 'string' && body.plan !== '') {
        if (body.plan === 'middle' || body.plan === 'pro') {
          // アップグレード / プラン変更
          nextPlan = body.plan;
        } else if (currentPlan === 'free') {
          // まだ端末が free のときだけサーバー側の値を採用
          nextPlan = body.plan;
        }
      }

      if (store) {
        store.settings ||= {};
        store.settings.plan = nextPlan;
        DB.save(store);
      }
    } catch (_) {}


      // ---- 表示を即同期（リロード無し）----
      window.applyPlanUI?.();
      window.enforcePlan?.();
      window.updatePlanPill?.();     // HOME の「現在のプラン」ピル
      window.syncLicenseButtons?.(); // ライセンス系ボタン表示
      window.refreshHome?.();        // HOMEカード再描画
      window.renderTodayList?.();
      window.renderHistory?.();

      // 成功フィードバック（必要なら消してOK）
      try { alert('再検証: OK'); } catch (_){}
    } else {
      try { alert('再検証: 失敗'); } catch (_){}
    }
  } catch (e) {
    console.error('reverify error:', e);
    try { alert('再検証: 通信エラー'); } catch (_){}
  }
};


init();
</script>



<script>
(()=>{ 'use strict';
  const TLP = (window.TLP = window.TLP || {});
  const meta = (window.__tlp_meta || {});
  const REQUIRED_EULA_VERSION = String(meta.eulaVersion || '2025-09-08');
  TLP.APP = Object.assign({ NAME:'Tabco Ledger Plus', VERSION:'1.0', EULA_VERSION: REQUIRED_EULA_VERSION }, TLP.APP || {});
  const LS = window.localStorage;
  const KEYS = { EULA_VER_NEW:'tlp_eula_version', EULA_VER_OLD:'tlp_eula_version_accepted', EULA_AT:'tlp_eula_accepted_at', LICENSE:'tlp_license_status' };
  TLP.keys = KEYS;
  TLP.license = {
    get status(){ try{ return LS.getItem(KEYS.LICENSE) || 'trial'; }catch(_){ return 'trial'; } },
    set status(v){ try{ LS.setItem(KEYS.LICENSE, v); }catch(_){} },
    isTrial(){ return this.status !== 'licensed'; },
    set(v){ this.status = v; }
  };
  TLP.eula = {
    needs(){ let a=null,b=null; try { a = LS.getItem(KEYS.EULA_VER_NEW); b = LS.getItem(KEYS.EULA_VER_OLD); } catch(_){ }
      return (a !== REQUIRED_EULA_VERSION) && (b !== REQUIRED_EULA_VERSION); },
    accept(){ try{
        LS.setItem(KEYS.EULA_VER_NEW, REQUIRED_EULA_VERSION);
        LS.setItem(KEYS.EULA_VER_OLD, REQUIRED_EULA_VERSION);
        LS.setItem(KEYS.EULA_AT, new Date().toISOString());
      }catch(_){} TLP.license.set('licensed');
    }
  };
  /* ===== License Verify (C-1) ===== */
window.LICENSE = { USE_MOCK: true, VERIFY_URL: 'https://api.example.com/license/verify', GRACE_MS: 7*86400000 };

async function verifyLicense(code, timeoutMs = 8000){
  const norm = String(code||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  if (norm.length < 12) return { ok:false, reason:'invalid' };

  // モック（後で VERIFY_URL に切替）
  if (LICENSE.USE_MOCK){
    await new Promise(r=>setTimeout(r, 400));             // 疑似レイテンシ
    const ok = norm === 'ABCDEFGH1234' || norm === 'ABCDEFGH0000' || norm === 'ABCDEFGHIJKL' || norm === 'ABCDEFGH1234'.replace(/-/g,'');
    return ok ? { ok:true, plan:'pro', exp:'2099-12-31T00:00:00Z' } : { ok:false, reason:'invalid' };
  }

  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  // これを try の前あたりに追加
if (!LICENSE.USE_MOCK && typeof navigator !== 'undefined' && navigator && navigator.onLine === false){
  return { ok:false, reason:'offline' };
}
try{
    const res = await fetch(LICENSE.VERIFY_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code:norm, app:'tlp', ver:(window.TLP?.APP?.VERSION||'0.0.0') }),
      signal: ctrl.signal, keepalive:true
    });
    if (!res.ok) return { ok:false, reason: res.status===403?'invalid':'network' };
    const data = await res.json().catch(()=> ({}));
    return { ok: data?.plan==='pro', plan:data?.plan, exp:data?.exp, data };
  }catch(e){ return { ok:false, reason: (e?.name==='AbortError'?'timeout':'network') }; }
  finally{ clearTimeout(t); }
}

function applyLicensed(info){
  // ライセンス情報が来た時だけ反映（未指定なら何もしない）
  if (info && typeof info.plan === 'string') {
    const plan = info.plan.toLowerCase();
    setPlan(plan);
    try {
      localStorage.setItem('tlpLicenseFreshAt', String(Date.now()));
      if (info.exp) localStorage.setItem('tlpLicenseExp', info.exp);
    } catch(_) {}
  }
}


function syncOfflineGrace(){
  const freshAt = Number(localStorage.getItem('tlpLicenseFreshAt')||0);
  const fresh = Date.now() - freshAt < LICENSE.GRACE_MS;
  if (fresh) localStorage.setItem(PRO_KEY,'1'); else localStorage.removeItem(PRO_KEY);
}
TLP.showEula = function(){
   if (typeof window.tlpOpenEula === 'function'){ window.tlpOpenEula(); return; }
   const ov = document.getElementById('eulaOverlay');
   if (ov){ ov.classList.add('show'); document.body.classList.add('eula-locked'); }
 };
  document.addEventListener('tlp:eula-accepted', ()=>{ TLP.eula.accept(); });
  document.addEventListener('tlp:eula-declined', ()=>{ TLP.license.set('trial'); });
  document.addEventListener('DOMContentLoaded', ()=>{ if (TLP.eula.needs()) TLP.showEula(); });
})();
</script>

<script>
(()=>{ // 共有メタ（権利ページ用バッジだけ使用）
  window.__tlp_meta = Object.assign({
    app: "Tabco Ledger Plus",
    brand: "Tabco Ledger Plus",
    version: (window.TLP && TLP.APP && TLP.APP.VERSION) || "1.0",
    eulaVersion: (window.TLP && TLP.APP && TLP.APP.EULA_VERSION) || "2025-09-08",
    build: "v0.8.1-20250930",
    site: "cafetabco.com"
  }, window.__tlp_meta || {});
})();
</script>

<style id="rights-css">
#page-rights h3 { margin: 0 0 8px; }
#page-rights h4 { margin: 14px 0 6px; font-size: 0.98rem; }
#page-rights p  { margin: 0 0 8px; }

/* 権利ページ専用バッジ */
#tlp-brand-badge-rights{
  position: fixed; right: 12px; bottom: 12px; z-index: 7000;
  display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px;
  border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.12); background: #fff; font-size: 12px; white-space: nowrap;
}
@media print {
  nav, header, footer, .actions, .btn-row, .toolbar { display: none !important; }
  .modal, .dialog, .backdrop, #modalHost, #eula-modal, .modal-backdrop { display: none !important; }
  #tlp-brand-badge-rights { display: none !important; }
}
#tlp-brand-badge-rights{ background:#fff; color:#111; border:1px solid #e5e7eb; }
[data-theme="dark"] #tlp-brand-badge-rights{
  background:#121212; color:#f5f5f5; border-color:#2a2a2a; box-shadow:0 3px 12px rgba(0,0,0,.6);
}
</style>
<script id="rights-js">
(() => {
  try {
    window.__tlp_meta = window.__tlp_meta || {};
    if (!window.__tlp_meta.eulaVersion) window.__tlp_meta.eulaVersion = '2025-09-08';
  } catch(e){}

  function buildRightsBadge(){
    const el = document.createElement('div');
    el.id = 'tlp-brand-badge-rights';
    el.setAttribute('role','note');
    el.textContent = 'Tabco Ledger Plus\u2122 v1.0';
    return el;
  }
  function mountRightsBadge(){
    const host = document.getElementById('tlp-rights-badge-host');
    if (!host) return;
    if (document.getElementById('tlp-brand-badge-rights')) return;
    host.appendChild(buildRightsBadge());
  }
  function wireEulaOpen(){
    const a = document.getElementById('open-eula');
    if (!a) return;
    a.addEventListener('click', (e) => {
      e.preventDefault();
      if (typeof window.tlpOpenEula === 'function')       window.tlpOpenEula();
      else if (window.TLP && typeof TLP.showEula==='function') TLP.showEula();
      else console.warn('EULA open handler not found.');
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { mountRightsBadge(); wireEulaOpen(); });
  } else {
    mountRightsBadge(); wireEulaOpen();
  }
})();
</script>

<script>
(()=>{try{
  const meta = window.__tlp_meta || {};
  const eulaVer = meta.eulaVersion || "2025-09-08";
  console.log("[TLP] diag boot v0.8.1 (minimal)");
  window.__TLP_BUILD = "planfix-v9-2025-12-17";
  console.log("[TLP] build:", window.__TLP_BUILD);
  window.addEventListener("keydown", (e)=>{
    if(e.altKey && e.key.toLowerCase()==="e"){
      e.preventDefault();
      if (typeof window.tlpOpenEula === "function") window.tlpOpenEula();
      else if (window.TLP && typeof TLP.showEula === "function") TLP.showEula();
      else console.warn("EULA open handler not found");
    }
  });
  window.addEventListener("tlp:eula-accepted", ()=>{ try{ localStorage.setItem("tlpEulaAcceptedVersion", eulaVer); }catch(_){ } console.log("[TLP] EULA accepted:", eulaVer); });
  window.addEventListener("tlp:eula-declined", ()=>{ console.warn("[TLP] EULA declined"); });
  window.tlpDiag = {
    check(){ console.table({ eulaVersion: eulaVer, eulaOpenFn: typeof window.tlpOpenEula === "function" ? "OK" : "fallback" }); },
    openEula(){ if (typeof window.tlpOpenEula === "function") window.tlpOpenEula();
                else if (window.TLP && typeof TLP.showEula === "function") TLP.showEula();
                else console.warn("EULA open handler not found"); }
  };
  console.log("[TLP] Ready. Try: tlpDiag.check(), tlpDiag.openEula()");
}catch(e){console.error("[TLP] diag init error", e);}})();
</script>

<style id="tlp-export-align">
#ModalExport label:has(> input[type="radio"]),
.modal.sheet label:has(> input[type="radio"]) {
  display: grid; grid-template-columns: 2.25em 1fr; align-items: center; column-gap: 12px;
  min-height: 36px; text-align: left; white-space: nowrap; padding: 10px 12px; margin: 8px 0;
  border: 1px dashed rgba(0,128,255,.35); border-radius: 8px; box-sizing: border-box; cursor: pointer;
}
#ModalExport label:has(> input[type="radio"]) > input[type="radio"]{ grid-column: 1; justify-self: center; margin:0; }
#ModalExport label:has(> input[type="radio"]) > :not(input){ grid-column: 2; margin:0; }
#ModalExport label:has(> input[type="radio"]:checked){ border-style: solid; border-color: rgba(0,128,255,.6); background: rgba(0,128,255,.06); }
#ModalExport label:has(> input[type="radio"]):hover{ background: rgba(0,0,0,.03); }
</style>

<script id="rights-autofill">
(()=>{ 'use strict';
  const meta  = (window.__tlp_meta||{});
  const app   = (window.TLP && TLP.APP) || {};
  const page  = document.querySelector('#page-rights .card');
  if(!page) return;
  const APP_NAME   = String(app.NAME || meta.app || 'Tabco Ledger Plus');
  const VERSION    = String(app.VERSION || meta.version || '0.0.0');
  const BUILD      = String(meta.build || VERSION);
  const EULA_VER   = String(app.EULA_VERSION || meta.eulaVersion || '-');
  const SITE_URL   = meta.site ? `https://${meta.site}` : 'https://cafetabco.com';
  const SUPPORT_MAIL= meta.supportEmail || 'info@cafetabco.com';
  const PUBLISHER  = meta.publisher || 'Tabco';
  const CURRENT_Y  = new Date().getFullYear();
  const ensure = (id, html) => {
    if (page.querySelector('#'+id)) return;
    const wrap = document.createElement('section');
    wrap.id = id; wrap.innerHTML = html.trim(); page.appendChild(wrap);
  };
  ensure('rights-appinfo', `<h4>アプリ情報</h4><p><b>App:</b> ${APP_NAME} / <b>Version:</b> ${VERSION} / <b>Build:</b> ${BUILD}</p><p><b>EULA:</b> ${EULA_VER} / <b>© ${CURRENT_Y} ${PUBLISHER}. All rights reserved.</b></p>`);
  ensure('rights-privacy', `<h4>プライバシーポリシー</h4><p>本アプリは入力データを<b>端末ローカル</b>に保存します。バックアップ機能利用時のみ、利用者自身のクラウドに保存されます。</p><p>詳細は <a href="https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/" target="_blank" rel="noopener">プライバシーポリシー</a> をご覧ください。</p>`);
  ensure('rights-eula-note', `<h4>使用許諾（EULA）</h4><p>本アプリの利用により、<a href="./#rights">EULA（使用許諾契約）</a>に同意したものとみなされます。</p>`);
  page.addEventListener('click', (e)=>{ const a = e.target.closest('#rights-open-eula'); if(!a) return; e.preventDefault(); if (typeof window.tlpOpenEula === 'function') window.tlpOpenEula(); else if (window.TLP && typeof TLP.showEula === 'function') TLP.showEula(); else alert('EULAを表示できませんでした。'); });
ensure('rights-support', `<h4>お問い合わせ</h4><p>Webサイト：<a href="https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/" target="_blank" rel="noopener noreferrer">https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/</a></p>`);
  ensure('rights-trademark', `<h4>商標について</h4><p>“${APP_NAME}” および関連ロゴは ${PUBLISHER} の商標です。記載の会社名・製品名は各社の商標または登録商標です。</p>`);
  ensure('rights-oss', `<h4>オープンソースコンポーネント</h4><p>本アプリは主に HTML/CSS/JavaScript で構築されています。必要に応じてライセンス情報を追記します。</p><ul id="oss-list" style="margin-top:4px"></ul>`);
  const css = `#page-rights section + section { margin-top: 12px; } #page-rights a { text-decoration: underline; } #page-rights p { line-height: 1.6; }`;
  const styleTag = document.createElement('style'); styleTag.textContent = css; page.appendChild(styleTag);
  page.querySelectorAll('a[href^="http"]').forEach(a=>{ a.setAttribute('target','_blank'); a.setAttribute('rel','noopener'); });
})();
</script>

<script>
window.addEventListener('hashchange', ()=>{ if (((location.hash||'').slice(1) || 'home') !== 'rights'){ document.getElementById('tlp-brand-badge-rights')?.remove(); }});
</script>

<script>
/* ==== 入力時にワンタップ全選択（動的要素にも効く） ==== */
document.addEventListener("focusin", (e)=>{
  const inp = e.target?.closest('input[type="number"], input[type="text"]');
  if(!inp || inp.readOnly || inp.disabled) return;
  try{ inp.select && inp.select(); }catch(_){}
  setTimeout(()=>{ try{ inp.select && inp.select(); }catch(_){} }, 0);
});
</script>
<script>
if ('serviceWorker' in navigator) {
  try {   
navigator.serviceWorker.register('/demo/sw.js?v=demo1', { scope: '/demo/' }).catch(()=>{});
  } catch(_) {}
}
</script>

<!-- === EULA Hard Consent (blocking) === -->
<div id="eulaOverlay" aria-modal="true" role="dialog" aria-labelledby="eulaTitle">
  <div id="eulaDialog" tabindex="-1">
    <h2 id="eulaTitle">利用許諾契約（EULA）への同意が必要です</h2>
  <p>本アプリのご利用には、次の利用許諾契約（EULA）への同意が必要です。</p>
<ul style="margin:.6em 0 0 1.2em;line-height:1.6">
  <li><b>ライセンス付与：</b>非独占・譲渡不可。再配布／逆コンパイル禁止。</li>
  <li><b>データとプライバシー：</b>出力データの管理は利用者の責任。</li>
  <li><b>知的財産：</b>本ソフト／名称／ロゴ等は開発者に帰属。</li>
  <li><b>保証の否認：</b>現状有姿。損害・逸失利益等は免責。</li>
  <li><b>準拠法・裁判管轄：</b>日本法・京都地方裁判所。</li>
</ul>
<div id="eulaLinks" style="margin-top:.6em">
  <p>
    <a href="./#rights" target="_blank" rel="noopener">EULA本文</a> ・
    <a href="https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/" target="_blank" rel="noopener">プライバシーポリシー</a> ・
    <a href="https://cafetabco.com/tabco-ledger-plus-仕入れ管理アプリ/" target="_blank" rel="noopener">お問い合わせ</a>
  </p>
</div>

    <div id="eulaActions">
      <button id="btnEulaAgree" type="button" autofocus>同意する</button>
    </div>
  </div>
</div>
<script>
/* === EULA Hard Consent === */
(() => {
  const EULA_VERSION = String(
   (window.__tlp_meta && __tlp_meta.eulaVersion) ||
   (window.TLP?.APP?.EULA_VERSION) ||
   "2025-09-08" // フォールバック（日付）
 );
  const EULA_KEY = "tlp.eula.accepted";      // localStorageキー

  const $overlay = document.getElementById('eulaOverlay');
  const $dialog  = document.getElementById('eulaDialog');
  const $agree   = document.getElementById('btnEulaAgree');

  function getAccepted(){
    try { return JSON.parse(localStorage.getItem(EULA_KEY) || "null"); }
    catch(e){ return null; }
  }
  function setAccepted(){
    const payload = { version: EULA_VERSION, ts: new Date().toISOString() };
    try { localStorage.setItem(EULA_KEY, JSON.stringify(payload)); }
    catch(e){
      alert("ブラウザの保存領域にアクセスできないため、アプリを利用できません。設定をご確認ください。");
      return;
    }
  }
  function needsConsent(){
    const saved = getAccepted();
    return !saved || saved.version !== EULA_VERSION;
  }
  function lockUI(lock){
    document.body.classList.toggle('eula-locked', lock);
    // 背景クリック/Escで閉じられないようにする
    if(lock){
      $overlay.addEventListener('click', eat, {capture:true});
      document.addEventListener('keydown', blockEsc, {capture:true});
      // フォーカスをダイアログ内にトラップ
      setTimeout(()=> ($agree || $dialog).focus(), 0);
      document.addEventListener('focus', trapFocus, true);
    }else{
      $overlay.removeEventListener('click', eat, {capture:true});
      document.removeEventListener('keydown', blockEsc, {capture:true});
      document.removeEventListener('focus', trapFocus, true);
    }
  }
  function eat(ev){
    // オーバーレイ/背景クリックの伝播を止める
    if(ev.target === $overlay) ev.stopPropagation();
    if(ev.target === $overlay) ev.preventDefault();
  }
  function blockEsc(ev){
    if(ev.key === 'Escape'){ ev.preventDefault(); ev.stopPropagation(); }
  }
  function trapFocus(ev){
    if(!$overlay.classList.contains('show')) return;
    if(!$dialog.contains(ev.target)){
      ev.stopPropagation();
      ($agree || $dialog).focus();
    }
  }
  function openEula(){
    $overlay.classList.add('show');
    lockUI(true);
  }
  function closeEula(){
    $overlay.classList.remove('show');
    lockUI(false);
  }

  // 同意ボタン
  $agree.addEventListener('click', () => {
  setAccepted();                    // ハード保存 {version:EULA_VERSION, ts}
   try { document.dispatchEvent(new Event('tlp:eula-accepted')); } catch(_){}
   try { TLP?.eula?.accept?.(); } catch(_){ }
  closeEula();
 });

  // 起動後チェック（既存initの後でも先でも安全に動くようDOMContentLoadedで実行）
  // デモ判定（?demo=1 のとき）
const isDemo = new URLSearchParams(location.search).get('demo') === '1';

// 起動後チェック（既存initの後でも先でも安全に動くようDOMContentLoadedで実行）
window.addEventListener('DOMContentLoaded', () => {
  if (!isDemo && needsConsent()) openEula();   // ← デモ時は出さない
});
})();
window.tlpOpenEula = function(){
  const ov = document.getElementById('eulaOverlay');
  const ok = document.getElementById('btnEulaAgree');
  if (!ov) return false;
  ov.classList.add('show');
  document.body.classList.add('eula-locked');
  setTimeout(()=> ok?.focus(), 0);
  return true;
};
window.tlpCloseEula = function(){
  const ov = document.getElementById('eulaOverlay');
  if (!ov) return false;
  ov.classList.remove('show');
  document.body.classList.remove('eula-locked');
  return true;
};
</script>
<script>
/* === Disable legacy (soft) EULA triggers === */
window.addEventListener('DOMContentLoaded', () => {
  // 1) よくある関数名を無効化（存在するものだけ上書き）
  ['openEula','showEula','openEULAModal','showEULAModal'].forEach(fn=>{
    if (typeof window[fn] === 'function') window[fn] = function(){};
  });

  // 2) クリック系トリガーを無効化（よくあるセレクタ）
  const sels = [
    '#btnEula','#btnOpenEula','#linkEula',
    '[data-open="eula"]','[data-modal="eula"]'
  ];
  sels.forEach(s=>{
    document.querySelectorAll(s).forEach(el=>{
      el.replaceWith(el.cloneNode(true)); // 全リスナー剥がし
      el.setAttribute?.('data-eula-soft-disabled','1');
    });
  });

  // 3) 旧オーバーレイが万一表示されたら即座に隠す（代表的ID/クラス）
  const hide = sel => document.querySelectorAll(sel).forEach(n=>{
    n.style.display='none'; n.setAttribute('aria-hidden','true');
  });
  hide('#eulaModal'); hide('#modalEula'); hide('.eula-modal'); hide('[data-role="eula-modal"]');
});
</script>
<script>
// --- Strictバックアップ（表示対象と同じ集合だけ保存） ---
// 非表示/削除/無効フラグの共通判定
function isFlagged(o){
  return !!(o && (
    o.deleted === true || o.isDeleted === true || o._deleted === true ||
    o.hidden  === true || o.archived === true ||
    o.active  === false|| o.enabled  === false|| o.visible  === false
  ));
}

// クリーンスナップショットを作る（UIで見えるデータだけ）
function getCleanSnapshot(s){
  s = s || {};
  // 1) 仕入先：フラグ無＆idあり
  const suppliers = (s.suppliers||[]).filter(x => !isFlagged(x) && x && x.id);
  const supSet = new Set(suppliers.map(x => x.id));

  // 2) 商品：フラグ無＆id/名前あり＆仕入先に実在リンク＆id重複排除
  const seenProd = new Set();
  const products = [];
  for (const p of (s.products||[])) {
    if (!p || isFlagged(p)) continue;
    if (!p.id) continue;
    if (!p.name || !String(p.name).trim()) continue;
   const sid = p.supplierId ?? p.supplier_id ?? null;
if (sid==null || !supSet.has(sid)) continue; // 未紐づけ/不正リンクは除外
    if (seenProd.has(p.id)) continue;        // 重複idは先勝ち
    products.push(p);
    seenProd.add(p.id);
  }
  const prodSet = new Set(products.map(p => p.id));

  // 3) 履歴：フラグ無＆参照整合（product/supplierが存在する場合のみ許可）
  const history = (s.history||[]).filter(h => {
    if (!h || isFlagged(h)) return false;
    const pidOk = (h.productId  == null) || prodSet.has(h.productId);
    const sidOk = (h.supplierId == null) || supSet.has(h.supplierId);
    return pidOk && sidOk;
  });

  // 4) そのほか（設定類）はそのまま持ち越す
  return { ...s, suppliers, products, history };
}

// 既存の「バックアップ保存」に適用する（※ここだけ置き換え）
// 例）元が saveJson(store) なら → saveJson(getCleanSnapshot(store))
window.saveBackupStrict = function(){
  const clean = getCleanSnapshot(store);
 const payload = {                                    // ★ ここから
    tables: {
      suppliers: clean.suppliers || [],
      products:  clean.products  || [],
      entries:   clean.entries   || [],
      priceHistory: clean.priceHistory || []
    },
    settings: clean.settings || { plan:'Free' },
    version:  clean.version  || 'v0.8.4'
  };                                                   // ★ ここまで
  const blob  = new Blob([JSON.stringify(payload)], {type:'application/json'});
  try { 
    store.settings.lastBackupAt = Date.now(); 
    DB.save(store); 
  } catch(_){}
  try { window.refreshHome?.(); window.refreshBackupPageLabels?.(); } catch(_){}

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `backup_strict_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
};
window.backupNow = function(){ saveBackupStrict(); };
</script>
<style>
  .fp-btnbar{display:flex;gap:.5rem;padding:.5rem;border-top:1px solid #eee}
  .fp-btn{padding:.4rem .8rem;border:1px solid #ddd;border-radius:.5rem;background:#f6f6f6;cursor:pointer}
  .fp-btn:hover{filter:brightness(0.97)}
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ja.js"></script>
<script>
// （既存の “flatpickr 初期化” ブロックと差し替え）
window.addEventListener('DOMContentLoaded', function () {
  // ★ 追加：CDN未読込・オフライン初回などで flatpickr が無い場合は何もしない
  if (typeof window.flatpickr !== 'function') return;

  var nodes = document.querySelectorAll('input[type="date"], input[data-datepicker]');
  for (var i = 0; i < nodes.length; i++) {
    var el = nodes[i];
    el.type = 'text'; // ネイティブUIを無効化

    flatpickr(el, {
      dateFormat: 'Y-m-d',
      locale: 'ja',          // ja.js 読み込み済み前提
      disableMobile: true,
      allowInput: true,
      closeOnSelect: false,  // 選択で自動クローズしない
      onOpen: function(selectedDates, str, inst){
        inst._orig = inst.input.value || null;
      },
      onReady: function(selectedDates, str, inst){
        var c = inst.calendarContainer;
        if (c.querySelector('.fp-btnbar')) return; // 二重追加防止
        var bar = document.createElement('div');
        bar.className = 'fp-btnbar';
        bar.innerHTML =
          '<button type="button" class="fp-btn fp-clear">削除</button>' +
          '<span style="flex:1"></span>' +
          '<button type="button" class="fp-btn fp-cancel">キャンセル</button>' +
          '<button type="button" class="fp-btn fp-ok">設定</button>';
        c.appendChild(bar);
        bar.querySelector('.fp-clear').onclick  = function(){ inst.clear(); inst.close(); };
        bar.querySelector('.fp-cancel').onclick = function(){ inst.setDate(inst._orig, false, "Y-m-d"); inst.close(); };
        bar.querySelector('.fp-ok').onclick     = function(){ inst.close(); };
      }
    });
  }
});

</script>

<!-- v0: #btnSave（完了）恒久配線：未追加チェック付き（正規実装・最小） -->
<script id="bind-btnsave">
(()=> {
  if (window.__boundBtnSave) return;

  const $q = (s)=>document.querySelector(s);
  const val = (s)=>{ const el=$q(s); return (el && 'value' in el) ? el.value : ''; };
  const checked = (s)=>{ const el=$q(s); return !!(el && el.checked); };

  // ローカル関数：未追加の有無（グローバル汚さない）
  const hasPending = ()=>{
    const free = checked('#chkFree');
    const price = Number(val('#inPrice')||0);
    const qty   = Number(val('#inQty')||1);
    if (price>0) return true;
    if (qty!==1) return true;
    if ((val('#inMemo')||'').trim()) return true;
    return free
      ? ((val('#freeSupplier').trim() || val('#freeProduct').trim()).length>0)
      : !!val('#inProduct');
  };

  document.addEventListener('click', (e) => {
    const hit = e.target.closest('#btnSave');
    if (!hit) return;
    e.preventDefault();

    if (hasPending()) {
      if (typeof openModalBase === 'function') {
        openModalBase("未追加の入力があります", `
          <div style="margin-top:4px">どうしますか？</div>
          <ul style="margin:8px 0 0 16px">
            <li><b>追加して戻る</b>：明細に追加してホームへ</li>
            <li><b>破棄</b>：入力中の内容は捨ててホームへ</li>
            <li><b>編集を続ける</b></li>
          </ul>
        `);
        const ok = $('#modalOK'), del = $('#modalDelete'), cancel = $('#modalCancel');
        ok.textContent="追加して戻る";
        del.textContent="破棄";
        del.classList.remove("hidden"); del.classList.add("danger","small");
        ok.onclick   = ()=>{ const b=(store.entries||[]).length; addLine(); const added=(store.entries||[]).length>b; closeModal(); if (added){ navigate('home'); refreshHome(); } };
        del.onclick  = ()=>{ closeModal(); navigate('home'); refreshHome(); };
        cancel.onclick = closeModal;
        setTimeout(()=> ok && ok.focus(), 0);
      } else {
        if (confirm("未追加があります。追加して戻りますか？\nキャンセルで編集を続けます。")) {
          const b=(store.entries||[]).length; addLine();
          if ((store.entries||[]).length > b) { navigate('home'); refreshHome(); }
        }
      }
      return;
    }

    navigate('home'); 
    refreshHome();
  });

  window.__boundBtnSave = true;
})();
</script>

<!-- v0: 復元直後にマスタの「＋追加」を確実に再有効化（遅延描画に対応） -->
<script id="fix-master-add-buttons">
(() => {
  const sels = {
    product : '#btnAddProduct,[data-btn="add-product"],.product .btn-add',
    supplier: '#btnAddSupplier,[data-btn="add-supplier"],.supplier .btn-add'
  };

  const enable = (sel) => {
    const b = document.querySelector(sel);
    if (!b) return false;
    b.disabled = false;
    b.classList.remove('is-disabled', 'disabled');
    b.removeAttribute('aria-disabled');
    b.style.pointerEvents = '';
    return true;
  };

  const ready = () => {
    const p = document.querySelector(sels.product);
    const s = document.querySelector(sels.supplier);
    return p && !p.disabled && !p.classList.contains('is-disabled') &&
           s && !s.disabled && !s.classList.contains('is-disabled');
  };

  // 繰り返し有効化（一定時間だけ）。描画が遅れても拾う
  const startWatch = (ms = 8000) => {
    const t0 = Date.now();
    const id = setInterval(() => {
      enable(sels.product);
      enable(sels.supplier);
      if (ready() || Date.now() - t0 > ms) clearInterval(id);
    }, 120);
  };

  // 1) 初回
  startWatch(8000);

  // 2) 復元／マスタ遷移っぽい操作の直後に再ウォッチ
  document.addEventListener('click', (e) => {
    const t = (e.target.textContent || '').trim();
    if (['復元', '商品マスタ', '仕入先マスタ', 'HOME', 'インポート']
          .some(x => t.includes(x))) {
      setTimeout(() => startWatch(6000), 80);
    }
  }, true);

  // 3) DOM変化でもフォロー（描画が分割されるケース）
  const mo = new MutationObserver(() => startWatch(4000));
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  (window.enforcePlan || window.PlanLocks?.enforce)?.();
  window.applyPlanUI?.();
});
</script>

<script id="tlp-plan-sync">
function updatePlanPill(){
  const p = getPlan();
  const t = planJp(p);
  document.querySelectorAll('[data-plan-pill],#licensePlanLabel')
    .forEach(el => { el.textContent = t; el.setAttribute('data-plan', p); });
}

(function(){
  // getPlan が未定義でも落ちないようにフォールバック
  const safeGetPlan = (typeof getPlan === 'function')
    ? getPlan
    : function(){ return 'free'; };

  window.PLAN = safeGetPlan;

  window.updatePlanPill = function(){
    const p = safeGetPlan();
    const t = p === 'pro' ? 'プロ' : p === 'middle' ? 'ミドル' : '無料';
    document.querySelectorAll('[data-plan-pill],#licensePlanLabel')
      .forEach(el => {
        el.textContent = t;
        el.setAttribute('data-plan', p);
      });
  };

  document.addEventListener('DOMContentLoaded', () => {
    // ★決済戻りの ?plan= を保存→URLをクリーン化
    try {
      const q  = new URLSearchParams(location.search);
      const qp = (q.get('plan') || '').toLowerCase();
      if (qp === 'middle' || qp === 'pro') {
        if (typeof setPlan === 'function') {
          setPlan(qp);
        }
        window.updatePlanPill?.();
        window.syncLicenseButtons?.();
        history.replaceState(null, '', location.pathname);
      }
    } catch(_){}
  });

  window.updatePlanPill?.();
  window.syncLicenseButtons?.();
  (window.enforcePlan || function(){})();
})();
</script>

<script>
  window.tlpVerifyURL  = 'https://cafetabco.com/api/license/verify.php';
  window.tlpRedeemURL  = 'https://cafetabco.com/api/license/redeem.php';
</script>
<!-- C-1 Nudge: 全面置換版 -->
<script>
(()=> {
  'use strict';

  // 既存バーが残っていれば除去（重複防止）
  document.getElementById('tlp-nudge')?.remove();

  const KEY  = 'tlpLicenseFreshAt';
  const week = 7 * 24 * 60 * 60 * 1000;
  const fresh = Number(localStorage.getItem(KEY) || 0);

  // 一度も再検証していない場合 or 7日以内なら表示しない
  if (!fresh) return;
  if (Date.now() - fresh < week) return;

  // バー生成（上部固定）
  const bar = document.createElement('div');
  bar.id = 'tlp-nudge';
  bar.setAttribute('role', 'region');
  bar.setAttribute('aria-label', 'ライセンス再検証のご案内');

  const s = bar.style;
  s.position = 'fixed';
  s.left = '0';
  s.right = '0';
  s.top = '0';
  s.zIndex = '2147483647';
  s.background = '#111';
  s.color = '#fff';
  s.padding = '10px 12px';
  s.display = 'flex';
  s.alignItems = 'center';
  s.justifyContent = 'space-between';
  s.gap = '8px';
  s.fontSize = '14px';
  s.boxShadow = '0 2px 6px rgba(0,0,0,.2)';

  bar.innerHTML = [
    '<span>ライセンスの再検証から7日以上経過しています。</span>',
    '<span style="margin-left:auto;display:flex;gap:6px;">',
      '<button id="nudgeNow" style="padding:6px 10px;border-radius:4px;border:none;background:#ffb400;color:#000;cursor:pointer;">今すぐ</button>',
      '<button id="nudgeLater" style="padding:6px 10px;border-radius:4px;border:none;background:#444;color:#fff;cursor:pointer;">あとで</button>',
    '</span>'
  ].join('');

  document.body.appendChild(bar);

  const removeBar = () => {
    const el = document.getElementById('tlp-nudge');
    if (el) el.remove();
  };

  const btnNow   = document.getElementById('nudgeNow');
  const btnLater = document.getElementById('nudgeLater');

  if (btnNow) {
    btnNow.onclick = async () => {
      try {
        if (typeof reverifyNow === 'function') {
          await reverifyNow();
        } else if (window.btnVerifyNow?.click) {
          // 万一 reverifyNow が無ければ、ボタン経由でフォールバック
          window.btnVerifyNow.click();
        }
      } catch (e) {
        console.error('[TLP] nudge reverify error', e);
      }
      removeBar();
    };
  }

  if (btnLater) {
    btnLater.onclick = () => removeBar();
  }
})();
</script>


<script>
// === TLP core restore (1-4 only) — 2025-11-12 ===
(function(){
  if (window.__tlp_core_1412) return;
  window.__tlp_core_1412 = true;

  // 0) helper
  function safe(fn){ try{ if (typeof fn === 'function') fn(); } catch(e){} }

  // 1) refreshAll: 呼べるところだけ呼ぶ（存在チェック）
  if (typeof window.refreshAll !== 'function'){
    window.refreshAll = function(){
      safe(window.updatePlanPill);
      safe(window.refreshHome);
      safe(window.renderTodayList);
      safe(window.renderHistory);
      safe(window.refreshLicenseUI);
    };
  }

  // 2) DB.save をラップ：保存のたびに即時反映（①③④）
  try{
    if (window.DB && typeof DB.save === 'function' && !DB.save.__wired){
      var _save = DB.save.bind(DB);
      DB.save = function(s){
        var r = _save(s);
        try{
          // 最低限の再描画
          window.renderTodayList && window.renderTodayList();
          window.renderHistory && window.renderHistory();
          window.refreshHome && window.refreshHome();
          window.updatePlanPill && updatePlanPill();
        }catch(_){}
        return r;
      };
      DB.save.__wired = true;
    }
  }catch(_){}

  // 3) localStorage 直書きも捕捉（初期化/復元で起こりがち）（③④）
  try{
    if (!localStorage.__tlp_hooked){
      var _setItem = localStorage.setItem.bind(localStorage);
      localStorage.setItem = function(k, v){
        var r = _setItem(k, v);
        if (k === 'tabco-store' || k === 'tlpStore'){
          try{
            window.renderTodayList && window.renderTodayList();
            window.renderHistory && window.renderHistory();
            window.refreshHome && window.refreshHome();
          }catch(_){}
        }
        return r;
      };
      localStorage.__tlp_hooked = true;
    }
  }catch(_){}

  // 4) refreshHome 強化：元の処理 + KPI/ピルの最終上書き（①）
  try{
    var _origRefreshHome = window.refreshHome;
    window.refreshHome = function(){
      // 既存処理を尊重
      try{ if (typeof _origRefreshHome === 'function') _origRefreshHome(); }catch(_){}
      // 最低限のKPI更新とピル反映だけ追加（壊さない範囲）
      try{
        var byId = function(id){ return document.getElementById(id); };
        var yenFmt = (typeof yen === 'function')
          ? yen
          : function(n){ return '¥'+(Math.round(n||0)).toLocaleString('ja-JP'); };
        var setYen = function(id, v){ var el = byId(id); if(el) el.textContent = yenFmt(v); };
        if (typeof calcTotals === 'function'){
          setYen('kpiWeek',  calcTotals(7));
          setYen('kpiMonth', calcTotals(30));
          setYen('kpi30',    calcTotals(30));
        }
        if (typeof getPlan === 'function'){
          var p = getPlan();
          var label = (p==='pro'?'プロ':p==='middle'?'ミドル':'無料');
          var nodes = document.querySelectorAll('#pillPlan,[data-plan-pill],.plan-pill');
          for (var i=0;i<nodes.length;i++){
            var el = nodes[i];
            var t = (el.textContent||'').trim();
            el.textContent = /^プラン：/.test(t) ? ('プラン：'+label) : label;
            el.dataset.plan = p;
          }
        }
      }catch(_){}
    };
  }catch(_){}

  // 5) 履歴/本日 → 行タップで編集モーダル（②）
  if (!window.__wiredEditRowClick){
    window.__wiredEditRowClick = true;
    window.__tlp_currentEntry = null;

    document.addEventListener('click', function(e){
      var row = e.target && e.target.closest ? e.target.closest('#historyList .entry, #todayList .entry') : null;
      if (!row) return;
      var id = row.getAttribute('data-id');
      var entry = null;
      if (typeof window._findEntryById === 'function') entry = _findEntryById(id);
      else if (window.store && Array.isArray(store.entries)) entry = store.entries.find(function(x){return x && x.id === id;});
      if (!entry){ alert('編集対象が見つかりません'); return; }
      e.preventDefault();
      window.__tlp_currentEntry = entry;
      try{ window.openEntryEditModalLite && openEntryEditModalLite(entry); }catch(err){ console.error(err); }
    }, false);

    // モーダルOK配線（簡易編集を確実に反映）（②）
    document.addEventListener('click', function(e){
      var ok = e.target && e.target.closest ? e.target.closest('#modalOK, #btnModalOK') : null;
      if (!ok) return;
      var entry = window.__tlp_currentEntry;
      if (!entry) return;
      var qEl = document.getElementById('mLiteQty'), pEl = document.getElementById('mLitePrice'), rEl = document.getElementById('mLiteRate');
      var q = Number(qEl && qEl.value), p = Number(pEl && pEl.value), r = Number(rEl && rEl.value);
      if (Number.isFinite(q) && q > 0) entry.qty = q;
      if (Number.isFinite(p) && p >= 0) entry.price = p;
      if ([0,8,10].indexOf(r) >= 0) entry.taxrate = r;
      try{ window.DB && DB.save && DB.save(store); }catch(err){ console.error(err); }
      try{ window.closeModal && closeModal(); }catch(_){}
      window.__tlp_currentEntry = null;
    }, false);
  }
})();
</script>

<script>
document.getElementById('btnEnterLicenseMiddle')?.addEventListener('click', function(){
  if (window.openLicenseModal) { openLicenseModal(); return; }
  // フォールバック（既存のコード入力起動ボタンがある場合）
  document.getElementById('btnOpenLicense')?.click();
});
</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const btnOpen   = document.getElementById('btnOpenLicense');
    const btnVerify = document.getElementById('btnVerifyNow');

    // 「コードを入力」ボタン
    if (btnOpen) {
      btnOpen.addEventListener('click', () => {
        // もし既存のダイアログ関数があればそっちを優先
        if (typeof window.openLicenseDialog === 'function') {
          window.openLicenseDialog();
          return;
        }

        // 当面のフォールバック（Stripe購入ならコード入力不要の案内）
        alert(
          '現在、Stripeでご購入いただいた場合はライセンスが自動反映されます。\n' +
          '別途ライセンスコードをお持ちの場合は、お問い合わせからご連絡ください。'
        );
      });
    }

        // 「再検証」ボタン
    if (btnVerify) {
      btnVerify.addEventListener('click', async () => {
        if (!window.tlpVerifyURL || typeof window.tlpDeviceId !== 'function') {
          console.warn('tlpVerifyURL / tlpDeviceId が未定義です');
          alert('再検証の設定がまだ完了していません。');
          return;
        }

        btnVerify.disabled = true;

        try {
          const url =
            window.tlpVerifyURL +
            '?device=' + encodeURIComponent(window.tlpDeviceId()) +
            '&app=tlp';

          const res  = await fetch(url, { credentials: 'omit' });
          const data = await res.json().catch(() => ({}));

          const currentPlan =
            (typeof getPlan === 'function' ? getPlan() : 'free') || 'free';
          const serverPlanRaw = data && data.plan ? String(data.plan) : 'free';
          const serverPlan    = serverPlanRaw.toLowerCase();

          if (data.ok) {
            // サーバーから見たライセンス情報の「新鮮さ」を控える
            try {
              localStorage.setItem('tlpLicenseFreshAt', String(Date.now()));
            } catch (e) {}

            if (serverPlan === 'middle' || serverPlan === 'pro') {
              // ★ サーバー側が有料と言っている → そちらを優先して上書き
              if (serverPlan !== currentPlan) {
                try {
                  if (typeof applyLicensed === 'function') {
                    applyLicensed({ plan: serverPlan, via: 'verify' });
                  } else if (typeof setPlan === 'function') {
                    setPlan(serverPlan);
                  }
                } catch (e) {
                  if (typeof setPlan === 'function') setPlan(serverPlan);
                }

                alert(
                  'サーバーの記録に基づき、この端末を ' +
                  serverPlan + ' プランとして再設定しました。'
                );
              } else {
                alert('再検証完了：現在のプラン（' + serverPlan + '）は有効です。');
              }
            } else {
              // ★ サーバー側の判定が free / 不明
              if (currentPlan === 'middle' || currentPlan === 'pro') {
                // 端末は有料表示 → 勝手にダウングレードしない
                alert(
                  'サーバー側にこの端末の有料プラン記録が見つかりませんでした。\n' +
                  '安全のため、自動でプランを変更せず現在の ' + currentPlan + ' プランのままにしています。\n' +
                  'ご購入済みの場合は、購入時のメールを添えてサポートまでご連絡ください。'
                );
              } else {
                alert(
                  '再検証完了：この端末の有料プラン記録は見つかりませんでした。\n' +
                  '購入済みでプランが反映されない場合は、ライセンスコード入力か、\n' +
                  '購入時のメールを添えてサポートまでご連絡ください。'
                );
              }
            }

            // プラン表示などを更新（あれば呼ぶ）
            window.applyPlanUI?.();
            // window.refreshLicenseUI?.(); // 未実装なら一旦コメントアウト
          } else {
            alert(
              '再検証に失敗しました。\n' +
              (data.message || '時間をおいて再度お試しください。')
            );
          }
        } catch (e) {
          console.error(e);
          alert('再検証中にエラーが発生しました。ネットワーク環境をご確認ください。');
        } finally {
          btnVerify.disabled = false;
        }
      });
    }

  });
</script>


<script>
  // demo badge after initial render
  (function(){
    try{
      if (typeof IS_DEMO !== "undefined" && IS_DEMO){
        if (document.readyState === "loading"){
          document.addEventListener("DOMContentLoaded", ()=>{ try{ mountDemoUI(); }catch(_){} }, { once:true });
        } else {
          try{ mountDemoUI(); }catch(_){}
        }
      }
    }catch(_){}
  })();
</script>
<script>
(() => {
  const inIframe = (window.parent && window.parent !== window);
  if (!inIframe) return;

  const PARENT_ORIGIN = "https://cafetabco.com";
  const sentKey = "tlpDemoStartSent_v2"; // ←ここがポイント

  function send(action, label = "") {
    const payload = { type: "tlp_demo", action, label };
    try {
      window.parent.postMessage(payload, PARENT_ORIGIN);
    } catch (e) {
      window.parent.postMessage(payload, "*");
    }
    // デモ側ログ（デモのDevTools見れる時だけ）
    try { console.log("[DEMO] sent", action); } catch(e){}
  }

  send("demo_loaded");

  function onFirstTouch() {
    if (sessionStorage.getItem(sentKey) === "1") return;
    sessionStorage.setItem(sentKey, "1");
    send("demo_start");
    cleanup();
  }

  function cleanup() {
    window.removeEventListener("pointerdown", onFirstTouch, true);
    window.removeEventListener("keydown", onFirstTouch, true);
  }

  window.addEventListener("pointerdown", onFirstTouch, true);
  window.addEventListener("keydown", onFirstTouch, true);
})();
</script>

</body>
</html>
